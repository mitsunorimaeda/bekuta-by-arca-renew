# 本番環境デプロイチェックリスト

このチェックリストに従って、本番環境へのデプロイを確実に行ってください。

## デプロイ前（必須）

### 1. 環境確認
- [ ] `npm run env:check` で環境を確認
- [ ] 開発環境になっている場合は `npm run env:prod` で切り替え
- [ ] `.env` ファイルが本番環境の設定になっているか確認

### 2. コード品質チェック
- [ ] `npm run lint` でエラーがないか確認
- [ ] `npm run build:production` でビルドが成功するか確認
- [ ] ビルドエラーや警告がないか確認

### 3. データベース確認
- [ ] Supabase本番環境ダッシュボードにログイン
- [ ] すべてのマイグレーションが適用されているか確認
- [ ] RLSがすべてのテーブルで有効になっているか確認
- [ ] テストデータではなく本番データが入っているか確認

### 4. Edge Functions確認
- [ ] `create-user` 関数がデプロイされているか
- [ ] `update-user` 関数がデプロイされているか
- [ ] `delete-user` 関数がデプロイされているか
- [ ] `send-email` 関数がデプロイされているか
- [ ] `reset-password` 関数がデプロイされているか
- [ ] 各関数が正常に動作するかテスト

### 5. 環境変数確認
- [ ] `VITE_SUPABASE_URL` が本番環境のURLか確認
- [ ] `VITE_SUPABASE_ANON_KEY` が本番環境のキーか確認
- [ ] Resend APIキーが設定されているか確認

### 6. セキュリティチェック
- [ ] `.env.local` ファイルが存在しないか確認
- [ ] ハードコードされた認証情報がないか確認
- [ ] Service Role Keyがクライアントコードに含まれていないか確認
- [ ] 本番環境のキーがGitにコミットされていないか確認

## Netlifyデプロイ手順

### 1. Netlifyアカウント作成
- [ ] https://netlify.com でアカウント作成
- [ ] GitHubアカウントで連携

### 2. プロジェクト接続
- [ ] 「New site from Git」をクリック
- [ ] GitHubリポジトリを選択
- [ ] ブランチを選択（通常は `main` または `master`）

### 3. ビルド設定
```
Build command: npm run build:production
Publish directory: dist
Node version: 18
```

- [ ] Build commandが `npm run build:production` になっているか確認
- [ ] Publish directoryが `dist` になっているか確認

### 4. 環境変数設定
Site settings → Environment variables → Add a variable

以下の環境変数を追加:

```
VITE_SUPABASE_URL=https://ucicxvepktvotvtafowm.supabase.co
VITE_SUPABASE_ANON_KEY=[本番環境のAnon Key]
```

- [ ] `VITE_SUPABASE_URL` を追加
- [ ] `VITE_SUPABASE_ANON_KEY` を追加
- [ ] 値が正しいか再確認

### 5. デプロイ実行
- [ ] 「Deploy site」をクリック
- [ ] デプロイログを確認
- [ ] エラーがないか確認
- [ ] デプロイが成功したか確認

## デプロイ後（必須）

### 1. 動作確認
- [ ] デプロイされたURLにアクセス
- [ ] ログインページが表示されるか確認
- [ ] 管理者アカウントでログイン可能か確認
- [ ] ダッシュボードが正常に表示されるか確認

### 2. 認証機能テスト
- [ ] ログインが正常に動作するか
- [ ] ログアウトが正常に動作するか
- [ ] パスワード変更が動作するか

### 3. データ操作テスト
- [ ] 練習記録の追加が動作するか
- [ ] 体重記録の追加が動作するか
- [ ] データの表示が正常か確認
- [ ] グラフが正常に表示されるか確認

### 4. ユーザー招待テスト
- [ ] ユーザー招待フォームが動作するか
- [ ] 招待メールが送信されるか確認
- [ ] 招待リンクが正常に動作するか
- [ ] 新規ユーザーがログインできるか確認

### 5. エラーハンドリング確認
- [ ] ブラウザのコンソールにエラーがないか確認
- [ ] Netlify Functionsのログを確認
- [ ] Supabaseのログを確認
- [ ] Resendのログを確認

## カスタムドメイン設定（オプション）

### 1. ドメイン追加
- [ ] Netlify: Site settings → Domain management → Add custom domain
- [ ] 独自ドメインを入力
- [ ] DNSレコードを設定

### 2. SSL証明書
- [ ] Netlifyが自動的にSSL証明書を発行するまで待つ（数分〜数時間）
- [ ] HTTPSでアクセスできるか確認

## 継続的デプロイ設定

### 1. 自動デプロイ確認
- [ ] Gitにコミット＆プッシュ
- [ ] Netlifyが自動的にビルド＆デプロイするか確認
- [ ] デプロイ通知を設定（オプション）

### 2. プレビュー環境
- [ ] Pull Requestで自動的にプレビュー環境が作成されるか確認
- [ ] プレビューURLで動作確認

## トラブルシューティング

### ビルドエラーが発生した場合
1. Netlifyのビルドログを確認
2. ローカルで `npm run build:production` を実行して再現
3. エラーメッセージをもとに修正
4. 再度プッシュしてデプロイ

### 認証エラーが発生した場合
1. Netlifyの環境変数を確認
2. `VITE_SUPABASE_URL` と `VITE_SUPABASE_ANON_KEY` が正しいか確認
3. 環境変数を更新後、手動で再デプロイ

### データが表示されない場合
1. ブラウザのコンソールでエラーを確認
2. Supabaseのログを確認
3. RLSポリシーが正しく設定されているか確認

## 完了

- [ ] すべてのチェック項目が完了
- [ ] 本番環境が正常に動作している
- [ ] チームメンバーに展開完了を通知

---

**デプロイ完了日**: __________

**デプロイ担当者**: __________

**本番環境URL**: __________

# パスワードリセットガイド

ユーザーがパスワードを忘れた場合の対応方法を説明します。

## 管理者向け：パスワードリセット手順

管理者は以下のスクリプトを使用して、任意のユーザーのパスワードをリセットできます。

### 基本的な使い方

```bash
node scripts/reset-user-password.mjs [メールアドレス] [新しいパスワード]
```

### 使用例

#### 例1: info@arca.fit のパスワードをリセット

```bash
node scripts/reset-user-password.mjs info@arca.fit NewPassword123!
```

#### 例2: 引数なしで実行（デフォルト値を使用）

```bash
node scripts/reset-user-password.mjs
```

デフォルト値：
- メールアドレス: `info@arca.fit`
- パスワード: `MNrh8181614`

### スクリプトの動作

パスワードリセットスクリプトは以下の処理を行います：

1. 指定されたメールアドレスのユーザーを検索
2. ユーザーが存在する場合、パスワードを更新
3. `requires_password_change` フラグを `true` に設定
4. ユーザーのメール確認状態を確認済みに設定

### 重要な注意事項

- **初回ログイン時の強制パスワード変更**: リセット後、ユーザーは初回ログイン時に必ずパスワード変更画面が表示されます
- **セキュリティ**: 一時パスワードは必ずユーザーに直接伝えてください（メール、電話など）
- **強力なパスワード**: 一時パスワードは推測されにくいものを使用してください

## ユーザー向け：パスワードを忘れた場合

### 1. 管理者に連絡

パスワードを忘れた場合は、以下の情報を管理者に伝えてください：

- 登録しているメールアドレス
- 氏名
- 所属チーム（分かれば）

### 2. 一時パスワードを受け取る

管理者から一時パスワードが発行されます。このパスワードはメールや電話で直接伝えられます。

### 3. 初回ログイン

1. ログイン画面で、メールアドレスと一時パスワードを入力
2. ログインすると、自動的にパスワード変更画面が表示されます
3. 新しいパスワードを設定してください

### パスワードの要件

新しいパスワードは以下の要件を満たす必要があります：

- 最低8文字以上
- 大文字と小文字を含む
- 数字を含む
- 特殊文字を含む（推奨）

### パスワード変更画面が表示されない場合

以下の手順を試してください：

1. ブラウザのキャッシュをクリア
2. 別のブラウザで試す
3. 管理者に連絡して、再度パスワードリセットを依頼

## トラブルシューティング

### エラー: ユーザーが見つからない

**原因**: 指定されたメールアドレスのユーザーが存在しない

**解決策**:
1. メールアドレスのスペルを確認
2. システムに登録されているか管理者に確認
3. ユーザーが削除されていないか確認

### エラー: 環境変数が見つからない

**原因**: `.env` ファイルが正しく設定されていない

**解決策**:
```bash
# 環境変数を検証
npm run validate-env

# 問題がある場合は .env.example からコピー
cp .env.example .env
```

### エラー: Invalid API key

**原因**: Supabase の認証情報が間違っている

**解決策**:
1. `.env` ファイルの `VITE_SUPABASE_URL` と `SUPABASE_SERVICE_ROLE_KEY` を確認
2. `SUPABASE_SETUP.md` を参照して正しい設定を確認
3. 環境変数を検証：`npm run validate-env`

## セキュリティのベストプラクティス

### 管理者向け

1. **一時パスワードの強度**: 推測されにくい複雑なパスワードを生成
2. **安全な伝達**: パスワードはセキュアな方法で伝達（直接伝える、暗号化されたチャネルなど）
3. **記録の保持**: パスワードリセットの履歴を記録（誰が、いつ、誰のパスワードをリセットしたか）
4. **即座の変更**: ユーザーに初回ログイン時のパスワード変更を促す

### ユーザー向け

1. **一時パスワードの保護**: 受け取った一時パスワードは他人に教えない
2. **速やかな変更**: 一時パスワードを受け取ったら、できるだけ早くログインして変更
3. **強力なパスワード**: 推測されにくい、複雑なパスワードを設定
4. **パスワードの使い回し**: 他のサービスと同じパスワードを使用しない

## 将来の機能拡張案

現在は管理者によるパスワードリセットのみですが、将来的には以下の機能を追加できます：

1. **セルフサービスパスワードリセット**
   - ユーザーがログイン画面から「パスワードを忘れた」をクリック
   - 登録されたメールアドレスにリセットリンクを送信
   - ユーザー自身でパスワードを変更

2. **メール通知**
   - パスワードリセット時に自動でメール通知
   - セキュリティ上の理由で、メールにはパスワードを含めない

3. **多要素認証（MFA）**
   - パスワードに加えて、SMS や認証アプリによる追加認証

これらの機能が必要な場合は、管理者にご相談ください。

## サポート

パスワードリセットに関する問題が解決しない場合は、以下の情報を含めて管理者に連絡してください：

- メールアドレス
- エラーメッセージ（表示された場合）
- 試した手順
- 使用しているブラウザとデバイス

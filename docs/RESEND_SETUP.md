# Resend メール送信設定ガイド

このドキュメントでは、ACWR Monitor システムでメール送信機能を有効にするための Resend の設定手順を説明します。

## 概要

ACWR Monitor は以下のメール通知機能を提供しています：

- **ユーザー招待メール**: 新規ユーザーへの招待リンクと初回パスワードを送信
- **パスワードリセット通知**: パスワード変更時の通知
- **怪我リスクアラート**: ACWR が危険範囲に達した際の警告メール
- **週次サマリー**: トレーニング負荷の週次レポート

これらの機能は **Resend** というメール配信サービスを使用しています。

---

## ステップ 1: Resend アカウントの作成

### 1.1 サインアップ

1. [Resend 公式サイト](https://resend.com) にアクセス
2. 右上の「Sign Up」ボタンをクリック
3. メールアドレスとパスワードを入力してアカウントを作成
4. 確認メールが届くので、リンクをクリックしてアカウントを有効化

### 1.2 無料プランについて

Resend の無料プランでは以下が利用できます：
- 月間 **3,000通** のメール送信
- 1日あたり **100通** のメール送信
- **onboarding@resend.dev** ドメインからの送信（検証不要）

小規模チームや開発環境では無料プランで十分です。

---

## ステップ 2: API キーの取得

### 2.1 API キーの作成

1. Resend ダッシュボードにログイン
2. 左サイドバーの **「API Keys」** をクリック
3. 右上の **「Create API Key」** ボタンをクリック
4. キー名を入力（例: `ACWR Monitor Production` または `ACWR Monitor Development`）
5. Permission を **「Sending access」** のまま（推奨）
6. **「Add」** ボタンをクリック

### 2.2 API キーのコピー

⚠️ **重要**: API キーは一度しか表示されません！

- 表示された API キー（`re_` で始まる文字列）を安全な場所にコピーして保存してください
- このキーは後で Supabase の環境変数として使用します

**例:**
```
re_123abc456def789ghi012jkl345mno678pqr
```

---

## ステップ 3: Supabase への API キー設定

### 3.1 開発環境の設定

1. [Supabase ダッシュボード](https://supabase.com/dashboard) にログイン
2. **開発環境プロジェクト** を選択
   - URL: `https://qetusppzdmktdwywxghd.supabase.co`
3. 左サイドバーから **「Edge Functions」** を選択
4. 上部の **「Manage secrets」** ボタンをクリック
5. 新しいシークレットを追加:
   - **Name**: `RESEND_API_KEY`
   - **Value**: 先ほどコピーした API キー
6. **「Save」** ボタンをクリック

### 3.2 本番環境の設定

同じ手順を **本番環境プロジェクト** でも実施します：

1. Supabase ダッシュボードで **本番環境プロジェクト** を選択
   - URL: `https://ucicxvepktvotvtafowm.supabase.co`
2. 左サイドバーから **「Edge Functions」** を選択
3. 上部の **「Manage secrets」** ボタンをクリック
4. 新しいシークレットを追加:
   - **Name**: `RESEND_API_KEY`
   - **Value**: Resend API キー
5. **「Save」** ボタンをクリック

### 3.3 環境変数の確認

設定後、環境変数が正しく登録されているか確認します：

1. Edge Functions のページで **「Secrets」** タブを確認
2. `RESEND_API_KEY` が表示されていれば成功

---

## ステップ 4: メール送信のテスト

### 4.1 テストメールの送信

1. ACWR Monitor にログイン（管理者アカウント）
2. **「ユーザー管理」** セクションに移動
3. **「新規ユーザー招待」** フォームでテストユーザーを招待:
   - 名前: テストユーザー
   - メールアドレス: **自分のメールアドレス**
   - 役割: 選手
   - チーム: 任意
4. **「招待メールを送信」** ボタンをクリック

### 4.2 メール受信の確認

- 数秒から数分以内に招待メールが届きます
- メールが届かない場合は、迷惑メールフォルダを確認してください
- メールの送信元は `onboarding@resend.dev` です

### 4.3 トラブルシューティング

**メールが届かない場合:**

1. Supabase のログを確認:
   - Edge Functions → `send-email` → Logs タブ
   - エラーメッセージを確認

2. API キーが正しいか確認:
   - `re_` で始まっているか
   - コピー時にスペースが入っていないか

3. Resend のダッシュボードを確認:
   - Logs セクションでメール送信履歴を確認
   - エラーがあれば詳細を確認

---

## ステップ 5: カスタムドメインの設定（オプション・推奨）

無料プランでは `onboarding@resend.dev` からメールが送信されますが、より信頼性の高い配信のためにカスタムドメインを設定することを推奨します。

### 5.1 ドメインの追加

1. Resend ダッシュボードで **「Domains」** をクリック
2. **「Add Domain」** ボタンをクリック
3. 所有しているドメインを入力（例: `arca.fit`）
4. DNS 設定用のレコードが表示されます

### 5.2 DNS レコードの設定

表示された以下のレコードをドメインの DNS 設定に追加します：

- **SPF レコード** (TXT): 送信者検証
- **DKIM レコード** (TXT): メール署名検証
- **DMARC レコード** (TXT): なりすまし防止

**例（お使いの DNS プロバイダーで設定）:**
```
Type: TXT
Name: @
Value: v=spf1 include:_spf.resend.com ~all

Type: TXT
Name: resend._domainkey
Value: [Resend が提供する値]
```

### 5.3 ドメイン検証

1. DNS レコードを追加後、Resend ダッシュボードに戻る
2. **「Verify DNS Records」** ボタンをクリック
3. 検証が完了すると、ドメインのステータスが「Verified」になります

⚠️ DNS の反映には最大 48時間かかる場合がありますが、通常は数分〜数時間で完了します。

### 5.4 Edge Function の送信元アドレス更新

カスタムドメインが検証されたら、Edge Function のコードを更新します：

**ファイル**: `supabase/functions/send-email/index.ts`

```typescript
// 131行目あたり
from: 'ACWR Monitor <noreply@yourdomain.com>',  // ← カスタムドメインに変更
```

例:
```typescript
from: 'ACWR Monitor <noreply@arca.fit>',
```

変更後、Edge Function を再デプロイします。

---

## メール送信の仕組み

### システム構成

```
ユーザー招待
    ↓
フロントエンド (React)
    ↓ fetch リクエスト
Supabase Edge Function (send-email)
    ↓ Resend API 呼び出し
Resend サービス
    ↓
受信者のメールボックス
```

### メールテンプレート

メールの HTML テンプレートは以下のファイルで定義されています：

- `src/lib/emailTemplates.ts`: 招待メールのテンプレート
- `supabase/functions/send-email/index.ts`: メール送信ロジック

デザインはレスポンシブで、モバイル・デスクトップの両方で美しく表示されます。

---

## よくある質問（FAQ）

### Q1: 無料プランで十分ですか？

**A:** 小規模チーム（20-30人）であれば、月間3,000通で十分です。
- ユーザー招待: 1通/人
- 週次サマリー: 4通/人/月
- アラート: 必要に応じて

大規模チームの場合は有料プラン（月額 $20〜）を検討してください。

### Q2: メールが迷惑メールフォルダに入ります

**A:** カスタムドメインを設定し、SPF/DKIM/DMARC レコードを正しく設定することで改善されます。また、受信者に送信元アドレス（`noreply@yourdomain.com`）をホワイトリストに追加してもらうことも有効です。

### Q3: API キーを紛失しました

**A:** Resend ダッシュボードで新しい API キーを作成し、Supabase の環境変数を更新してください。古いキーは削除することを推奨します。

### Q4: 開発環境と本番環境で異なる API キーを使えますか？

**A:** はい、それが推奨されます。開発環境用と本番環境用で別々の API キーを作成し、それぞれの Supabase プロジェクトに設定してください。

### Q5: メール送信が失敗した場合どうなりますか？

**A:** システムはエラーをログに記録し、ユーザーに通知します。招待 URL と初回パスワードは画面上に表示されるため、管理者が手動で共有することも可能です。

---

## セキュリティのベストプラクティス

### API キーの管理

- ✅ API キーは環境変数として Supabase に保存
- ✅ コードに直接書き込まない
- ✅ Git リポジトリにコミットしない
- ✅ 定期的にローテーション（更新）する
- ✅ 不要になったキーは削除する

### メール送信のセキュリティ

- ✅ 送信元アドレスを固定
- ✅ レート制限を設定（Resend が自動で設定）
- ✅ 認証済みユーザーのみが Edge Function を呼び出せる
- ✅ メール内容に機密情報を含めない

---

## サポート

### 問題が発生した場合

1. **Supabase ログを確認**:
   - Edge Functions → send-email → Logs

2. **Resend ダッシュボードを確認**:
   - Logs セクションで送信履歴とエラーを確認

3. **コンソールログを確認**:
   - ブラウザの開発者ツール → Console タブ

### 公式ドキュメント

- [Resend 公式ドキュメント](https://resend.com/docs)
- [Supabase Edge Functions ドキュメント](https://supabase.com/docs/guides/functions)
- [ACWR Monitor README](../README.md)

---

## まとめ

以上で Resend メール送信機能の設定は完了です。

**設定完了チェックリスト:**

- [ ] Resend アカウントを作成
- [ ] API キーを取得
- [ ] 開発環境の Supabase に API キーを設定
- [ ] 本番環境の Supabase に API キーを設定
- [ ] テストメールを送信して動作確認
- [ ] （オプション）カスタムドメインを設定

これでユーザー招待メールやアラート通知が自動的に送信されるようになります。

{"version":3,"file":"AthleteNutritionDashboardView-B0c06uVF.js","sources":["../../src/components/NutritionEditModal.tsx","../../src/components/PFCBalance.tsx","../../src/components/NutritionSummaryPanel.tsx","../../src/components/NutritionCard.tsx","../../src/components/views/AthleteNutritionDashboardView.tsx"],"sourcesContent":["// src/components/NutritionEditModal.tsx\nimport React, { useEffect, useMemo, useState } from \"react\";\nimport { X, Save, Trash2, Loader2 } from \"lucide-react\";\nimport { supabase } from \"../lib/supabase\";\n\ntype MealType = \"朝食\" | \"昼食\" | \"夕食\" | \"補食\";\n\nfunction toNum(v: any, fallback = 0) {\n  const n = Number(v);\n  return Number.isFinite(n) ? n : fallback;\n}\n\nfunction formatMealLabel(mealType: string, mealSlot: any) {\n  if (mealType === \"補食\") return `補食${Number(mealSlot ?? 1)}`;\n  return mealType;\n}\n\nexport type NutritionLog = {\n  id: string;\n  user_id: string;\n  record_date: string; // yyyy-mm-dd\n  meal_type: MealType | string;\n  meal_slot: number;\n\n  total_calories: number;\n  p: number;\n  f: number;\n  c: number;\n\n  menu_items: any[]; // jsonb\n  advice_markdown: string | null;\n\n  image_url?: string | null;\n  image_path?: string | null;\n\n  analysis_status?: string | null;\n  analysis_error?: string | null;\n\n  is_edited?: boolean;\n  edit_meta?: any;\n\n  created_at?: string;\n  updated_at?: string;\n};\n\ntype Props = {\n  open: boolean;\n  log: NutritionLog | null;\n\n  onClose: () => void;\n\n  // 成功したら NutritionCard 側の local state を更新するために返す\n  onSaved: (updated: NutritionLog) => void;\n\n  onDeleted: (deletedId: string) => void;\n};\n\nexport default function NutritionEditModal({\n  open,\n  log,\n  onClose,\n  onSaved,\n  onDeleted,\n}: Props) {\n  const [saving, setSaving] = useState(false);\n  const [deleting, setDeleting] = useState(false);\n  const [err, setErr] = useState<string | null>(null);\n\n  const [cal, setCal] = useState<string>(\"0\");\n  const [p, setP] = useState<string>(\"0\");\n  const [f, setF] = useState<string>(\"0\");\n  const [c, setC] = useState<string>(\"0\");\n  const [menuText, setMenuText] = useState<string>(\"\");\n  const [advice, setAdvice] = useState<string>(\"\");\n\n  const title = useMemo(() => {\n    if (!log) return \"\";\n    return `${formatMealLabel(String(log.meal_type), log.meal_slot)} の編集`;\n  }, [log]);\n\n  // ✅ 背景スクロールを止める（open の時だけ）\n  useEffect(() => {\n    if (!open) return;\n    const prevOverflow = document.body.style.overflow;\n    const prevPaddingRight = document.body.style.paddingRight;\n\n    // iOS系でガタつくことがあるのでスクロールバー幅分のpaddingを足す（PC用）\n    const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;\n    document.body.style.overflow = \"hidden\";\n    if (scrollbarWidth > 0) document.body.style.paddingRight = `${scrollbarWidth}px`;\n\n    return () => {\n      document.body.style.overflow = prevOverflow;\n      document.body.style.paddingRight = prevPaddingRight;\n    };\n  }, [open]);\n\n  // ✅ ESCで閉じる\n  useEffect(() => {\n    if (!open) return;\n    const onKeyDown = (e: KeyboardEvent) => {\n      if (e.key === \"Escape\") onClose();\n    };\n    window.addEventListener(\"keydown\", onKeyDown);\n    return () => window.removeEventListener(\"keydown\", onKeyDown);\n  }, [open, onClose]);\n\n  // ✅ log が変わったらフォームに反映\n  useEffect(() => {\n    if (!open || !log) return;\n\n    setErr(null);\n    setCal(String(toNum(log.total_calories, 0)));\n    setP(String(toNum(log.p, 0)));\n    setF(String(toNum(log.f, 0)));\n    setC(String(toNum(log.c, 0)));\n\n    const items = Array.isArray(log.menu_items) ? log.menu_items : [];\n    const names = items\n      .map((x: any) => (typeof x === \"string\" ? x : x?.name ?? x?.label ?? \"\"))\n      .filter(Boolean);\n    setMenuText(names.join(\"\\n\"));\n\n    setAdvice(String(log.advice_markdown ?? \"\"));\n  }, [open, log]);\n\n  if (!open || !log) return null;\n\n  const handleSave = async () => {\n    setSaving(true);\n    setErr(null);\n\n    try {\n      const updatedPayload = {\n        total_calories: Math.max(0, Math.round(toNum(cal, 0))),\n        p: Math.max(0, Number(toNum(p, 0).toFixed(1))),\n        f: Math.max(0, Number(toNum(f, 0).toFixed(1))),\n        c: Math.max(0, Number(toNum(c, 0).toFixed(1))),\n        menu_items: (menuText || \"\")\n          .split(\"\\n\")\n          .map((s) => s.trim())\n          .filter(Boolean),\n        advice_markdown: advice?.trim() ? advice.trim() : null,\n\n        is_edited: true,\n        edit_meta: {\n          updated_at: new Date().toISOString(),\n          source: \"nutrition_edit_modal\",\n        },\n      };\n\n      const { data, error } = await supabase\n        .from(\"nutrition_logs\")\n        .update(updatedPayload)\n        .eq(\"id\", log.id)\n        .select(\"*\")\n        .single();\n\n      if (error) throw error;\n\n      onSaved(data as NutritionLog);\n      onClose();\n    } catch (e: any) {\n      console.error(\"[NutritionEditModal] save error:\", e);\n      setErr(String(e?.message ?? e));\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  const handleDelete = async () => {\n    const ok = window.confirm(\"この栄養記録を削除します。よろしいですか？\");\n    if (!ok) return;\n\n    setDeleting(true);\n    setErr(null);\n\n    try {\n      const { error } = await supabase.from(\"nutrition_logs\").delete().eq(\"id\", log.id);\n      if (error) throw error;\n\n      onDeleted(log.id);\n      onClose();\n    } catch (e: any) {\n      console.error(\"[NutritionEditModal] delete error:\", e);\n      setErr(String(e?.message ?? e));\n    } finally {\n      setDeleting(false);\n    }\n  };\n\n  return (\n    <div className=\"fixed inset-0 z-[60] flex items-center justify-center p-4\">\n      {/* ✅ overlay：button にする（a11y警告回避） */}\n      <button\n        type=\"button\"\n        className=\"absolute inset-0 bg-black/50\"\n        onClick={onClose}\n        aria-label=\"閉じる\"\n        disabled={saving || deleting}\n      />\n\n      {/* modal */}\n      <div\n        className=\"\n          relative w-full max-w-2xl\n          bg-white dark:bg-gray-900\n          rounded-2xl shadow-2xl\n          flex flex-col\n          max-h-[calc(100vh-2rem)]\n        \"\n        role=\"dialog\"\n        aria-modal=\"true\"\n        aria-label={title}\n      >\n        {/* header */}\n        <div className=\"flex items-center justify-between px-4 sm:px-6 py-4 border-b border-gray-200 dark:border-gray-800 flex-none\">\n          <div className=\"min-w-0\">\n            <p className=\"text-sm font-semibold text-gray-900 dark:text-white truncate\">{title}</p>\n            <p className=\"text-xs text-gray-500 dark:text-gray-400\">\n              {log.record_date} / status: {log.analysis_status ?? \"-\"}\n              {log.is_edited ? \"（編集済）\" : \"\"}\n            </p>\n          </div>\n\n          <button\n            type=\"button\"\n            onClick={onClose}\n            className=\"p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 flex-none\"\n            aria-label=\"close\"\n            disabled={saving || deleting}\n          >\n            <X className=\"w-5 h-5 text-gray-700 dark:text-gray-200\" />\n          </button>\n        </div>\n\n        {/* ✅ body：ここがスクロールする */}\n        <div className=\"p-4 sm:p-6 space-y-4 overflow-y-auto\">\n          {err && (\n            <div className=\"bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-3\">\n              <p className=\"text-sm text-red-700 dark:text-red-300\">{err}</p>\n            </div>\n          )}\n\n          {log.image_url && (\n            <div className=\"rounded-xl overflow-hidden border border-gray-200 dark:border-gray-800\">\n              {/* eslint-disable-next-line @next/next/no-img-element */}\n              <img\n                src={log.image_url}\n                alt=\"meal\"\n                className=\"w-full max-h-[320px] object-cover\"\n                loading=\"eager\"\n                decoding=\"async\"\n              />\n            </div>\n          )}\n\n          <div className=\"grid grid-cols-2 sm:grid-cols-4 gap-3\">\n            <label className=\"space-y-1\">\n              <p className=\"text-xs text-gray-600 dark:text-gray-400\">kcal</p>\n              <input\n                value={cal}\n                onChange={(e) => setCal(e.target.value)}\n                inputMode=\"numeric\"\n                className=\"w-full px-3 py-2 text-sm rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-950 text-gray-900 dark:text-gray-100\"\n                disabled={saving || deleting}\n              />\n            </label>\n\n            <label className=\"space-y-1\">\n              <p className=\"text-xs text-gray-600 dark:text-gray-400\">P (g)</p>\n              <input\n                value={p}\n                onChange={(e) => setP(e.target.value)}\n                inputMode=\"decimal\"\n                className=\"w-full px-3 py-2 text-sm rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-950 text-gray-900 dark:text-gray-100\"\n                disabled={saving || deleting}\n              />\n            </label>\n\n            <label className=\"space-y-1\">\n              <p className=\"text-xs text-gray-600 dark:text-gray-400\">F (g)</p>\n              <input\n                value={f}\n                onChange={(e) => setF(e.target.value)}\n                inputMode=\"decimal\"\n                className=\"w-full px-3 py-2 text-sm rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-950 text-gray-900 dark:text-gray-100\"\n                disabled={saving || deleting}\n              />\n            </label>\n\n            <label className=\"space-y-1\">\n              <p className=\"text-xs text-gray-600 dark:text-gray-400\">C (g)</p>\n              <input\n                value={c}\n                onChange={(e) => setC(e.target.value)}\n                inputMode=\"decimal\"\n                className=\"w-full px-3 py-2 text-sm rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-950 text-gray-900 dark:text-gray-100\"\n                disabled={saving || deleting}\n              />\n            </label>\n          </div>\n\n          <label className=\"space-y-1 block\">\n            <p className=\"text-xs text-gray-600 dark:text-gray-400\">推定メニュー（1行=1品）</p>\n            <textarea\n              value={menuText}\n              onChange={(e) => setMenuText(e.target.value)}\n              rows={4}\n              className=\"w-full px-3 py-2 text-sm rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-950 text-gray-900 dark:text-gray-100\"\n              disabled={saving || deleting}\n            />\n          </label>\n\n          <label className=\"space-y-1 block\">\n            <p className=\"text-xs text-gray-600 dark:text-gray-400\">メモ / AIコメント（編集OK）</p>\n            <textarea\n              value={advice}\n              onChange={(e) => setAdvice(e.target.value)}\n              rows={4}\n              className=\"w-full px-3 py-2 text-sm rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-950 text-gray-900 dark:text-gray-100\"\n              disabled={saving || deleting}\n            />\n          </label>\n\n          {log.analysis_status === \"failed\" && log.analysis_error && (\n            <div className=\"bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-3\">\n              <p className=\"text-xs text-amber-800 dark:text-amber-200 whitespace-pre-wrap\">\n                解析失敗: {String(log.analysis_error)}\n              </p>\n            </div>\n          )}\n        </div>\n\n        {/* footer */}\n        <div className=\"flex items-center justify-between gap-2 px-4 sm:px-6 py-4 border-t border-gray-200 dark:border-gray-800 flex-none\">\n          <button\n            type=\"button\"\n            onClick={handleDelete}\n            disabled={saving || deleting}\n            className=\"inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-red-200 dark:border-red-800 text-red-600 dark:text-red-300 hover:bg-red-50 dark:hover:bg-red-900/20 disabled:opacity-60\"\n          >\n            {deleting ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <Trash2 className=\"w-4 h-4\" />}\n            削除\n          </button>\n\n          <button\n            type=\"button\"\n            onClick={handleSave}\n            disabled={saving || deleting}\n            className=\"inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-60\"\n          >\n            {saving ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <Save className=\"w-4 h-4\" />}\n            保存\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n}","// src/components/PFCBalance.tsx\nimport React, { useMemo, useState } from \"react\";\n\ntype Totals = { p: number; f: number; c: number };\ntype Targets = { p: number; f: number; c: number }; // 将来用（今は使わない）\n\nfunction toNum(v: any, fallback = 0) {\n  const n = Number(v);\n  return Number.isFinite(n) ? n : fallback;\n}\nfunction clamp(n: number, min: number, max: number) {\n  return Math.min(max, Math.max(min, n));\n}\n\nfunction kcalFromPFC(pG: number, fG: number, cG: number) {\n  const pK = pG * 4;\n  const fK = fG * 9;\n  const cK = cG * 4;\n  const total = pK + fK + cK;\n  return { pK, fK, cK, total };\n}\n\n/**\n * 小数% → 整数% にして「必ず合計100」になるよう調整\n *（最大剰余法 / Largest Remainder Method）\n */\nfunction toIntPct100(p: number, f: number, c: number) {\n  const raw = [\n    { key: \"p\" as const, v: clamp(p, 0, 100) },\n    { key: \"f\" as const, v: clamp(f, 0, 100) },\n    { key: \"c\" as const, v: clamp(c, 0, 100) },\n  ];\n\n  // total が 0 のケースは呼び出し側で弾く\n  const floors = raw.map((x) => ({\n    ...x,\n    floor: Math.floor(x.v),\n    frac: x.v - Math.floor(x.v),\n  }));\n\n  let sum = floors.reduce((acc, x) => acc + x.floor, 0);\n  let remain = 100 - sum;\n\n  // frac の大きい順に +1 して合計100に寄せる\n  floors.sort((a, b) => b.frac - a.frac);\n\n  const addMap: Record<\"p\" | \"f\" | \"c\", number> = { p: 0, f: 0, c: 0 };\n  for (let i = 0; i < floors.length && remain > 0; i++) {\n    addMap[floors[i].key] += 1;\n    remain -= 1;\n  }\n\n  // 元の順に戻して返す\n  const base: Record<\"p\" | \"f\" | \"c\", number> = { p: 0, f: 0, c: 0 };\n  for (const x of raw) {\n    const fnd = floors.find((z) => z.key === x.key)!;\n    base[x.key] = fnd.floor + addMap[x.key];\n  }\n\n  // 念のため最終調整（丸め誤差や極端値対策）\n  const finalSum = base.p + base.f + base.c;\n  if (finalSum !== 100) {\n    // どれかに差分を乗せる（最大のやつに寄せる）\n    const maxKey = ([\"p\", \"f\", \"c\"] as const).reduce((best, k) =>\n      base[k] > base[best] ? k : best\n    , \"p\");\n    base[maxKey] += 100 - finalSum;\n  }\n\n  return base;\n}\n\nfunction fmt1(n: number) {\n  return Math.round(n * 10) / 10;\n}\n\ntype Key = \"p\" | \"f\" | \"c\";\n\nconst LABEL: Record<Key, { short: string; long: string }> = {\n  p: { short: \"P\", long: \"たんぱく質\" },\n  f: { short: \"F\", long: \"脂質\" },\n  c: { short: \"C\", long: \"炭水化物\" },\n};\n\nexport default function PFCBalance({\n  totals,\n  targets, // 今は未使用（残しておく）\n  title = \"PFCバランス\",\n}: {\n  totals: Totals;\n  targets?: Targets | null;\n  title?: string;\n}) {\n  const [active, setActive] = useState<Key | null>(null);\n\n  const data = useMemo(() => {\n    const pG = toNum(totals?.p, 0);\n    const fG = toNum(totals?.f, 0);\n    const cG = toNum(totals?.c, 0);\n\n    const now = kcalFromPFC(pG, fG, cG);\n    const total = now.total;\n\n    if (!Number.isFinite(total) || total <= 0) {\n      return {\n        pG,\n        fG,\n        cG,\n        now,\n        totalK: 0,\n        pctInt: { p: 0, f: 0, c: 0 } as Record<Key, number>,\n        pctFloat: { p: 0, f: 0, c: 0 } as Record<Key, number>,\n      };\n    }\n\n    const pPct = (now.pK / total) * 100;\n    const fPct = (now.fK / total) * 100;\n    const cPct = (now.cK / total) * 100;\n\n    const pctInt = toIntPct100(pPct, fPct, cPct);\n\n    return {\n      pG,\n      fG,\n      cG,\n      now,\n      totalK: Math.round(total),\n      pctInt: pctInt as Record<Key, number>,\n      pctFloat: { p: pPct, f: fPct, c: cPct } as Record<Key, number>,\n    };\n  }, [totals]);\n\n  const totalK = data.totalK;\n\n  const activeDetail = useMemo(() => {\n    if (!active) return null;\n    const g =\n      active === \"p\" ? data.pG : active === \"f\" ? data.fG : data.cG;\n    const k =\n      active === \"p\" ? data.now.pK : active === \"f\" ? data.now.fK : data.now.cK;\n    const pct = data.pctInt[active] ?? 0;\n    return { g, k, pct, key: active };\n  }, [active, data]);\n\n  const setOrToggle = (k: Key) => {\n    setActive((prev) => (prev === k ? null : k));\n  };\n\n  const fade = (k: Key) => {\n    if (!active) return \"opacity-100\";\n    return active === k ? \"opacity-100\" : \"opacity-35\";\n  };\n\n  const isEmpty = totalK <= 0;\n\n  return (\n    <div className=\"rounded-2xl bg-white dark:bg-gray-900 shadow-sm ring-1 ring-gray-200 dark:ring-gray-800 p-4\">\n      {/* Header（最小情報） */}\n      <div className=\"flex items-baseline justify-between gap-3\">\n        <div className=\"text-sm font-semibold text-gray-900 dark:text-white\">\n          {title}\n        </div>\n        <div className=\"text-xs text-gray-500 dark:text-gray-400\">\n          合計: <span className=\"font-bold tabular-nums\">{totalK}</span> kcal（P/F/C換算）\n        </div>\n      </div>\n\n      {/* 0kcal / 未入力 */}\n      {isEmpty ? (\n        <div className=\"mt-4 rounded-xl bg-gray-50 dark:bg-gray-800/60 p-4 text-sm text-gray-600 dark:text-gray-300\">\n          まだ記録がありません（写真で食事を追加するとPFCバランスが表示されます）\n        </div>\n      ) : (\n        <>\n          {/* =========================\n              PC（sm以上）：横バー + グラフ内ラベル\n             ========================= */}\n          <div className=\"hidden sm:block mt-3\">\n            <div className=\"h-10 rounded-xl bg-gray-200 dark:bg-gray-700 overflow-hidden flex\">\n              {/* P */}\n              <button\n                type=\"button\"\n                onClick={() => setOrToggle(\"p\")}\n                className={`h-full bg-emerald-600 flex items-center justify-center px-2 ${fade(\n                  \"p\"\n                )}`}\n                style={{ width: `${data.pctInt.p}%` }}\n                title={`P（たんぱく質） ${data.pctInt.p}%`}\n              >\n                <span className=\"text-white font-semibold text-xs whitespace-nowrap drop-shadow\">\n                  P（たんぱく質） {data.pctInt.p}%\n                </span>\n              </button>\n\n              {/* F */}\n              <button\n                type=\"button\"\n                onClick={() => setOrToggle(\"f\")}\n                className={`h-full bg-orange-500 flex items-center justify-center px-2 ${fade(\n                  \"f\"\n                )}`}\n                style={{ width: `${data.pctInt.f}%` }}\n                title={`F（脂質） ${data.pctInt.f}%`}\n              >\n                <span className=\"text-white font-semibold text-xs whitespace-nowrap drop-shadow\">\n                  F（脂質） {data.pctInt.f}%\n                </span>\n              </button>\n\n              {/* C */}\n              <button\n                type=\"button\"\n                onClick={() => setOrToggle(\"c\")}\n                className={`h-full bg-blue-600 flex items-center justify-center px-2 ${fade(\n                  \"c\"\n                )}`}\n                style={{ width: `${data.pctInt.c}%` }}\n                title={`C（炭水化物） ${data.pctInt.c}%`}\n              >\n                <span className=\"text-white font-semibold text-xs whitespace-nowrap drop-shadow\">\n                  C（炭水化物） {data.pctInt.c}%\n                </span>\n              </button>\n            </div>\n\n            {/* タップ後の1行詳細 */}\n            {activeDetail && (\n              <div className=\"mt-2 text-xs text-gray-600 dark:text-gray-300 tabular-nums\">\n                {LABEL[activeDetail.key].short}（{LABEL[activeDetail.key].long}）：\n                {fmt1(activeDetail.g)}g / {Math.round(activeDetail.k)}kcal（{activeDetail.pct}%）\n              </div>\n            )}\n          </div>\n\n          {/* =========================\n              Mobile（sm未満）：ドーナツ + ピル（線なし）\n             ========================= */}\n          <div className=\"sm:hidden mt-3\">\n            <div className=\"relative rounded-2xl bg-gray-50 dark:bg-gray-800/60 p-3\">\n              <div className=\"relative mx-auto w-[260px] max-w-full\">\n                {/* Donut */}\n                <svg\n                  viewBox=\"0 0 200 200\"\n                  className=\"block mx-auto w-[220px] h-[220px]\"\n                >\n                  {/* 背景リング */}\n                  <circle\n                    cx=\"100\"\n                    cy=\"100\"\n                    r=\"70\"\n                    fill=\"none\"\n                    stroke=\"rgba(156,163,175,0.25)\"\n                    strokeWidth=\"28\"\n                  />\n\n                  {/* Segments */}\n                  {(() => {\n                    const CIRC = 2 * Math.PI * 70;\n\n                    const segs: Array<{\n                      key: Key;\n                      pct: number;\n                      className: string;\n                    }> = [\n                      { key: \"p\", pct: data.pctInt.p, className: \"stroke-emerald-600\" },\n                      { key: \"f\", pct: data.pctInt.f, className: \"stroke-orange-500\" },\n                      { key: \"c\", pct: data.pctInt.c, className: \"stroke-blue-600\" },\n                    ];\n\n                    let offsetPct = 0;\n\n                    return segs.map((s) => {\n                      const dash = (s.pct / 100) * CIRC;\n                      const dashArray = `${dash} ${CIRC - dash}`;\n                      const dashOffset = (offsetPct / 100) * CIRC;\n\n                      offsetPct += s.pct;\n\n                      return (\n                        <circle\n                          key={s.key}\n                          cx=\"100\"\n                          cy=\"100\"\n                          r=\"70\"\n                          fill=\"none\"\n                          strokeWidth=\"28\"\n                          strokeLinecap=\"butt\"\n                          className={`${s.className} ${fade(s.key)}`}\n                          strokeDasharray={dashArray}\n                          strokeDashoffset={-dashOffset}\n                          transform=\"rotate(-90 100 100)\"\n                        />\n                      );\n                    });\n                  })()}\n\n                  {/* 中央テキスト */}\n                  <text\n                    x=\"100\"\n                    y=\"96\"\n                    textAnchor=\"middle\"\n                    className=\"fill-gray-900 dark:fill-white\"\n                    style={{ fontSize: 22, fontWeight: 800 }}\n                  >\n                    {totalK} kcal\n                  </text>\n                  <text\n                    x=\"100\"\n                    y=\"118\"\n                    textAnchor=\"middle\"\n                    className=\"fill-gray-500 dark:fill-gray-300\"\n                    style={{ fontSize: 12, fontWeight: 700 }}\n                  >\n                    （P/F/C換算）\n                  </text>\n                </svg>\n\n                {/* Pills（線なし・被ってOK） */}\n                <button\n                  type=\"button\"\n                  onClick={() => setOrToggle(\"c\")}\n                  className={`absolute left-0 top-2 rounded-2xl bg-white/90 dark:bg-gray-900/80 ring-1 ring-gray-200 dark:ring-gray-700 px-3 py-2 text-left shadow-sm ${active === \"c\" ? \"ring-2 ring-blue-500\" : \"\"}`}\n                >\n                  <div className=\"text-xs font-extrabold text-gray-900 dark:text-white\">\n                    C（炭水化物）\n                  </div>\n                  <div className=\"text-2xl leading-none font-extrabold text-gray-900 dark:text-white tabular-nums\">\n                    {data.pctInt.c}%\n                  </div>\n                </button>\n\n                <button\n                  type=\"button\"\n                  onClick={() => setOrToggle(\"p\")}\n                  className={`absolute right-0 top-6 rounded-2xl bg-white/90 dark:bg-gray-900/80 ring-1 ring-gray-200 dark:ring-gray-700 px-3 py-2 text-left shadow-sm ${active === \"p\" ? \"ring-2 ring-emerald-500\" : \"\"}`}\n                >\n                  <div className=\"text-xs font-extrabold text-gray-900 dark:text-white\">\n                    P（たんぱく質）\n                  </div>\n                  <div className=\"text-2xl leading-none font-extrabold text-gray-900 dark:text-white tabular-nums\">\n                    {data.pctInt.p}%\n                  </div>\n                </button>\n\n                <button\n                  type=\"button\"\n                  onClick={() => setOrToggle(\"f\")}\n                  className={`absolute left-0 bottom-4 rounded-2xl bg-white/90 dark:bg-gray-900/80 ring-1 ring-gray-200 dark:ring-gray-700 px-3 py-2 text-left shadow-sm ${active === \"f\" ? \"ring-2 ring-orange-400\" : \"\"}`}\n                >\n                  <div className=\"text-xs font-extrabold text-gray-900 dark:text-white\">\n                    F（脂質）\n                  </div>\n                  <div className=\"text-2xl leading-none font-extrabold text-gray-900 dark:text-white tabular-nums\">\n                    {data.pctInt.f}%\n                  </div>\n                </button>\n              </div>\n\n              {/* タップ後の1行詳細（スマホはここに） */}\n              {activeDetail && (\n                <div className=\"mt-2 text-xs text-gray-600 dark:text-gray-300 tabular-nums text-center\">\n                  {LABEL[activeDetail.key].short}（{LABEL[activeDetail.key].long}）：\n                  {fmt1(activeDetail.g)}g / {Math.round(activeDetail.k)}kcal（{activeDetail.pct}%）\n                </div>\n              )}\n            </div>\n          </div>\n        </>\n      )}\n    </div>\n  );\n}","// src/components/NutritionSummaryPanel.tsx\nimport React, { useMemo } from \"react\";\nimport PFCBalance from \"./PFCBalance\";\n\ntype Totals = { cal: number; p: number; f: number; c: number };\ntype Targets = { cal: number; p: number; f: number; c: number };\n\ntype Props = {\n  dateLabel?: string;\n  totals: Totals;\n  targets: Targets | null;\n  loading?: boolean;\n\n  // 推定（任意）\n  bmrKcal?: number | null;\n  tdeeKcal?: number | null;\n\n  // CTA（例：写真で記録）\n  onPrimaryAction?: () => void;\n  primaryLabel?: string;\n};\n\nfunction toNum(v: any, fallback = 0) {\n  const n = Number(v);\n  return Number.isFinite(n) ? n : fallback;\n}\nfunction clamp(n: number, min: number, max: number) {\n  return Math.min(max, Math.max(min, n));\n}\nfunction pct(now: number, goal: number) {\n  if (!Number.isFinite(goal) || goal <= 0) return 0;\n  return clamp((now / goal) * 100, 0, 100);\n}\nfunction fmt1(n: number) {\n  return Math.round(n * 10) / 10;\n}\nfunction remain(now: number, goal: number) {\n  if (!Number.isFinite(goal) || goal <= 0) return null;\n  return Math.max(0, goal - now);\n}\n\nfunction ProgressBar({ now, goal }: { now: number; goal: number }) {\n  const w = pct(now, goal);\n  return (\n    <div className=\"mt-2 h-2.5 rounded-full bg-gray-200 dark:bg-gray-700 overflow-hidden\">\n      <div\n        className=\"h-full bg-gray-400 dark:bg-gray-300\"\n        style={{ width: `${w}%` }}\n      />\n    </div>\n  );\n}\n\nfunction MacroCell({\n  label,\n  unit,\n  now,\n  goal,\n}: {\n  label: string;\n  unit: string;\n  now: number;\n  goal: number;\n}) {\n  const r = remain(now, goal);\n  return (\n    <div className=\"rounded-xl bg-gray-50 dark:bg-gray-800/60 px-4 py-3\">\n      <div className=\"flex items-center justify-between\">\n        <div className=\"text-sm font-semibold text-gray-900 dark:text-gray-100\">\n          {label}\n        </div>\n        <div className=\"text-xs font-semibold text-emerald-600 dark:text-emerald-400\">\n          {r != null ? `あと${fmt1(r)}${unit}` : \"\"}\n        </div>\n      </div>\n\n      <div className=\"mt-1.5 flex items-baseline gap-2\">\n        <div className=\"text-2xl font-extrabold tabular-nums text-gray-900 dark:text-white\">\n          {fmt1(now)}\n        </div>\n        <div className=\"text-sm font-bold text-gray-600 dark:text-gray-300 tabular-nums\">\n          / {fmt1(goal)}\n          {unit}\n        </div>\n      </div>\n\n      <ProgressBar now={now} goal={goal} />\n    </div>\n  );\n}\n\nexport default function NutritionSummaryPanel({\n  dateLabel,\n  totals,\n  targets,\n  loading = false,\n  bmrKcal = null,\n  tdeeKcal = null,\n  onPrimaryAction,\n  primaryLabel = \"食事を記録\",\n}: Props) {\n  const t = useMemo(\n    () => ({\n      cal: toNum(totals?.cal, 0),\n      p: toNum(totals?.p, 0),\n      f: toNum(totals?.f, 0),\n      c: toNum(totals?.c, 0),\n    }),\n    [totals]\n  );\n\n  const g = useMemo(() => {\n    if (!targets) return null;\n    return {\n      cal: toNum(targets?.cal, 0),\n      p: toNum(targets?.p, 0),\n      f: toNum(targets?.f, 0),\n      c: toNum(targets?.c, 0),\n    };\n  }, [targets]);\n\n  const calRemain = g ? remain(t.cal, g.cal) : null;\n\n  return (\n    <div className=\"rounded-2xl bg-white dark:bg-gray-900 shadow-sm ring-1 ring-gray-200 dark:ring-gray-800\">\n      {/* ヘッダー */}\n      <div className=\"px-4 sm:px-5 pt-4\">\n        <div className=\"flex items-start justify-between gap-3\">\n          <div>\n            <div className=\"text-sm font-semibold text-gray-900 dark:text-white\">\n              栄養サマリー\n            </div>\n            {dateLabel && (\n              <div className=\"mt-0.5 text-xs text-gray-500 dark:text-gray-400\">\n                {dateLabel}\n              </div>\n            )}\n          </div>\n\n          {/* 右上：推定値（小さく、邪魔しない） */}\n          <div className=\"text-right text-[11px] leading-snug text-gray-500 dark:text-gray-400\">\n            {bmrKcal != null && <div>推定BMR: {Math.round(bmrKcal)}kcal</div>}\n            {tdeeKcal != null && <div>今日必要: {Math.round(tdeeKcal)}kcal</div>}\n          </div>\n        </div>\n      </div>\n\n      {/* 本体 */}\n      <div className=\"px-4 sm:px-5 pb-4 sm:pb-5\">\n        {loading ? (\n          <div className=\"mt-4 text-sm text-gray-500 dark:text-gray-400\">\n            読み込み中…\n          </div>\n        ) : !g ? (\n          <div className=\"mt-4 text-sm text-gray-500 dark:text-gray-400\">\n            目標値の表示には体重データが必要です\n          </div>\n        ) : (\n          <div className=\"mt-4\">\n            {/* カロリー（中央大きく） */}\n            <div className=\"rounded-2xl bg-gray-50 dark:bg-gray-800/60 px-4 py-4\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"text-sm font-semibold text-gray-900 dark:text-gray-100\">\n                  カロリー\n                </div>\n\n                <div className=\"text-xs font-semibold text-emerald-600 dark:text-emerald-400\">\n                  {calRemain != null ? `あと${Math.round(calRemain)}kcal` : \"\"}\n                </div>\n              </div>\n\n              <div className=\"mt-2 flex items-baseline justify-center gap-2\">\n                <div className=\"text-5xl font-extrabold tabular-nums text-gray-900 dark:text-white\">\n                  {Math.round(t.cal)}\n                </div>\n                <div className=\"text-xl font-bold text-gray-600 dark:text-gray-300 tabular-nums\">\n                  / {Math.round(g.cal)}kcal\n                </div>\n              </div>\n\n              <div className=\"mt-3\">\n                <ProgressBar now={t.cal} goal={g.cal} />\n              </div>\n            </div>\n\n            {/* PFC 3列（プレースホルダー削除）*/}\n            <div className=\"mt-3 grid grid-cols-1 md:grid-cols-3 gap-3\">\n            <MacroCell label=\"たんぱく質\" unit=\"g\" now={t.p} goal={g.p} />\n            <MacroCell label=\"脂質\" unit=\"g\" now={t.f} goal={g.f} />\n            <MacroCell label=\"炭水化物\" unit=\"g\" now={t.c} goal={g.c} />\n            </div>\n\n            {/* PFCバランスバー */}\n            <div className=\"gap-3 mt-4\">\n            <PFCBalance totals={{ p: t.p, f: t.f, c: t.c }} targets={g ? { p: g.p, f: g.f, c: g.c } : null} />\n            </div>\n\n            {/* 下部：CTA（カロミルの右下ボタンっぽい） */}\n            {onPrimaryAction && (\n              <div className=\"mt-4 flex justify-end\">\n                <button\n                  type=\"button\"\n                  onClick={onPrimaryAction}\n                  className=\"inline-flex items-center justify-center px-5 py-2.5 rounded-full bg-emerald-600 text-white font-bold text-sm hover:bg-emerald-500 transition\"\n                >\n                  {primaryLabel}\n                </button>\n              </div>\n            )}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}","// src/components/NutritionCard.tsx\nimport React, { useEffect, useMemo, useRef, useState } from \"react\";\nimport { Flame, Camera, Loader2, CheckCircle2, Lightbulb } from \"lucide-react\";\nimport { buildDailyTargets, calcGaps } from \"../lib/nutritionCalc\";\nimport { supabase } from \"../lib/supabase\";\nimport NutritionEditModal, { type NutritionLog } from \"./NutritionEditModal\";\nimport NutritionOverview from \"./NutritionOverview\";\nimport NutritionSummaryPanel from \"./NutritionSummaryPanel\";\n\ntype MealType = \"朝食\" | \"昼食\" | \"夕食\" | \"補食\";\ntype MacroTotals = { cal: number; p: number; f: number; c: number };\n\ntype Props = {\n  user: any;\n  latestInbody?: any;\n  latestWeightKg?: number | null;\n  date?: any;\n  trainingRecords?: any[];\n\n  badgeText?: string;\n\n  nutritionLogs?: NutritionLog[];\n  nutritionTotals?: MacroTotals; // 親が返してくる合計（あってもOK / なくてもOK）\n  nutritionLoading?: boolean;\n  nutritionError?: string | null;\n\n  onSaved?: (updated?: NutritionLog | null) => void;\n};\n\nfunction toNum(v: any, fallback = 0) {\n  const n = Number(v);\n  return Number.isFinite(n) ? n : fallback;\n}\nfunction clamp(n: number, min: number, max: number) {\n  return Math.min(max, Math.max(min, n));\n}\nfunction formatMealLabel(mealType: string, mealSlot: any) {\n  if (mealType === \"補食\") return `補食${Number(mealSlot ?? 1)}`;\n  return mealType;\n}\nfunction normalizeSex(gender: any) {\n  if (!gender) return null;\n  if (gender === \"male\") return \"male\";\n  if (gender === \"female\") return \"female\";\n  return null;\n}\nfunction calcAge(dateOfBirth: any) {\n  if (!dateOfBirth) return null;\n  const d = new Date(dateOfBirth);\n  if (Number.isNaN(d.getTime())) return null;\n  const now = new Date();\n  let age = now.getFullYear() - d.getFullYear();\n  const m = now.getMonth() - d.getMonth();\n  if (m < 0 || (m === 0 && now.getDate() < d.getDate())) age -= 1;\n  return age >= 0 ? age : null;\n}\n\n/** DB制約に合わせて meal_slot を正規化（朝昼夕=1、補食=1/2） */\nfunction normalizeMealSlot(type: MealType, slot: number) {\n  if (type === \"補食\") return clamp(toNum(slot, 1), 1, 2);\n  return 1;\n}\n\n/** File -> base64(payload only) */\nasync function fileToBase64(file: File): Promise<string> {\n  return new Promise((resolve, reject) => {\n    const reader = new FileReader();\n    reader.onload = () => {\n      const res = reader.result as string;\n      resolve(res.split(\",\")[1] ?? \"\");\n    };\n    reader.onerror = reject;\n    reader.readAsDataURL(file);\n  });\n}\n\n/** Tokyo日付 yyyy-mm-dd に寄せる */\nfunction toTokyoDateString(anyDate: any) {\n  if (!anyDate) return null;\n  if (typeof anyDate === \"string\" && /^\\d{4}-\\d{2}-\\d{2}$/.test(anyDate)) return anyDate;\n  const d = new Date(anyDate);\n  if (Number.isNaN(d.getTime())) return null;\n  const parts = d.toLocaleDateString(\"ja-JP\", { timeZone: \"Asia/Tokyo\" }).split(\"/\");\n  return `${parts[0]}-${String(parts[1]).padStart(2, \"0\")}-${String(parts[2]).padStart(2, \"0\")}`;\n}\n\n/**\n * nutrition-gemini の返却を厳格にパース（必須キーが揃わない場合は throw）\n */\nfunction parseGeminiResultStrict(json: any) {\n  const r = json?.result ?? json?.data ?? json ?? {};\n\n  const calories = r?.calories ?? r?.total_calories ?? r?.kcal;\n  const protein = r?.protein ?? r?.p;\n  const fat = r?.fat ?? r?.f;\n  const carbs = r?.carbs ?? r?.c;\n\n  const calsN = Number(calories);\n  const pN = Number(protein);\n  const fN = Number(fat);\n  const cN = Number(carbs);\n\n  const ok =\n    Number.isFinite(calsN) &&\n    calsN >= 0 &&\n    Number.isFinite(pN) &&\n    pN >= 0 &&\n    Number.isFinite(fN) &&\n    fN >= 0 &&\n    Number.isFinite(cN) &&\n    cN >= 0;\n\n  if (!ok) {\n    const msg = r?.error ?? r?.message ?? \"Gemini返却に必須値（calories/protein/fat/carbs）が見つかりません\";\n    const detail = JSON.stringify({ calories, protein, fat, carbs, keys: Object.keys(r ?? {}) }, null, 2);\n    throw new Error(`${msg}\\n${detail}`);\n  }\n\n  const menuItems = r?.menu_items ?? r?.menuItems ?? [];\n  const comment = r?.comment ?? r?.advice_markdown ?? r?.advice ?? null;\n\n  return {\n    total_calories: Math.round(calsN),\n    p: toNum(pN, 0),\n    f: toNum(fN, 0),\n    c: toNum(cN, 0),\n    menu_items: Array.isArray(menuItems) ? menuItems : [],\n    advice_markdown: comment != null ? String(comment) : null,\n    raw: json,\n  };\n}\n\nfunction isDuplicateMealError(err: any) {\n  const code = err?.code ?? err?.details?.code;\n  const msg = String(err?.message ?? \"\");\n  const detail = String(err?.details ?? \"\");\n  const hint = String(err?.hint ?? \"\");\n  return (\n    code === \"23505\" ||\n    msg.includes(\"nutrition_logs_user_date_meal_slot_unique\") ||\n    detail.includes(\"nutrition_logs_user_date_meal_slot_unique\") ||\n    hint.includes(\"nutrition_logs_user_date_meal_slot_unique\")\n  );\n}\nfunction duplicateMealMessage(mealType: MealType, mealSlot: number) {\n  const label = mealType === \"補食\" ? `補食${mealSlot}` : mealType;\n  return `すでに「${label}」は記録済みです。新規追加はできません。\\n「今日の記録」から開いて編集してください。`;\n}\n\n/** 今日の結論カード用：不足量（remain>0 = 足りない） */\ntype DeficitRow = {\n  key: \"cal\" | \"p\" | \"f\" | \"c\";\n  label: string;\n  unit: string;\n  now: number;\n  goal: number;\n  remain: number; // goal - now\n};\n\nfunction buildDeficits(totals: MacroTotals, targets: any | null): DeficitRow[] | null {\n  if (!targets) return null;\n\n  const calNow = toNum(totals?.cal, 0);\n  const pNow = toNum(totals?.p, 0);\n  const fNow = toNum(totals?.f, 0);\n  const cNow = toNum(totals?.c, 0);\n\n  const rows: DeficitRow[] = [\n    {\n      key: \"cal\",\n      label: \"エネルギー\",\n      unit: \"kcal\",\n      now: Math.round(calNow),\n      goal: Math.round(toNum(targets?.cal, 0)),\n      remain: Math.round(toNum(targets?.cal, 0)) - Math.round(calNow),\n    },\n    {\n      key: \"p\",\n      label: \"たんぱく質\",\n      unit: \"g\",\n      now: Math.round(pNow * 10) / 10,\n      goal: Math.round(toNum(targets?.p, 0) * 10) / 10,\n      remain: Math.round((toNum(targets?.p, 0) - pNow) * 10) / 10,\n    },\n    {\n      key: \"f\",\n      label: \"脂質\",\n      unit: \"g\",\n      now: Math.round(fNow * 10) / 10,\n      goal: Math.round(toNum(targets?.f, 0) * 10) / 10,\n      remain: Math.round((toNum(targets?.f, 0) - fNow) * 10) / 10,\n    },\n    {\n      key: \"c\",\n      label: \"炭水化物\",\n      unit: \"g\",\n      now: Math.round(cNow * 10) / 10,\n      goal: Math.round(toNum(targets?.c, 0) * 10) / 10,\n      remain: Math.round((toNum(targets?.c, 0) - cNow) * 10) / 10,\n    },\n  ];\n\n  return rows;\n}\n\n/** “次の一手”は断言しない。候補を3つだけ出す（ローカルルール） */\nfunction buildQuickSuggestions(deficits: DeficitRow[] | null) {\n  if (!deficits) return [];\n\n  const byKey = Object.fromEntries(deficits.map((d) => [d.key, d])) as Record<string, DeficitRow>;\n  const pNeed = Math.max(0, toNum(byKey.p?.remain, 0));\n  const cNeed = Math.max(0, toNum(byKey.c?.remain, 0));\n  const fNeed = Math.max(0, toNum(byKey.f?.remain, 0));\n  const calNeed = Math.max(0, toNum(byKey.cal?.remain, 0));\n\n  const primary =\n    pNeed >= 15 ? \"p\" :\n    cNeed >= 40 ? \"c\" :\n    fNeed >= 10 ? \"f\" :\n    calNeed >= 300 ? \"cal\" :\n    pNeed > 0 || cNeed > 0 || fNeed > 0 || calNeed > 0 ? \"mix\" :\n    \"ok\";\n\n  const pcCombo = pNeed >= 15 && cNeed >= 40;\n\n  if (primary === \"ok\") {\n    return [\n      \"今日はだいたいOK。水分・野菜・睡眠を整える\",\n      \"補食を入れるなら：ヨーグルト or 果物\",\n      \"明日に備えて：夕食で主食・主菜を欠かさない\",\n    ];\n  }\n\n  if (pcCombo) {\n    return [\n      \"ご飯（中）＋鶏むね/ささみ（目安）\",\n      \"おにぎり2個＋ツナ/サバ缶（半分〜1缶）\",\n      \"うどん＋卵/納豆（タンパク質を足す）\",\n    ];\n  }\n\n  if (primary === \"p\") {\n    return [\n      \"鶏むね・ささみ（目安）／脂質を抑えてPを足す\",\n      \"卵＋納豆（手軽にPを積む）\",\n      \"プロテイン1杯＋ヨーグルト（補食で埋める）\",\n    ];\n  }\n\n  if (primary === \"c\") {\n    return [\n      \"おにぎり2個（まず主食で埋める）\",\n      \"ご飯＋汁物（消化しやすく）\",\n      \"バナナ＋ヨーグルト（補食でCを足す）\",\n    ];\n  }\n\n  if (primary === \"f\") {\n    return [\n      \"ナッツひと握り（20g目安）\",\n      \"オリーブオイルを料理に小さじ1〜2追加\",\n      \"サバ缶（脂質もPも足せる）\",\n    ];\n  }\n\n  return [\n    \"主食＋主菜＋果物（まず“セット”で増やす）\",\n    \"補食：おにぎり＋乳製品（簡単に底上げ）\",\n    \"夕食：丼もの/定食スタイルで“量”を確保\",\n  ];\n}\n\n/** menu_items は jsonb/配列/文字列(JSON) があり得るので正規化 */\nfunction normalizeMenuItems(raw: any): any[] {\n  if (!raw) return [];\n  if (Array.isArray(raw)) return raw;\n\n  if (typeof raw === \"string\") {\n    try {\n      const parsed = JSON.parse(raw);\n      return Array.isArray(parsed) ? parsed : [];\n    } catch {\n      return [];\n    }\n  }\n\n  if (typeof raw === \"object\") {\n    const vals = Object.values(raw);\n    return Array.isArray(vals) ? vals : [];\n  }\n\n  return [];\n}\nfunction formatMenuItem(x: any) {\n  if (!x) return \"\";\n  if (typeof x === \"string\") return x;\n\n  const name = x?.name ?? \"\";\n  const note = x?.note ? `(${x.note})` : \"\";\n  const amt = x?.estimated_amount ? ` ${x.estimated_amount}` : \"\";\n  const s = `${name}${note}${amt}`.trim();\n  return s || \"\";\n}\n\nexport function NutritionCard({\n  user,\n  latestInbody,\n  latestWeightKg,\n  date,\n  trainingRecords,\n\n  badgeText = \"栄養(β)\",\n\n  nutritionLogs = [],\n  nutritionTotals = { cal: 0, p: 0, f: 0, c: 0 },\n  nutritionLoading = false,\n  nutritionError = null,\n\n  onSaved,\n}: Props) {\n  const fileRef = useRef<HTMLInputElement | null>(null);\n\n  const [uploading, setUploading] = useState(false);\n  const [uploadErr, setUploadErr] = useState<string | null>(null);\n  const [successMsg, setSuccessMsg] = useState<string | null>(null);\n\n  const [mealType, setMealType] = useState<MealType>(\"朝食\");\n  const [mealSlot, setMealSlot] = useState<number>(1);\n\n  const recordDate =\n    toTokyoDateString(date) ?? toTokyoDateString(new Date()) ?? new Date().toISOString().slice(0, 10);\n\n  // ✅ 表示を即更新するためのローカル状態（propsと同期）\n  const [localLogs, setLocalLogs] = useState<NutritionLog[]>(Array.isArray(nutritionLogs) ? nutritionLogs : []);\n\n  useEffect(() => {\n    setLocalLogs(Array.isArray(nutritionLogs) ? nutritionLogs : []);\n  }, [nutritionLogs]);\n\n  // ✅ 合計は「localLogsから常に再集計」＝編集/削除でズレない\n  const displayTotals: MacroTotals = useMemo(() => {\n    const sum = (Array.isArray(localLogs) ? localLogs : []).reduce(\n      (acc, l: any) => {\n        acc.cal += toNum(l?.total_calories, 0);\n        acc.p += toNum(l?.p, 0);\n        acc.f += toNum(l?.f, 0);\n        acc.c += toNum(l?.c, 0);\n        return acc;\n      },\n      { cal: 0, p: 0, f: 0, c: 0 }\n    );\n\n    // 初回ロード中に localLogs が空でも、親が totals を持ってる場合はそれを優先表示して“0チラつき”を回避\n    const canUsePropsTotals =\n      nutritionLoading && (!Array.isArray(localLogs) || localLogs.length === 0) && nutritionTotals;\n\n    return canUsePropsTotals\n      ? {\n          cal: toNum((nutritionTotals as any).cal, 0),\n          p: toNum((nutritionTotals as any).p, 0),\n          f: toNum((nutritionTotals as any).f, 0),\n          c: toNum((nutritionTotals as any).c, 0),\n        }\n      : sum;\n  }, [localLogs, nutritionLoading, nutritionTotals]);\n\n  // ✅ 編集モーダル\n  const [editOpen, setEditOpen] = useState(false);\n  const [selectedLog, setSelectedLog] = useState<NutritionLog | null>(null);\n\n  async function callNutritionGeminiViaInvoke(payload: any) {\n    const { data, error } = await supabase.functions.invoke(\"nutrition-gemini\", { body: payload });\n    if (error) {\n      const msg = (error as any)?.message ?? JSON.stringify(error);\n      throw new Error(msg || \"nutrition-gemini invoke error\");\n    }\n    return data;\n  }\n\n  // 体重（InBody優先 → 体重記録latestWeightKg → user.profile）\n  const targetsAndRefs = useMemo(() => {\n    const weightFromUser = toNum(user?.weight_kg, NaN);\n    const weightFromInbody = toNum(latestInbody?.weight ?? latestInbody?.weight_kg, NaN);\n    const weightFromLatest = toNum(latestWeightKg, NaN);\n\n    const weightKg = Number.isFinite(weightFromInbody)\n      ? weightFromInbody\n      : Number.isFinite(weightFromLatest)\n      ? weightFromLatest\n      : Number.isFinite(weightFromUser)\n      ? weightFromUser\n      : NaN;\n\n    const heightCm = toNum(user?.height_cm, NaN);\n    const age = calcAge(user?.date_of_birth);\n    const sex = normalizeSex(user?.gender);\n\n    const bodyFatPercent = toNum(\n      latestInbody?.body_fat_percent ?? latestInbody?.body_fat_perc ?? latestInbody?.body_fat_percent,\n      NaN\n    );\n\n    if (!Number.isFinite(weightKg) || weightKg <= 0) {\n      return {\n        weightKg: null as number | null,\n        targets: null as any,\n        refs: null as any,\n      };\n    }\n\n    const res = buildDailyTargets({\n      weightKg,\n      bodyFatPercent: Number.isFinite(bodyFatPercent) ? bodyFatPercent : null,\n      heightCm: Number.isFinite(heightCm) ? heightCm : null,\n      age: Number.isFinite(Number(age)) ? Number(age) : null,\n      sex: sex ?? null,\n      activityLevel: \"moderate\",\n      goalType: \"maintain\",\n    });\n\n    return {\n      weightKg,\n      targets: res?.target ?? null,\n      refs: {\n        ffmKg: res?.ffmKg ?? null,\n        bmrKcal: res?.bmrKcal ?? null,\n        tdeeKcal: res?.tdeeKcal ?? null,\n      },\n    };\n  }, [user, latestInbody, latestWeightKg]);\n\n  const targets = targetsAndRefs.targets;\n  const refs = targetsAndRefs.refs;\n\n  // ✅ 結論カード（不足ランキング + 次の一手）\n  const deficits = useMemo(() => buildDeficits(displayTotals, targets), [displayTotals, targets]);\n\n  const shortageRanking = useMemo(() => {\n    if (!deficits) return null;\n    const shorts = deficits.filter((d) => d.remain > 0 && Number.isFinite(d.remain));\n    shorts.sort((a, b) => b.remain - a.remain);\n    return shorts;\n  }, [deficits]);\n\n  const quickSuggestions = useMemo(() => buildQuickSuggestions(deficits), [deficits]);\n\n  const gaps = useMemo(() => {\n    if (!targets) return null;\n    return calcGaps({\n      today: {\n        cal: toNum(displayTotals?.cal, 0),\n        p: toNum(displayTotals?.p, 0),\n        f: toNum(displayTotals?.f, 0),\n        c: toNum(displayTotals?.c, 0),\n      },\n      target: targets,\n    });\n  }, [displayTotals, targets]);\n\n  const handleSelectPhoto = async (file: File | null) => {\n    if (!file) return;\n\n    const safeSlot = normalizeMealSlot(mealType, mealSlot);\n    const exists = (Array.isArray(localLogs) ? localLogs : []).some(\n      (l: any) =>\n        String(l?.record_date) === String(recordDate) &&\n        l?.meal_type === mealType &&\n        Number(l?.meal_slot) === Number(safeSlot)\n    );\n    if (exists) {\n      setUploadErr(duplicateMealMessage(mealType, safeSlot));\n      if (fileRef.current) fileRef.current.value = \"\";\n      return;\n    }\n\n    setUploading(true);\n    setUploadErr(null);\n    setSuccessMsg(null);\n\n    let insertedId: string | null = null;\n\n    try {\n      const userId = user?.id;\n      if (!userId) throw new Error(\"user.id が取れません\");\n\n      // 1) Storage upload\n      const ext = (file.name.split(\".\").pop() || \"jpg\").toLowerCase();\n      const uuid = crypto.randomUUID();\n      const path = `nutrition/${userId}/${recordDate}/${uuid}.${ext}`;\n\n      const { error: upErr } = await supabase.storage\n        .from(\"nutrition-images\")\n        .upload(path, file, { upsert: false, contentType: file.type || \"image/jpeg\" });\n      if (upErr) throw upErr;\n\n      const { data: pub } = supabase.storage.from(\"nutrition-images\").getPublicUrl(path);\n      const imageUrl = pub?.publicUrl ?? null;\n\n      // 2) INSERT（pending）\n      const { data: inserted, error: insErr } = await supabase\n        .from(\"nutrition_logs\")\n        .insert({\n          user_id: userId,\n          record_date: recordDate,\n          meal_type: mealType,\n          meal_slot: safeSlot,\n          image_path: path,\n          image_url: imageUrl,\n          image_meta: { original_name: file.name, size: file.size, type: file.type },\n          analysis_status: \"pending\",\n          analysis_error: null,\n        })\n        .select(\"*\")\n        .single();\n\n      if (insErr) {\n        if (isDuplicateMealError(insErr)) throw new Error(duplicateMealMessage(mealType, safeSlot));\n        throw insErr;\n      }\n\n      insertedId = inserted?.id ?? null;\n\n      // 3) analyze\n      const base64 = await fileToBase64(file);\n      const context = `meal_type=${mealType}${mealType === \"補食\" ? ` slot=${safeSlot}` : \"\"}`;\n\n      const geminiJson = await callNutritionGeminiViaInvoke({\n        type: \"analyze_meal\",\n        imageBase64: base64,\n        context,\n      });\n\n      const parsed = parseGeminiResultStrict(geminiJson);\n      const meta = geminiJson?.meta ?? null;\n\n      // 4) UPDATE success\n      const { data: updated, error: updErr } = await supabase\n        .from(\"nutrition_logs\")\n        .update({\n          total_calories: parsed.total_calories,\n          p: parsed.p,\n          f: parsed.f,\n          c: parsed.c,\n          menu_items: parsed.menu_items,\n          advice_markdown: parsed.advice_markdown,\n\n          analysis_status: \"success\",\n          analysis_error: null,\n\n          analysis_meta: meta ?? {},\n          analysis_model: meta?.used_model ?? null,\n          analysis_reason: meta?.reason ?? null,\n        })\n        .eq(\"id\", inserted.id)\n        .select(\"*\")\n        .single();\n\n      if (updErr) throw updErr;\n\n      // 5) UI即更新（合計は useMemo で再計算される）\n      setLocalLogs((prev) =>\n        [...(Array.isArray(prev) ? prev : []), updated].sort((a: any, b: any) => {\n          const at = new Date(a?.created_at ?? 0).getTime();\n          const bt = new Date(b?.created_at ?? 0).getTime();\n          return at - bt;\n        })\n      );\n\n      setSuccessMsg(\"記録完了\");\n      if (typeof onSaved === \"function\") onSaved(updated as NutritionLog);\n    } catch (e: any) {\n      console.error(\"[NutritionCard] photo/analyze error:\", e);\n      const msg = String(e?.message ?? e);\n      setUploadErr(msg);\n\n      // ✅ pending 作った場合は failed 記録\n      if (insertedId != null) {\n        try {\n          await supabase\n            .from(\"nutrition_logs\")\n            .update({ analysis_status: \"failed\", analysis_error: msg.slice(0, 2000) })\n            .eq(\"id\", insertedId);\n        } catch (markErr) {\n          console.error(\"[NutritionCard] failed status update error:\", markErr);\n        }\n      }\n    } finally {\n      setUploading(false);\n      if (fileRef.current) fileRef.current.value = \"\";\n    }\n  };\n\n  return (\n    <div className=\"bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 sm:p-6 transition-colors\">\n      {/* header */}\n      <div className=\"flex items-start justify-between gap-3\">\n        <div>\n          <div className=\"flex items-center gap-2\">\n            <div className=\"inline-flex items-center gap-1 px-2 py-1 rounded-full bg-orange-50 dark:bg-orange-900/20 text-orange-700 dark:text-orange-300 text-xs font-medium\">\n              <Flame className=\"w-3.5 h-3.5\" />\n              {badgeText}\n            </div>\n            <span className=\"text-xs text-gray-500 dark:text-gray-400\">{recordDate}</span>\n          </div>\n\n          <h3 className=\"mt-2 text-base sm:text-lg font-semibold text-gray-900 dark:text-white\">栄養</h3>\n\n          <div className=\"mt-1 text-[11px] text-gray-500 dark:text-gray-400 space-x-3\">\n            {refs?.bmrKcal != null && <span>推定基礎代謝量: {refs.bmrKcal} kcal</span>}\n            {refs?.tdeeKcal != null && <span>今日必要なカロリー(推定TDEE): {refs.tdeeKcal} kcal</span>}\n          </div>\n\n          {targets && (\n            <div className=\"mt-1 text-[11px] text-gray-500 dark:text-gray-400\">\n              目標: {targets.cal} kcal / P {targets.p} g / F {targets.f} g / C {targets.c} g\n            </div>\n          )}\n        </div>\n\n        {/* photo uploader */}\n        <div className=\"flex items-center gap-2\">\n          <select\n            value={mealType}\n            onChange={(e) => {\n              const v = e.target.value as MealType;\n              setMealType(v);\n              if (v !== \"補食\") setMealSlot(1);\n            }}\n            className=\"px-2 py-1.5 text-xs border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200\"\n            disabled={uploading}\n          >\n            <option value=\"朝食\">朝食</option>\n            <option value=\"昼食\">昼食</option>\n            <option value=\"夕食\">夕食</option>\n            <option value=\"補食\">補食</option>\n          </select>\n\n          {mealType === \"補食\" && (\n            <select\n              value={mealSlot}\n              onChange={(e) => setMealSlot(Number(e.target.value))}\n              className=\"px-2 py-1.5 text-xs border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200\"\n              disabled={uploading}\n            >\n              <option value={1}>補食1</option>\n              <option value={2}>補食2</option>\n            </select>\n          )}\n\n          <button\n            type=\"button\"\n            onClick={() => fileRef.current?.click()}\n            disabled={uploading}\n            className=\"inline-flex items-center gap-1 px-3 py-2 text-sm rounded-lg bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-60\"\n            title=\"写真を選択\"\n          >\n            {uploading ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <Camera className=\"w-4 h-4\" />}\n            写真\n          </button>\n\n          <input\n            ref={fileRef}\n            type=\"file\"\n            accept=\"image/*\"\n            className=\"absolute -left-[9999px] top-0 w-px h-px opacity-0\"\n            onChange={(e) => handleSelectPhoto(e.target.files?.[0] ?? null)}\n          />\n        </div>\n      </div>\n\n      {/* success */}\n      {successMsg && (\n        <div className=\"mt-3 bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800 rounded-lg p-3 flex items-center gap-2\">\n          <CheckCircle2 className=\"w-4 h-4 text-emerald-600 dark:text-emerald-300\" />\n          <p className=\"text-sm text-emerald-700 dark:text-emerald-200\">{successMsg}</p>\n        </div>\n      )}\n\n      {/* errors */}\n      {uploadErr && (\n        <div className=\"mt-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-3\">\n          <p className=\"text-sm text-red-700 dark:text-red-300 whitespace-pre-wrap\">写真/解析に失敗しました：{uploadErr}</p>\n        </div>\n      )}\n      {nutritionError && (\n        <div className=\"mt-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-3\">\n          <p className=\"text-sm text-red-700 dark:text-red-300\">栄養ログの取得に失敗しました：{nutritionError}</p>\n        </div>\n      )}\n\n      {/* ✅ 今日の結論カード（不足ランキング + 次の一手） */}\n      <div className=\"mt-4 rounded-xl border border-gray-200 dark:border-gray-700 bg-slate-50 dark:bg-slate-900/20 p-4\">\n        <div className=\"flex items-start justify-between gap-3\">\n          <div className=\"flex items-center gap-2\">\n            <Lightbulb className=\"w-4 h-4 text-slate-700 dark:text-slate-200\" />\n            <p className=\"text-sm font-semibold text-slate-800 dark:text-slate-100\">今日の結論</p>\n          </div>\n          <span className=\"text-[11px] text-slate-500 dark:text-slate-400\">※ 目安です</span>\n        </div>\n\n        {!targets ? (\n          <div className=\"mt-2 text-sm text-slate-600 dark:text-slate-300\">\n            体重データがあると、推定目標（BMR/TDEE/PFC）が出せます。\n          </div>\n        ) : nutritionLoading ? (\n          <div className=\"mt-2 text-sm text-slate-600 dark:text-slate-300\">集計中…</div>\n        ) : (\n          <div className=\"mt-3 space-y-3\">\n            {/* 不足ランキング */}\n            <div>\n              <p className=\"text-xs font-medium text-slate-700 dark:text-slate-200\">不足（優先度）</p>\n              {shortageRanking && shortageRanking.length > 0 ? (\n                <div className=\"mt-1 space-y-1\">\n                  {shortageRanking.slice(0, 2).map((d) => (\n                    <div key={d.key} className=\"text-sm text-slate-800 dark:text-slate-100\">\n                      <span className=\"font-semibold\">{d.label}</span>\n                      <span className=\"ml-2 text-slate-600 dark:text-slate-300\">\n                        あと <b>{d.remain}</b> {d.unit}\n                      </span>\n                    </div>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"mt-1 text-sm text-slate-700 dark:text-slate-200\">\n                  目標はだいたい到達（超過が気になる場合は脂質/間食を見直し）\n                </div>\n              )}\n\n              {gaps && (\n                <div className=\"mt-2 text-[11px] text-slate-600 dark:text-slate-300\">\n                  残り目安：P {toNum((gaps as any).p, 0).toFixed(1)} g / F {toNum((gaps as any).f, 0).toFixed(1)} g / C{\" \"}\n                  {toNum((gaps as any).c, 0).toFixed(1)} g / kcal {Math.round(toNum((gaps as any).cal, 0))}\n                </div>\n              )}\n            </div>\n\n            {/* 次の一手 */}\n            <div>\n              <p className=\"text-xs font-medium text-slate-700 dark:text-slate-200\">次の一手（候補）</p>\n              <ul className=\"mt-1 list-disc pl-5 space-y-1 text-sm text-slate-800 dark:text-slate-100\">\n                {quickSuggestions.slice(0, 3).map((s, i) => (\n                  <li key={i}>{s}</li>\n                ))}\n              </ul>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {/* Summary Panel（既存コンポーネント） */}\n      <div className=\"mt-4\">\n        <NutritionSummaryPanel\n          dateLabel={recordDate}\n          totals={displayTotals}\n          targets={targets}\n          loading={nutritionLoading}\n          bmrKcal={refs?.bmrKcal ?? null}\n          tdeeKcal={refs?.tdeeKcal ?? null}\n          onPrimaryAction={() => fileRef.current?.click()}\n          primaryLabel=\"食事を記録\"\n        />\n      </div>\n\n      {/* logs */}\n      <div className=\"mt-5\">\n        <p className=\"text-sm font-medium text-gray-900 dark:text-white\">今日の記録</p>\n\n        {nutritionLoading ? (\n          <div className=\"mt-2 text-sm text-gray-500 dark:text-gray-400\">読み込み中...</div>\n        ) : !Array.isArray(localLogs) || localLogs.length === 0 ? (\n          <div className=\"mt-2 text-sm text-gray-500 dark:text-gray-400\">\n            まだ栄養記録がありません（朝/昼/夕/補食を追加していこう）\n          </div>\n        ) : (\n          <div className=\"mt-2 space-y-2\">\n            {localLogs.map((log: any) => {\n              const menuItems = normalizeMenuItems(log?.menu_items);\n              const menuText = menuItems.map((x: any) => formatMenuItem(x)).filter(Boolean).join(\" / \");\n\n              return (\n                <div key={log.id} className=\"rounded-lg border border-gray-200 dark:border-gray-700 p-3\">\n                  <div className=\"flex items-start justify-between gap-3\">\n                    {/* 左：サムネ + テキスト */}\n                    <div className=\"flex items-start gap-3 min-w-0\">\n                      {log.image_url ? (\n                        // eslint-disable-next-line @next/next/no-img-element\n                        <img\n                          src={log.image_url}\n                          alt=\"meal\"\n                          className=\"w-14 h-14 rounded-lg object-cover border border-gray-200 dark:border-gray-700 flex-none\"\n                          loading=\"lazy\"\n                          decoding=\"async\"\n                        />\n                      ) : (\n                        <div className=\"w-14 h-14 rounded-lg bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 flex-none\" />\n                      )}\n\n                      <div className=\"min-w-0\">\n                        <p className=\"text-sm font-semibold text-gray-900 dark:text-white\">\n                          {formatMealLabel(log.meal_type, log.meal_slot)}\n                          <span className=\"ml-2 text-xs text-gray-500 dark:text-gray-400\">\n                            {toNum(log.total_calories, 0)} kcal\n                          </span>\n                          {log.analysis_status && (\n                            <span className=\"ml-2 text-[10px] px-1.5 py-0.5 rounded bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300\">\n                              {String(log.analysis_status)}\n                            </span>\n                          )}\n                        </p>\n\n                        <p className=\"text-xs text-gray-600 dark:text-gray-400\">\n                          P {toNum(log.p, 0).toFixed(1)} / F {toNum(log.f, 0).toFixed(1)} / C {toNum(log.c, 0).toFixed(1)}\n                          {log.is_edited ? \"（編集済）\" : \"\"}\n                        </p>\n\n                        {/* ✅ 推定メニュー（ここが今回の修正点） */}\n                        {menuText && (\n                          <p className=\"mt-1 text-[11px] text-gray-500 dark:text-gray-400 break-words\">\n                            推定メニュー: {menuText}\n                          </p>\n                        )}\n\n                        {/* ✅ AIアドバイス（必要なら表示） */}\n                        {log.advice_markdown && (\n                          <p className=\"mt-1 text-[11px] text-gray-500 dark:text-gray-400 whitespace-pre-wrap\">\n                            {String(log.advice_markdown)}\n                          </p>\n                        )}\n\n                        {log.analysis_status === \"failed\" && log.analysis_error && (\n                          <p className=\"mt-1 text-[11px] text-red-600 dark:text-red-400 whitespace-pre-wrap\">\n                            解析失敗: {String(log.analysis_error)}\n                          </p>\n                        )}\n                      </div>\n                    </div>\n\n                    {/* 右：詳細ボタン */}\n                    <button\n                      type=\"button\"\n                      className=\"text-sm text-blue-600 dark:text-blue-400 hover:underline\"\n                      onClick={() => {\n                        setSelectedLog(log as NutritionLog);\n                        setEditOpen(true);\n                      }}\n                    >\n                      詳細\n                    </button>\n                  </div>\n                </div>\n              );\n            })}\n          </div>\n        )}\n      </div>\n\n      {/* ✅ Edit Modal */}\n      {editOpen && selectedLog && (\n        <NutritionEditModal\n          open={editOpen}\n          log={selectedLog}\n          onClose={() => {\n            setEditOpen(false);\n            setSelectedLog(null);\n          }}\n          onSaved={(updated) => {\n            setLocalLogs((prev) => (Array.isArray(prev) ? prev.map((x: any) => (x.id === updated.id ? updated : x)) : []));\n            setEditOpen(false);\n            setSelectedLog(null);\n            if (typeof onSaved === \"function\") onSaved(updated);\n          }}\n          onDeleted={(deletedId) => {\n            setLocalLogs((prev) => (Array.isArray(prev) ? prev.filter((x: any) => x?.id !== deletedId) : []));\n            setEditOpen(false);\n            setSelectedLog(null);\n            if (typeof onSaved === \"function\") onSaved(null);\n          }}\n        />\n      )}\n\n      {/* 既存コンポーネント（使ってるなら残す：未使用なら消してOK） */}\n      {/* <NutritionOverview /> */}\n    </div>\n  );\n}\n\nexport default NutritionCard;","// src/components/views/AthleteNutritionDashboardView.tsx\nimport React, { useMemo } from \"react\";\nimport type { Database } from \"../../lib/database.types\";\nimport { ArrowLeft, Flame } from \"lucide-react\";\nimport NutritionCard from \"../NutritionCard\";\n\ntype UserProfile = Database[\"public\"][\"Tables\"][\"users\"][\"Row\"];\n\ntype Props = {\n  user: UserProfile;\n  date: string;\n\n  // 親（ページ側）で取得済みのデータ\n  nutritionLogs: any[];\n  nutritionTotals: any | null;\n  nutritionLoading: boolean;\n  nutritionError: string | null;\n\n  // 戻る\n  onBackHome: () => void;\n\n  // （任意）InBody/練習データがあるなら渡す（無ければ null/[] でOK）\n  latestInbody?: any | null;\n  trainingRecords?: any[] | null;\n  latestWeightKg?: number | null; // ✅追加\n\n  // （任意）保存後に親側で再fetchしたい時に渡す\n  onRefreshNutrition?: () => void;\n};\n\nexport default function AthleteNutritionDashboardView({\n  user,\n  date,\n  nutritionLogs,\n  nutritionTotals,\n  nutritionLoading,\n  nutritionError,\n  onBackHome,\n  latestInbody = null,\n  trainingRecords = [],\n  latestWeightKg = null,\n  onRefreshNutrition,\n}: Props) {\n  // 「進捗」だけはダッシュボードらしく残す（思想：評価しない / 見える化だけ）\n  const completedCount = useMemo(() => {\n    const confirmed =\n      nutritionLogs?.filter(\n        (l) => l?.status === \"confirmed\" || l?.is_confirmed === true || l?.analysis_status === \"success\"\n      ).length ?? 0;\n    return confirmed > 0 ? confirmed : nutritionLogs?.length ?? 0;\n  }, [nutritionLogs]);\n\n  const progressLabel = useMemo(() => {\n    const base = Math.min(completedCount, 3);\n    if (base === 0) return \"まだ記録がありません\";\n    if (base === 1) return \"1つ進んだ\";\n    if (base === 2) return \"2つ進んだ\";\n    return \"今日の基本3食がそろった\";\n  }, [completedCount]);\n\n  // NutritionCard の期待する totals 形式（cal/p/f/c）に寄せる\n  // ※ 既に { cal, p, f, c } ならそのまま通る\n  const normalizedTotals = useMemo(() => {\n    const t = nutritionTotals ?? {};\n    // いろんなキー揺れを吸収\n    const cal =\n      Number(t?.cal ?? t?.kcal ?? t?.calories ?? t?.total_calories ?? 0) || 0;\n    const p =\n      Number(t?.p ?? t?.protein_g ?? t?.p_g ?? t?.protein ?? 0) || 0;\n    const f =\n      Number(t?.f ?? t?.fat_g ?? t?.f_g ?? t?.fat ?? 0) || 0;\n    const c =\n      Number(t?.c ?? t?.carbs_g ?? t?.c_g ?? t?.carbs ?? 0) || 0;\n\n    return { cal, p, f, c };\n  }, [nutritionTotals]);\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 sm:p-6 transition-colors\">\n        <div className=\"flex items-start justify-between gap-3\">\n          <div>\n            <div className=\"flex items-center gap-2\">\n              <Flame className=\"w-5 h-5 text-orange-500\" />\n              <h2 className=\"text-lg sm:text-xl font-semibold text-gray-900 dark:text-white\">\n                栄養（詳細）\n              </h2>\n            </div>\n            <p className=\"text-sm text-gray-600 dark:text-gray-400 mt-1\">\n              AIは下書き。最後に決めるのはあなた。\n            </p>\n            <p className=\"text-xs text-gray-500 dark:text-gray-500 mt-1\">\n              {user?.name ?? \"ユーザー\"}さん · {date}\n            </p>\n\n            <div className=\"mt-3\">\n              <p className=\"text-sm text-gray-700 dark:text-gray-200\">\n                今日の進捗：<b>{Math.min(completedCount, 3)}/3</b>\n                <span className=\"ml-2 text-xs text-gray-500 dark:text-gray-400\">\n                  {progressLabel}\n                </span>\n              </p>\n            </div>\n          </div>\n\n          <button type=\"button\"\n            onClick={onBackHome}\n            className=\"inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors\"\n          >\n            <ArrowLeft className=\"w-4 h-4\" />\n            <span className=\"text-sm font-medium\">ホームへ</span>\n          </button>\n        </div>\n      </div>\n\n      {/* ✅ 詳細ページは NutritionCard をそのまま表示 */}\n      <NutritionCard\n        user={user}\n        latestInbody={latestInbody}\n        date={date}\n        trainingRecords={trainingRecords}\n        nutritionLogs={nutritionLogs}\n        nutritionTotals={normalizedTotals}\n        nutritionLoading={nutritionLoading}\n        nutritionError={nutritionError}\n        latestWeightKg={latestWeightKg}\n        onSaved={() => {\n          if (typeof onRefreshNutrition === \"function\") onRefreshNutrition();\n        }}\n      />\n\n      {/* ここに後で FAB を載せる（カメラ/食品検索） */}\n      {/* <NutritionFAB ... /> */}\n    </div>\n  );\n}"],"names":["toNum","v","fallback","n","Number","isFinite","NutritionEditModal","open","log","onClose","onSaved","onDeleted","saving","setSaving","useState","deleting","setDeleting","err","setErr","cal","setCal","p","setP","f","setF","c","setC","menuText","setMenuText","advice","setAdvice","title","useMemo","mealType","String","meal_type","mealSlot","meal_slot","useEffect","prevOverflow","document","body","style","overflow","prevPaddingRight","paddingRight","scrollbarWidth","window","innerWidth","documentElement","clientWidth","onKeyDown","e","key","addEventListener","removeEventListener","total_calories","names","Array","isArray","menu_items","map","x","name","label","filter","Boolean","join","advice_markdown","jsxs","className","children","jsx","type","onClick","disabled","role","record_date","analysis_status","is_edited","X","image_url","src","alt","loading","decoding","value","onChange","target","inputMode","rows","analysis_error","async","confirm","error","supabase","from","delete","eq","id","console","message","Loader2","Trash2","updatedPayload","Math","max","round","toFixed","split","s","trim","edit_meta","updated_at","Date","toISOString","source","data","update","select","single","Save","clamp","min","fmt1","LABEL","short","long","PFCBalance","totals","targets","active","setActive","pG","fG","cG","now","pK","fK","cK","total","kcalFromPFC","totalK","pctInt","pctFloat","pPct","fPct","cPct","raw","floors","floor","frac","remain","reduce","acc","sort","a","b","addMap","i","length","base","fnd","find","z","finalSum","maxKey","best","k","toIntPct100","activeDetail","g","pct","setOrToggle","prev","fade","isEmpty","Fragment","width","viewBox","cx","cy","r","fill","stroke","strokeWidth","CIRC","PI","segs","offsetPct","dash","dashArray","dashOffset","strokeLinecap","strokeDasharray","strokeDashoffset","transform","y","textAnchor","fontSize","fontWeight","goal","ProgressBar","w","MacroCell","unit","NutritionSummaryPanel","dateLabel","bmrKcal","tdeeKcal","onPrimaryAction","primaryLabel","t","calRemain","formatMealLabel","normalizeMealSlot","slot","toTokyoDateString","anyDate","test","d","isNaN","getTime","parts","toLocaleDateString","timeZone","padStart","duplicateMealMessage","NutritionCard","user","latestInbody","latestWeightKg","date","trainingRecords","badgeText","nutritionLogs","nutritionTotals","nutritionLoading","nutritionError","fileRef","useRef","uploading","setUploading","uploadErr","setUploadErr","successMsg","setSuccessMsg","setMealType","setMealSlot","recordDate","slice","localLogs","setLocalLogs","displayTotals","sum","l","editOpen","setEditOpen","selectedLog","setSelectedLog","targetsAndRefs","weightFromUser","weight_kg","NaN","weightFromInbody","weight","weightFromLatest","weightKg","heightCm","height_cm","age","dateOfBirth","getFullYear","m","getMonth","getDate","calcAge","date_of_birth","sex","gender","bodyFatPercent","body_fat_percent","body_fat_perc","refs","res","buildDailyTargets","activityLevel","goalType","ffmKg","deficits","calNow","pNow","fNow","cNow","buildDeficits","shortageRanking","shorts","quickSuggestions","byKey","Object","fromEntries","pNeed","_a","cNeed","_b","fNeed","_c","calNeed","_d","primary","buildQuickSuggestions","gaps","calcGaps","today","handleSelectPhoto","file","safeSlot","some","current","insertedId","userId","Error","ext","pop","toLowerCase","uuid","crypto","randomUUID","path","upErr","storage","upload","upsert","contentType","pub","getPublicUrl","imageUrl","publicUrl","inserted","insErr","insert","user_id","image_path","image_meta","original_name","size","code","details","msg","detail","hint","includes","isDuplicateMealError","base64","Promise","resolve","reject","reader","FileReader","onload","result","onerror","readAsDataURL","fileToBase64","context","geminiJson","payload","functions","invoke","JSON","stringify","callNutritionGeminiViaInvoke","imageBase64","parsed","json","calories","kcal","protein","fat","carbs","calsN","pN","fN","cN","keys","menuItems","comment","parseGeminiResultStrict","meta","updated","updErr","analysis_meta","analysis_model","used_model","analysis_reason","reason","created_at","markErr","Flame","click","Camera","ref","accept","files","CheckCircle2","Lightbulb","parse","vals","values","normalizeMenuItems","note","estimated_amount","formatMenuItem","deletedId","AthleteNutritionDashboardView","onBackHome","onRefreshNutrition","completedCount","confirmed","status","is_confirmed","progressLabel","normalizedTotals","protein_g","p_g","fat_g","f_g","carbs_g","c_g","ArrowLeft"],"mappings":"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"}
{"version":3,"file":"MessagingPanel-D7zdw3YG.js","sources":["../../node_modules/lucide-react/dist/esm/icons/loader.js","../../src/components/MessagingPanel.tsx","../../src/hooks/useMessages.ts"],"sourcesContent":["/**\n * @license lucide-react v0.344.0 - ISC\n *\n * This source code is licensed under the ISC license.\n * See the LICENSE file in the root directory of this source tree.\n */\n\nimport createLucideIcon from '../createLucideIcon.js';\n\nconst Loader = createLucideIcon(\"Loader\", [\n  [\"line\", { x1: \"12\", x2: \"12\", y1: \"2\", y2: \"6\", key: \"gza1u7\" }],\n  [\"line\", { x1: \"12\", x2: \"12\", y1: \"18\", y2: \"22\", key: \"1qhbu9\" }],\n  [\"line\", { x1: \"4.93\", x2: \"7.76\", y1: \"4.93\", y2: \"7.76\", key: \"xae44r\" }],\n  [\"line\", { x1: \"16.24\", x2: \"19.07\", y1: \"16.24\", y2: \"19.07\", key: \"bxnmvf\" }],\n  [\"line\", { x1: \"2\", x2: \"6\", y1: \"12\", y2: \"12\", key: \"89khin\" }],\n  [\"line\", { x1: \"18\", x2: \"22\", y1: \"12\", y2: \"12\", key: \"pb8tfm\" }],\n  [\"line\", { x1: \"4.93\", x2: \"7.76\", y1: \"19.07\", y2: \"16.24\", key: \"1uxjnu\" }],\n  [\"line\", { x1: \"16.24\", x2: \"19.07\", y1: \"7.76\", y2: \"4.93\", key: \"6duxfx\" }]\n]);\n\nexport { Loader as default };\n//# sourceMappingURL=loader.js.map\n","import React, { useState, useEffect, useCallback, useMemo } from 'react';\nimport { useMessages } from '../hooks/useMessages';\nimport { MessageSquare, X, Send, Search, Loader, User, AlertCircle } from 'lucide-react';\nimport { supabase } from '../lib/supabase';\n\ninterface MessagingPanelProps {\n  userId: string;\n  userName: string;\n  onClose: () => void;\n}\n\ninterface UserOption {\n  id: string;\n  name: string;\n  email: string;\n  role: string;\n}\n\nexport const MessagingPanel = React.memo(function MessagingPanel({\n  userId,\n  userName,\n  onClose,\n}: MessagingPanelProps) {\n  const {\n    threads,\n    messages,\n    loading,\n    error,\n    activeThreadId,\n    setActiveThreadId,\n    totalUnreadCount,\n    getOrCreateThread,\n    sendMessage,\n    markThreadAsRead,\n    fetchMessages,\n  } = useMessages(userId);\n\n  const [messageInput, setMessageInput] = useState('');\n  const [sending, setSending] = useState(false);\n  const [searchQuery, setSearchQuery] = useState('');\n  const [showNewMessage, setShowNewMessage] = useState(false);\n  const [availableUsers, setAvailableUsers] = useState<UserOption[]>([]);\n  const [loadingUsers, setLoadingUsers] = useState(false);\n  const [selectedNewUser, setSelectedNewUser] = useState<string | null>(null);\n  const [showThreadList, setShowThreadList] = useState(true);\n\n  // Get active thread details\n  const activeThread = useMemo(\n    () => threads.find((t) => t.id === activeThreadId),\n    [threads, activeThreadId]\n  );\n\n  // Filter threads by search query\n  const filteredThreads = useMemo(() => {\n    if (!searchQuery.trim()) return threads;\n    const query = searchQuery.toLowerCase();\n    return threads.filter(\n      (thread) =>\n        thread.other_user?.name.toLowerCase().includes(query) ||\n        thread.other_user?.email.toLowerCase().includes(query)\n    );\n  }, [threads, searchQuery]);\n\n  // Fetch available users for new conversation\n  const fetchAvailableUsers = useCallback(async () => {\n    try {\n      setLoadingUsers(true);\n\n      // Get user's organization\n      const { data: userOrgs } = await supabase\n        .from('organization_members')\n        .select('organization_id')\n        .eq('user_id', userId);\n\n      if (!userOrgs || userOrgs.length === 0) {\n        setAvailableUsers([]);\n        return;\n      }\n\n      const organizationIds = userOrgs.map((org) => org.organization_id);\n\n      // Get all users in the same organizations\n      const { data: orgMembers } = await supabase\n        .from('organization_members')\n        .select('user_id')\n        .in('organization_id', organizationIds);\n\n      if (!orgMembers) {\n        setAvailableUsers([]);\n        return;\n      }\n\n      const userIds = [...new Set(orgMembers.map((m) => m.user_id))].filter(\n        (id) => id !== userId\n      );\n\n      // Get user details\n      const { data: users } = await supabase\n        .from('users')\n        .select('id, name, email, role')\n        .in('id', userIds)\n        .order('name');\n\n      setAvailableUsers(users || []);\n    } catch (err) {\n      console.error('Error fetching users:', err);\n    } finally {\n      setLoadingUsers(false);\n    }\n  }, [userId]);\n\n  // Handle thread selection\n  const handleThreadSelect = useCallback(\n    async (threadId: string) => {\n      setActiveThreadId(threadId);\n      setShowNewMessage(false);\n      setShowThreadList(false);\n      await fetchMessages(threadId);\n      await markThreadAsRead(threadId);\n    },\n    [setActiveThreadId, fetchMessages, markThreadAsRead]\n  );\n\n  // Handle send message\n  const handleSendMessage = useCallback(async () => {\n    if (!messageInput.trim() || sending) return;\n\n    let threadId = activeThreadId;\n    let receiverId = activeThread?.other_user?.id;\n\n    // If new message mode, create thread first\n    if (showNewMessage && selectedNewUser) {\n      try {\n        setSending(true);\n        threadId = await getOrCreateThread(selectedNewUser);\n        receiverId = selectedNewUser;\n        setActiveThreadId(threadId);\n        setShowNewMessage(false);\n        setSelectedNewUser(null);\n        setSending(false);\n      } catch (err) {\n        console.error('Error creating thread:', err);\n        setSending(false);\n        alert('スレッドの作成に失敗しました: ' + (err instanceof Error ? err.message : '不明なエラー'));\n        return;\n      }\n    }\n\n    if (!threadId || !receiverId) return;\n\n    setSending(true);\n    const result = await sendMessage(threadId, messageInput, receiverId);\n    setSending(false);\n\n    if (result.success) {\n      setMessageInput('');\n    }\n  }, [\n    messageInput,\n    sending,\n    activeThreadId,\n    activeThread,\n    showNewMessage,\n    selectedNewUser,\n    getOrCreateThread,\n    sendMessage,\n    setActiveThreadId,\n  ]);\n\n  // Handle key press in input\n  const handleKeyPress = useCallback(\n    (e: React.KeyboardEvent) => {\n      if (e.key === 'Enter' && !e.shiftKey) {\n        e.preventDefault();\n        handleSendMessage();\n      }\n    },\n    [handleSendMessage]\n  );\n\n  // Fetch available users when opening new message\n  useEffect(() => {\n    if (showNewMessage) {\n      fetchAvailableUsers();\n    }\n  }, [showNewMessage, fetchAvailableUsers]);\n\n  // Auto-scroll to bottom when messages change\n  useEffect(() => {\n    if (activeThreadId && messages[activeThreadId]) {\n      const messagesContainer = document.getElementById('messages-container');\n      if (messagesContainer) {\n        messagesContainer.scrollTop = messagesContainer.scrollHeight;\n      }\n    }\n  }, [activeThreadId, messages]);\n\n  return (\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 sm:p-4\">\n      <div className=\"bg-white dark:bg-gray-800 sm:rounded-xl shadow-2xl w-full sm:max-w-5xl h-full sm:h-[600px] flex flex-col\">\n        {/* Header */}\n        <div className=\"flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700\">\n          <div className=\"flex items-center space-x-3\">\n            <MessageSquare className=\"w-6 h-6 text-blue-600 dark:text-blue-400\" />\n            <h2 className=\"text-xl font-bold text-gray-900 dark:text-white\">\n              メッセージ\n            </h2>\n            {totalUnreadCount > 0 && (\n              <span className=\"bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full\">\n                {totalUnreadCount}\n              </span>\n            )}\n          </div>\n          <button\n            onClick={onClose}\n            className=\"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors\"\n          >\n            <X className=\"w-6 h-6\" />\n          </button>\n        </div>\n\n        {/* Main Content */}\n        <div className=\"flex flex-1 overflow-hidden\">\n          {/* Threads List */}\n          <div className={`${\n            showThreadList ? 'flex' : 'hidden sm:flex'\n          } w-full sm:w-1/3 border-r border-gray-200 dark:border-gray-700 flex-col`}>\n            {/* Search and New Message */}\n            <div className=\"p-3 space-y-2 border-b border-gray-200 dark:border-gray-700\">\n              <div className=\"relative\">\n                <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400\" />\n                <input\n                  type=\"text\"\n                  placeholder=\"会話を検索...\"\n                  value={searchQuery}\n                  onChange={(e) => setSearchQuery(e.target.value)}\n                  className=\"w-full pl-10 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white text-sm\"\n                />\n              </div>\n              <button\n                onClick={() => {\n                  setShowNewMessage(true);\n                  setActiveThreadId(null);\n                }}\n                className=\"w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg transition-colors text-sm font-medium\"\n              >\n                新しいメッセージ\n              </button>\n            </div>\n\n            {/* Threads */}\n            <div className=\"flex-1 overflow-y-auto\">\n              {loading && threads.length === 0 ? (\n                <div className=\"flex items-center justify-center h-32\">\n                  <Loader className=\"w-6 h-6 animate-spin text-blue-600\" />\n                </div>\n              ) : filteredThreads.length === 0 ? (\n                <div className=\"text-center py-8 px-4\">\n                  <MessageSquare className=\"w-12 h-12 text-gray-400 mx-auto mb-2\" />\n                  <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n                    {searchQuery ? '該当する会話がありません' : 'メッセージはありません'}\n                  </p>\n                </div>\n              ) : (\n                filteredThreads.map((thread) => (\n                  <button\n                    key={thread.id}\n                    onClick={() => handleThreadSelect(thread.id)}\n                    className={`w-full p-3 sm:p-3 border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors text-left ${\n                      activeThreadId === thread.id\n                        ? 'bg-blue-50 dark:bg-gray-700'\n                        : ''\n                    }`}\n                  >\n                    <div className=\"flex items-start justify-between\">\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"flex items-center space-x-2\">\n                          <p className=\"font-semibold text-gray-900 dark:text-white text-sm truncate\">\n                            {thread.other_user?.name || '不明なユーザー'}\n                          </p>\n                          {(thread.unread_count || 0) > 0 && (\n                            <span className=\"bg-red-500 text-white text-xs font-bold px-1.5 py-0.5 rounded-full\">\n                              {thread.unread_count}\n                            </span>\n                          )}\n                        </div>\n                        <p className=\"text-xs text-gray-600 dark:text-gray-400 truncate\">\n                          {thread.other_user?.role === '<global_admin'\n                            ? '管理者'\n                            : thread.other_user?.role === 'staff'\n                            ? 'コーチ'\n                            : 'アスリート'}\n                        </p>\n                        {thread.last_message_preview && (\n                          <p className=\"text-xs text-gray-500 dark:text-gray-400 truncate mt-1\">\n                            {thread.last_message_preview}\n                          </p>\n                        )}\n                      </div>\n                      <span className=\"text-xs text-gray-400 ml-2 whitespace-nowrap\">\n                        {new Date(thread.last_message_at).toLocaleDateString(\n                          'ja-JP',\n                          {\n                            month: 'short',\n                            day: 'numeric',\n                          }\n                        )}\n                      </span>\n                    </div>\n                  </button>\n                ))\n              )}\n            </div>\n          </div>\n\n          {/* Messages Area */}\n          <div className={`${\n            !showThreadList || activeThread || showNewMessage ? 'flex' : 'hidden sm:flex'\n          } flex-1 flex-col`}>\n            {showNewMessage ? (\n              /* New Message Composer */\n              <>\n                {/* Mobile Back Button */}\n                <div className=\"sm:hidden p-4 border-b border-gray-200 dark:border-gray-700 flex items-center space-x-3\">\n                  <button\n                    onClick={() => {\n                      setShowNewMessage(false);\n                      setShowThreadList(true);\n                    }}\n                    className=\"text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white\"\n                  >\n                    <X className=\"w-5 h-5\" />\n                  </button>\n                  <h3 className=\"text-lg font-semibold text-gray-900 dark:text-white\">\n                    新しいメッセージ\n                  </h3>\n                </div>\n                <div className=\"flex-1 flex flex-col p-4\">\n                <h3 className=\"hidden sm:block text-lg font-semibold text-gray-900 dark:text-white mb-4\">\n                  新しいメッセージ\n                </h3>\n                <div className=\"mb-4\">\n                  <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\n                    宛先を選択\n                  </label>\n                  {loadingUsers ? (\n                    <div className=\"flex items-center justify-center py-8\">\n                      <Loader className=\"w-6 h-6 animate-spin text-blue-600\" />\n                    </div>\n                  ) : availableUsers.length === 0 ? (\n                    <div className=\"text-center py-8\">\n                      <User className=\"w-12 h-12 text-gray-400 mx-auto mb-2\" />\n                      <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n                        メッセージを送信できるユーザーがいません\n                      </p>\n                    </div>\n                  ) : (\n                    <div className=\"space-y-2 max-h-64 overflow-y-auto\">\n                      {availableUsers.map((user) => (\n                        <button\n                          key={user.id}\n                          onClick={() => setSelectedNewUser(user.id)}\n                          className={`w-full p-3 border rounded-lg text-left transition-colors ${\n                            selectedNewUser === user.id\n                              ? 'border-blue-500 bg-blue-50 dark:bg-gray-700'\n                              : 'border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700'\n                          }`}\n                        >\n                          <p className=\"font-semibold text-gray-900 dark:text-white text-sm\">\n                            {user.name}\n                          </p>\n                          <p className=\"text-xs text-gray-600 dark:text-gray-400\">\n                            {user.email} •{' '}\n                            {user.role === 'global_admin'\n                              ? '管理者'\n                              : user.role === 'staff'\n                              ? 'コーチ'\n                              : 'アスリート'}\n                          </p>\n                        </button>\n                      ))}\n                    </div>\n                  )}\n                </div>\n              </div>\n              </>\n            ) : activeThread ? (\n              /* Active Conversation */\n              <>\n                {/* Conversation Header */}\n                <div className=\"p-4 border-b border-gray-200 dark:border-gray-700 flex items-center space-x-3\">\n                  {/* Mobile Back Button */}\n                  <button\n                    onClick={() => {\n                      setActiveThreadId(null);\n                      setShowThreadList(true);\n                    }}\n                    className=\"sm:hidden text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white\"\n                  >\n                    <X className=\"w-5 h-5\" />\n                  </button>\n                  <div className=\"flex-1\">\n                    <h3 className=\"font-semibold text-gray-900 dark:text-white\">\n                      {activeThread.other_user?.name || '不明なユーザー'}\n                    </h3>\n                    <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n                      {activeThread.other_user?.role === 'global_admin'\n                        ? '管理者'\n                        : activeThread.other_user?.role === 'staff'\n                        ? 'コーチ'\n                        : 'アスリート'}\n                    </p>\n                  </div>\n                </div>\n\n                {/* Messages */}\n                <div\n                  id=\"messages-container\"\n                  className=\"flex-1 overflow-y-auto p-4 space-y-3\"\n                >\n                  {messages[activeThreadId]?.map((message) => {\n                    const isOwn = message.sender_id === userId;\n                    return (\n                      <div\n                        key={message.id}\n                        className={`flex ${isOwn ? 'justify-end' : 'justify-start'}`}\n                      >\n                        <div\n                          className={`max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${\n                            isOwn\n                              ? 'bg-blue-600 text-white'\n                              : 'bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-white'\n                          }`}\n                        >\n                          <p className=\"text-sm whitespace-pre-wrap break-words\">\n                            {message.content}\n                          </p>\n                          <p\n                            className={`text-xs mt-1 ${\n                              isOwn ? 'text-blue-100' : 'text-gray-500 dark:text-gray-400'\n                            }`}\n                          >\n                            {new Date(message.created_at).toLocaleTimeString(\n                              'ja-JP',\n                              {\n                                hour: '2-digit',\n                                minute: '2-digit',\n                              }\n                            )}\n                            {isOwn && message.is_read && ' • 既読'}\n                          </p>\n                        </div>\n                      </div>\n                    );\n                  })}\n                </div>\n              </>\n            ) : (\n              /* No Thread Selected */\n              <div className=\"flex-1 flex items-center justify-center\">\n                <div className=\"text-center\">\n                  <MessageSquare className=\"w-16 h-16 text-gray-400 mx-auto mb-4\" />\n                  <p className=\"text-gray-600 dark:text-gray-400\">\n                    会話を選択してください\n                  </p>\n                </div>\n              </div>\n            )}\n\n            {/* Message Input */}\n            {(activeThread || (showNewMessage && selectedNewUser)) && (\n              <div className=\"p-4 border-t border-gray-200 dark:border-gray-700\">\n                {error && (\n                  <div className=\"mb-2 p-2 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg flex items-center space-x-2\">\n                    <AlertCircle className=\"w-4 h-4 text-red-600 dark:text-red-400\" />\n                    <p className=\"text-sm text-red-600 dark:text-red-400\">{error}</p>\n                  </div>\n                )}\n                <div className=\"flex space-x-2\">\n                  <textarea\n                    value={messageInput}\n                    onChange={(e) => setMessageInput(e.target.value)}\n                    onKeyPress={handleKeyPress}\n                    placeholder=\"メッセージを入力... (Enterで送信)\"\n                    rows={2}\n                    maxLength={2000}\n                    className=\"flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white text-sm resize-none\"\n                  />\n                  <button\n                    onClick={handleSendMessage}\n                    disabled={!messageInput.trim() || sending}\n                    className=\"bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white px-4 py-2 rounded-lg transition-colors flex items-center space-x-2\"\n                  >\n                    {sending ? (\n                      <Loader className=\"w-5 h-5 animate-spin\" />\n                    ) : (\n                      <Send className=\"w-5 h-5\" />\n                    )}\n                  </button>\n                </div>\n                <p className=\"text-xs text-gray-500 dark:text-gray-400 mt-1\">\n                  {messageInput.length}/2000文字\n                </p>\n              </div>\n            )}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n});\n","// src/hooks/useMessages.ts\nimport { useState, useEffect, useCallback, useMemo, useRef } from \"react\";\nimport { supabase } from \"../lib/supabase\";\nimport type { RealtimeChannel } from \"@supabase/supabase-js\";\nimport { useRealtimeHub } from \"./useRealtimeHub\";\n\nconst ENABLE_REALTIME = import.meta.env.VITE_ENABLE_REALTIME === \"true\";\n\nexport interface MessageThread {\n  id: string;\n  participant1_id: string;\n  participant2_id: string;\n  last_message_at: string;\n  created_at: string;\n  other_user?: {\n    id: string;\n    name: string;\n    email: string;\n    role: string;\n  };\n  unread_count?: number;\n  last_message_preview?: string;\n}\n\nexport interface Message {\n  id: string;\n  thread_id: string;\n  sender_id: string;\n  receiver_id: string;\n  content: string;\n  is_read: boolean;\n  created_at: string;\n  updated_at: string;\n  sender?: {\n    id: string;\n    name: string;\n    email: string;\n  };\n}\n\nexport function useMessages(userId: string) {\n  const [threads, setThreads] = useState<MessageThread[]>([]);\n  const [messages, setMessages] = useState<Record<string, Message[]>>({});\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [activeThreadId, setActiveThreadId] = useState<string | null>(null);\n\n  const { state, registerPollJob } = useRealtimeHub();\n\n  // ✅ active thread の realtime channel（多重subscribe防止）\n  const channelRef = useRef<RealtimeChannel | null>(null);\n\n  // ✅ Hub poll unregister\n  const unregisterThreadsPollRef = useRef<null | (() => void)>(null);\n  const unregisterActivePollRef = useRef<null | (() => void)>(null);\n\n  // ✅ hookインスタンス固有ID（key衝突回避）\n  const instanceIdRef = useRef(\n    globalThis.crypto?.randomUUID?.() ?? Math.random().toString(36).slice(2)\n  );\n\n  // ✅ 多重fetchガード（Hub tickの並列実行対策）\n  const inflightThreadsRef = useRef(false);\n  const inflightMessagesRef = useRef<Record<string, boolean>>({});\n\n  const cleanupChannel = useCallback(() => {\n    const ch = channelRef.current;\n    if (!ch) return;\n    try {\n      ch.unsubscribe?.();\n    } catch (_) {}\n    try {\n      supabase.removeChannel(ch);\n    } catch (_) {}\n    channelRef.current = null;\n  }, []);\n\n  // -----------------------------\n  // Fetch threads\n  // -----------------------------\n  const fetchThreads = useCallback(async () => {\n    if (!userId) return;\n    if (inflightThreadsRef.current) return;\n    inflightThreadsRef.current = true;\n\n    try {\n      const { data: threadsData, error: threadsError } = await supabase\n        .from(\"message_threads\")\n        .select(\n          `\n          id,\n          participant1_id,\n          participant2_id,\n          last_message_at,\n          created_at\n        `\n        )\n        .or(`participant1_id.eq.${userId},participant2_id.eq.${userId}`)\n        .order(\"last_message_at\", { ascending: false });\n\n      if (threadsError) throw threadsError;\n\n      // N+1は将来 view/RPC で最適化できる。今は安全性優先で現状踏襲。\n      const threadsWithDetails = await Promise.all(\n        (threadsData || []).map(async (thread) => {\n          const otherUserId =\n            thread.participant1_id === userId ? thread.participant2_id : thread.participant1_id;\n\n          const { data: userData } = await supabase\n            .from(\"users\")\n            .select(\"id, name, email, role\")\n            .eq(\"id\", otherUserId)\n            .single();\n\n          const { count } = await supabase\n            .from(\"messages\")\n            .select(\"*\", { count: \"exact\", head: true })\n            .eq(\"thread_id\", thread.id)\n            .eq(\"receiver_id\", userId)\n            .eq(\"is_read\", false);\n\n          const { data: lastMessage } = await supabase\n            .from(\"messages\")\n            .select(\"content\")\n            .eq(\"thread_id\", thread.id)\n            .order(\"created_at\", { ascending: false })\n            .limit(1)\n            .single();\n\n          return {\n            ...thread,\n            other_user: userData || undefined,\n            unread_count: count || 0,\n            last_message_preview: lastMessage?.content,\n          } as MessageThread;\n        })\n      );\n\n      setThreads(threadsWithDetails);\n      setError(null);\n    } catch (err) {\n      console.error(\"[useMessages] fetchThreads error:\", err);\n      setError(err instanceof Error ? err.message : \"スレッドの取得に失敗しました\");\n    } finally {\n      inflightThreadsRef.current = false;\n    }\n  }, [userId]);\n\n  // -----------------------------\n  // Fetch messages（thread単位）\n  // -----------------------------\n  const fetchMessages = useCallback(async (threadId: string) => {\n    if (!threadId) return;\n\n    if (inflightMessagesRef.current[threadId]) return;\n    inflightMessagesRef.current[threadId] = true;\n\n    try {\n      const { data: messagesData, error: messagesError } = await supabase\n        .from(\"messages\")\n        .select(\n          `\n          id,\n          thread_id,\n          sender_id,\n          receiver_id,\n          content,\n          is_read,\n          created_at,\n          updated_at,\n          sender:users!messages_sender_id_fkey(id, name, email)\n        `\n        )\n        .eq(\"thread_id\", threadId)\n        .order(\"created_at\", { ascending: true })\n        .limit(100);\n\n      if (messagesError) throw messagesError;\n\n      setMessages((prev) => ({\n        ...prev,\n        [threadId]: messagesData || [],\n      }));\n    } catch (err) {\n      console.error(\"[useMessages] fetchMessages error:\", err);\n      setError(err instanceof Error ? err.message : \"メッセージの取得に失敗しました\");\n    } finally {\n      inflightMessagesRef.current[threadId] = false;\n    }\n  }, []);\n\n  // -----------------------------\n  // Create or get thread\n  // -----------------------------\n  const getOrCreateThread = useCallback(\n    async (otherUserId: string) => {\n      const [participant1, participant2] = [userId, otherUserId].sort();\n\n      const { data: userOrgs } = await supabase\n        .from(\"organization_members\")\n        .select(\"organization_id\")\n        .eq(\"user_id\", userId);\n\n      const { data: otherUserOrgs } = await supabase\n        .from(\"organization_members\")\n        .select(\"organization_id\")\n        .eq(\"user_id\", otherUserId);\n\n      if (!userOrgs || userOrgs.length === 0) {\n        throw new Error(\n          \"あなたは組織に所属していません。メッセージを送信するには組織に所属する必要があります。\"\n        );\n      }\n      if (!otherUserOrgs || otherUserOrgs.length === 0) {\n        throw new Error(\"相手が組織に所属していません。\");\n      }\n\n      const userOrgIds = userOrgs.map((o) => o.organization_id);\n      const otherUserOrgIds = otherUserOrgs.map((o) => o.organization_id);\n      const commonOrgs = userOrgIds.filter((id) => otherUserOrgIds.includes(id));\n      if (commonOrgs.length === 0) {\n        throw new Error(\n          \"相手と同じ組織に所属していません。同じ組織のメンバーとのみメッセージのやり取りができます。\"\n        );\n      }\n\n      const { data: existingThread, error: findError } = await supabase\n        .from(\"message_threads\")\n        .select(\"id\")\n        .eq(\"participant1_id\", participant1)\n        .eq(\"participant2_id\", participant2)\n        .maybeSingle();\n\n      if (findError) throw new Error(\"既存のスレッド検索に失敗しました: \" + findError.message);\n      if (existingThread) return existingThread.id;\n\n      const { data: newThread, error: createError } = await supabase\n        .from(\"message_threads\")\n        .insert({\n          participant1_id: participant1,\n          participant2_id: participant2,\n        })\n        .select(\"id\")\n        .single();\n\n      if (createError) throw new Error(\"スレッド作成に失敗しました: \" + createError.message);\n\n      await fetchThreads();\n      return newThread.id;\n    },\n    [userId, fetchThreads]\n  );\n\n  // -----------------------------\n  // Send message\n  // -----------------------------\n  const sendMessage = useCallback(\n    async (threadId: string, content: string, receiverId: string) => {\n      try {\n        const trimmedContent = content.trim();\n        if (!trimmedContent) throw new Error(\"メッセージを入力してください\");\n        if (trimmedContent.length > 2000) throw new Error(\"メッセージは2000文字以内で入力してください\");\n\n        const { error: sendError } = await supabase.from(\"messages\").insert({\n          thread_id: threadId,\n          sender_id: userId,\n          receiver_id: receiverId,\n          content: trimmedContent,\n        });\n\n        if (sendError) throw sendError;\n\n        await Promise.all([fetchMessages(threadId), fetchThreads()]);\n        return { success: true, error: null };\n      } catch (err) {\n        console.error(\"[useMessages] sendMessage error:\", err);\n        return {\n          success: false,\n          error: err instanceof Error ? err.message : \"メッセージの送信に失敗しました\",\n        };\n      }\n    },\n    [userId, fetchMessages, fetchThreads]\n  );\n\n  // -----------------------------\n  // Read\n  // -----------------------------\n  const markAsRead = useCallback(\n    async (messageId: string) => {\n      try {\n        const { error } = await supabase\n          .from(\"messages\")\n          .update({ is_read: true })\n          .eq(\"id\", messageId)\n          .eq(\"receiver_id\", userId);\n\n        if (error) throw error;\n      } catch (err) {\n        console.error(\"[useMessages] markAsRead error:\", err);\n      }\n    },\n    [userId]\n  );\n\n  const markThreadAsRead = useCallback(\n    async (threadId: string) => {\n      try {\n        const { error } = await supabase\n          .from(\"messages\")\n          .update({ is_read: true })\n          .eq(\"thread_id\", threadId)\n          .eq(\"receiver_id\", userId)\n          .eq(\"is_read\", false);\n\n        if (error) throw error;\n        await fetchThreads();\n      } catch (err) {\n        console.error(\"[useMessages] markThreadAsRead error:\", err);\n      }\n    },\n    [userId, fetchThreads]\n  );\n\n  // -----------------------------\n  // 初回ロード\n  // -----------------------------\n  useEffect(() => {\n    let cancelled = false;\n\n    const run = async () => {\n      if (!userId) {\n        setLoading(false);\n        setThreads([]);\n        setMessages({});\n        setActiveThreadId(null);\n        setError(null);\n        return;\n      }\n\n      setLoading(true);\n      await fetchThreads();\n      if (!cancelled) setLoading(false);\n    };\n\n    run();\n    return () => {\n      cancelled = true;\n    };\n  }, [userId, fetchThreads]);\n\n  // -----------------------------\n  // Hubポーリング：threads（120秒）\n  // -----------------------------\n  useEffect(() => {\n    if (unregisterThreadsPollRef.current) {\n      unregisterThreadsPollRef.current();\n      unregisterThreadsPollRef.current = null;\n    }\n    if (!userId) return;\n\n    const key = `messages:threads:${userId}:${instanceIdRef.current}`;\n    const unregister = registerPollJob({\n      key,\n      intervalMs: 120000,\n      run: fetchThreads,\n      enabled: true,\n      requireVisible: true,\n      requireOnline: true,\n      immediate: false,\n    });\n\n    unregisterThreadsPollRef.current = unregister;\n\n    return () => {\n      if (unregisterThreadsPollRef.current) {\n        unregisterThreadsPollRef.current();\n        unregisterThreadsPollRef.current = null;\n      }\n    };\n  }, [userId, registerPollJob, fetchThreads]);\n\n  // -----------------------------\n  // Hubポーリング：active thread（30秒）\n  // ✅ Realtimeが使える時は止めて、落ちた時だけ保険で動く\n  // -----------------------------\n  const canUseRealtime =\n    !!userId && !!activeThreadId && ENABLE_REALTIME && state.canRealtime;\n\n  useEffect(() => {\n    if (unregisterActivePollRef.current) {\n      unregisterActivePollRef.current();\n      unregisterActivePollRef.current = null;\n    }\n\n    if (!userId || !activeThreadId) return;\n\n    const key = `messages:active:${activeThreadId}:${instanceIdRef.current}`;\n    const unregister = registerPollJob({\n      key,\n      intervalMs: 30000,\n      run: async () => {\n        await fetchMessages(activeThreadId);\n      },\n      enabled: !canUseRealtime,     // ✅ ここが大事\n      requireVisible: true,\n      requireOnline: true,\n      immediate: true,              // active切替時は即取得\n    });\n\n    unregisterActivePollRef.current = unregister;\n\n    return () => {\n      if (unregisterActivePollRef.current) {\n        unregisterActivePollRef.current();\n        unregisterActivePollRef.current = null;\n      }\n    };\n  }, [userId, activeThreadId, registerPollJob, fetchMessages, canUseRealtime]);\n\n  // -----------------------------\n  // Realtime：active thread のみ（Hub許可のときだけ）\n  // -----------------------------\n  useEffect(() => {\n    cleanupChannel();\n\n    if (!canUseRealtime) return;\n\n    const channel = supabase\n      .channel(`messages:${activeThreadId}:${instanceIdRef.current}`)\n      .on(\n        \"postgres_changes\",\n        {\n          event: \"INSERT\",\n          schema: \"public\",\n          table: \"messages\",\n          filter: `thread_id=eq.${activeThreadId}`,\n        },\n        () => {\n          fetchMessages(activeThreadId);\n          fetchThreads();\n        }\n      )\n      .on(\n        \"postgres_changes\",\n        {\n          event: \"UPDATE\",\n          schema: \"public\",\n          table: \"messages\",\n          filter: `thread_id=eq.${activeThreadId}`,\n        },\n        () => {\n          fetchMessages(activeThreadId);\n        }\n      );\n\n    channelRef.current = channel;\n\n    channel.subscribe((status) => {\n      if (import.meta.env.DEV) console.log(\"[useMessages] realtime status\", status);\n\n      if (status === \"CHANNEL_ERROR\" || status === \"TIMED_OUT\") {\n        console.warn(\"[useMessages] realtime issue:\", status);\n        cleanupChannel(); // pollが保険で生きる\n      }\n    });\n\n    return () => {\n      cleanupChannel();\n    };\n  }, [activeThreadId, canUseRealtime, fetchMessages, fetchThreads, cleanupChannel]);\n\n  // -----------------------------\n  // Unread count\n  // -----------------------------\n  const totalUnreadCount = useMemo(() => {\n    return threads.reduce((sum, thread) => sum + (thread.unread_count || 0), 0);\n  }, [threads]);\n\n  return {\n    threads,\n    messages,\n    loading,\n    error,\n    activeThreadId,\n    setActiveThreadId,\n    totalUnreadCount,\n    getOrCreateThread,\n    sendMessage,\n    markAsRead,\n    markThreadAsRead,\n    fetchMessages,\n    refreshThreads: fetchThreads,\n  };\n}"],"names":["Loader","createLucideIcon","x1","x2","y1","y2","key","MessagingPanel","React","memo","userId","userName","onClose","threads","messages","loading","error","activeThreadId","setActiveThreadId","totalUnreadCount","getOrCreateThread","sendMessage","markThreadAsRead","fetchMessages","setThreads","useState","setMessages","setLoading","setError","state","registerPollJob","useRealtimeHub","channelRef","useRef","unregisterThreadsPollRef","unregisterActivePollRef","instanceIdRef","_b","_a","globalThis","crypto","randomUUID","call","Math","random","toString","slice","inflightThreadsRef","inflightMessagesRef","cleanupChannel","useCallback","ch","current","unsubscribe","_","supabase","removeChannel","fetchThreads","async","data","threadsData","threadsError","from","select","or","order","ascending","threadsWithDetails","Promise","all","map","thread","otherUserId","participant1_id","participant2_id","userData","eq","single","count","head","id","lastMessage","limit","other_user","unread_count","last_message_preview","content","err","console","Error","message","threadId","messagesData","messagesError","prev","participant1","participant2","sort","userOrgs","otherUserOrgs","length","userOrgIds","o","organization_id","otherUserOrgIds","filter","includes","existingThread","findError","maybeSingle","newThread","createError","insert","receiverId","trimmedContent","trim","sendError","thread_id","sender_id","receiver_id","success","markAsRead","messageId","update","is_read","useEffect","cancelled","run","unregister","intervalMs","enabled","requireVisible","requireOnline","immediate","canUseRealtime","useMemo","reduce","sum","refreshThreads","useMessages","messageInput","setMessageInput","sending","setSending","searchQuery","setSearchQuery","showNewMessage","setShowNewMessage","availableUsers","setAvailableUsers","loadingUsers","setLoadingUsers","selectedNewUser","setSelectedNewUser","showThreadList","setShowThreadList","activeThread","find","t","filteredThreads","query","toLowerCase","name","email","fetchAvailableUsers","organizationIds","org","orgMembers","in","userIds","Set","m","user_id","users","handleThreadSelect","handleSendMessage","alert","result","handleKeyPress","e","shiftKey","preventDefault","messagesContainer","document","getElementById","scrollTop","scrollHeight","className","children","jsxs","jsx","MessageSquare","onClick","X","Search","type","placeholder","value","onChange","target","role","_c","Date","last_message_at","toLocaleDateString","month","day","Fragment","User","user","_d","isOwn","created_at","toLocaleTimeString","hour","minute","AlertCircle","onKeyPress","rows","maxLength","disabled","Send"],"mappings":"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","x_google_ignoreList":[0]}
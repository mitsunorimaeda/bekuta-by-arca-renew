{"version":3,"file":"exportUtils-CVEBC2Fl.js","sources":["../../src/lib/exportUtils.ts"],"sourcesContent":["import { TrainingRecord, User } from './supabase';\nimport { ACWRData } from './acwr';\nimport { TrendAnalysis } from './trendAnalysis';\nimport { formatDateJST, getTodayJST } from './date'; // ★ 追加\n\nexport interface ExportData {\n  user: User;\n  trainingRecords: TrainingRecord[];\n  acwrData: ACWRData[];\n  trendAnalysis?: TrendAnalysis;\n  exportDate: string;\n  dateRange: {\n    start: string;\n    end: string;\n  };\n}\n\nexport interface TeamExportData {\n  teamName: string;\n  athletes: Array<{\n    user: User;\n    trainingRecords: TrainingRecord[];\n    acwrData: ACWRData[];\n    latestACWR?: number;\n    riskLevel?: string;\n  }>;\n  teamSummary: {\n    totalAthletes: number;\n    activeAthletes: number;\n    averageACWR: number;\n    highRiskAthletes: number;\n  };\n  exportDate: string;\n  dateRange: {\n    start: string;\n    end: string;\n  };\n}\n\n// CSV エクスポート関数\nexport function exportToCSV(data: ExportData): void {\n  const { user, trainingRecords, acwrData, exportDate, dateRange } = data;\n  \n  // ヘッダー行\n  const headers = [\n    '日付',\n    'RPE',\n    '練習時間(分)',\n    '負荷',\n    'ACWR',\n    '急性負荷',\n    '慢性負荷',\n    'リスクレベル'\n  ];\n  \n  // データ行を作成\n  const rows = trainingRecords.map(record => {\n    const acwrEntry = acwrData.find(a => a.date === record.date);\n    return [\n      record.date,\n      record.rpe.toString(),\n      record.duration_min.toString(),\n      (record.load ?? '').toString(),\n      acwrEntry?.acwr?.toString() || '',\n      acwrEntry?.acuteLoad?.toString() || '',\n      acwrEntry?.chronicLoad?.toString() || '',\n      acwrEntry?.riskLevel || ''\n    ];\n  });\n  \n  // CSV文字列を作成\n  const csvContent = [\n    `# ${user.name}さんの練習記録`,\n    `# エクスポート日時: ${exportDate}`,\n    `# 期間: ${dateRange.start} ～ ${dateRange.end}`,\n    '',\n    headers.join(','),\n    ...rows.map(row => row.join(','))\n  ].join('\\n');\n  \n  // BOMを追加してUTF-8エンコーディングを明示\n  const bom = '\\uFEFF';\n  const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });\n  \n  // ダウンロード\n  const link = document.createElement('a');\n  const url = URL.createObjectURL(blob);\n  link.setAttribute('href', url);\n  link.setAttribute('download', `${user.name}_練習記録_${dateRange.start}_${dateRange.end}.csv`);\n  link.style.visibility = 'hidden';\n  document.body.appendChild(link);\n  link.click();\n  document.body.removeChild(link);\n}\n\n// チームCSVエクスポート関数\nexport function exportTeamToCSV(data: TeamExportData): void {\n  const { teamName, athletes, teamSummary, exportDate, dateRange } = data;\n  \n  // ヘッダー行\n  const headers = [\n    '選手名',\n    '日付',\n    'RPE',\n    '練習時間(分)',\n    '負荷',\n    'ACWR',\n    '急性負荷',\n    '慢性負荷',\n    'リスクレベル'\n  ];\n  \n  // データ行を作成\n  const rows: string[][] = [];\n  \n  athletes.forEach(athlete => {\n    athlete.trainingRecords.forEach(record => {\n      const acwrEntry = athlete.acwrData.find(a => a.date === record.date);\n      rows.push([\n        athlete.user.name,\n        record.date,\n        record.rpe.toString(),\n        record.duration_min.toString(),\n        (record.load ?? '').toString(),\n        acwrEntry?.acwr?.toString() || '',\n        acwrEntry?.acuteLoad?.toString() || '',\n        acwrEntry?.chronicLoad?.toString() || '',\n        acwrEntry?.riskLevel || ''\n      ]);\n    });\n  });\n  \n  // CSV文字列を作成\n  const csvContent = [\n    `# ${teamName} チーム練習記録`,\n    `# エクスポート日時: ${exportDate}`,\n    `# 期間: ${dateRange.start} ～ ${dateRange.end}`,\n    `# 総選手数: ${teamSummary.totalAthletes}名`,\n    `# アクティブ選手数: ${teamSummary.activeAthletes}名`,\n    `# チーム平均ACWR: ${teamSummary.averageACWR}`,\n    `# 高リスク選手数: ${teamSummary.highRiskAthletes}名`,\n    '',\n    headers.join(','),\n    ...rows.map(row => row.join(','))\n  ].join('\\n');\n  \n  // BOMを追加してUTF-8エンコーディングを明示\n  const bom = '\\uFEFF';\n  const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });\n  \n  // ダウンロード\n  const link = document.createElement('a');\n  const url = URL.createObjectURL(blob);\n  link.setAttribute('href', url);\n  link.setAttribute('download', `${teamName}_チーム練習記録_${dateRange.start}_${dateRange.end}.csv`);\n  link.style.visibility = 'hidden';\n  document.body.appendChild(link);\n  link.click();\n  document.body.removeChild(link);\n}\n\n// JSON エクスポート関数（詳細データ用）\nexport function exportToJSON(data: ExportData): void {\n  const { user, exportDate, dateRange } = data;\n  \n  const jsonContent = JSON.stringify(data, null, 2);\n  const blob = new Blob([jsonContent], { type: 'application/json' });\n  \n  const link = document.createElement('a');\n  const url = URL.createObjectURL(blob);\n  link.setAttribute('href', url);\n  link.setAttribute('download', `${user.name}_詳細データ_${dateRange.start}_${dateRange.end}.json`);\n  link.style.visibility = 'hidden';\n  document.body.appendChild(link);\n  link.click();\n  document.body.removeChild(link);\n}\n\n// 日付範囲のヘルパー関数（JST対応版）\nexport function getDateRange(\n  period: 'week' | 'month' | 'quarter' | 'custom',\n  customStart?: string,\n  customEnd?: string\n) {\n  const today = getTodayJST();         // ★ ベースはJSTの「今日」\n  let start: Date;\n  let end: Date = new Date(today);\n\n  switch (period) {\n    case 'week': {\n      start = new Date(today);\n      start.setDate(start.getDate() - 7);\n      break;\n    }\n    case 'month': {\n      start = new Date(today);\n      start.setMonth(start.getMonth() - 1);\n      break;\n    }\n    case 'quarter': {\n      start = new Date(today);\n      start.setMonth(start.getMonth() - 3);\n      break;\n    }\n    case 'custom': {\n      if (customStart && customEnd) {\n        // custom はユーザーが選んだ YYYY-MM-DD をそのまま使う\n        return {\n          start: customStart,\n          end: customEnd\n        };\n      } else {\n        throw new Error('カスタム期間には開始日と終了日が必要です');\n      }\n    }\n    default: {\n      start = new Date(today);\n      start.setMonth(start.getMonth() - 1);\n    }\n  }\n\n  return {\n    start: formatDateJST(start),  // ★ JSTベースで YYYY-MM-DD を作成\n    end: formatDateJST(end)\n  };\n}\n\n// リスクレベルの日本語変換\nexport function getRiskLevelJapanese(riskLevel: string): string {\n  switch (riskLevel) {\n    case 'high': return '高リスク';\n    case 'caution': return '注意';\n    case 'good': return '良好';\n    case 'low': return '低負荷';\n    default: return '不明';\n  }\n}"],"names":["exportToCSV","data","user","trainingRecords","acwrData","exportDate","dateRange","rows","map","record","acwrEntry","find","a","date","rpe","toString","duration_min","load","_a","acwr","_b","acuteLoad","_c","chronicLoad","riskLevel","csvContent","name","start","end","join","row","blob","Blob","type","link","document","createElement","url","URL","createObjectURL","setAttribute","style","visibility","body","appendChild","click","removeChild","exportTeamToCSV","teamName","athletes","teamSummary","forEach","athlete","push","totalAthletes","activeAthletes","averageACWR","highRiskAthletes","exportToJSON","jsonContent","JSON","stringify","getDateRange","period","customStart","customEnd","today","getTodayJST","Date","setDate","getDate","setMonth","getMonth","Error","formatDateJST"],"mappings":"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"}
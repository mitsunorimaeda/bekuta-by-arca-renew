{"version":3,"file":"GamificationView-B4thg2QI.js","sources":["../../node_modules/lucide-react/dist/esm/icons/database.js","../../node_modules/lucide-react/dist/esm/icons/medal.js","../../node_modules/lucide-react/dist/esm/icons/sunrise.js","../../node_modules/lucide-react/dist/esm/icons/tag.js","../../src/components/StreakDisplay.tsx","../../src/components/LevelProgressCard.tsx","../../src/components/BadgeCollection.tsx","../../src/components/TeamRankings.tsx","../../src/components/LevelUpModal.tsx","../../src/components/ErrorBoundary.tsx","../../src/components/PointHistoryModal.tsx","../../src/components/RankStatsCard.tsx","../../src/components/GamificationView.tsx","../../src/hooks/useStreaks.ts","../../src/hooks/useRankStats.ts","../../src/hooks/usePoints.ts","../../src/hooks/useRankings.ts"],"sourcesContent":["/**\n * @license lucide-react v0.344.0 - ISC\n *\n * This source code is licensed under the ISC license.\n * See the LICENSE file in the root directory of this source tree.\n */\n\nimport createLucideIcon from '../createLucideIcon.js';\n\nconst Database = createLucideIcon(\"Database\", [\n  [\"ellipse\", { cx: \"12\", cy: \"5\", rx: \"9\", ry: \"3\", key: \"msslwz\" }],\n  [\"path\", { d: \"M3 5V19A9 3 0 0 0 21 19V5\", key: \"1wlel7\" }],\n  [\"path\", { d: \"M3 12A9 3 0 0 0 21 12\", key: \"mv7ke4\" }]\n]);\n\nexport { Database as default };\n//# sourceMappingURL=database.js.map\n","/**\n * @license lucide-react v0.344.0 - ISC\n *\n * This source code is licensed under the ISC license.\n * See the LICENSE file in the root directory of this source tree.\n */\n\nimport createLucideIcon from '../createLucideIcon.js';\n\nconst Medal = createLucideIcon(\"Medal\", [\n  [\n    \"path\",\n    {\n      d: \"M7.21 15 2.66 7.14a2 2 0 0 1 .13-2.2L4.4 2.8A2 2 0 0 1 6 2h12a2 2 0 0 1 1.6.8l1.6 2.14a2 2 0 0 1 .14 2.2L16.79 15\",\n      key: \"143lza\"\n    }\n  ],\n  [\"path\", { d: \"M11 12 5.12 2.2\", key: \"qhuxz6\" }],\n  [\"path\", { d: \"m13 12 5.88-9.8\", key: \"hbye0f\" }],\n  [\"path\", { d: \"M8 7h8\", key: \"i86dvs\" }],\n  [\"circle\", { cx: \"12\", cy: \"17\", r: \"5\", key: \"qbz8iq\" }],\n  [\"path\", { d: \"M12 18v-2h-.5\", key: \"fawc4q\" }]\n]);\n\nexport { Medal as default };\n//# sourceMappingURL=medal.js.map\n","/**\n * @license lucide-react v0.344.0 - ISC\n *\n * This source code is licensed under the ISC license.\n * See the LICENSE file in the root directory of this source tree.\n */\n\nimport createLucideIcon from '../createLucideIcon.js';\n\nconst Sunrise = createLucideIcon(\"Sunrise\", [\n  [\"path\", { d: \"M12 2v8\", key: \"1q4o3n\" }],\n  [\"path\", { d: \"m4.93 10.93 1.41 1.41\", key: \"2a7f42\" }],\n  [\"path\", { d: \"M2 18h2\", key: \"j10viu\" }],\n  [\"path\", { d: \"M20 18h2\", key: \"wocana\" }],\n  [\"path\", { d: \"m19.07 10.93-1.41 1.41\", key: \"15zs5n\" }],\n  [\"path\", { d: \"M22 22H2\", key: \"19qnx5\" }],\n  [\"path\", { d: \"m8 6 4-4 4 4\", key: \"ybng9g\" }],\n  [\"path\", { d: \"M16 18a4 4 0 0 0-8 0\", key: \"1lzouq\" }]\n]);\n\nexport { Sunrise as default };\n//# sourceMappingURL=sunrise.js.map\n","/**\n * @license lucide-react v0.344.0 - ISC\n *\n * This source code is licensed under the ISC license.\n * See the LICENSE file in the root directory of this source tree.\n */\n\nimport createLucideIcon from '../createLucideIcon.js';\n\nconst Tag = createLucideIcon(\"Tag\", [\n  [\n    \"path\",\n    {\n      d: \"M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z\",\n      key: \"vktsd0\"\n    }\n  ],\n  [\"circle\", { cx: \"7.5\", cy: \"7.5\", r: \".5\", fill: \"currentColor\", key: \"kqv944\" }]\n]);\n\nexport { Tag as default };\n//# sourceMappingURL=tag.js.map\n","import React from 'react';\nimport { Flame, TrendingUp, Award, AlertCircle } from 'lucide-react';\nimport { Streak } from '../hooks/useStreaks';\n\ninterface StreakDisplayProps {\n  streak: Streak | null;\n  label: string;\n  icon?: React.ReactNode;\n  compact?: boolean;\n}\n\nexport function StreakDisplay({ streak, label, icon, compact = false }: StreakDisplayProps) {\n  const getStreakColor = () => {\n    if (!streak || streak.current_streak === 0) return 'text-gray-400';\n    if (streak.current_streak >= 30) return 'text-orange-500';\n    if (streak.current_streak >= 7) return 'text-yellow-500';\n    return 'text-blue-500';\n  };\n\n  const getStreakBgColor = () => {\n    if (!streak || streak.current_streak === 0) return 'bg-gray-50 dark:bg-gray-800';\n    if (streak.current_streak >= 30) return 'bg-orange-50 dark:bg-orange-900/20';\n    if (streak.current_streak >= 7) return 'bg-yellow-50 dark:bg-yellow-900/20';\n    return 'bg-blue-50 dark:bg-blue-900/20';\n  };\n\n  const getStreakBorderColor = () => {\n    if (!streak || streak.current_streak === 0) return 'border-gray-200 dark:border-gray-700';\n    if (streak.current_streak >= 30) return 'border-orange-200 dark:border-orange-800';\n    if (streak.current_streak >= 7) return 'border-yellow-200 dark:border-yellow-800';\n    return 'border-blue-200 dark:border-blue-800';\n  };\n\n  const isAtRisk = () => {\n    if (!streak || !streak.last_recorded_date) return false;\n    const lastDate = new Date(streak.last_recorded_date);\n    const today = new Date();\n    today.setHours(0, 0, 0, 0);\n    lastDate.setHours(0, 0, 0, 0);\n    const daysDiff = Math.floor((today.getTime() - lastDate.getTime()) / (1000 * 60 * 60 * 24));\n    return daysDiff >= 1;\n  };\n\n  if (compact) {\n    return (\n      <div className={`inline-flex items-center space-x-2 px-3 py-1.5 rounded-full border ${getStreakBgColor()} ${getStreakBorderColor()} transition-colors`}>\n        {icon || <Flame className={`w-4 h-4 ${getStreakColor()}`} />}\n        <span className={`text-sm font-semibold ${getStreakColor()}`}>\n          {streak?.current_streak || 0}日\n        </span>\n        {isAtRisk() && <AlertCircle className=\"w-3 h-3 text-red-500\" />}\n      </div>\n    );\n  }\n\n  return (\n    <div className={`rounded-xl border ${getStreakBgColor()} ${getStreakBorderColor()} p-4 sm:p-6 transition-all hover:shadow-md`}>\n      <div className=\"flex items-start justify-between mb-3\">\n        <div>\n          <p className=\"text-xs text-gray-600 dark:text-gray-400 mb-1\">{label}</p>\n          <div className=\"flex items-baseline space-x-2\">\n            <p className={`text-3xl font-bold ${getStreakColor()}`}>\n              {streak?.current_streak || 0}\n            </p>\n            <span className=\"text-sm text-gray-600 dark:text-gray-400\">日連続</span>\n          </div>\n        </div>\n        <div className={`p-3 rounded-lg ${getStreakBgColor()}`}>\n          {icon || <Flame className={`w-6 h-6 ${getStreakColor()}`} />}\n        </div>\n      </div>\n\n      {isAtRisk() && (\n        <div className=\"flex items-center space-x-2 mb-3 p-2 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg\">\n          <AlertCircle className=\"w-4 h-4 text-red-500 flex-shrink-0\" />\n          <p className=\"text-xs text-red-600 dark:text-red-400\">今日記録しないとストリークが途切れます！</p>\n        </div>\n      )}\n\n      <div className=\"grid grid-cols-2 gap-3 pt-3 border-t border-gray-200 dark:border-gray-700\">\n        <div className=\"flex items-center space-x-2\">\n          <Award className=\"w-4 h-4 text-gray-400\" />\n          <div>\n            <p className=\"text-xs text-gray-500 dark:text-gray-400\">最長記録</p>\n            <p className=\"text-sm font-semibold text-gray-900 dark:text-white\">\n              {streak?.longest_streak || 0}日\n            </p>\n          </div>\n        </div>\n        <div className=\"flex items-center space-x-2\">\n          <TrendingUp className=\"w-4 h-4 text-gray-400\" />\n          <div>\n            <p className=\"text-xs text-gray-500 dark:text-gray-400\">累計記録</p>\n            <p className=\"text-sm font-semibold text-gray-900 dark:text-white\">\n              {streak?.total_records || 0}回\n            </p>\n          </div>\n        </div>\n      </div>\n\n      {streak && streak.current_streak > 0 && (\n        <div className=\"mt-3 pt-3 border-t border-gray-200 dark:border-gray-700\">\n          <div className=\"flex items-center justify-between text-xs\">\n            <span className=\"text-gray-500 dark:text-gray-400\">次のマイルストーン</span>\n            <span className=\"font-semibold text-gray-900 dark:text-white\">\n              {streak.current_streak < 7 ? '7日' : streak.current_streak < 30 ? '30日' : '100日'}連続\n            </span>\n          </div>\n          <div className=\"mt-2 w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 overflow-hidden\">\n            <div\n              className={`h-full rounded-full transition-all duration-500 ${\n                streak.current_streak >= 30 ? 'bg-orange-500' : streak.current_streak >= 7 ? 'bg-yellow-500' : 'bg-blue-500'\n              }`}\n              style={{\n                width: `${\n                  streak.current_streak < 7\n                    ? (streak.current_streak / 7) * 100\n                    : streak.current_streak < 30\n                    ? ((streak.current_streak - 7) / 23) * 100\n                    : ((streak.current_streak - 30) / 70) * 100\n                }%`,\n              }}\n            />\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","import React from \"react\";\nimport { Trophy, TrendingUp, Star, Sparkles } from \"lucide-react\";\nimport { UserPoints } from \"../hooks/usePoints\";\n\ninterface LevelProgressCardProps {\n  userPoints: UserPoints | null;\n  levelProgress: number;\n  compact?: boolean;\n  showDetails?: boolean;\n\n  // ✅ 追加：カード内に差し込むアクション領域\n  actions?: React.ReactNode;\n}\n\nexport function LevelProgressCard({\n  userPoints,\n  levelProgress,\n  compact = false,\n  showDetails = true,\n  actions,\n}: LevelProgressCardProps) {\n  const getRankColor = () => {\n    if (!userPoints) return \"text-gray-500\";\n    if (userPoints.current_level >= 50) return \"text-purple-600 dark:text-purple-400\";\n    if (userPoints.current_level >= 40) return \"text-red-600 dark:text-red-400\";\n    if (userPoints.current_level >= 30) return \"text-orange-600 dark:text-orange-400\";\n    if (userPoints.current_level >= 20) return \"text-yellow-600 dark:text-yellow-400\";\n    if (userPoints.current_level >= 10) return \"text-green-600 dark:text-green-400\";\n    return \"text-blue-600 dark:text-blue-400\";\n  };\n\n  const getRankBgColor = () => {\n    if (!userPoints) return \"bg-gray-50 dark:bg-gray-800\";\n    if (userPoints.current_level >= 50) return \"bg-purple-50 dark:bg-purple-900/20\";\n    if (userPoints.current_level >= 40) return \"bg-red-50 dark:bg-red-900/20\";\n    if (userPoints.current_level >= 30) return \"bg-orange-50 dark:bg-orange-900/20\";\n    if (userPoints.current_level >= 20) return \"bg-yellow-50 dark:bg-yellow-900/20\";\n    if (userPoints.current_level >= 10) return \"bg-green-50 dark:bg-green-900/20\";\n    return \"bg-blue-50 dark:bg-blue-900/20\";\n  };\n\n  const getRankBorderColor = () => {\n    if (!userPoints) return \"border-gray-200 dark:border-gray-700\";\n    if (userPoints.current_level >= 50) return \"border-purple-200 dark:border-purple-800\";\n    if (userPoints.current_level >= 40) return \"border-red-200 dark:border-red-800\";\n    if (userPoints.current_level >= 30) return \"border-orange-200 dark:border-orange-800\";\n    if (userPoints.current_level >= 20) return \"border-yellow-200 dark:border-yellow-800\";\n    if (userPoints.current_level >= 10) return \"border-green-200 dark:border-green-800\";\n    return \"border-blue-200 dark:border-blue-800\";\n  };\n\n  const getProgressBarColor = () => {\n    if (!userPoints) return \"bg-gray-400\";\n    if (userPoints.current_level >= 50) return \"bg-gradient-to-r from-purple-500 to-pink-500\";\n    if (userPoints.current_level >= 40) return \"bg-gradient-to-r from-red-500 to-orange-500\";\n    if (userPoints.current_level >= 30) return \"bg-gradient-to-r from-orange-500 to-yellow-500\";\n    if (userPoints.current_level >= 20) return \"bg-gradient-to-r from-yellow-500 to-green-500\";\n    if (userPoints.current_level >= 10) return \"bg-gradient-to-r from-green-500 to-blue-500\";\n    return \"bg-gradient-to-r from-blue-500 to-cyan-500\";\n  };\n\n  const getRankIcon = () => {\n    if (!userPoints) return <Star className=\"w-6 h-6\" />;\n    if (userPoints.current_level >= 50) return <Sparkles className=\"w-6 h-6\" />;\n    if (userPoints.current_level >= 30) return <Trophy className=\"w-6 h-6\" />;\n    return <Star className=\"w-6 h-6\" />;\n  };\n\n  if (compact) {\n    return (\n      <div\n        className={`inline-flex items-center space-x-3 px-4 py-2 rounded-xl border ${getRankBgColor()} ${getRankBorderColor()} transition-colors`}\n      >\n        <div className={getRankColor()}>{getRankIcon()}</div>\n        <div>\n          <p className=\"text-xs text-gray-600 dark:text-gray-400\">Lv.{userPoints?.current_level || 1}</p>\n          <p className={`text-sm font-bold ${getRankColor()}`}>{userPoints?.rank_title || \"ビギナー\"}</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className={`rounded-xl border ${getRankBgColor()} ${getRankBorderColor()} p-4 sm:p-6 transition-all hover:shadow-lg`}>\n      <div className=\"flex items-start justify-between mb-4\">\n        <div className=\"flex-1\">\n          <p className=\"text-xs text-gray-600 dark:text-gray-400 mb-1\">あなたのランク</p>\n          <div className=\"flex items-baseline space-x-2 mb-1\">\n            <h3 className={`text-2xl font-bold ${getRankColor()}`}>{userPoints?.rank_title || \"ビギナー\"}</h3>\n          </div>\n          <p className=\"text-sm text-gray-600 dark:text-gray-400\">レベル {userPoints?.current_level || 1}</p>\n        </div>\n        <div className={`p-3 rounded-xl ${getRankBgColor()} ${getRankColor()}`}>{getRankIcon()}</div>\n      </div>\n\n      {showDetails && (\n        <>\n          <div className=\"mb-4\">\n            <div className=\"flex items-center justify-between text-sm mb-2\">\n              <span className=\"text-gray-600 dark:text-gray-400\">次のレベルまで</span>\n              <span className=\"font-semibold text-gray-900 dark:text-white\">{userPoints?.points_to_next_level || 100} pt</span>\n            </div>\n            <div className=\"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden\">\n              <div className={`h-full rounded-full transition-all duration-500 ${getProgressBarColor()}`} style={{ width: `${levelProgress}%` }} />\n            </div>\n            <p className=\"text-xs text-gray-500 dark:text-gray-400 mt-1 text-right\">{Math.round(levelProgress)}%</p>\n          </div>\n\n          {/* ✅ ここが修正ポイント：下段を3枠にして actions を中に入れる */}\n          <div\n            className={[\n              \"pt-4 border-t border-gray-200 dark:border-gray-700\",\n              \"grid gap-3\",\n              actions ? \"grid-cols-1 sm:grid-cols-3\" : \"grid-cols-2\",\n            ].join(\" \")}\n          >\n            <div className=\"flex items-center space-x-2\">\n              <div className=\"p-2 bg-white dark:bg-gray-700 rounded-lg\">\n                <Trophy className=\"w-4 h-4 text-yellow-500\" />\n              </div>\n              <div>\n                <p className=\"text-xs text-gray-500 dark:text-gray-400\">総ポイント</p>\n                <p className=\"text-sm font-semibold text-gray-900 dark:text-white\">\n                  {userPoints?.total_points?.toLocaleString?.() ?? 0}\n                </p>\n              </div>\n            </div>\n\n            <div className=\"flex items-center space-x-2\">\n              <div className=\"p-2 bg-white dark:bg-gray-700 rounded-lg\">\n                <TrendingUp className=\"w-4 h-4 text-green-500\" />\n              </div>\n              <div>\n                <p className=\"text-xs text-gray-500 dark:text-gray-400\">現在のレベル</p>\n                <p className=\"text-sm font-semibold text-gray-900 dark:text-white\">Lv.{userPoints?.current_level || 1}</p>\n              </div>\n            </div>\n\n            {actions ? (\n              <div className=\"flex items-center sm:justify-end\">{actions}</div>\n            ) : null}\n          </div>\n        </>\n      )}\n    </div>\n  );\n}","import React, { useState } from 'react';\nimport { X, Lock, Sparkles, Award, Flame, Star, Trophy, Shield, Database, Heart, Sunrise, Zap } from 'lucide-react';\nimport { Badge, UserBadge } from '../hooks/useBadges';\n\ninterface BadgeCollectionProps {\n  userBadges: UserBadge[];\n  allBadges: Badge[];\n  onClose?: () => void;\n  onBadgeClick?: (badge: UserBadge | Badge) => void;\n}\n\nconst ICON_MAP: { [key: string]: React.ComponentType<any> } = {\n  Sparkles,\n  Award,\n  Flame,\n  Star,\n  Trophy,\n  Shield,\n  Database,\n  Heart,\n  Sunrise,\n  Zap,\n};\n\nexport function BadgeCollection({ userBadges, allBadges, onClose, onBadgeClick }: BadgeCollectionProps) {\n  const [selectedCategory, setSelectedCategory] = useState<string>('all');\n\n  const categories = [\n    { id: 'all', label: 'すべて' },\n    { id: 'streak', label: 'ストリーク' },\n    { id: 'performance', label: 'パフォーマンス' },\n    { id: 'consistency', label: '継続' },\n    { id: 'milestone', label: 'マイルストーン' },\n    { id: 'special', label: 'スペシャル' },\n    { id: 'team', label: 'チーム' },\n  ];\n\n  const earnedBadgeIds = new Set(userBadges.map((ub) => ub.badge_id));\n\n  const filteredBadges = allBadges.filter(\n    (badge) =>\n      !badge.is_hidden &&\n      (selectedCategory === 'all' || badge.category === selectedCategory)\n  );\n\n  const getRarityColor = (rarity: Badge['rarity']) => {\n    switch (rarity) {\n      case 'legendary':\n        return 'from-purple-500 to-pink-500';\n      case 'epic':\n        return 'from-orange-500 to-red-500';\n      case 'rare':\n        return 'from-blue-500 to-cyan-500';\n      default:\n        return 'from-gray-400 to-gray-500';\n    }\n  };\n\n  const getRarityBorderColor = (rarity: Badge['rarity']) => {\n    switch (rarity) {\n      case 'legendary':\n        return 'border-purple-300 dark:border-purple-700';\n      case 'epic':\n        return 'border-orange-300 dark:border-orange-700';\n      case 'rare':\n        return 'border-blue-300 dark:border-blue-700';\n      default:\n        return 'border-gray-300 dark:border-gray-600';\n    }\n  };\n\n  const getRarityLabel = (rarity: Badge['rarity']) => {\n    switch (rarity) {\n      case 'legendary':\n        return 'レジェンダリー';\n      case 'epic':\n        return 'エピック';\n      case 'rare':\n        return 'レア';\n      default:\n        return 'コモン';\n    }\n  };\n\n  const getIconComponent = (iconName: string) => {\n    const IconComponent = ICON_MAP[iconName] || Star;\n    return IconComponent;\n  };\n\n  const earnedCount = filteredBadges.filter((b) => earnedBadgeIds.has(b.id)).length;\n  const totalCount = filteredBadges.length;\n  const progress = totalCount > 0 ? (earnedCount / totalCount) * 100 : 0;\n\n  return (\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 backdrop-blur-sm\">\n      <div className=\"bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col transition-colors\">\n        {/* Header */}\n        <div className=\"flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700\">\n          <div>\n            <h2 className=\"text-2xl font-bold text-gray-900 dark:text-white\">バッジコレクション</h2>\n            <p className=\"text-sm text-gray-600 dark:text-gray-400 mt-1\">\n              獲得: {earnedCount} / {totalCount} ({Math.round(progress)}%)\n            </p>\n          </div>\n          {onClose && (\n            <button\n              onClick={onClose}\n              className=\"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors\"\n            >\n              <X className=\"w-6 h-6 text-gray-600 dark:text-gray-400\" />\n            </button>\n          )}\n        </div>\n\n        {/* Progress Bar */}\n        <div className=\"px-6 pt-4\">\n          <div className=\"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 overflow-hidden\">\n            <div\n              className=\"h-full bg-gradient-to-r from-blue-500 to-purple-500 rounded-full transition-all duration-500\"\n              style={{ width: `${progress}%` }}\n            />\n          </div>\n        </div>\n\n        {/* Category Filter */}\n        <div className=\"px-6 py-4 overflow-x-auto\">\n          <div className=\"flex space-x-2\">\n            {categories.map((cat) => (\n              <button\n                key={cat.id}\n                onClick={() => setSelectedCategory(cat.id)}\n                className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors whitespace-nowrap ${\n                  selectedCategory === cat.id\n                    ? 'bg-blue-600 text-white'\n                    : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'\n                }`}\n              >\n                {cat.label}\n              </button>\n            ))}\n          </div>\n        </div>\n\n        {/* Badge Grid */}\n        <div className=\"flex-1 overflow-y-auto px-6 pb-6\">\n          <div className=\"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4\">\n            {filteredBadges.map((badge) => {\n              const isEarned = earnedBadgeIds.has(badge.id);\n              const userBadge = userBadges.find((ub) => ub.badge_id === badge.id);\n              const IconComponent = getIconComponent(badge.icon);\n\n              return (\n                <div\n                  key={badge.id}\n                  onClick={() => onBadgeClick && onBadgeClick(userBadge || badge)}\n                  className={`relative p-4 rounded-xl border-2 transition-all cursor-pointer ${\n                    isEarned\n                      ? `${getRarityBorderColor(badge.rarity)} bg-white dark:bg-gray-700 hover:shadow-lg transform hover:scale-105`\n                      : 'border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 opacity-60 hover:opacity-80'\n                  }`}\n                >\n                  {/* Rarity Indicator */}\n                  {isEarned && badge.rarity !== 'common' && (\n                    <div className=\"absolute top-2 right-2\">\n                      <div className={`w-2 h-2 rounded-full bg-gradient-to-r ${getRarityColor(badge.rarity)}`} />\n                    </div>\n                  )}\n\n                  {/* New Badge Indicator */}\n                  {userBadge?.is_new && (\n                    <div className=\"absolute -top-2 -right-2\">\n                      <div className=\"bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full animate-pulse\">\n                        NEW\n                      </div>\n                    </div>\n                  )}\n\n                  {/* Icon */}\n                  <div className=\"flex justify-center mb-3\">\n                    <div\n                      className={`p-4 rounded-full ${\n                        isEarned\n                          ? `bg-gradient-to-br ${getRarityColor(badge.rarity)} text-white`\n                          : 'bg-gray-200 dark:bg-gray-700 text-gray-400'\n                      }`}\n                    >\n                      {isEarned ? (\n                        <IconComponent className=\"w-8 h-8\" />\n                      ) : (\n                        <Lock className=\"w-8 h-8\" />\n                      )}\n                    </div>\n                  </div>\n\n                  {/* Badge Info */}\n                  <div className=\"text-center\">\n                    <h3 className={`text-sm font-bold mb-1 ${isEarned ? 'text-gray-900 dark:text-white' : 'text-gray-500 dark:text-gray-400'}`}>\n                      {badge.name}\n                    </h3>\n                    <p className={`text-xs ${isEarned ? 'text-gray-600 dark:text-gray-400' : 'text-gray-400 dark:text-gray-500'}`}>\n                      {badge.description}\n                    </p>\n                    {isEarned && (\n                      <div className=\"mt-2 flex items-center justify-center space-x-1 text-xs text-gray-500 dark:text-gray-400\">\n                        <Trophy className=\"w-3 h-3\" />\n                        <span>+{badge.points_reward}pt</span>\n                      </div>\n                    )}\n                  </div>\n                </div>\n              );\n            })}\n          </div>\n\n          {filteredBadges.length === 0 && (\n            <div className=\"text-center py-12\">\n              <Lock className=\"w-12 h-12 text-gray-300 dark:text-gray-600 mx-auto mb-3\" />\n              <p className=\"text-gray-500 dark:text-gray-400\">このカテゴリーにはバッジがありません</p>\n            </div>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n","import React, { useMemo, useState } from \"react\";\nimport { Trophy, TrendingUp, Medal, Award, Users } from \"lucide-react\";\nimport type { WeeklyRanking, PointsRanking } from \"../hooks/useRankings\";\n\ninterface TeamRankingsProps {\n  weeklyRankings?: WeeklyRanking[]; // ✅ undefinedでも落ちない\n  pointsRankings?: PointsRanking[]; // ✅ undefinedでも落ちない\n  myUserId: string;\n  compact?: boolean;\n}\n\nfunction safeNumber(v: any, fallback = 0): number {\n  const n = typeof v === \"number\" ? v : Number(v);\n  return Number.isFinite(n) ? n : fallback;\n}\n\nfunction safeText(v: any, fallback = \"—\"): string {\n  const s = typeof v === \"string\" ? v : v == null ? \"\" : String(v);\n  return s.trim() ? s : fallback;\n}\n\nexport function TeamRankings({\n  weeklyRankings,\n  pointsRankings,\n  myUserId,\n  compact = false,\n}: TeamRankingsProps) {\n  const [activeTab, setActiveTab] = useState<\"weekly\" | \"points\">(\"weekly\");\n\n  // ✅ 配列が来なくても必ず配列\n  const weekly = useMemo(() => (Array.isArray(weeklyRankings) ? weeklyRankings : []), [weeklyRankings]);\n  const points = useMemo(() => (Array.isArray(pointsRankings) ? pointsRankings : []), [pointsRankings]);\n\n  const getRankMedal = (rank: number) => {\n    if (rank === 1) return { icon: Trophy, color: \"text-yellow-500\", bg: \"bg-yellow-50 dark:bg-yellow-900/20\" };\n    if (rank === 2) return { icon: Medal, color: \"text-gray-400\", bg: \"bg-gray-50 dark:bg-gray-800\" };\n    if (rank === 3) return { icon: Award, color: \"text-orange-600 dark:text-orange-400\", bg: \"bg-orange-50 dark:bg-orange-900/20\" };\n    return null;\n  };\n\n  const limit = compact ? 5 : 10;\n\n  const renderWeeklyRankings = () => {\n    const myRank = weekly.find((r: any) => r?.user_id === myUserId);\n\n    return (\n      <div className=\"space-y-2\">\n        {weekly.slice(0, limit).map((ranking: any) => {\n          const rankNum = safeNumber(ranking?.rank, 0);\n          const medal = getRankMedal(rankNum);\n          const userId = safeText(ranking?.user_id, `row-${rankNum}`);\n          const isMe = ranking?.user_id === myUserId;\n\n          const weeklyRecords = safeNumber(ranking?.weekly_records, 0);\n          const userName = safeText(ranking?.user_name, \"ユーザー\");\n\n          return (\n            <div\n              key={userId}\n              className={`flex items-center justify-between p-3 rounded-lg transition-all ${\n                isMe\n                  ? \"bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-300 dark:border-blue-700\"\n                  : \"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:shadow-md\"\n              }`}\n            >\n              <div className=\"flex items-center space-x-3 flex-1\">\n                <div\n                  className={`flex items-center justify-center w-8 h-8 rounded-full font-bold ${\n                    medal ? `${medal.bg} ${medal.color}` : \"bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400\"\n                  }`}\n                >\n                  {medal ? <medal.icon className=\"w-5 h-5\" /> : <span className=\"text-sm\">{rankNum || \"—\"}</span>}\n                </div>\n\n                <div className=\"flex-1\">\n                  <p className={`font-semibold ${isMe ? \"text-blue-700 dark:text-blue-400\" : \"text-gray-900 dark:text-white\"}`}>\n                    {userName}\n                    {isMe && <span className=\"ml-2 text-xs text-blue-600 dark:text-blue-400\">(あなた)</span>}\n                  </p>\n                </div>\n\n                <div className=\"text-right\">\n                  <p className=\"text-sm font-semibold text-gray-900 dark:text-white\">{weeklyRecords}回</p>\n                  <p className=\"text-xs text-gray-500 dark:text-gray-400\">今週</p>\n                </div>\n              </div>\n            </div>\n          );\n        })}\n\n        {myRank && safeNumber((myRank as any)?.rank, 0) > limit && (\n          <>\n            <div className=\"flex items-center justify-center py-2\">\n              <div className=\"w-12 h-0.5 bg-gray-300 dark:bg-gray-600\" />\n            </div>\n\n            <div className=\"flex items-center justify-between p-3 rounded-lg bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-300 dark:border-blue-700\">\n              <div className=\"flex items-center space-x-3 flex-1\">\n                <div className=\"flex items-center justify-center w-8 h-8 rounded-full font-bold bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400\">\n                  <span className=\"text-sm\">{safeNumber((myRank as any)?.rank, 0) || \"—\"}</span>\n                </div>\n\n                <div className=\"flex-1\">\n                  <p className=\"font-semibold text-blue-700 dark:text-blue-400\">\n                    {safeText((myRank as any)?.user_name, \"あなた\")}\n                    <span className=\"ml-2 text-xs\">(あなた)</span>\n                  </p>\n                </div>\n\n                <div className=\"text-right\">\n                  <p className=\"text-sm font-semibold text-gray-900 dark:text-white\">\n                    {safeNumber((myRank as any)?.weekly_records, 0)}回\n                  </p>\n                  <p className=\"text-xs text-gray-500 dark:text-gray-400\">今週</p>\n                </div>\n              </div>\n            </div>\n          </>\n        )}\n      </div>\n    );\n  };\n\n  const renderPointsRankings = () => {\n    const myRank = points.find((r: any) => r?.user_id === myUserId);\n\n    return (\n      <div className=\"space-y-2\">\n        {points.slice(0, limit).map((ranking: any) => {\n          const rankNum = safeNumber(ranking?.rank, 0);\n          const medal = getRankMedal(rankNum);\n          const userId = safeText(ranking?.user_id, `row-${rankNum}`);\n          const isMe = ranking?.user_id === myUserId;\n\n          const totalPoints = safeNumber(ranking?.total_points, 0);\n          const currentLevel = safeNumber(ranking?.current_level, 0);\n          const userName = safeText(ranking?.user_name, \"ユーザー\");\n\n          return (\n            <div\n              key={userId}\n              className={`flex items-center justify-between p-3 rounded-lg transition-all ${\n                isMe\n                  ? \"bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-300 dark:border-blue-700\"\n                  : \"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:shadow-md\"\n              }`}\n            >\n              <div className=\"flex items-center space-x-3 flex-1\">\n                <div\n                  className={`flex items-center justify-center w-8 h-8 rounded-full font-bold ${\n                    medal ? `${medal.bg} ${medal.color}` : \"bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400\"\n                  }`}\n                >\n                  {medal ? <medal.icon className=\"w-5 h-5\" /> : <span className=\"text-sm\">{rankNum || \"—\"}</span>}\n                </div>\n\n                <div className=\"flex-1\">\n                  <p className={`font-semibold ${isMe ? \"text-blue-700 dark:text-blue-400\" : \"text-gray-900 dark:text-white\"}`}>\n                    {userName}\n                    {isMe && <span className=\"ml-2 text-xs text-blue-600 dark:text-blue-400\">(あなた)</span>}\n                  </p>\n                  <p className=\"text-xs text-gray-500 dark:text-gray-400\">Lv.{currentLevel}</p>\n                </div>\n\n                <div className=\"text-right\">\n                  <p className=\"text-sm font-semibold text-gray-900 dark:text-white\">\n                    {totalPoints.toLocaleString()}pt\n                  </p>\n                </div>\n              </div>\n            </div>\n          );\n        })}\n\n        {myRank && safeNumber((myRank as any)?.rank, 0) > limit && (\n          <>\n            <div className=\"flex items-center justify-center py-2\">\n              <div className=\"w-12 h-0.5 bg-gray-300 dark:bg-gray-600\" />\n            </div>\n\n            <div className=\"flex items-center justify-between p-3 rounded-lg bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-300 dark:border-blue-700\">\n              <div className=\"flex items-center space-x-3 flex-1\">\n                <div className=\"flex items-center justify-center w-8 h-8 rounded-full font-bold bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400\">\n                  <span className=\"text-sm\">{safeNumber((myRank as any)?.rank, 0) || \"—\"}</span>\n                </div>\n\n                <div className=\"flex-1\">\n                  <p className=\"font-semibold text-blue-700 dark:text-blue-400\">\n                    {safeText((myRank as any)?.user_name, \"あなた\")}\n                    <span className=\"ml-2 text-xs\">(あなた)</span>\n                  </p>\n                  <p className=\"text-xs text-gray-500 dark:text-gray-400\">Lv.{safeNumber((myRank as any)?.current_level, 0)}</p>\n                </div>\n\n                <div className=\"text-right\">\n                  <p className=\"text-sm font-semibold text-gray-900 dark:text-white\">\n                    {safeNumber((myRank as any)?.total_points, 0).toLocaleString()}pt\n                  </p>\n                </div>\n              </div>\n            </div>\n          </>\n        )}\n      </div>\n    );\n  };\n\n  const currentList = activeTab === \"weekly\" ? weekly : points;\n\n  if (compact) {\n    return (\n      <div className=\"bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 transition-colors\">\n        <div className=\"flex items-center space-x-2 mb-4\">\n          <Users className=\"w-5 h-5 text-blue-600 dark:text-blue-400\" />\n          <h3 className=\"text-lg font-semibold text-gray-900 dark:text-white\">チームランキング</h3>\n        </div>\n\n        {activeTab === \"weekly\" ? renderWeeklyRankings() : renderPointsRankings()}\n\n        {currentList.length === 0 && (\n          <div className=\"text-center py-10\">\n            <Users className=\"w-10 h-10 text-gray-300 dark:text-gray-600 mx-auto mb-3\" />\n            <p className=\"text-gray-500 dark:text-gray-400\">ランキングデータがありません</p>\n          </div>\n        )}\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden transition-colors\">\n      {/* Header */}\n      <div className=\"p-6 border-b border-gray-200 dark:border-gray-700\">\n        <div className=\"flex items-center space-x-2 mb-4\">\n          <Users className=\"w-6 h-6 text-blue-600 dark:text-blue-400\" />\n          <h2 className=\"text-2xl font-bold text-gray-900 dark:text-white\">チームランキング</h2>\n        </div>\n\n        {/* Tabs */}\n        <div className=\"flex space-x-2 bg-gray-100 dark:bg-gray-700 p-1 rounded-lg\">\n          <button\n            onClick={() => setActiveTab(\"weekly\")}\n            className={`flex-1 flex items-center justify-center space-x-2 px-4 py-2 rounded-md text-sm font-medium transition-colors ${\n              activeTab === \"weekly\"\n                ? \"bg-white dark:bg-gray-600 text-blue-600 dark:text-blue-400 shadow-sm\"\n                : \"text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white\"\n            }`}\n          >\n            <TrendingUp className=\"w-4 h-4\" />\n            <span>週間記録数</span>\n          </button>\n\n          <button\n            onClick={() => setActiveTab(\"points\")}\n            className={`flex-1 flex items-center justify-center space-x-2 px-4 py-2 rounded-md text-sm font-medium transition-colors ${\n              activeTab === \"points\"\n                ? \"bg-white dark:bg-gray-600 text-blue-600 dark:text-blue-400 shadow-sm\"\n                : \"text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white\"\n            }`}\n          >\n            <Trophy className=\"w-4 h-4\" />\n            <span>総ポイント</span>\n          </button>\n        </div>\n      </div>\n\n      {/* Content */}\n      <div className=\"p-6\">\n        {activeTab === \"weekly\" ? renderWeeklyRankings() : renderPointsRankings()}\n\n        {currentList.length === 0 && (\n          <div className=\"text-center py-12\">\n            <Users className=\"w-12 h-12 text-gray-300 dark:text-gray-600 mx-auto mb-3\" />\n            <p className=\"text-gray-500 dark:text-gray-400\">ランキングデータがありません</p>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}","import React, { useEffect, useMemo, useState } from \"react\";\nimport { X, Trophy, Star, Sparkles, TrendingUp } from \"lucide-react\";\nimport * as confettiNS from \"canvas-confetti\";\n\ninterface LevelUpModalProps {\n  newLevel: number;\n  rankTitle: string;\n  onClose: () => void;\n}\n\nexport function LevelUpModal({ newLevel, rankTitle, onClose }: LevelUpModalProps) {\n  const [isVisible, setIsVisible] = useState(false);\n\n  // ✅ ESM/CJS どっちでも「関数」を取り出す\n  const confettiFn = useMemo(() => {\n    const anyNS = confettiNS as any;\n    const fn = anyNS?.default ?? anyNS;\n    return typeof fn === \"function\" ? fn : null;\n  }, []);\n\n  useEffect(() => {\n    setIsVisible(true);\n\n    // ✅ confetti が取れなければ「演出なし」で続行（絶対に落とさない）\n    if (!confettiFn) {\n      console.warn(\"[LevelUpModal] canvas-confetti function not available (skipping confetti).\");\n      return;\n    }\n\n    try {\n      const duration = 4000;\n      const end = Date.now() + duration;\n\n      (function frame() {\n        // 左右から少量ずつ（軽い）\n        confettiFn({\n          particleCount: 2,\n          angle: 60,\n          spread: 55,\n          origin: { x: 0 },\n          colors: [\"#FFD700\", \"#FFA500\", \"#FF6347\"],\n        });\n        confettiFn({\n          particleCount: 2,\n          angle: 120,\n          spread: 55,\n          origin: { x: 1 },\n          colors: [\"#FFD700\", \"#FFA500\", \"#FF6347\"],\n        });\n\n        if (Date.now() < end) requestAnimationFrame(frame);\n      })();\n    } catch (e) {\n      console.warn(\"[LevelUpModal] confetti threw error (skipping).\", e);\n    }\n  }, [confettiFn]);\n\n  const getRankColor = () => {\n    if (newLevel >= 50) return \"from-purple-600 via-pink-600 to-purple-600\";\n    if (newLevel >= 40) return \"from-red-600 via-orange-600 to-red-600\";\n    if (newLevel >= 30) return \"from-orange-600 via-yellow-600 to-orange-600\";\n    if (newLevel >= 20) return \"from-yellow-600 via-green-600 to-yellow-600\";\n    if (newLevel >= 10) return \"from-green-600 via-blue-600 to-green-600\";\n    return \"from-blue-600 via-cyan-600 to-blue-600\";\n  };\n\n  // 背景の星位置は render ごとに変わるとチラつくので固定化\n  const stars = useMemo(\n    () =>\n      Array.from({ length: 8 }).map((_, i) => ({\n        key: i,\n        top: `${Math.random() * 100}%`,\n        left: `${Math.random() * 100}%`,\n        delay: `${i * 0.3}s`,\n        duration: \"2s\",\n      })),\n    []\n  );\n\n  return (\n    <div className=\"fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black bg-opacity-70 backdrop-blur-sm\">\n      <div\n        className={`bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full overflow-hidden transition-all duration-500 transform ${\n          isVisible ? \"scale-100 opacity-100\" : \"scale-90 opacity-0\"\n        }`}\n      >\n        {/* Header */}\n        <div className={`relative p-8 bg-gradient-to-r ${getRankColor()} text-white overflow-hidden`}>\n          <div className=\"absolute inset-0 bg-black opacity-10\" />\n\n          {/* Animated background elements */}\n          <div className=\"absolute inset-0 overflow-hidden\">\n            {stars.map((s) => (\n              <div\n                key={s.key}\n                className=\"absolute animate-pulse\"\n                style={{\n                  top: s.top,\n                  left: s.left,\n                  animationDelay: s.delay,\n                  animationDuration: s.duration,\n                }}\n              >\n                <Star className=\"w-4 h-4 text-white opacity-30\" />\n              </div>\n            ))}\n          </div>\n\n          <div className=\"relative z-10\">\n            <button\n              onClick={onClose}\n              className=\"absolute top-0 right-0 p-2 hover:bg-white hover:bg-opacity-20 rounded-lg transition-colors\"\n              aria-label=\"閉じる\"\n            >\n              <X className=\"w-5 h-5\" />\n            </button>\n\n            <div className=\"text-center\">\n              <div className=\"inline-flex items-center justify-center mb-4\">\n                <div className=\"relative\">\n                  <div\n                    className=\"absolute inset-0 bg-white opacity-20 rounded-full animate-ping\"\n                    style={{ animationDuration: \"1.5s\" }}\n                  />\n                  <div\n                    className=\"absolute inset-0 bg-white opacity-20 rounded-full animate-ping\"\n                    style={{ animationDelay: \"0.5s\", animationDuration: \"1.5s\" }}\n                  />\n                  <div className=\"relative bg-white bg-opacity-20 backdrop-blur-sm p-6 rounded-full\">\n                    <Trophy className=\"w-16 h-16 animate-bounce\" style={{ animationDuration: \"1s\" }} />\n                  </div>\n                </div>\n              </div>\n\n              <h2 className=\"text-4xl font-bold mb-2 animate-pulse\">LEVEL UP!</h2>\n              <p className=\"text-white text-opacity-90 text-lg\">レベルアップしました！</p>\n            </div>\n          </div>\n        </div>\n\n        {/* Body */}\n        <div className=\"p-6\">\n          <div className=\"text-center mb-6\">\n            <div className=\"flex items-center justify-center space-x-4 mb-4\">\n              <div className=\"flex items-center space-x-2\">\n                <span className=\"text-4xl font-bold text-gray-400 dark:text-gray-500\">\n                  Lv.{Math.max(0, newLevel - 1)}\n                </span>\n              </div>\n              <TrendingUp className=\"w-6 h-6 text-gray-400\" />\n              <div className=\"flex items-center space-x-2\">\n                <span\n                  className={`text-4xl font-bold bg-gradient-to-r ${getRankColor()} bg-clip-text text-transparent`}\n                >\n                  Lv.{newLevel}\n                </span>\n                <Sparkles className=\"w-6 h-6 text-yellow-500 animate-pulse\" />\n              </div>\n            </div>\n\n            <div className=\"mb-4\">\n              <div className=\"inline-block\">\n                <span\n                  className={`px-4 py-2 rounded-full text-lg font-bold bg-gradient-to-r ${getRankColor()} text-white shadow-lg`}\n                >\n                  {rankTitle}\n                </span>\n              </div>\n            </div>\n\n            <p className=\"text-gray-600 dark:text-gray-400 mb-4\">\n              おめでとうございます！新しいランクに到達しました\n            </p>\n\n            <div className=\"bg-gradient-to-br from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-xl p-4 border border-blue-200 dark:border-blue-800\">\n              <p className=\"text-sm font-semibold text-gray-900 dark:text-white mb-2\">レベル{newLevel}特典</p>\n              <div className=\"space-y-1 text-sm text-gray-600 dark:text-gray-400\">\n                <p>• より多くのポイント獲得ボーナス</p>\n                <p>• 新しいバッジ獲得チャンス</p>\n                <p>• チーム内でのステータス向上</p>\n              </div>\n            </div>\n          </div>\n\n          <button\n            onClick={onClose}\n            className={`w-full py-3 rounded-xl font-semibold text-white bg-gradient-to-r ${getRankColor()} hover:shadow-lg transform hover:scale-105 transition-all`}\n          >\n            さらに成長する！\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n}","import React from \"react\";\n\ntype Props = {\n  children: React.ReactNode;\n  title?: string;\n  description?: string;\n  compact?: boolean;\n};\n\ntype State = {\n  hasError: boolean;\n  error?: any;\n};\n\nexport class ErrorBoundary extends React.Component<Props, State> {\n  state: State = { hasError: false };\n\n  static getDerivedStateFromError(error: any) {\n    return { hasError: true, error };\n  }\n\n  componentDidCatch(error: any, info: any) {\n    console.error(\"[ErrorBoundary] caught\", error, info);\n  }\n\n  retry = () => this.setState({ hasError: false, error: undefined });\n\n  render() {\n    if (!this.state.hasError) return this.props.children;\n\n    const title = this.props.title ?? \"この表示でエラーが起きました\";\n    const desc =\n      this.props.description ??\n      \"このセクションだけ復旧できます。もう一度表示を試してください。\";\n\n    if (this.props.compact) {\n      return (\n        <div className=\"rounded-xl border bg-white p-4 dark:bg-gray-800\">\n          <div className=\"font-semibold text-gray-900 dark:text-white\">{title}</div>\n          <div className=\"mt-1 text-sm text-gray-600 dark:text-gray-300\">{desc}</div>\n          <div className=\"mt-3 flex gap-2\">\n            <button\n              onClick={this.retry}\n              className=\"rounded-lg bg-black px-3 py-2 text-sm font-medium text-white\"\n            >\n              再表示\n            </button>\n          </div>\n\n          {import.meta.env.DEV && this.state.error && (\n            <pre className=\"mt-3 max-h-40 overflow-auto rounded-lg bg-gray-50 p-2 text-xs text-red-600 dark:bg-gray-900/40\">\n              {String(this.state.error?.stack ?? this.state.error)}\n            </pre>\n          )}\n        </div>\n      );\n    }\n\n    return (\n      <div className=\"rounded-2xl border bg-white p-5 shadow-sm dark:bg-gray-800\">\n        <div className=\"text-lg font-bold text-gray-900 dark:text-white\">{title}</div>\n        <div className=\"mt-1 text-sm text-gray-600 dark:text-gray-300\">{desc}</div>\n        <div className=\"mt-4 flex flex-wrap gap-2\">\n          <button\n            onClick={this.retry}\n            className=\"rounded-lg bg-black px-3 py-2 text-sm font-medium text-white\"\n          >\n            もう一度表示する\n          </button>\n          <button\n            onClick={() => window.location.reload()}\n            className=\"rounded-lg border px-3 py-2 text-sm font-medium dark:border-gray-700\"\n          >\n            ページを再読み込み\n          </button>\n        </div>\n\n        {import.meta.env.DEV && this.state.error && (\n          <pre className=\"mt-4 max-h-56 overflow-auto rounded-lg bg-gray-50 p-3 text-xs text-red-600 dark:bg-gray-900/40\">\n            {String(this.state.error?.stack ?? this.state.error)}\n          </pre>\n        )}\n      </div>\n    );\n  }\n}","// src/components/PointHistoryModal.tsx\nimport React, { useEffect, useMemo } from \"react\";\nimport { X, RefreshCw, Clock, Tag } from \"lucide-react\";\n\ntype Tx = {\n  id: string;\n  user_id: string;\n  points: number;\n  reason: string | null;\n  category: string | null;\n  metadata: any;\n  created_at: string; // timestamptz\n};\n\ntype Props = {\n  open: boolean;\n  onClose: () => void;\n  transactions: Tx[];\n  loading: boolean;\n  onReload?: () => Promise<void> | void;\n};\n\nfunction formatJST(iso: string) {\n  try {\n    const d = new Date(iso);\n    const date = new Intl.DateTimeFormat(\"ja-JP\", {\n      timeZone: \"Asia/Tokyo\",\n      year: \"numeric\",\n      month: \"2-digit\",\n      day: \"2-digit\",\n    }).format(d);\n    const time = new Intl.DateTimeFormat(\"ja-JP\", {\n      timeZone: \"Asia/Tokyo\",\n      hour: \"2-digit\",\n      minute: \"2-digit\",\n      hour12: false,\n    }).format(d);\n    return { date, time };\n  } catch {\n    return { date: \"----/--/--\", time: \"--:--\" };\n  }\n}\n\nfunction categoryLabel(cat?: string | null) {\n  const c = (cat ?? \"\").toLowerCase();\n  if (!c) return \"その他\";\n  if (c.includes(\"streak\")) return \"ストリーク\";\n  if (c.includes(\"badge\")) return \"バッジ\";\n  if (c.includes(\"login\")) return \"ログイン\";\n  if (c.includes(\"manual\")) return \"手動\";\n  if (c.includes(\"admin\")) return \"管理者\";\n  if (c.includes(\"training\")) return \"トレーニング\";\n  if (c.includes(\"weight\")) return \"体重\";\n  if (c.includes(\"sleep\")) return \"睡眠\";\n  if (c.includes(\"motivation\")) return \"モチベ\";\n  return cat ?? \"その他\";\n}\n\nfunction categoryTone(cat?: string | null) {\n  const c = (cat ?? \"\").toLowerCase();\n  if (c.includes(\"badge\")) return \"bg-yellow-50 text-yellow-700 dark:bg-yellow-900/20 dark:text-yellow-300\";\n  if (c.includes(\"streak\")) return \"bg-orange-50 text-orange-700 dark:bg-orange-900/20 dark:text-orange-300\";\n  if (c.includes(\"training\")) return \"bg-blue-50 text-blue-700 dark:bg-blue-900/20 dark:text-blue-300\";\n  if (c.includes(\"sleep\")) return \"bg-indigo-50 text-indigo-700 dark:bg-indigo-900/20 dark:text-indigo-300\";\n  if (c.includes(\"weight\")) return \"bg-emerald-50 text-emerald-700 dark:bg-emerald-900/20 dark:text-emerald-300\";\n  return \"bg-gray-50 text-gray-700 dark:bg-gray-800 dark:text-gray-300\";\n}\n\nexport function PointHistoryModal({ open, onClose, transactions, loading, onReload }: Props) {\n  // ESCで閉じる\n  useEffect(() => {\n    if (!open) return;\n    const onKeyDown = (e: KeyboardEvent) => {\n      if (e.key === \"Escape\") onClose();\n    };\n    window.addEventListener(\"keydown\", onKeyDown);\n    return () => window.removeEventListener(\"keydown\", onKeyDown);\n  }, [open, onClose]);\n\n  const grouped = useMemo(() => {\n    const map = new Map<string, Tx[]>();\n    for (const tx of transactions ?? []) {\n      const { date } = formatJST(tx.created_at);\n      const arr = map.get(date) ?? [];\n      arr.push(tx);\n      map.set(date, arr);\n    }\n    // 日付降順、各日付内も created_at 降順\n    const keys = Array.from(map.keys()).sort((a, b) => (a < b ? 1 : -1));\n    return keys.map((k) => ({\n      date: k,\n      items: (map.get(k) ?? []).sort((a, b) => (a.created_at < b.created_at ? 1 : -1)),\n    }));\n  }, [transactions]);\n\n  if (!open) return null;\n\n  const hasItems = (transactions?.length ?? 0) > 0;\n\n  return (\n    <div className=\"fixed inset-0 z-[100]\">\n      {/* overlay */}\n      <div\n        className=\"absolute inset-0 bg-black/40\"\n        onClick={onClose}\n      />\n\n      {/* dialog */}\n      <div className=\"absolute inset-0 flex items-center justify-center p-4\">\n        <div className=\"w-full max-w-2xl bg-white dark:bg-gray-900 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 overflow-hidden\">\n          {/* header */}\n          <div className=\"flex items-center justify-between px-5 py-4 border-b border-gray-200 dark:border-gray-700\">\n            <div>\n              <h3 className=\"text-lg font-bold text-gray-900 dark:text-white\">ポイント履歴</h3>\n              <p className=\"text-xs text-gray-500 dark:text-gray-400 mt-1\">\n                獲得・減少したポイントの記録です（JST表示）\n              </p>\n            </div>\n\n            <div className=\"flex items-center gap-2\">\n              {onReload && (\n                <button\n                  onClick={onReload}\n                  disabled={loading}\n                  className=\"inline-flex items-center gap-2 px-3 py-2 rounded-lg text-sm\n                             bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700\n                             hover:bg-gray-50 dark:hover:bg-gray-700\n                             text-gray-900 dark:text-white transition-colors\n                             disabled:opacity-60 disabled:cursor-not-allowed\"\n                  title=\"更新\"\n                >\n                  <RefreshCw className={`w-4 h-4 ${loading ? \"animate-spin\" : \"\"}`} />\n                  更新\n                </button>\n              )}\n\n              <button\n                onClick={onClose}\n                className=\"p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300\"\n                title=\"閉じる\"\n              >\n                <X className=\"w-5 h-5\" />\n              </button>\n            </div>\n          </div>\n\n          {/* body */}\n          <div className=\"max-h-[70vh] overflow-y-auto px-5 py-4\">\n            {loading && !hasItems ? (\n              <div className=\"h-48 flex items-center justify-center\">\n                <div className=\"animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600\" />\n              </div>\n            ) : !hasItems ? (\n              <div className=\"h-48 flex flex-col items-center justify-center text-center\">\n                <p className=\"text-sm font-semibold text-gray-900 dark:text-white\">まだ履歴がありません</p>\n                <p className=\"text-xs text-gray-500 dark:text-gray-400 mt-2\">\n                  記録やバッジ獲得でポイントが付与されると、ここに表示されます。\n                </p>\n                {onReload && (\n                  <button\n                    onClick={onReload}\n                    className=\"mt-4 inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm\n                               bg-blue-600 hover:bg-blue-700 text-white transition-colors\"\n                  >\n                    <RefreshCw className=\"w-4 h-4\" />\n                    再読み込み\n                  </button>\n                )}\n              </div>\n            ) : (\n              <div className=\"space-y-5\">\n                {grouped.map((g) => (\n                  <div key={g.date}>\n                    <div className=\"text-xs font-semibold text-gray-600 dark:text-gray-300 mb-2\">\n                      {g.date}\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      {g.items.map((tx) => {\n                        const { time } = formatJST(tx.created_at);\n                        const pts = Number(tx.points ?? 0);\n                        const sign = pts > 0 ? \"+\" : \"\";\n                        const reason = (tx.reason ?? \"\").trim() || \"ポイント付与\";\n                        const cat = categoryLabel(tx.category);\n                        const catTone = categoryTone(tx.category);\n\n                        return (\n                          <div\n                            key={tx.id}\n                            className=\"rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-3\"\n                          >\n                            <div className=\"flex items-start justify-between gap-3\">\n                              <div className=\"min-w-0\">\n                                <div className=\"flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400\">\n                                  <span className=\"inline-flex items-center gap-1\">\n                                    <Clock className=\"w-3.5 h-3.5\" />\n                                    {time}\n                                  </span>\n                                  <span className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full ${catTone}`}>\n                                    <Tag className=\"w-3.5 h-3.5\" />\n                                    {cat}\n                                  </span>\n                                </div>\n\n                                <div className=\"mt-1 text-sm font-semibold text-gray-900 dark:text-white truncate\">\n                                  {reason}\n                                </div>\n\n                                {/* metadataの軽いヒント（あれば） */}\n                                {tx.metadata?.source && (\n                                  <div className=\"mt-1 text-xs text-gray-500 dark:text-gray-400\">\n                                    source: {String(tx.metadata.source)}\n                                  </div>\n                                )}\n                              </div>\n\n                              <div\n                                className={`shrink-0 text-sm font-bold ${\n                                  pts >= 0 ? \"text-blue-700 dark:text-blue-300\" : \"text-red-600 dark:text-red-300\"\n                                }`}\n                              >\n                                {sign}\n                                {pts.toLocaleString()} pt\n                              </div>\n                            </div>\n                          </div>\n                        );\n                      })}\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n          </div>\n\n          {/* footer */}\n          <div className=\"px-5 py-3 border-t border-gray-200 dark:border-gray-700 flex justify-end\">\n            <button\n              onClick={onClose}\n              className=\"px-4 py-2 rounded-lg text-sm\n                         bg-gray-100 dark:bg-gray-800\n                         hover:bg-gray-200 dark:hover:bg-gray-700\n                         text-gray-900 dark:text-white transition-colors\"\n            >\n              閉じる\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}","// src/components/RankStatsCard.tsx\nimport React, { useMemo } from \"react\";\nimport type { RankScope, RankStats } from \"../hooks/useRankStats\";\nimport { Globe, Building2, Users, ChevronRight } from \"lucide-react\";\n\nfunction scopeLabel(scope: RankScope) {\n  if (scope === \"global\") return \"全体\";\n  if (scope === \"organization\") return \"組織内\";\n  return \"チーム内\";\n}\n\nfunction scopeIcon(scope: RankScope) {\n  if (scope === \"global\") return <Globe className=\"w-5 h-5\" />;\n  if (scope === \"organization\") return <Building2 className=\"w-5 h-5\" />;\n  return <Users className=\"w-5 h-5\" />;\n}\n\nexport function RankStatsCard({\n  scope,\n  data,\n  loading,\n  error,\n}: {\n  scope: RankScope;\n  data: RankStats | null;\n  loading: boolean;\n  error: string | null;\n}) {\n  const headline = useMemo(() => {\n    if (!data) return null;\n    const total = data.total_users ?? 0;\n    const rank = data.my_rank;\n    const pct = data.top_percent;\n\n    if (!total || rank == null || pct == null) return `${scopeLabel(scope)}の順位データがありません`;\n    return `${total.toLocaleString()}人中 ${rank.toLocaleString()}位（上位 ${pct}%）`;\n  }, [data, scope]);\n\n  // ✅ 分布：表示順を逆に（ビギナーⅠが最下層になる想定）\n  const dist = useMemo(() => {\n    const arr = (data?.distribution ?? []).slice();\n    return arr.reverse();\n  }, [data?.distribution]);\n\n  // ✅ 最大人数（棒グラフの100%基準）\n  const maxCount = useMemo(() => {\n    const m = Math.max(0, ...dist.map((d) => Number(d.count ?? 0)));\n    return m > 0 ? m : 1;\n  }, [dist]);\n\n  return (\n    <div className=\"bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4\">\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center space-x-2 text-gray-900 dark:text-white\">\n          <div className=\"p-2 rounded-lg bg-gray-50 dark:bg-gray-700\">{scopeIcon(scope)}</div>\n          <div>\n            <div className=\"text-xs text-gray-600 dark:text-gray-400\">{scopeLabel(scope)}ランキング</div>\n            <div className=\"text-base font-semibold\">{loading ? \"読み込み中…\" : headline ?? \"—\"}</div>\n          </div>\n        </div>\n      </div>\n\n      {error && <div className=\"mt-2 text-xs text-red-600 dark:text-red-400\">error: {error}</div>}\n\n      {/* ✅ ランク分布（横棒グラフ：最大人数が横幅いっぱい） */}\n      {dist.length ? (\n        <div className=\"mt-3\">\n          <div className=\"text-xs text-gray-600 dark:text-gray-400 mb-2\">人数分布</div>\n\n          <div className=\"space-y-2\">\n            {dist.map((d) => {\n              const count = Number(d.count ?? 0);\n              const pct = Math.round((count / maxCount) * 100); // 0〜100\n              return (\n                <div key={d.rank_title} className=\"space-y-1\">\n                  <div className=\"flex items-center justify-between text-xs\">\n                    <span className=\"text-gray-800 dark:text-gray-200\">{d.rank_title}</span>\n                    <span className=\"text-gray-600 dark:text-gray-400\">{count.toLocaleString()}人</span>\n                  </div>\n\n                  <div className=\"w-full h-2 rounded-full bg-gray-200 dark:bg-gray-700 overflow-hidden\">\n                    <div\n                      className=\"h-full rounded-full bg-blue-600\"\n                      style={{ width: `${pct}%` }}\n                      aria-label={`${d.rank_title} ${count}人`}\n                    />\n                  </div>\n                </div>\n              );\n            })}\n          </div>\n        </div>\n      ) : (\n        <div className=\"mt-3 text-xs text-gray-500 dark:text-gray-400\">分布データはまだありません</div>\n      )}\n    </div>\n  );\n}","// src/components/GamificationView.tsx\nimport React, { useEffect, useMemo, useRef, useState } from \"react\";\nimport { Trophy, Award, Users, Flame, HelpCircle } from \"lucide-react\";\n\nimport { useStreaks } from \"../hooks/useStreaks\";\nimport { usePoints } from \"../hooks/usePoints\";\nimport { useBadges } from \"../hooks/useBadges\";\nimport { useRankings } from \"../hooks/useRankings\";\nimport { useRealtimeHub } from \"../hooks/useRealtimeHub\";\n\nimport { StreakDisplay } from \"./StreakDisplay\";\nimport { LevelProgressCard } from \"./LevelProgressCard\";\nimport { BadgeCollection } from \"./BadgeCollection\";\nimport { BadgeEarnedModal } from \"./BadgeEarnedModal\";\nimport { TeamRankings } from \"./TeamRankings\";\nimport { LevelUpModal } from \"./LevelUpModal\";\nimport { TutorialController } from \"./TutorialController\";\nimport { getTutorialSteps } from \"../lib/tutorialContent\";\nimport { ErrorBoundary } from \"./ErrorBoundary\";\nimport { PointHistoryModal } from \"./PointHistoryModal\";\nimport { useRankStats } from \"../hooks/useRankStats\";\nimport { RankStatsCard } from \"./RankStatsCard\";\n\ninterface GamificationViewProps {\n  userId: string;\n  userTeamId: string | null;\n}\n\nexport function GamificationView({ userId, userTeamId }: GamificationViewProps) {\n  // ✅ Hubの状態（visibility/onlineなど）を見るログ\n  const { state } = useRealtimeHub();\n  useEffect(() => {\n    console.log(\"[RealtimeHub state]\", state);\n  }, [state]);\n\n  // ✅ props確認ログ\n  useEffect(() => {\n    console.log(\"[Gamification] props\", { userId, userTeamId });\n  }, [userId, userTeamId]);\n\n  // --- Hooks ---\n  const { loading: streaksLoading, getStreakByType, getTotalStreak } = useStreaks(userId);\n\n  const {\n    scope: globalScope,\n    setScope: setGlobalScope,\n    availableScopes,\n    data: globalStats,\n    loading: globalStatsLoading,\n    error: globalStatsError,\n  } = useRankStats(userId, userTeamId, {\n    enabled: true,\n    pollMs: 120000,\n    pauseWhenHidden: true,\n    defaultScope: \"global\",\n  });\n\n  // ✅ transactions を初回で取らない（通信削減の本命）\n  const {\n    userPoints,\n    loading: pointsLoading,\n    getLevelProgress,\n    transactions,\n    transactionsLoading,\n    loadTransactions,\n  } = usePoints(userId, {\n    includeTransactions: false, // ✅ 初回0回（point_transactions）\n    transactionsLimit: 50,\n  });\n\n  const {\n    allBadges,\n    userBadges,\n    loading: badgesLoading,\n    getNewBadges,\n    markBadgeAsViewed,\n    getBadgeProgress,\n  } = useBadges(userId, {\n    enabled: true,\n    pollMs: 5 * 60 * 1000,\n  });\n\n  // --- Rankings lazy enable（ランキング領域が見えたらON）---\n  const [rankingsEl, setRankingsEl] = useState<HTMLDivElement | null>(null);\n  const [rankingsEnabled, setRankingsEnabled] = useState(false);\n  const offTimerRef = useRef<number | null>(null);\n\n  useEffect(() => {\n    console.log(\"[Gamification] rankingsEl set?\", !!rankingsEl);\n  }, [rankingsEl]);\n\n  useEffect(() => {\n    if (!rankingsEl) return;\n\n    console.log(\"[Gamification] IntersectionObserver setup\");\n\n    const obs = new IntersectionObserver(\n      (entries) => {\n        const inView = entries.some((e) => e.isIntersecting);\n        console.log(\"[Gamification] rankings inView?\", inView);\n\n        if (inView) {\n          console.log(\"[Gamification] ✅ rankingsEnabled -> true\");\n          setRankingsEnabled(true);\n          obs.disconnect();\n\n          if (offTimerRef.current) {\n            window.clearTimeout(offTimerRef.current);\n            offTimerRef.current = null;\n          }\n        }\n      },\n      { threshold: 0, rootMargin: \"200px 0px\" }\n    );\n\n    obs.observe(rankingsEl);\n\n    return () => {\n      obs.disconnect();\n      if (offTimerRef.current) {\n        window.clearTimeout(offTimerRef.current);\n        offTimerRef.current = null;\n      }\n    };\n  }, [rankingsEl]);\n\n  useEffect(() => {\n    console.log(\"[Gamification] rankingsEnabled:\", rankingsEnabled);\n  }, [rankingsEnabled]);\n\n  // ✅ Ranking（view参照＝ポーリング前提）\n  const { weeklyRankings, pointsRankings, loading: rankingsLoading, error: rankingsError } =\n    useRankings(userTeamId, {\n      enabled: rankingsEnabled && !!userTeamId,\n      pollMs: 120000,\n      pauseWhenHidden: true,\n    });\n\n  useEffect(() => {\n    console.log(\"[Gamification] rankings state\", {\n      enabled: rankingsEnabled && !!userTeamId,\n      userTeamId,\n      rankingsLoading,\n      weeklyLen: weeklyRankings?.length ?? 0,\n      pointsLen: pointsRankings?.length ?? 0,\n      rankingsError,\n    });\n  }, [rankingsEnabled, userTeamId, rankingsLoading, weeklyRankings, pointsRankings, rankingsError]);\n\n  // --- UI State ---\n  const [showBadgeCollection, setShowBadgeCollection] = useState(false);\n  const [newBadgeToShow, setNewBadgeToShow] = useState<any>(null);\n  const [levelUpData, setLevelUpData] = useState<{ level: number; rankTitle: string } | null>(null);\n  const [showTutorial, setShowTutorial] = useState(false);\n\n  // ✅ ポイント履歴モーダル\n  const [showPointHistory, setShowPointHistory] = useState(false);\n\n  // ✅ 全体ローディング（rankings は画面全体のローディングには含めない）\n  const loading = streaksLoading || pointsLoading || badgesLoading;\n\n  const levelProgress = useMemo(() => {\n    if (pointsLoading) return 0;\n    try {\n      return getLevelProgress();\n    } catch (e) {\n      console.warn(\"[GamificationView] getLevelProgress failed\", e);\n      return 0;\n    }\n  }, [pointsLoading, getLevelProgress]);\n\n  const newBadges = useMemo(() => {\n    if (badgesLoading) return [];\n    try {\n      return getNewBadges() ?? [];\n    } catch (e) {\n      console.warn(\"[GamificationView] getNewBadges failed\", e);\n      return [];\n    }\n  }, [badgesLoading, getNewBadges]);\n\n  const badgeProgress = useMemo(() => {\n    if (badgesLoading) return { earned: 0, total: 0, percentage: 0 };\n    try {\n      return getBadgeProgress() ?? { earned: 0, total: 0, percentage: 0 };\n    } catch (e) {\n      console.warn(\"[GamificationView] getBadgeProgress failed\", e);\n      return { earned: 0, total: 0, percentage: 0 };\n    }\n  }, [badgesLoading, getBadgeProgress]);\n\n  // ---------------------------------------\n  // ✅ レベルアップ検知（初回ログインは出さない / ページを開いた時点で上がってても出す）\n  // ---------------------------------------\n  const lastLevelRef = useRef<number | null>(null);\n\n  const levelSeenKey = useMemo(() => {\n    return `bekuta:last_seen_level:${userId || \"unknown\"}`;\n  }, [userId]);\n\n  const getStoredLevel = () => {\n    try {\n      const raw = localStorage.getItem(levelSeenKey);\n      const n = raw == null ? NaN : Number(raw);\n      return Number.isFinite(n) ? n : null;\n    } catch {\n      return null;\n    }\n  };\n\n  const setStoredLevel = (lvl: number) => {\n    try {\n      localStorage.setItem(levelSeenKey, String(lvl));\n    } catch {\n      // Safariプライベート等でも落とさない\n    }\n  };\n\n  useEffect(() => {\n    const curLevel = userPoints?.current_level;\n    if (curLevel == null) return;\n\n    const stored = getStoredLevel();\n\n    // ✅ 初回（保存だけ。初回ログインでモーダルは出さない）\n    if (stored == null) {\n      setStoredLevel(curLevel);\n      lastLevelRef.current = curLevel;\n      return;\n    }\n\n    // ✅ ページを開いた時点で既に上がっていた（stored より大きい）\n    if (curLevel > stored) {\n      setLevelUpData({\n        level: curLevel,\n        rankTitle: userPoints?.rank_title ?? \"\",\n      });\n      // 連続発火防止：出すと決めた時点で保存\n      setStoredLevel(curLevel);\n    }\n\n    // ✅ 表示中に上がった（リアルタイム/再取得）\n    if (lastLevelRef.current != null && curLevel > lastLevelRef.current) {\n      setLevelUpData({\n        level: curLevel,\n        rankTitle: userPoints?.rank_title ?? \"\",\n      });\n      setStoredLevel(curLevel);\n    }\n\n    lastLevelRef.current = curLevel;\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [userPoints?.current_level, userPoints?.rank_title, levelSeenKey]);\n\n  // ---------------------------------------\n  // ✅ 新バッジ演出\n  // ---------------------------------------\n  useEffect(() => {\n    try {\n      if (newBadgeToShow) return;\n      if (!newBadges || newBadges.length === 0) return;\n\n      const badge = newBadges[0];\n      if (badge?.badge) setNewBadgeToShow(badge.badge);\n    } catch (e) {\n      console.warn(\"[GamificationView] new badge effect failed\", e);\n    }\n  }, [newBadges, newBadgeToShow]);\n\n  const handleBadgeModalClose = async () => {\n    try {\n      if (newBadgeToShow && newBadges.length > 0) {\n        const newBadge = newBadges.find((nb: any) => nb?.badge?.id === newBadgeToShow.id);\n        if (newBadge) {\n          await markBadgeAsViewed(newBadge.id);\n        }\n      }\n    } catch (e) {\n      console.warn(\"[GamificationView] markBadgeAsViewed failed\", e);\n    } finally {\n      setNewBadgeToShow(null);\n    }\n  };\n\n  // ✅ ポイント履歴：開いた時だけ取得（初回だけ通信）\n  const openPointHistory = async () => {\n    console.log(\"[Gamification] openPointHistory clicked\");\n    setShowPointHistory(true);\n\n    const currentLen = (transactions ?? []).length;\n    if (currentLen === 0) {\n      console.log(\"[Gamification] loadTransactions start\");\n      await loadTransactions({ silent: false } as any);\n      console.log(\"[Gamification] loadTransactions done\");\n    } else {\n      console.log(\"[Gamification] transactions already loaded (skip fetch)\");\n    }\n  };\n\n  const reloadPointHistory = async () => {\n    console.log(\"[Gamification] reloadPointHistory\");\n    await loadTransactions({ silent: false } as any);\n  };\n\n  return (\n    <ErrorBoundary\n      title=\"ゲーミフィケーションの表示に失敗しました\"\n      description=\"この画面だけ復旧できます。再表示を試してください。\"\n    >\n      {loading ? (\n        <div className=\"flex items-center justify-center h-96\">\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600\" />\n        </div>\n      ) : (\n        <div className=\"space-y-6\">\n          <ErrorBoundary compact title=\"チュートリアルの表示でエラー\">\n            <TutorialController\n              steps={getTutorialSteps(\"gamification\")}\n              isActive={showTutorial}\n              onComplete={() => setShowTutorial(false)}\n              onSkip={() => setShowTutorial(false)}\n            />\n          </ErrorBoundary>\n\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <h2 className=\"text-2xl font-bold text-gray-900 dark:text-white\">ゲーミフィケーション</h2>\n              <p className=\"text-sm text-gray-600 dark:text-gray-400 mt-1\">\n                楽しみながら継続的な記録を！ストリークとバッジで成長を可視化\n              </p>\n            </div>\n            <button\n              onClick={() => setShowTutorial(true)}\n              className=\"flex items-center space-x-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors\"\n              title=\"チュートリアルを表示\"\n            >\n              <HelpCircle className=\"w-5 h-5\" />\n              <span className=\"hidden sm:inline\">チュートリアル</span>\n            </button>\n          </div>\n\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n            <ErrorBoundary compact title=\"ストリーク表示でエラー\">\n              <StreakDisplay\n                streak={getTotalStreak()}\n                label=\"総合ストリーク\"\n                icon={<Flame className=\"w-6 h-6\" />}\n              />\n            </ErrorBoundary>\n\n            <ErrorBoundary compact title=\"レベル表示でエラー\">\n              <div className=\"space-y-3\">\n                <LevelProgressCard userPoints={userPoints} levelProgress={levelProgress} showDetails={false} />\n              </div>\n            </ErrorBoundary>\n\n            <button\n              onClick={() => setShowBadgeCollection(true)}\n              className=\"bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 hover:shadow-md transition-all text-left\"\n              data-tutorial=\"badges-card\"\n            >\n              <div className=\"flex items-start justify-between mb-3\">\n                <div>\n                  <p className=\"text-xs text-gray-600 dark:text-gray-400 mb-1\">バッジコレクション</p>\n                  <div className=\"flex items-baseline space-x-2\">\n                    <p className=\"text-3xl font-bold text-gray-900 dark:text-white\">{badgeProgress.earned}</p>\n                    <span className=\"text-sm text-gray-600 dark:text-gray-400\">/ {badgeProgress.total}</span>\n                  </div>\n                </div>\n                <div className=\"p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg\">\n                  <Award className=\"w-6 h-6 text-yellow-600 dark:text-yellow-400\" />\n                </div>\n              </div>\n\n              <div className=\"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 overflow-hidden\">\n                <div\n                  className=\"h-full bg-gradient-to-r from-yellow-500 to-orange-500 rounded-full transition-all duration-500\"\n                  style={{ width: `${badgeProgress.percentage}%` }}\n                />\n              </div>\n\n              {newBadges.length > 0 && (\n                <div className=\"mt-2 flex items-center space-x-1 text-xs text-red-600 dark:text-red-400 font-semibold animate-pulse\">\n                  <span>新しいバッジ: {newBadges.length}個</span>\n                </div>\n              )}\n            </button>\n          </div>\n\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n            <div className=\"space-y-6\">\n              <div data-tutorial=\"streaks-section\">\n                <h3 className=\"text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center space-x-2\">\n                  <Flame className=\"w-5 h-5 text-orange-500\" />\n                  <span>あなたのストリーク</span>\n                </h3>\n\n                <ErrorBoundary compact title=\"ストリーク詳細でエラー\">\n                  <div className=\"space-y-4\">\n                    <StreakDisplay streak={getStreakByType(\"training\")} label=\"練習記録\" />\n                    <StreakDisplay streak={getStreakByType(\"weight\")} label=\"体重記録\" />\n                    <StreakDisplay streak={getStreakByType(\"sleep\")} label=\"睡眠記録\" />\n                    <StreakDisplay streak={getStreakByType(\"motivation\")} label=\"モチベーション記録\" />\n                  </div>\n                </ErrorBoundary>\n              </div>\n\n              <div data-tutorial=\"level-section\">\n                <h3 className=\"text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center space-x-2\">\n                  <Trophy className=\"w-5 h-5 text-yellow-500\" />\n                  <span>レベル進捗</span>\n                </h3>\n\n                <ErrorBoundary compact title=\"レベル進捗の表示でエラー\">\n                  <LevelProgressCard\n                    userPoints={userPoints}\n                    levelProgress={levelProgress}\n                    showDetails={true}\n                    actions={\n                      <button\n                        onClick={openPointHistory}\n                        className=\"w-full sm:w-auto px-3 py-2 rounded-lg text-sm\n                                   bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700\n                                   hover:bg-gray-50 dark:hover:bg-gray-700\n                                   text-gray-900 dark:text-white transition-colors\"\n                        title=\"ポイント履歴を表示\"\n                      >\n                        ポイント履歴\n                      </button>\n                    }\n                  />\n                </ErrorBoundary>\n              </div>\n            </div>\n\n            {/* ✅ 全体/組織/チーム：順位カード */}\n            <div className=\"mb-4\">\n              <div className=\"flex items-center space-x-2 mb-2\">\n                {availableScopes.map((s) => (\n                  <button\n                    key={s}\n                    onClick={() => setGlobalScope(s)}\n                    className={`px-3 py-1 rounded-full text-xs border transition-colors\n                      ${\n                        globalScope === s\n                          ? \"bg-blue-600 text-white border-blue-600\"\n                          : \"bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700\"\n                      }`}\n                  >\n                    {s === \"global\" ? \"全体\" : s === \"organization\" ? \"組織\" : \"チーム\"}\n                  </button>\n                ))}\n              </div>\n\n              <RankStatsCard\n                scope={globalScope}\n                data={globalStats}\n                loading={globalStatsLoading}\n                error={globalStatsError}\n              />\n            </div>\n\n\n\n\n\n            <div ref={setRankingsEl} data-tutorial=\"rankings-section\">\n              <h3 className=\"text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center space-x-2\">\n                <Users className=\"w-5 h-5 text-blue-500\" />\n                <span>チームランキング</span>\n              </h3>\n\n              <ErrorBoundary compact title=\"ランキング表示でエラー\">\n                {!rankingsEnabled ? (\n                  <div className=\"text-sm text-gray-500 dark:text-gray-400 h-24 flex items-center\">\n                    ランキングを読み込みます…\n                  </div>\n                ) : rankingsLoading ? (\n                  <div className=\"flex items-center justify-center h-24\">\n                    <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600\" />\n                  </div>\n                ) : (\n                  <TeamRankings\n                    weeklyRankings={weeklyRankings}\n                    pointsRankings={pointsRankings}\n                    myUserId={userId}\n                  />\n                )}\n              </ErrorBoundary>\n\n              {rankingsError && (\n                <div className=\"mt-2 text-xs text-red-600 dark:text-red-400\">\n                  rankingsError: {rankingsError}\n                </div>\n              )}\n            </div>\n          </div>\n\n          {showBadgeCollection && (\n            <ErrorBoundary title=\"バッジ一覧の表示でエラー\">\n              <BadgeCollection\n                userBadges={userBadges}\n                allBadges={allBadges}\n                onClose={() => setShowBadgeCollection(false)}\n              />\n            </ErrorBoundary>\n          )}\n\n          {newBadgeToShow && (\n            <ErrorBoundary title=\"バッジ獲得モーダルの表示でエラー\">\n              <BadgeEarnedModal badge={newBadgeToShow} onClose={handleBadgeModalClose} />\n            </ErrorBoundary>\n          )}\n\n          {levelUpData && (\n            <ErrorBoundary title=\"レベルアップ演出の表示でエラー\">\n              <LevelUpModal\n                newLevel={levelUpData.level}\n                rankTitle={levelUpData.rankTitle}\n                onClose={() => setLevelUpData(null)}\n              />\n            </ErrorBoundary>\n          )}\n\n          {/* ✅ ポイント履歴モーダル */}\n          <PointHistoryModal\n            open={showPointHistory}\n            onClose={() => setShowPointHistory(false)}\n            transactions={(transactions ?? []) as any}\n            loading={transactionsLoading}\n            onReload={reloadPointHistory}\n          />\n        </div>\n      )}\n    </ErrorBoundary>\n  );\n}","// src/hooks/useStreaks.ts\nimport { useState, useEffect, useRef, useCallback, useMemo } from \"react\";\nimport { supabase } from \"../lib/supabase\";\nimport type { RealtimeChannel } from \"@supabase/supabase-js\";\nimport { useRealtimeHub } from \"./useRealtimeHub\";\n\nconst ENABLE_REALTIME = import.meta.env.VITE_ENABLE_REALTIME === \"true\";\n\nexport interface Streak {\n  id: string;\n  user_id: string;\n  streak_type: \"training\" | \"weight\" | \"sleep\" | \"motivation\" | \"all\";\n  current_streak: number;\n  longest_streak: number;\n  last_recorded_date: string | null;\n  streak_freeze_count: number;\n  total_records: number;\n}\n\ntype Options = {\n  enabled?: boolean;          // falseなら取得/購読/ポーリングを止める（stateは保持）\n  pollMs?: number;            // realtime無効時のポーリング間隔（例: 120000）\n  pauseWhenHidden?: boolean;  // trueならタブ非表示でポーリング停止\n};\n\nexport function useStreaks(userId: string, options: Options = {}) {\n  const enabled = options.enabled ?? true;\n  const pollMs = options.pollMs ?? 0;\n  const pauseWhenHidden = options.pauseWhenHidden ?? true;\n\n  const [streaks, setStreaks] = useState<Streak[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n\n  const { state, registerPollJob } = useRealtimeHub();\n\n  const mountedRef = useRef(true);\n  useEffect(() => {\n    return () => {\n      mountedRef.current = false;\n    };\n  }, []);\n\n  // hookインスタンス固有ID（同名channel/キー衝突防止）\n  const instanceIdRef = useRef(\n    globalThis.crypto?.randomUUID?.() ?? Math.random().toString(36).slice(2)\n  );\n\n  const channelRef = useRef<RealtimeChannel | null>(null);\n  const unregisterPollRef = useRef<null | (() => void)>(null);\n  const inflightRef = useRef(false);\n\n  const cleanupRealtime = useCallback(() => {\n    const ch = channelRef.current;\n    if (!ch) return;\n    try { ch.unsubscribe?.(); } catch (_) {}\n    try { supabase.removeChannel(ch); } catch (_) {}\n    channelRef.current = null;\n  }, []);\n\n  const cleanupPoll = useCallback(() => {\n    if (unregisterPollRef.current) {\n      unregisterPollRef.current();\n      unregisterPollRef.current = null;\n    }\n  }, []);\n\n  const fetchStreaks = useCallback(\n    async (opts?: { silent?: boolean }) => {\n      if (!userId || !enabled) return;\n      if (inflightRef.current) return;\n      inflightRef.current = true;\n\n      const silent = opts?.silent ?? false;\n\n      try {\n        if (!silent && mountedRef.current) setLoading(true);\n\n        const { data, error } = await supabase\n          .from(\"user_streaks\")\n          .select(\"*\")\n          .eq(\"user_id\", userId)\n          .order(\"streak_type\");\n\n        if (error) throw error;\n\n        if (!mountedRef.current) return;\n        setStreaks((data ?? []) as Streak[]);\n        setError(null);\n      } catch (e: any) {\n        if (!mountedRef.current) return;\n        setError(e?.message ?? \"ストリークの取得に失敗しました\");\n      } finally {\n        inflightRef.current = false;\n        if (!silent && mountedRef.current) setLoading(false);\n      }\n    },\n    [userId, enabled]\n  );\n\n  // -----------------------------\n  // 初期ロード（ユーザー切替/無効化に強い）\n  // -----------------------------\n  useEffect(() => {\n    cleanupRealtime();\n    cleanupPoll();\n\n    if (!userId || !enabled) {\n      setLoading(false);\n      return;\n    }\n\n    void fetchStreaks({ silent: false });\n    }, [userId, enabled, fetchStreaks, cleanupRealtime, cleanupPoll]);\n\n    // cleanup は別effectが担当（Realtime/Poll）\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n\n\n  // -----------------------------\n  // ✅ Realtime（Hub許可のときだけ）\n  // -----------------------------\n  useEffect(() => {\n    cleanupRealtime();\n\n    const canUseRealtime = !!userId && enabled && ENABLE_REALTIME && state.canRealtime;\n    if (!canUseRealtime) return;\n\n    const channel = supabase\n      .channel(`user-streaks:${userId}:${instanceIdRef.current}`)\n      .on(\n        \"postgres_changes\",\n        { event: \"*\", schema: \"public\", table: \"user_streaks\", filter: `user_id=eq.${userId}` },\n        () => {\n          // Realtime更新は「静かに」再取得（loading立てない）\n          void fetchStreaks({ silent: true });\n        }\n      );\n\n    channelRef.current = channel;\n\n    channel.subscribe((status) => {\n      if (import.meta.env.DEV) console.log(\"[useStreaks] realtime status\", status);\n      if (status === \"CHANNEL_ERROR\" || status === \"TIMED_OUT\") {\n        console.warn(\"[useStreaks] realtime issue:\", status);\n        cleanupRealtime();\n      }\n    });\n\n    return () => cleanupRealtime();\n  }, [userId, enabled, state.canRealtime, fetchStreaks, cleanupRealtime]);\n\n  // -----------------------------\n  // ✅ Hubポーリング（Realtimeが使えない時だけ）\n  // -----------------------------\n  useEffect(() => {\n    cleanupPoll();\n\n    const shouldPoll =\n      !!userId &&\n      enabled &&\n      pollMs > 0 &&\n      (!ENABLE_REALTIME || !state.canRealtime);\n\n    if (!shouldPoll) return;\n\n    const key = `streaks:${userId}:${instanceIdRef.current}`;\n    const unregister = registerPollJob({\n      key,\n      intervalMs: pollMs,\n      run: async () => {\n        await fetchStreaks({ silent: true });\n      },\n      enabled: true,\n      requireVisible: pauseWhenHidden,\n      requireOnline: true,\n      immediate: false, // 初回は上で fetch 済み\n    });\n\n    unregisterPollRef.current = unregister;\n\n    return () => cleanupPoll();\n  }, [\n    userId,\n    enabled,\n    pollMs,\n    pauseWhenHidden,\n    state.canRealtime,\n    registerPollJob,\n    fetchStreaks,\n    cleanupPoll,\n  ]);\n\n  const getStreakByType = useCallback(\n    (type: Streak[\"streak_type\"]) => streaks.find((s) => s.streak_type === type) || null,\n    [streaks]\n  );\n\n  const getTotalStreak = useCallback(\n    () => streaks.find((s) => s.streak_type === \"all\") || null,\n    [streaks]\n  );\n\n  const updateStreak = useCallback(\n    async (type: Streak[\"streak_type\"], recordDate: string) => {\n      if (!userId) return;\n\n      const { error } = await supabase.rpc(\"update_user_streak\", {\n        p_user_id: userId,\n        p_streak_type: type,\n        p_record_date: recordDate,\n      });\n\n      if (error) throw error;\n\n      // RPC後は即反映したいので silent でリフレッシュ\n      await fetchStreaks({ silent: true });\n    },\n    [userId, fetchStreaks]\n  );\n\n  const isStreakAtRisk = useCallback((streak: Streak | null) => {\n    if (!streak?.last_recorded_date) return false;\n    const lastDate = new Date(streak.last_recorded_date);\n    const today = new Date();\n    today.setHours(0, 0, 0, 0);\n    lastDate.setHours(0, 0, 0, 0);\n    const daysDiff = Math.floor((today.getTime() - lastDate.getTime()) / 86400000);\n    return daysDiff >= 1;\n  }, []);\n\n  const getStreakStatus = useCallback((streak: Streak | null): \"safe\" | \"at_risk\" | \"broken\" => {\n    if (!streak?.last_recorded_date) return \"broken\";\n    const lastDate = new Date(streak.last_recorded_date);\n    const today = new Date();\n    today.setHours(0, 0, 0, 0);\n    lastDate.setHours(0, 0, 0, 0);\n    const daysDiff = Math.floor((today.getTime() - lastDate.getTime()) / 86400000);\n    if (daysDiff === 0) return \"safe\";\n    if (daysDiff === 1) return \"at_risk\";\n    return \"broken\";\n  }, []);\n\n  return {\n    streaks,\n    loading,\n    error,\n    getStreakByType,\n    getTotalStreak,\n    updateStreak,\n    isStreakAtRisk,\n    getStreakStatus,\n    refresh: async () => {\n      await fetchStreaks({ silent: false });\n    },\n  };\n}","// src/hooks/useRankStats.ts\nimport { useCallback, useEffect, useMemo, useRef, useState } from \"react\";\nimport { supabase } from \"../lib/supabase\";\nimport { useRealtimeHub } from \"./useRealtimeHub\";\n\nexport type RankScope = \"global\" | \"organization\" | \"team\";\n\nexport type RankDistRow = {\n  rank_title: string;\n  count: number;\n};\n\nexport type RankStats = {\n  scope: RankScope;\n  total_users: number;\n  my_rank: number | null;\n  top_percent: number | null;\n  my_points: number;\n  distribution: RankDistRow[];\n};\n\ntype Options = {\n  enabled?: boolean;\n  pollMs?: number;\n  pauseWhenHidden?: boolean;\n  defaultScope?: RankScope;\n};\n\ntype UserMini = {\n  id: string;\n  team_id: string | null;\n  organization_id: string | null;\n};\n\nexport function useRankStats(userId: string, userTeamId?: string | null, options: Options = {}) {\n  const enabled = options.enabled ?? true;\n  const pollMs = options.pollMs ?? 120000;\n  const pauseWhenHidden = options.pauseWhenHidden ?? true;\n  const defaultScope = options.defaultScope ?? \"global\";\n\n  const [scope, setScope] = useState<RankScope>(defaultScope);\n\n  const [userMini, setUserMini] = useState<UserMini | null>(null);\n  const [statsByScope, setStatsByScope] = useState<Record<RankScope, RankStats | null>>({\n    global: null,\n    organization: null,\n    team: null,\n  });\n\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n\n  const { registerPollJob } = useRealtimeHub();\n\n  const mountedRef = useRef(true);\n  useEffect(() => {\n    mountedRef.current = true;\n    return () => {\n      mountedRef.current = false;\n    };\n  }, []);\n\n  // hookインスタンス固有ID（poll key 衝突回避）\n  const instanceIdRef = useRef(\n    globalThis.crypto?.randomUUID?.() ?? Math.random().toString(36).slice(2)\n  );\n\n  const unregisterPollRef = useRef<null | (() => void)>(null);\n  const inflightRef = useRef(false);\n\n  const cleanupPoll = useCallback(() => {\n    if (unregisterPollRef.current) {\n      unregisterPollRef.current();\n      unregisterPollRef.current = null;\n    }\n  }, []);\n\n  // ✅ userMini を取得（organization_id が必要。team_idは props 優先）\n  const loadUserMini = useCallback(async () => {\n    if (!enabled || !userId) return;\n    try {\n      const { data, error } = await supabase\n        .from(\"users\")\n        .select(\"id, team_id, organization_id\")\n        .eq(\"id\", userId)\n        .maybeSingle();\n\n      if (error) throw error;\n\n      const team_id = (userTeamId ?? data?.team_id ?? null) as string | null;\n\n      if (!mountedRef.current) return;\n      setUserMini({\n        id: userId,\n        team_id,\n        organization_id: (data?.organization_id ?? null) as string | null,\n      });\n    } catch (e: any) {\n      console.error(\"[useRankStats] loadUserMini error:\", e);\n      if (!mountedRef.current) return;\n      // ここで落としても global は動かせるので、致命的扱いにしない\n      setUserMini({\n        id: userId,\n        team_id: userTeamId ?? null,\n        organization_id: null,\n      });\n    }\n  }, [enabled, userId, userTeamId]);\n\n  useEffect(() => {\n    void loadUserMini();\n  }, [loadUserMini]);\n\n  const canUseOrg = !!userMini?.organization_id;\n  const canUseTeam = !!userMini?.team_id;\n\n  // UI用：押せるスコープ一覧（organization/team が null の場合は出さない）\n  const availableScopes = useMemo(() => {\n    const scopes: RankScope[] = [\"global\"];\n    if (canUseOrg) scopes.push(\"organization\");\n    if (canUseTeam) scopes.push(\"team\");\n    return scopes;\n  }, [canUseOrg, canUseTeam]);\n\n  // scope が使えない状態なら global に戻す\n  useEffect(() => {\n    if (!enabled) return;\n    if (scope === \"organization\" && !canUseOrg) setScope(\"global\");\n    if (scope === \"team\" && !canUseTeam) setScope(\"global\");\n  }, [enabled, scope, canUseOrg, canUseTeam]);\n\n  const fetchRankStats = useCallback(\n    async (targetScope: RankScope, opts?: { silent?: boolean }) => {\n      if (!enabled) return;\n\n      // global はID不要、organization/team は必要\n      if (targetScope === \"organization\" && !userMini?.organization_id) return;\n      if (targetScope === \"team\" && !userMini?.team_id) return;\n\n      if (inflightRef.current) return;\n      inflightRef.current = true;\n\n      const silent = opts?.silent ?? false;\n\n      try {\n        if (!silent && mountedRef.current) setLoading(true);\n\n        const payload: any = { p_scope: targetScope };\n        if (targetScope === \"organization\") payload.p_org_id = userMini!.organization_id;\n        if (targetScope === \"team\") payload.p_team_id = userMini!.team_id;\n\n        const { data, error } = await supabase.rpc(\"get_rank_stats\", payload);\n        if (error) throw error;\n\n        const s = (data ?? null) as RankStats | null;\n\n        if (!mountedRef.current) return;\n        setStatsByScope((prev) => ({ ...prev, [targetScope]: s }));\n        setError(null);\n      } catch (e: any) {\n        console.error(\"[useRankStats] fetch error:\", e);\n        if (!mountedRef.current) return;\n        setError(e?.message ?? \"順位情報の取得に失敗しました\");\n      } finally {\n        inflightRef.current = false;\n        if (!silent && mountedRef.current) setLoading(false);\n      }\n    },\n    [enabled, userMini]\n  );\n\n  // 初回：現在 scope のデータだけ取る\n  useEffect(() => {\n    cleanupPoll();\n    if (!enabled) return;\n    if (!userMini) return;\n\n    void fetchRankStats(scope, { silent: false });\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [enabled, userMini, scope]);\n\n  // ポーリング（現在の scope だけ）\n  useEffect(() => {\n    cleanupPoll();\n\n    const shouldPoll = enabled && pollMs > 0 && !!userMini;\n    if (!shouldPoll) return;\n\n    const key = `rankstats:${scope}:${instanceIdRef.current}`;\n\n    const unregister = registerPollJob({\n      key,\n      intervalMs: pollMs,\n      run: async () => {\n        await fetchRankStats(scope, { silent: true });\n      },\n      enabled: true,\n      requireVisible: pauseWhenHidden,\n      requireOnline: true,\n      immediate: false,\n    });\n\n    unregisterPollRef.current = unregister;\n    return () => cleanupPoll();\n  }, [enabled, pollMs, pauseWhenHidden, registerPollJob, fetchRankStats, cleanupPoll, scope, userMini]);\n\n  const current = statsByScope[scope];\n\n  const refresh = useCallback(async () => {\n    await fetchRankStats(scope, { silent: false });\n  }, [fetchRankStats, scope]);\n\n  return {\n    scope,\n    setScope,\n    availableScopes,\n    canUseOrg,\n    canUseTeam,\n    data: current,\n    loading,\n    error,\n    refresh,\n  };\n}","// src/hooks/usePoints.ts\nimport { useCallback, useEffect, useRef, useState } from \"react\";\nimport type { RealtimeChannel } from \"@supabase/supabase-js\";\nimport { supabase } from \"../lib/supabase\";\nimport { useRealtimeHub } from \"./useRealtimeHub\";\n\nconst ENABLE_REALTIME = import.meta.env.VITE_ENABLE_REALTIME === \"true\";\n\n// 必要ならあなたの型に置換してOK\nexport type UserPoints = any;\nexport type PointTransaction = any;\n\ntype Options = {\n  includeTransactions?: boolean; // 初回で履歴も取るか（デフォ false）\n  transactionsLimit?: number; // 例: 50\n};\n\nexport function usePoints(userId: string | null | undefined, options: Options = {}) {\n  const includeTransactions = options.includeTransactions ?? false;\n  const transactionsLimit = options.transactionsLimit ?? 50;\n\n  const [userPoints, setUserPoints] = useState<UserPoints | null>(null);\n  const [transactions, setTransactions] = useState<PointTransaction[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [transactionsLoading, setTransactionsLoading] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n\n  // ✅ 「一度でも履歴を取ったか」を state でも持つ（UI/分岐に使える）\n  const [hasLoadedTransactions, setHasLoadedTransactions] = useState(false);\n\n  const { state } = useRealtimeHub();\n\n  const mountedRef = useRef(true);\n  useEffect(() => {\n    return () => {\n      mountedRef.current = false;\n    };\n  }, []);\n\n  const instanceIdRef = useRef(\n    globalThis.crypto?.randomUUID?.() ?? Math.random().toString(36).slice(2)\n  );\n\n  const pointsChannelRef = useRef<RealtimeChannel | null>(null);\n  const txChannelRef = useRef<RealtimeChannel | null>(null);\n\n  const fetchedTxOnceRef = useRef(false);\n  const inflightPointsRef = useRef(false);\n  const inflightTxRef = useRef(false);\n\n  const cleanupPointsRealtime = useCallback(() => {\n    const ch = pointsChannelRef.current;\n    if (!ch) return;\n    try { ch.unsubscribe?.(); } catch (_) {}\n    try { supabase.removeChannel(ch); } catch (_) {}\n    pointsChannelRef.current = null;\n  }, []);\n\n  const cleanupTxRealtime = useCallback(() => {\n    const ch = txChannelRef.current;\n    if (!ch) return;\n    try { ch.unsubscribe?.(); } catch (_) {}\n    try { supabase.removeChannel(ch); } catch (_) {}\n    txChannelRef.current = null;\n  }, []);\n\n  const fetchUserPoints = useCallback(\n    async (opts?: { silent?: boolean }) => {\n      if (!userId) return;\n      if (inflightPointsRef.current) return;\n      inflightPointsRef.current = true;\n\n      const silent = opts?.silent ?? false;\n\n      try {\n        if (!silent && mountedRef.current) setLoading(true);\n\n        const res = await supabase\n          .from(\"user_points\")\n          .select(\"*\")\n          .eq(\"user_id\", userId)\n          .maybeSingle();\n\n        if (res.error) throw res.error;\n\n        if (!mountedRef.current) return;\n        setUserPoints(res.data ?? null);\n        setError(null);\n      } catch (e: any) {\n        if (!mountedRef.current) return;\n        console.error(\"[usePoints] fetch user_points error:\", e);\n        setError(e?.message ?? \"ポイント情報の取得に失敗しました\");\n      } finally {\n        inflightPointsRef.current = false;\n        if (!silent && mountedRef.current) setLoading(false);\n      }\n    },\n    [userId]\n  );\n\n  const fetchTransactions = useCallback(\n    async (opts?: { silent?: boolean }) => {\n      if (!userId) return;\n      if (inflightTxRef.current) return;\n      inflightTxRef.current = true;\n\n      const silent = opts?.silent ?? false;\n\n      try {\n        if (!silent && mountedRef.current) setTransactionsLoading(true);\n\n        // ✅ ここが400の原因になりやすいので、存在するカラムだけを列挙（あなたの一覧に合わせ済み）\n        const res = await supabase\n          .from(\"point_transactions\")\n          .select(\"id,user_id,points,reason,category,metadata,created_at\")\n          .eq(\"user_id\", userId)\n          .order(\"created_at\", { ascending: false })\n          .limit(transactionsLimit);\n\n        if (res.error) throw res.error;\n\n        if (!mountedRef.current) return;\n        setTransactions((res.data ?? []) as PointTransaction[]);\n        setError(null);\n\n        fetchedTxOnceRef.current = true;\n        setHasLoadedTransactions(true);\n      } catch (e: any) {\n        if (!mountedRef.current) return;\n        console.error(\"[usePoints] fetch point_transactions error:\", e);\n        setError(e?.message ?? \"ポイント履歴の取得に失敗しました\");\n      } finally {\n        inflightTxRef.current = false;\n        if (!silent && mountedRef.current) setTransactionsLoading(false);\n      }\n    },\n    [userId, transactionsLimit]\n  );\n\n  // ✅ 外部から「必要なときだけ」呼ぶ用\n  const loadTransactions = useCallback(\n    async (opts?: { silent?: boolean }) => {\n      await fetchTransactions({ silent: opts?.silent ?? false });\n    },\n    [fetchTransactions]\n  );\n\n  // 初期ロード：user_points は必須 / transactions は任意\n  useEffect(() => {\n    cleanupPointsRealtime();\n    cleanupTxRealtime();\n\n    if (!userId) {\n      setLoading(false);\n      setTransactions([]);\n      setHasLoadedTransactions(false);\n      fetchedTxOnceRef.current = false;\n      return;\n    }\n\n    void fetchUserPoints({ silent: false });\n\n    if (includeTransactions) {\n      void fetchTransactions({ silent: false });\n    } else {\n      setTransactions([]);\n      setHasLoadedTransactions(false);\n      fetchedTxOnceRef.current = false;\n    }\n  }, [\n    userId,\n    includeTransactions,\n    fetchUserPoints,\n    fetchTransactions,\n    cleanupPointsRealtime,\n    cleanupTxRealtime,\n  ]);\n\n  // Realtime：user_points\n  useEffect(() => {\n    cleanupPointsRealtime();\n\n    const canUseRealtime = !!userId && ENABLE_REALTIME && state.canRealtime;\n    if (!canUseRealtime) return;\n\n    const chName = `user-points:${userId}:${instanceIdRef.current}`;\n    const ch = supabase\n      .channel(chName)\n      .on(\n        \"postgres_changes\",\n        { event: \"*\", schema: \"public\", table: \"user_points\", filter: `user_id=eq.${userId}` },\n        () => { void fetchUserPoints({ silent: true }); }\n      );\n\n    pointsChannelRef.current = ch;\n\n    ch.subscribe((status) => {\n      if (import.meta.env.DEV) console.log(\"[usePoints] realtime status\", chName, status);\n      if (status === \"CHANNEL_ERROR\" || status === \"TIMED_OUT\") {\n        console.warn(\"[usePoints] realtime issue:\", chName, status);\n        cleanupPointsRealtime();\n      }\n    });\n\n    return () => cleanupPointsRealtime();\n  }, [userId, state.canRealtime, fetchUserPoints, cleanupPointsRealtime]);\n\n  // Realtime：transactions は「一度でも読み込んだ後」だけ購読\n  useEffect(() => {\n    cleanupTxRealtime();\n\n    const canUseRealtime =\n      !!userId &&\n      ENABLE_REALTIME &&\n      state.canRealtime &&\n      fetchedTxOnceRef.current;\n\n    if (!canUseRealtime) return;\n\n    const chName = `point-tx:${userId}:${instanceIdRef.current}`;\n    const ch = supabase\n      .channel(chName)\n      .on(\n        \"postgres_changes\",\n        { event: \"*\", schema: \"public\", table: \"point_transactions\", filter: `user_id=eq.${userId}` },\n        () => { void fetchTransactions({ silent: true }); }\n      );\n\n    txChannelRef.current = ch;\n\n    ch.subscribe((status) => {\n      if (import.meta.env.DEV) console.log(\"[usePoints] tx realtime status\", chName, status);\n      if (status === \"CHANNEL_ERROR\" || status === \"TIMED_OUT\") {\n        console.warn(\"[usePoints] tx realtime issue:\", chName, status);\n        cleanupTxRealtime();\n      }\n    });\n\n    return () => cleanupTxRealtime();\n  }, [userId, state.canRealtime, fetchTransactions, cleanupTxRealtime]);\n\n  const getLevelProgress = useCallback(() => {\n    const p = (userPoints as any)?.current_points ?? 0;\n    const next = (userPoints as any)?.points_to_next ?? 0;\n    if (!next) return 0;\n    return Math.max(0, Math.min(100, Math.round((p / next) * 100)));\n  }, [userPoints]);\n\n  const awardPoints = useCallback(\n    async (payload: any) => {\n      const { error } = await supabase.rpc(\"award_points\", payload);\n      if (error) throw error;\n\n      await fetchUserPoints({ silent: true });\n      if (fetchedTxOnceRef.current) {\n        await fetchTransactions({ silent: true });\n      }\n    },\n    [fetchUserPoints, fetchTransactions]\n  );\n\n  return {\n    userPoints,\n    transactions,\n    loading,\n    transactionsLoading,\n    error,\n\n    getLevelProgress,\n    awardPoints,\n\n    loadTransactions,\n    hasLoadedTransactions,\n  };\n}","// src/hooks/useRankings.ts\nimport { useCallback, useEffect, useRef, useState } from \"react\";\nimport { supabase } from \"../lib/supabase\";\nimport { useRealtimeHub } from \"./useRealtimeHub\";\n\nexport type WeeklyRanking = any;  // 既存型があるなら置き換えOK\nexport type PointsRanking = any;  // 既存型があるなら置き換えOK\n\ntype Options = {\n  enabled?: boolean;\n  pollMs?: number;            // ポーリング間隔（例: 120000）\n  pauseWhenHidden?: boolean;  // true推奨\n};\n\ntype RpcResult = {\n  weekly?: WeeklyRanking[];\n  points?: PointsRanking[];\n};\n\nexport function useRankings(teamId: string | null | undefined, options: Options = {}) {\n  const enabled = options.enabled ?? true;\n  const pollMs = options.pollMs ?? 120000;\n  const pauseWhenHidden = options.pauseWhenHidden ?? true;\n\n  const [weeklyRankings, setWeeklyRankings] = useState<WeeklyRanking[]>([]);\n  const [pointsRankings, setPointsRankings] = useState<PointsRanking[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n\n  const { registerPollJob } = useRealtimeHub();\n\n  const mountedRef = useRef(true);\n  useEffect(() => {\n    mountedRef.current = true;\n    return () => {\n      mountedRef.current = false;\n    };\n  }, []);\n\n  // hookインスタンス固有ID（poll key 衝突回避）\n  const instanceIdRef = useRef(\n    globalThis.crypto?.randomUUID?.() ?? Math.random().toString(36).slice(2)\n  );\n\n  const unregisterPollRef = useRef<null | (() => void)>(null);\n  const inflightRef = useRef(false);\n\n  const cleanupPoll = useCallback(() => {\n    if (unregisterPollRef.current) {\n      unregisterPollRef.current();\n      unregisterPollRef.current = null;\n    }\n  }, []);\n\n  const fetchRankings = useCallback(\n    async (opts?: { silent?: boolean }) => {\n      if (!teamId || !enabled) return;\n      if (inflightRef.current) return;\n      inflightRef.current = true;\n\n      const silent = opts?.silent ?? false;\n\n      try {\n        if (!silent && mountedRef.current) setLoading(true);\n\n        // ✅ VIEW直叩き→RPCで取得（RLS問題を回避）\n        const { data, error } = await supabase.rpc(\"get_team_rankings\", {\n          p_team_id: teamId,\n        });\n\n        if (error) throw error;\n\n        const res = (data ?? {}) as RpcResult;\n        const weekly = Array.isArray(res.weekly) ? res.weekly : [];\n        const points = Array.isArray(res.points) ? res.points : [];\n\n        if (!mountedRef.current) return;\n        setWeeklyRankings(weekly);\n        setPointsRankings(points);\n        setError(null);\n      } catch (e: any) {\n        if (!mountedRef.current) return;\n        console.error(\"[useRankings] fetch error:\", e);\n        setError(e?.message ?? \"ランキングの取得に失敗しました\");\n\n        // 失敗時は「前回表示が残る」より、空にして気づける方が良いなら↓をON\n        // setWeeklyRankings([]);\n        // setPointsRankings([]);\n      } finally {\n        inflightRef.current = false;\n        if (!silent && mountedRef.current) setLoading(false);\n      }\n    },\n    [teamId, enabled]\n  );\n\n  // -----------------------------\n  // 初期ロード（team切替/無効化に強い）\n  // -----------------------------\n  useEffect(() => {\n    cleanupPoll();\n\n    if (!teamId || !enabled) {\n      // 表示対象なしなら空にして終了\n      setWeeklyRankings([]);\n      setPointsRankings([]);\n      setError(null);\n      setLoading(false);\n      return;\n    }\n\n    void fetchRankings({ silent: false });\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [teamId, enabled]);\n\n  // -----------------------------\n  // ✅ ポーリング（Hub管理）\n  // -----------------------------\n  useEffect(() => {\n    cleanupPoll();\n\n    const shouldPoll = !!teamId && enabled && pollMs > 0;\n    if (!shouldPoll) return;\n\n    const key = `rankings:${teamId}:${instanceIdRef.current}`;\n\n    const unregister = registerPollJob({\n      key,\n      intervalMs: pollMs,\n      run: async () => {\n        await fetchRankings({ silent: true });\n      },\n      enabled: true,\n      requireVisible: pauseWhenHidden,\n      requireOnline: true,\n      immediate: false, // 初回は上の useEffect で取得済み\n    });\n\n    unregisterPollRef.current = unregister;\n    return () => cleanupPoll();\n  }, [teamId, enabled, pollMs, pauseWhenHidden, registerPollJob, fetchRankings, cleanupPoll]);\n\n  return {\n    weeklyRankings,\n    pointsRankings,\n    loading,\n    error,\n    refresh: async () => {\n      await fetchRankings({ silent: false });\n    },\n  };\n}"],"names":["Database","createLucideIcon","cx","cy","rx","ry","key","d","Medal","r","Sunrise","Tag","fill","StreakDisplay","streak","label","icon","compact","getStreakColor","current_streak","getStreakBgColor","getStreakBorderColor","isAtRisk","last_recorded_date","lastDate","Date","today","setHours","Math","floor","getTime","jsxs","className","children","Flame","jsx","AlertCircle","Award","longest_streak","TrendingUp","total_records","style","width","LevelProgressCard","userPoints","levelProgress","showDetails","actions","getRankColor","current_level","getRankBgColor","getRankBorderColor","getRankIcon","Sparkles","Trophy","Star","rank_title","Fragment","points_to_next_level","round","join","total_points","toLocaleString","ICON_MAP","Shield","Heart","Zap","BadgeCollection","userBadges","allBadges","onClose","onBadgeClick","selectedCategory","setSelectedCategory","useState","earnedBadgeIds","Set","map","ub","badge_id","filteredBadges","filter","badge","is_hidden","category","getRarityColor","rarity","getRarityBorderColor","earnedCount","b","has","id","length","totalCount","progress","onClick","X","cat","isEarned","userBadge","find","IconComponent","iconName","is_new","Lock","name","description","points_reward","safeNumber","v","fallback","n","Number","isFinite","safeText","s","String","trim","TeamRankings","weeklyRankings","pointsRankings","myUserId","activeTab","setActiveTab","weekly","useMemo","Array","isArray","points","getRankMedal","rank","color","bg","limit","renderWeeklyRankings","myRank","user_id","slice","ranking","rankNum","medal","userId","isMe","weeklyRecords","weekly_records","userName","user_name","renderPointsRankings","totalPoints","currentLevel","currentList","Users","LevelUpModal","newLevel","rankTitle","isVisible","setIsVisible","confettiFn","anyNS","confettiNS","fn","default","useEffect","duration","end","now","frame","particleCount","angle","spread","origin","x","colors","e","console","warn","stars","from","_","i","top","random","left","delay","animationDelay","animationDuration","max","ErrorBoundary","React","Component","constructor","super","arguments","__publicField","this","hasError","setState","error","getDerivedStateFromError","componentDidCatch","info","render","state","props","title","desc","retry","window","location","reload","formatJST","iso","date","Intl","DateTimeFormat","timeZone","year","month","day","format","time","hour","minute","hour12","PointHistoryModal","open","transactions","loading","onReload","onKeyDown","addEventListener","removeEventListener","grouped","Map","tx","created_at","arr","get","push","set","keys","sort","a","k","items","hasItems","disabled","RefreshCw","g","pts","sign","reason","c","toLowerCase","includes","categoryLabel","catTone","categoryTone","Clock","_a","metadata","source","scopeLabel","scope","scopeIcon","Globe","Building2","RankStatsCard","data","headline","total","total_users","my_rank","pct","top_percent","dist","distribution","reverse","maxCount","m","count","GamificationView","userTeamId","useRealtimeHub","log","streaksLoading","getStreakByType","getTotalStreak","options","enabled","pollMs","pauseWhenHidden","streaks","setStreaks","setLoading","setError","registerPollJob","mountedRef","useRef","current","instanceIdRef","_b","globalThis","crypto","randomUUID","call","toString","channelRef","unregisterPollRef","inflightRef","cleanupRealtime","useCallback","ch","unsubscribe","supabase","removeChannel","cleanupPoll","fetchStreaks","async","opts","silent","select","eq","order","message","canRealtime","unregister","intervalMs","run","requireVisible","requireOnline","immediate","type","streak_type","updateStreak","recordDate","rpc","p_user_id","p_streak_type","p_record_date","isStreakAtRisk","getStreakStatus","daysDiff","refresh","useStreaks","globalScope","setScope","setGlobalScope","availableScopes","globalStats","globalStatsLoading","globalStatsError","defaultScope","userMini","setUserMini","statsByScope","setStatsByScope","global","organization","team","loadUserMini","maybeSingle","team_id","organization_id","canUseOrg","canUseTeam","scopes","fetchRankStats","targetScope","payload","p_scope","p_org_id","p_team_id","prev","useRankStats","pointsLoading","getLevelProgress","transactionsLoading","loadTransactions","includeTransactions","transactionsLimit","setUserPoints","setTransactions","setTransactionsLoading","hasLoadedTransactions","setHasLoadedTransactions","pointsChannelRef","txChannelRef","fetchedTxOnceRef","inflightPointsRef","inflightTxRef","cleanupPointsRealtime","cleanupTxRealtime","fetchUserPoints","res","fetchTransactions","ascending","p","current_points","next","points_to_next","min","awardPoints","usePoints","badgesLoading","getNewBadges","markBadgeAsViewed","getBadgeProgress","useBadges","rankingsEl","setRankingsEl","rankingsEnabled","setRankingsEnabled","offTimerRef","obs","IntersectionObserver","entries","inView","some","isIntersecting","disconnect","clearTimeout","threshold","rootMargin","observe","rankingsLoading","rankingsError","teamId","setWeeklyRankings","setPointsRankings","fetchRankings","useRankings","weeklyLen","pointsLen","showBadgeCollection","setShowBadgeCollection","newBadgeToShow","setNewBadgeToShow","levelUpData","setLevelUpData","showTutorial","setShowTutorial","showPointHistory","setShowPointHistory","newBadges","badgeProgress","earned","percentage","lastLevelRef","levelSeenKey","setStoredLevel","lvl","localStorage","setItem","curLevel","stored","raw","getItem","NaN","getStoredLevel","level","TutorialController","steps","getTutorialSteps","isActive","onComplete","onSkip","HelpCircle","ref","BadgeEarnedModal","newBadge","nb"],"mappings":"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","x_google_ignoreList":[0,1,2,3]}
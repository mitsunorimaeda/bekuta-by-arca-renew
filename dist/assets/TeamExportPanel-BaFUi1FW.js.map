{"version":3,"file":"TeamExportPanel-BaFUi1FW.js","sources":["../../src/components/TeamExportPanel.tsx"],"sourcesContent":["import React, { useState, useEffect } from 'react';\nimport { User, Team, TrainingRecord, supabase } from '../lib/supabase';\nimport { calculateACWR, ACWRData } from '../lib/acwr';\nimport {\n  exportTeamToCSV,\n  getDateRange,\n  TeamExportData\n} from '../lib/exportUtils';\nimport {\n  Download,\n  Calendar,\n  FileSpreadsheet,\n  X,\n  Users,\n  TrendingUp\n} from 'lucide-react';\n\ninterface TeamExportPanelProps {\n  team: Team;\n  onClose: () => void;\n}\n\nexport function TeamExportPanel({ team, onClose }: TeamExportPanelProps) {\n  const [selectedPeriod, setSelectedPeriod] = useState<'week' | 'month' | 'quarter' | 'custom'>('month');\n  const [customStartDate, setCustomStartDate] = useState('');\n  const [customEndDate, setCustomEndDate] = useState('');\n  const [isExporting, setIsExporting] = useState(false);\n  const [teamData, setTeamData] = useState<TeamExportData | null>(null);\n  const [loading, setLoading] = useState(true);\n\n  useEffect(() => {\n    fetchTeamData();\n  }, [team.id, selectedPeriod, customStartDate, customEndDate]);\n\n  const fetchTeamData = async () => {\n    setLoading(true);\n    try {\n      // チームの選手を取得\n      const { data: athletes, error: athletesError } = await supabase\n        .from('users')\n        .select('*')\n        .eq('role', 'athlete')\n        .eq('team_id', team.id);\n\n      if (athletesError) throw athletesError;\n\n      if (!athletes || athletes.length === 0) {\n        setTeamData(null);\n        setLoading(false);\n        return;\n      }\n\n      const dateRange = selectedPeriod === 'custom' && customStartDate && customEndDate\n        ? { start: customStartDate, end: customEndDate }\n        : getDateRange(selectedPeriod);\n\n      const athleteIds = athletes.map(athlete => athlete.id);\n\n      // 全選手の練習記録を取得\n      const { data: allRecords, error: recordsError } = await supabase\n        .from('training_records')\n        .select('*')\n        .in('user_id', athleteIds)\n        .gte('date', dateRange.start)\n        .lte('date', dateRange.end)\n        .order('date', { ascending: true });\n\n      if (recordsError) throw recordsError;\n\n      // 選手ごとのデータを構築\n      const athletesData = athletes.map(athlete => {\n        const athleteRecords = allRecords?.filter(r => r.user_id === athlete.id) || [];\n        const acwrData = calculateACWR(athleteRecords);\n        const latestACWR = acwrData.length > 0 ? acwrData[acwrData.length - 1] : null;\n\n        return {\n          user: athlete,\n          trainingRecords: athleteRecords,\n          acwrData,\n          latestACWR: latestACWR?.acwr,\n          riskLevel: latestACWR?.riskLevel\n        };\n      });\n\n      // チームサマリーを計算\n      const activeAthletes = athletesData.filter(a => a.trainingRecords.length > 0);\n      const acwrValues = activeAthletes\n        .map(a => a.latestACWR)\n        .filter(acwr => acwr !== undefined) as number[];\n      \n      const averageACWR = acwrValues.length > 0 \n        ? acwrValues.reduce((sum, acwr) => sum + acwr, 0) / acwrValues.length\n        : 0;\n\n      const highRiskAthletes = activeAthletes.filter(a => \n        a.riskLevel === 'high' || a.riskLevel === 'caution'\n      ).length;\n\n      const teamSummary = {\n        totalAthletes: athletes.length,\n        activeAthletes: activeAthletes.length,\n        averageACWR: Number(averageACWR.toFixed(2)),\n        highRiskAthletes\n      };\n\n      setTeamData({\n        teamName: team.name,\n        athletes: athletesData,\n        teamSummary,\n        exportDate: new Date().toLocaleString('ja-JP'),\n        dateRange\n      });\n\n    } catch (error) {\n      console.error('Error fetching team data:', error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleExport = async () => {\n    if (!teamData) return;\n\n    setIsExporting(true);\n\n    try {\n      exportTeamToCSV(teamData);\n\n      setTimeout(() => {\n        setIsExporting(false);\n      }, 1000);\n\n    } catch (error) {\n      console.error('Export error:', error);\n      alert('エクスポートに失敗しました。もう一度お試しください。');\n      setIsExporting(false);\n    }\n  };\n\n  const getPeriodLabel = () => {\n    switch (selectedPeriod) {\n      case 'week': return '過去1週間';\n      case 'month': return '過去1ヶ月';\n      case 'quarter': return '過去3ヶ月';\n      case 'custom': return 'カスタム期間';\n      default: return '過去1ヶ月';\n    }\n  };\n\n  const getTotalRecords = () => {\n    if (!teamData) return 0;\n    return teamData.athletes.reduce((total, athlete) => total + athlete.trainingRecords.length, 0);\n  };\n\n  return (\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4\">\n      <div className=\"bg-white rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto\">\n        {/* Header */}\n        <div className=\"bg-gradient-to-r from-purple-600 to-blue-600 text-white p-6 rounded-t-2xl\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-3\">\n              <Users className=\"w-8 h-8\" />\n              <div>\n                <h2 className=\"text-2xl font-bold\">チームデータエクスポート</h2>\n                <p className=\"text-purple-100\">{team.name}</p>\n              </div>\n            </div>\n            <button\n              onClick={onClose}\n              className=\"bg-purple-500 hover:bg-purple-400 rounded-full p-2 transition-colors\"\n            >\n              <X className=\"w-6 h-6\" />\n            </button>\n          </div>\n        </div>\n\n        <div className=\"p-6 space-y-6\">\n          {/* 期間選択 */}\n          <div className=\"bg-gray-50 rounded-lg p-4\">\n            <h3 className=\"font-semibold text-gray-900 mb-4 flex items-center\">\n              <Calendar className=\"w-5 h-5 mr-2\" />\n              エクスポート期間\n            </h3>\n            \n            <div className=\"grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4\">\n              {[\n                { value: 'week', label: '1週間' },\n                { value: 'month', label: '1ヶ月' },\n                { value: 'quarter', label: '3ヶ月' },\n                { value: 'custom', label: 'カスタム' }\n              ].map(period => (\n                <button\n                  key={period.value}\n                  onClick={() => setSelectedPeriod(period.value as any)}\n                  className={`p-3 rounded-lg text-sm font-medium transition-colors ${\n                    selectedPeriod === period.value\n                      ? 'bg-purple-600 text-white'\n                      : 'bg-white border border-gray-300 text-gray-700 hover:bg-gray-50'\n                  }`}\n                >\n                  {period.label}\n                </button>\n              ))}\n            </div>\n\n            {selectedPeriod === 'custom' && (\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n                    開始日\n                  </label>\n                  <input\n                    type=\"date\"\n                    value={customStartDate}\n                    onChange={(e) => setCustomStartDate(e.target.value)}\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent\"\n                  />\n                </div>\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n                    終了日\n                  </label>\n                  <input\n                    type=\"date\"\n                    value={customEndDate}\n                    onChange={(e) => setCustomEndDate(e.target.value)}\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent\"\n                  />\n                </div>\n              </div>\n            )}\n\n            {teamData && (\n              <div className=\"mt-4 p-3 bg-purple-50 rounded-lg\">\n                <div className=\"grid grid-cols-2 sm:grid-cols-4 gap-4 text-sm\">\n                  <div className=\"text-center\">\n                    <div className=\"font-bold text-purple-700\">{teamData.teamSummary.totalAthletes}</div>\n                    <div className=\"text-purple-600\">総選手数</div>\n                  </div>\n                  <div className=\"text-center\">\n                    <div className=\"font-bold text-purple-700\">{teamData.teamSummary.activeAthletes}</div>\n                    <div className=\"text-purple-600\">アクティブ</div>\n                  </div>\n                  <div className=\"text-center\">\n                    <div className=\"font-bold text-purple-700\">{getTotalRecords()}</div>\n                    <div className=\"text-purple-600\">練習記録</div>\n                  </div>\n                  <div className=\"text-center\">\n                    <div className=\"font-bold text-purple-700\">{teamData.teamSummary.averageACWR}</div>\n                    <div className=\"text-purple-600\">平均ACWR</div>\n                  </div>\n                </div>\n              </div>\n            )}\n          </div>\n\n          {loading ? (\n            <div className=\"text-center py-8\">\n              <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4\"></div>\n              <p className=\"text-gray-600\">チームデータを読み込み中...</p>\n            </div>\n          ) : !teamData ? (\n            <div className=\"text-center py-8\">\n              <Users className=\"w-16 h-16 text-gray-400 mx-auto mb-4\" />\n              <h3 className=\"text-lg font-medium text-gray-900 mb-2\">データがありません</h3>\n              <p className=\"text-gray-600\">選択した期間にチームの練習記録がありません。</p>\n            </div>\n          ) : (\n            <>\n              {/* データエクスポート */}\n              <div className=\"bg-white border border-gray-200 rounded-lg p-4\">\n                <h3 className=\"font-semibold text-gray-900 mb-4 flex items-center\">\n                  <Download className=\"w-5 h-5 mr-2 text-green-600\" />\n                  データエクスポート\n                </h3>\n                \n                <button\n                  onClick={handleExport}\n                  disabled={isExporting}\n                  className=\"w-full bg-green-600 hover:bg-green-700 text-white p-4 rounded-lg transition-colors disabled:opacity-50 flex items-center justify-center space-x-2\"\n                >\n                  <FileSpreadsheet className=\"w-5 h-5\" />\n                  <span>チームデータ（CSV）</span>\n                </button>\n                \n                <p className=\"text-xs text-gray-600 mt-2\">\n                  全選手の練習記録とACWRデータをCSV形式でエクスポート\n                </p>\n              </div>\n\n              {/* 高リスク選手の警告 */}\n              {teamData.teamSummary.highRiskAthletes > 0 && (\n                <div className=\"bg-red-50 border border-red-200 rounded-lg p-4\">\n                  <div className=\"flex items-center\">\n                    <TrendingUp className=\"w-6 h-6 text-red-600 mr-3\" />\n                    <div>\n                      <h4 className=\"font-semibold text-red-900\">注意が必要な選手</h4>\n                      <p className=\"text-sm text-red-700\">\n                        {teamData.teamSummary.highRiskAthletes}名の選手が高リスク状態です。\n                        個別に詳細を確認してください。\n                      </p>\n                    </div>\n                  </div>\n                </div>\n              )}\n\n              {isExporting && (\n                <div className=\"text-center py-4\">\n                  <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-2\"></div>\n                  <p className=\"text-sm text-gray-600\">エクスポート中...</p>\n                </div>\n              )}\n            </>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}"],"names":["TeamExportPanel","team","onClose","selectedPeriod","setSelectedPeriod","useState","customStartDate","setCustomStartDate","customEndDate","setCustomEndDate","isExporting","setIsExporting","teamData","setTeamData","loading","setLoading","useEffect","fetchTeamData","id","async","data","athletes","error","athletesError","supabase","from","select","eq","length","dateRange","start","end","getDateRange","athleteIds","map","athlete","allRecords","recordsError","in","gte","lte","order","ascending","athletesData","athleteRecords","filter","r","user_id","acwrData","calculateACWR","latestACWR","user","trainingRecords","acwr","riskLevel","activeAthletes","a","acwrValues","averageACWR","reduce","sum","highRiskAthletes","teamSummary","totalAthletes","Number","toFixed","teamName","name","exportDate","Date","toLocaleString","console","className","children","jsxs","jsx","Users","onClick","X","Calendar","value","label","period","type","onChange","e","target","total","Fragment","Download","exportTeamToCSV","setTimeout","alert","disabled","FileSpreadsheet","TrendingUp"],"mappings":"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"}
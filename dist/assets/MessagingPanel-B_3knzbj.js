import{z as I,J as ee,s as c,j as e,a3 as G,X as Y,a4 as re,a5 as se,K as te,a6 as ae}from"./index-C7IL5YWP.js";import{r as a,d as ne}from"./chart-vendor-B8I3tXXj.js";import"./supabase-vendor-CRHRt2Ih.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Z=I("Loader",[["line",{x1:"12",x2:"12",y1:"2",y2:"6",key:"gza1u7"}],["line",{x1:"12",x2:"12",y1:"18",y2:"22",key:"1qhbu9"}],["line",{x1:"4.93",x2:"7.76",y1:"4.93",y2:"7.76",key:"xae44r"}],["line",{x1:"16.24",x2:"19.07",y1:"16.24",y2:"19.07",key:"bxnmvf"}],["line",{x1:"2",x2:"6",y1:"12",y2:"12",key:"89khin"}],["line",{x1:"18",x2:"22",y1:"12",y2:"12",key:"pb8tfm"}],["line",{x1:"4.93",x2:"7.76",y1:"19.07",y2:"16.24",key:"1uxjnu"}],["line",{x1:"16.24",x2:"19.07",y1:"7.76",y2:"4.93",key:"6duxfx"}]]),ie=!1;function le(n){var E,$;const[p,Q]=a.useState([]),[V,w]=a.useState({}),[T,R]=a.useState(!0),[B,o]=a.useState(null),[d,z]=a.useState(null),{state:W,registerPollJob:v}=ee(),L=a.useRef(null),f=a.useRef(null),m=a.useRef(null),U=a.useRef((($=(E=globalThis.crypto)==null?void 0:E.randomUUID)==null?void 0:$.call(E))??Math.random().toString(36).slice(2)),j=a.useRef(!1),_=a.useRef({}),k=a.useCallback(()=>{var s;const t=L.current;if(t){try{(s=t.unsubscribe)==null||s.call(t)}catch{}try{c.removeChannel(t)}catch{}L.current=null}},[]),x=a.useCallback(async()=>{if(n&&!j.current){j.current=!0;try{const{data:t,error:s}=await c.from("message_threads").select(`
          id,
          participant1_id,
          participant2_id,
          last_message_at,
          created_at
        `).or(`participant1_id.eq.${n},participant2_id.eq.${n}`).order("last_message_at",{ascending:!1});if(s)throw s;const g=await Promise.all((t||[]).map(async i=>{const h=i.participant1_id===n?i.participant2_id:i.participant1_id,{data:C}=await c.from("users").select("id, name, email, role").eq("id",h).single(),{count:O}=await c.from("messages").select("*",{count:"exact",head:!0}).eq("thread_id",i.id).eq("receiver_id",n).eq("is_read",!1),{data:M}=await c.from("messages").select("content").eq("thread_id",i.id).order("created_at",{ascending:!1}).limit(1).single();return{...i,other_user:C||void 0,unread_count:O||0,last_message_preview:M==null?void 0:M.content}}));Q(g),o(null)}catch(t){console.error("[useMessages] fetchThreads error:",t),o(t instanceof Error?t.message:"スレッドの取得に失敗しました")}finally{j.current=!1}}},[n]),u=a.useCallback(async t=>{if(t&&!_.current[t]){_.current[t]=!0;try{const{data:s,error:g}=await c.from("messages").select(`
          id,
          thread_id,
          sender_id,
          receiver_id,
          content,
          is_read,
          created_at,
          updated_at,
          sender:users!messages_sender_id_fkey(id, name, email)
        `).eq("thread_id",t).order("created_at",{ascending:!0}).limit(100);if(g)throw g;w(i=>({...i,[t]:s||[]}))}catch(s){console.error("[useMessages] fetchMessages error:",s),o(s instanceof Error?s.message:"メッセージの取得に失敗しました")}finally{_.current[t]=!1}}},[]),S=a.useCallback(async t=>{const[s,g]=[n,t].sort(),{data:i}=await c.from("organization_members").select("organization_id").eq("user_id",n),{data:h}=await c.from("organization_members").select("organization_id").eq("user_id",t);if(!i||i.length===0)throw new Error("あなたは組織に所属していません。メッセージを送信するには組織に所属する必要があります。");if(!h||h.length===0)throw new Error("相手が組織に所属していません。");const C=i.map(l=>l.organization_id),O=h.map(l=>l.organization_id);if(C.filter(l=>O.includes(l)).length===0)throw new Error("相手と同じ組織に所属していません。同じ組織のメンバーとのみメッセージのやり取りができます。");const{data:P,error:D}=await c.from("message_threads").select("id").eq("participant1_id",s).eq("participant2_id",g).maybeSingle();if(D)throw new Error("既存のスレッド検索に失敗しました: "+D.message);if(P)return P.id;const{data:H,error:r}=await c.from("message_threads").insert({participant1_id:s,participant2_id:g}).select("id").single();if(r)throw new Error("スレッド作成に失敗しました: "+r.message);return await x(),H.id},[n,x]),F=a.useCallback(async(t,s,g)=>{try{const i=s.trim();if(!i)throw new Error("メッセージを入力してください");if(i.length>2e3)throw new Error("メッセージは2000文字以内で入力してください");const{error:h}=await c.from("messages").insert({thread_id:t,sender_id:n,receiver_id:g,content:i});if(h)throw h;return await Promise.all([u(t),x()]),{success:!0,error:null}}catch(i){return console.error("[useMessages] sendMessage error:",i),{success:!1,error:i instanceof Error?i.message:"メッセージの送信に失敗しました"}}},[n,u,x]),A=a.useCallback(async t=>{try{const{error:s}=await c.from("messages").update({is_read:!0}).eq("id",t).eq("receiver_id",n);if(s)throw s}catch(s){console.error("[useMessages] markAsRead error:",s)}},[n]),X=a.useCallback(async t=>{try{const{error:s}=await c.from("messages").update({is_read:!0}).eq("thread_id",t).eq("receiver_id",n).eq("is_read",!1);if(s)throw s;await x()}catch(s){console.error("[useMessages] markThreadAsRead error:",s)}},[n,x]);a.useEffect(()=>{let t=!1;return(async()=>{if(!n){R(!1),Q([]),w({}),z(null),o(null);return}R(!0),await x(),t||R(!1)})(),()=>{t=!0}},[n,x]),a.useEffect(()=>{if(f.current&&(f.current(),f.current=null),!n)return;const t=`messages:threads:${n}:${U.current}`,s=v({key:t,intervalMs:12e4,run:x,enabled:!0,requireVisible:!0,requireOnline:!0,immediate:!1});return f.current=s,()=>{f.current&&(f.current(),f.current=null)}},[n,v,x]);const q=!!n&&!!d&&ie;a.useEffect(()=>{if(m.current&&(m.current(),m.current=null),!n||!d)return;const t=`messages:active:${d}:${U.current}`,s=v({key:t,intervalMs:3e4,run:async()=>{await u(d)},enabled:!q,requireVisible:!0,requireOnline:!0,immediate:!0});return m.current=s,()=>{m.current&&(m.current(),m.current=null)}},[n,d,v,u,q]),a.useEffect(()=>{k()},[d,q,u,x,k]);const N=a.useMemo(()=>p.reduce((t,s)=>t+(s.unread_count||0),0),[p]);return{threads:p,messages:V,loading:T,error:B,activeThreadId:d,setActiveThreadId:z,totalUnreadCount:N,getOrCreateThread:S,sendMessage:F,markAsRead:A,markThreadAsRead:X,fetchMessages:u,refreshThreads:x}}const me=ne.memo(function({userId:p,userName:Q,onClose:V}){var M,P,D,H;const{threads:w,messages:T,loading:R,error:B,activeThreadId:o,setActiveThreadId:d,totalUnreadCount:z,getOrCreateThread:W,sendMessage:v,markThreadAsRead:L,fetchMessages:f}=le(p),[m,U]=a.useState(""),[j,_]=a.useState(!1),[k,x]=a.useState(""),[u,S]=a.useState(!1),[F,A]=a.useState([]),[X,q]=a.useState(!1),[N,E]=a.useState(null),[$,t]=a.useState(!0),s=a.useMemo(()=>w.find(r=>r.id===o),[w,o]),g=a.useMemo(()=>{if(!k.trim())return w;const r=k.toLowerCase();return w.filter(l=>{var y,b;return((y=l.other_user)==null?void 0:y.name.toLowerCase().includes(r))||((b=l.other_user)==null?void 0:b.email.toLowerCase().includes(r))})},[w,k]),i=a.useCallback(async()=>{try{q(!0);const{data:r}=await c.from("organization_members").select("organization_id").eq("user_id",p);if(!r||r.length===0){A([]);return}const l=r.map(K=>K.organization_id),{data:y}=await c.from("organization_members").select("user_id").in("organization_id",l);if(!y){A([]);return}const b=[...new Set(y.map(K=>K.user_id))].filter(K=>K!==p),{data:J}=await c.from("users").select("id, name, email, role").in("id",b).order("name");A(J||[])}catch(r){console.error("Error fetching users:",r)}finally{q(!1)}},[p]),h=a.useCallback(async r=>{d(r),S(!1),t(!1),await f(r),await L(r)},[d,f,L]),C=a.useCallback(async()=>{var b;if(!m.trim()||j)return;let r=o,l=(b=s==null?void 0:s.other_user)==null?void 0:b.id;if(u&&N)try{_(!0),r=await W(N),l=N,d(r),S(!1),E(null),_(!1)}catch(J){console.error("Error creating thread:",J),_(!1),alert("スレッドの作成に失敗しました: "+(J instanceof Error?J.message:"不明なエラー"));return}if(!r||!l)return;_(!0);const y=await v(r,m,l);_(!1),y.success&&U("")},[m,j,o,s,u,N,W,v,d]),O=a.useCallback(r=>{r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),C())},[C]);return a.useEffect(()=>{u&&i()},[u,i]),a.useEffect(()=>{if(o&&T[o]){const r=document.getElementById("messages-container");r&&(r.scrollTop=r.scrollHeight)}},[o,T]),e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 sm:p-4",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 sm:rounded-xl shadow-2xl w-full sm:max-w-5xl h-full sm:h-[600px] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(G,{className:"w-6 h-6 text-blue-600 dark:text-blue-400"}),e.jsx("h2",{className:"text-xl font-bold text-gray-900 dark:text-white",children:"メッセージ"}),z>0&&e.jsx("span",{className:"bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full",children:z})]}),e.jsx("button",{onClick:V,className:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors",children:e.jsx(Y,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"flex flex-1 overflow-hidden",children:[e.jsxs("div",{className:`${$?"flex":"hidden sm:flex"} w-full sm:w-1/3 border-r border-gray-200 dark:border-gray-700 flex-col`,children:[e.jsxs("div",{className:"p-3 space-y-2 border-b border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"relative",children:[e.jsx(re,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"会話を検索...",value:k,onChange:r=>x(r.target.value),className:"w-full pl-10 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white text-sm"})]}),e.jsx("button",{onClick:()=>{S(!0),d(null)},className:"w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg transition-colors text-sm font-medium",children:"新しいメッセージ"})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:R&&w.length===0?e.jsx("div",{className:"flex items-center justify-center h-32",children:e.jsx(Z,{className:"w-6 h-6 animate-spin text-blue-600"})}):g.length===0?e.jsxs("div",{className:"text-center py-8 px-4",children:[e.jsx(G,{className:"w-12 h-12 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:k?"該当する会話がありません":"メッセージはありません"})]}):g.map(r=>{var l,y,b;return e.jsx("button",{onClick:()=>h(r.id),className:`w-full p-3 sm:p-3 border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors text-left ${o===r.id?"bg-blue-50 dark:bg-gray-700":""}`,children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("p",{className:"font-semibold text-gray-900 dark:text-white text-sm truncate",children:((l=r.other_user)==null?void 0:l.name)||"不明なユーザー"}),(r.unread_count||0)>0&&e.jsx("span",{className:"bg-red-500 text-white text-xs font-bold px-1.5 py-0.5 rounded-full",children:r.unread_count})]}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400 truncate",children:((y=r.other_user)==null?void 0:y.role)==="<global_admin"?"管理者":((b=r.other_user)==null?void 0:b.role)==="staff"?"コーチ":"アスリート"}),r.last_message_preview&&e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 truncate mt-1",children:r.last_message_preview})]}),e.jsx("span",{className:"text-xs text-gray-400 ml-2 whitespace-nowrap",children:new Date(r.last_message_at).toLocaleDateString("ja-JP",{month:"short",day:"numeric"})})]})},r.id)})})]}),e.jsxs("div",{className:`${!$||s||u?"flex":"hidden sm:flex"} flex-1 flex-col`,children:[u?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"sm:hidden p-4 border-b border-gray-200 dark:border-gray-700 flex items-center space-x-3",children:[e.jsx("button",{onClick:()=>{S(!1),t(!0)},className:"text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white",children:e.jsx(Y,{className:"w-5 h-5"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"新しいメッセージ"})]}),e.jsxs("div",{className:"flex-1 flex flex-col p-4",children:[e.jsx("h3",{className:"hidden sm:block text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"新しいメッセージ"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"宛先を選択"}),X?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(Z,{className:"w-6 h-6 animate-spin text-blue-600"})}):F.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(se,{className:"w-12 h-12 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"メッセージを送信できるユーザーがいません"})]}):e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:F.map(r=>e.jsxs("button",{onClick:()=>E(r.id),className:`w-full p-3 border rounded-lg text-left transition-colors ${N===r.id?"border-blue-500 bg-blue-50 dark:bg-gray-700":"border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700"}`,children:[e.jsx("p",{className:"font-semibold text-gray-900 dark:text-white text-sm",children:r.name}),e.jsxs("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:[r.email," •"," ",r.role==="global_admin"?"管理者":r.role==="staff"?"コーチ":"アスリート"]})]},r.id))})]})]})]}):s?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 dark:border-gray-700 flex items-center space-x-3",children:[e.jsx("button",{onClick:()=>{d(null),t(!0)},className:"sm:hidden text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white",children:e.jsx(Y,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-white",children:((M=s.other_user)==null?void 0:M.name)||"不明なユーザー"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:((P=s.other_user)==null?void 0:P.role)==="global_admin"?"管理者":((D=s.other_user)==null?void 0:D.role)==="staff"?"コーチ":"アスリート"})]})]}),e.jsx("div",{id:"messages-container",className:"flex-1 overflow-y-auto p-4 space-y-3",children:(H=T[o])==null?void 0:H.map(r=>{const l=r.sender_id===p;return e.jsx("div",{className:`flex ${l?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${l?"bg-blue-600 text-white":"bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-white"}`,children:[e.jsx("p",{className:"text-sm whitespace-pre-wrap break-words",children:r.content}),e.jsxs("p",{className:`text-xs mt-1 ${l?"text-blue-100":"text-gray-500 dark:text-gray-400"}`,children:[new Date(r.created_at).toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit"}),l&&r.is_read&&" • 既読"]})]})},r.id)})})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(G,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"会話を選択してください"})]})}),(s||u&&N)&&e.jsxs("div",{className:"p-4 border-t border-gray-200 dark:border-gray-700",children:[B&&e.jsxs("div",{className:"mb-2 p-2 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg flex items-center space-x-2",children:[e.jsx(te,{className:"w-4 h-4 text-red-600 dark:text-red-400"}),e.jsx("p",{className:"text-sm text-red-600 dark:text-red-400",children:B})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("textarea",{value:m,onChange:r=>U(r.target.value),onKeyPress:O,placeholder:"メッセージを入力... (Enterで送信)",rows:2,maxLength:2e3,className:"flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white text-sm resize-none"}),e.jsx("button",{onClick:C,disabled:!m.trim()||j,className:"bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white px-4 py-2 rounded-lg transition-colors flex items-center space-x-2",children:j?e.jsx(Z,{className:"w-5 h-5 animate-spin"}):e.jsx(ae,{className:"w-5 h-5"})})]}),e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:[m.length,"/2000文字"]})]})]})]})]})})});export{me as MessagingPanel};

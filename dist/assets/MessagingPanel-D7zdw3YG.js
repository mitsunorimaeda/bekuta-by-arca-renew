import{z as e,J as r,s as a,j as t,a3 as s,X as n,a4 as l,a5 as i,K as d,a6 as c}from"./index-BXAoWvaK.js";import{r as o,d as x}from"./chart-vendor-DEPfNMx8.js";import"./supabase-vendor-BgrwFlS9.js";
/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const u=e("Loader",[["line",{x1:"12",x2:"12",y1:"2",y2:"6",key:"gza1u7"}],["line",{x1:"12",x2:"12",y1:"18",y2:"22",key:"1qhbu9"}],["line",{x1:"4.93",x2:"7.76",y1:"4.93",y2:"7.76",key:"xae44r"}],["line",{x1:"16.24",x2:"19.07",y1:"16.24",y2:"19.07",key:"bxnmvf"}],["line",{x1:"2",x2:"6",y1:"12",y2:"12",key:"89khin"}],["line",{x1:"18",x2:"22",y1:"12",y2:"12",key:"pb8tfm"}],["line",{x1:"4.93",x2:"7.76",y1:"19.07",y2:"16.24",key:"1uxjnu"}],["line",{x1:"16.24",x2:"19.07",y1:"7.76",y2:"4.93",key:"6duxfx"}]]);const m=x.memo(function({userId:e,userName:x,onClose:m}){var h,g,f,y;const{threads:b,messages:p,loading:w,error:v,activeThreadId:j,setActiveThreadId:_,totalUnreadCount:k,getOrCreateThread:N,sendMessage:C,markThreadAsRead:q,fetchMessages:E}=function(e){var t,s;const[n,l]=o.useState([]),[i,d]=o.useState({}),[c,x]=o.useState(!0),[u,m]=o.useState(null),[h,g]=o.useState(null),{state:f,registerPollJob:y}=r(),b=o.useRef(null),p=o.useRef(null),w=o.useRef(null),v=o.useRef((null==(s=null==(t=globalThis.crypto)?void 0:t.randomUUID)?void 0:s.call(t))??Math.random().toString(36).slice(2)),j=o.useRef(!1),_=o.useRef({}),k=o.useCallback(()=>{var e;const r=b.current;if(r){try{null==(e=r.unsubscribe)||e.call(r)}catch(t){}try{a.removeChannel(r)}catch(t){}b.current=null}},[]),N=o.useCallback(async()=>{if(e&&!j.current){j.current=!0;try{const{data:r,error:t}=await a.from("message_threads").select("\n          id,\n          participant1_id,\n          participant2_id,\n          last_message_at,\n          created_at\n        ").or(`participant1_id.eq.${e},participant2_id.eq.${e}`).order("last_message_at",{ascending:!1});if(t)throw t;const s=await Promise.all((r||[]).map(async r=>{const t=r.participant1_id===e?r.participant2_id:r.participant1_id,{data:s}=await a.from("users").select("id, name, email, role").eq("id",t).single(),{count:n}=await a.from("messages").select("*",{count:"exact",head:!0}).eq("thread_id",r.id).eq("receiver_id",e).eq("is_read",!1),{data:l}=await a.from("messages").select("content").eq("thread_id",r.id).order("created_at",{ascending:!1}).limit(1).single();return{...r,other_user:s||void 0,unread_count:n||0,last_message_preview:null==l?void 0:l.content}}));l(s),m(null)}catch(r){console.error("[useMessages] fetchThreads error:",r),m(r instanceof Error?r.message:"スレッドの取得に失敗しました")}finally{j.current=!1}}},[e]),C=o.useCallback(async e=>{if(e&&!_.current[e]){_.current[e]=!0;try{const{data:r,error:t}=await a.from("messages").select("\n          id,\n          thread_id,\n          sender_id,\n          receiver_id,\n          content,\n          is_read,\n          created_at,\n          updated_at,\n          sender:users!messages_sender_id_fkey(id, name, email)\n        ").eq("thread_id",e).order("created_at",{ascending:!0}).limit(100);if(t)throw t;d(a=>({...a,[e]:r||[]}))}catch(r){console.error("[useMessages] fetchMessages error:",r),m(r instanceof Error?r.message:"メッセージの取得に失敗しました")}finally{_.current[e]=!1}}},[]),q=o.useCallback(async r=>{const[t,s]=[e,r].sort(),{data:n}=await a.from("organization_members").select("organization_id").eq("user_id",e),{data:l}=await a.from("organization_members").select("organization_id").eq("user_id",r);if(!n||0===n.length)throw new Error("あなたは組織に所属していません。メッセージを送信するには組織に所属する必要があります。");if(!l||0===l.length)throw new Error("相手が組織に所属していません。");const i=n.map(e=>e.organization_id),d=l.map(e=>e.organization_id);if(0===i.filter(e=>d.includes(e)).length)throw new Error("相手と同じ組織に所属していません。同じ組織のメンバーとのみメッセージのやり取りができます。");const{data:c,error:o}=await a.from("message_threads").select("id").eq("participant1_id",t).eq("participant2_id",s).maybeSingle();if(o)throw new Error("既存のスレッド検索に失敗しました: "+o.message);if(c)return c.id;const{data:x,error:u}=await a.from("message_threads").insert({participant1_id:t,participant2_id:s}).select("id").single();if(u)throw new Error("スレッド作成に失敗しました: "+u.message);return await N(),x.id},[e,N]),E=o.useCallback(async(r,t,s)=>{try{const n=t.trim();if(!n)throw new Error("メッセージを入力してください");if(n.length>2e3)throw new Error("メッセージは2000文字以内で入力してください");const{error:l}=await a.from("messages").insert({thread_id:r,sender_id:e,receiver_id:s,content:n});if(l)throw l;return await Promise.all([C(r),N()]),{success:!0,error:null}}catch(n){return console.error("[useMessages] sendMessage error:",n),{success:!1,error:n instanceof Error?n.message:"メッセージの送信に失敗しました"}}},[e,C,N]),S=o.useCallback(async r=>{try{const{error:t}=await a.from("messages").update({is_read:!0}).eq("id",r).eq("receiver_id",e);if(t)throw t}catch(t){console.error("[useMessages] markAsRead error:",t)}},[e]),M=o.useCallback(async r=>{try{const{error:t}=await a.from("messages").update({is_read:!0}).eq("thread_id",r).eq("receiver_id",e).eq("is_read",!1);if(t)throw t;await N()}catch(t){console.error("[useMessages] markThreadAsRead error:",t)}},[e,N]);o.useEffect(()=>{let r=!1;return(async()=>{if(!e)return x(!1),l([]),d({}),g(null),void m(null);x(!0),await N(),r||x(!1)})(),()=>{r=!0}},[e,N]),o.useEffect(()=>{if(p.current&&(p.current(),p.current=null),!e)return;const r=`messages:threads:${e}:${v.current}`,a=y({key:r,intervalMs:12e4,run:N,enabled:!0,requireVisible:!0,requireOnline:!0,immediate:!1});return p.current=a,()=>{p.current&&(p.current(),p.current=null)}},[e,y,N]);const z=!!e&&!!h&&!1;o.useEffect(()=>{if(w.current&&(w.current(),w.current=null),!e||!h)return;const r=`messages:active:${h}:${v.current}`,a=y({key:r,intervalMs:3e4,run:async()=>{await C(h)},enabled:!z,requireVisible:!0,requireOnline:!0,immediate:!0});return w.current=a,()=>{w.current&&(w.current(),w.current=null)}},[e,h,y,C,z]),o.useEffect(()=>{k()},[h,z,C,N,k]);const T=o.useMemo(()=>n.reduce((e,r)=>e+(r.unread_count||0),0),[n]);return{threads:n,messages:i,loading:c,error:u,activeThreadId:h,setActiveThreadId:g,totalUnreadCount:T,getOrCreateThread:q,sendMessage:E,markAsRead:S,markThreadAsRead:M,fetchMessages:C,refreshThreads:N}}(e),[S,M]=o.useState(""),[z,T]=o.useState(!1),[R,A]=o.useState(""),[I,L]=o.useState(!1),[P,$]=o.useState([]),[D,J]=o.useState(!1),[O,U]=o.useState(null),[K,F]=o.useState(!0),V=o.useMemo(()=>b.find(e=>e.id===j),[b,j]),B=o.useMemo(()=>{if(!R.trim())return b;const e=R.toLowerCase();return b.filter(r=>{var a,t;return(null==(a=r.other_user)?void 0:a.name.toLowerCase().includes(e))||(null==(t=r.other_user)?void 0:t.email.toLowerCase().includes(e))})},[b,R]),H=o.useCallback(async()=>{try{J(!0);const{data:r}=await a.from("organization_members").select("organization_id").eq("user_id",e);if(!r||0===r.length)return void $([]);const t=r.map(e=>e.organization_id),{data:s}=await a.from("organization_members").select("user_id").in("organization_id",t);if(!s)return void $([]);const n=[...new Set(s.map(e=>e.user_id))].filter(r=>r!==e),{data:l}=await a.from("users").select("id, name, email, role").in("id",n).order("name");$(l||[])}catch(r){console.error("Error fetching users:",r)}finally{J(!1)}},[e]),G=o.useCallback(async e=>{_(e),L(!1),F(!1),await E(e),await q(e)},[_,E,q]),Q=o.useCallback(async()=>{var e;if(!S.trim()||z)return;let r=j,a=null==(e=null==V?void 0:V.other_user)?void 0:e.id;if(I&&O)try{T(!0),r=await N(O),a=O,_(r),L(!1),U(null),T(!1)}catch(s){return console.error("Error creating thread:",s),T(!1),void alert("スレッドの作成に失敗しました: "+(s instanceof Error?s.message:"不明なエラー"))}if(!r||!a)return;T(!0);const t=await C(r,S,a);T(!1),t.success&&M("")},[S,z,j,V,I,O,N,C,_]),W=o.useCallback(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),Q())},[Q]);return o.useEffect(()=>{I&&H()},[I,H]),o.useEffect(()=>{if(j&&p[j]){const e=document.getElementById("messages-container");e&&(e.scrollTop=e.scrollHeight)}},[j,p]),t.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 sm:p-4",children:t.jsxs("div",{className:"bg-white dark:bg-gray-800 sm:rounded-xl shadow-2xl w-full sm:max-w-5xl h-full sm:h-[600px] flex flex-col",children:[t.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700",children:[t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx(s,{className:"w-6 h-6 text-blue-600 dark:text-blue-400"}),t.jsx("h2",{className:"text-xl font-bold text-gray-900 dark:text-white",children:"メッセージ"}),k>0&&t.jsx("span",{className:"bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full",children:k})]}),t.jsx("button",{onClick:m,className:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors",children:t.jsx(n,{className:"w-6 h-6"})})]}),t.jsxs("div",{className:"flex flex-1 overflow-hidden",children:[t.jsxs("div",{className:(K?"flex":"hidden sm:flex")+" w-full sm:w-1/3 border-r border-gray-200 dark:border-gray-700 flex-col",children:[t.jsxs("div",{className:"p-3 space-y-2 border-b border-gray-200 dark:border-gray-700",children:[t.jsxs("div",{className:"relative",children:[t.jsx(l,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),t.jsx("input",{type:"text",placeholder:"会話を検索...",value:R,onChange:e=>A(e.target.value),className:"w-full pl-10 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white text-sm"})]}),t.jsx("button",{onClick:()=>{L(!0),_(null)},className:"w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg transition-colors text-sm font-medium",children:"新しいメッセージ"})]}),t.jsx("div",{className:"flex-1 overflow-y-auto",children:w&&0===b.length?t.jsx("div",{className:"flex items-center justify-center h-32",children:t.jsx(u,{className:"w-6 h-6 animate-spin text-blue-600"})}):0===B.length?t.jsxs("div",{className:"text-center py-8 px-4",children:[t.jsx(s,{className:"w-12 h-12 text-gray-400 mx-auto mb-2"}),t.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:R?"該当する会話がありません":"メッセージはありません"})]}):B.map(e=>{var r,a,s;return t.jsx("button",{onClick:()=>G(e.id),className:"w-full p-3 sm:p-3 border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors text-left "+(j===e.id?"bg-blue-50 dark:bg-gray-700":""),children:t.jsxs("div",{className:"flex items-start justify-between",children:[t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("p",{className:"font-semibold text-gray-900 dark:text-white text-sm truncate",children:(null==(r=e.other_user)?void 0:r.name)||"不明なユーザー"}),(e.unread_count||0)>0&&t.jsx("span",{className:"bg-red-500 text-white text-xs font-bold px-1.5 py-0.5 rounded-full",children:e.unread_count})]}),t.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400 truncate",children:"<global_admin"===(null==(a=e.other_user)?void 0:a.role)?"管理者":"staff"===(null==(s=e.other_user)?void 0:s.role)?"コーチ":"アスリート"}),e.last_message_preview&&t.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 truncate mt-1",children:e.last_message_preview})]}),t.jsx("span",{className:"text-xs text-gray-400 ml-2 whitespace-nowrap",children:new Date(e.last_message_at).toLocaleDateString("ja-JP",{month:"short",day:"numeric"})})]})},e.id)})})]}),t.jsxs("div",{className:(!K||V||I?"flex":"hidden sm:flex")+" flex-1 flex-col",children:[I?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"sm:hidden p-4 border-b border-gray-200 dark:border-gray-700 flex items-center space-x-3",children:[t.jsx("button",{onClick:()=>{L(!1),F(!0)},className:"text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white",children:t.jsx(n,{className:"w-5 h-5"})}),t.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"新しいメッセージ"})]}),t.jsxs("div",{className:"flex-1 flex flex-col p-4",children:[t.jsx("h3",{className:"hidden sm:block text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"新しいメッセージ"}),t.jsxs("div",{className:"mb-4",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"宛先を選択"}),D?t.jsx("div",{className:"flex items-center justify-center py-8",children:t.jsx(u,{className:"w-6 h-6 animate-spin text-blue-600"})}):0===P.length?t.jsxs("div",{className:"text-center py-8",children:[t.jsx(i,{className:"w-12 h-12 text-gray-400 mx-auto mb-2"}),t.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"メッセージを送信できるユーザーがいません"})]}):t.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:P.map(e=>t.jsxs("button",{onClick:()=>U(e.id),className:"w-full p-3 border rounded-lg text-left transition-colors "+(O===e.id?"border-blue-500 bg-blue-50 dark:bg-gray-700":"border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700"),children:[t.jsx("p",{className:"font-semibold text-gray-900 dark:text-white text-sm",children:e.name}),t.jsxs("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:[e.email," •"," ","global_admin"===e.role?"管理者":"staff"===e.role?"コーチ":"アスリート"]})]},e.id))})]})]})]}):V?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"p-4 border-b border-gray-200 dark:border-gray-700 flex items-center space-x-3",children:[t.jsx("button",{onClick:()=>{_(null),F(!0)},className:"sm:hidden text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white",children:t.jsx(n,{className:"w-5 h-5"})}),t.jsxs("div",{className:"flex-1",children:[t.jsx("h3",{className:"font-semibold text-gray-900 dark:text-white",children:(null==(h=V.other_user)?void 0:h.name)||"不明なユーザー"}),t.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"global_admin"===(null==(g=V.other_user)?void 0:g.role)?"管理者":"staff"===(null==(f=V.other_user)?void 0:f.role)?"コーチ":"アスリート"})]})]}),t.jsx("div",{id:"messages-container",className:"flex-1 overflow-y-auto p-4 space-y-3",children:null==(y=p[j])?void 0:y.map(r=>{const a=r.sender_id===e;return t.jsx("div",{className:"flex "+(a?"justify-end":"justify-start"),children:t.jsxs("div",{className:"max-w-xs lg:max-w-md px-4 py-2 rounded-lg "+(a?"bg-blue-600 text-white":"bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-white"),children:[t.jsx("p",{className:"text-sm whitespace-pre-wrap break-words",children:r.content}),t.jsxs("p",{className:"text-xs mt-1 "+(a?"text-blue-100":"text-gray-500 dark:text-gray-400"),children:[new Date(r.created_at).toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit"}),a&&r.is_read&&" • 既読"]})]})},r.id)})})]}):t.jsx("div",{className:"flex-1 flex items-center justify-center",children:t.jsxs("div",{className:"text-center",children:[t.jsx(s,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),t.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"会話を選択してください"})]})}),(V||I&&O)&&t.jsxs("div",{className:"p-4 border-t border-gray-200 dark:border-gray-700",children:[v&&t.jsxs("div",{className:"mb-2 p-2 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg flex items-center space-x-2",children:[t.jsx(d,{className:"w-4 h-4 text-red-600 dark:text-red-400"}),t.jsx("p",{className:"text-sm text-red-600 dark:text-red-400",children:v})]}),t.jsxs("div",{className:"flex space-x-2",children:[t.jsx("textarea",{value:S,onChange:e=>M(e.target.value),onKeyPress:W,placeholder:"メッセージを入力... (Enterで送信)",rows:2,maxLength:2e3,className:"flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white text-sm resize-none"}),t.jsx("button",{onClick:Q,disabled:!S.trim()||z,className:"bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white px-4 py-2 rounded-lg transition-colors flex items-center space-x-2",children:z?t.jsx(u,{className:"w-5 h-5 animate-spin"}):t.jsx(c,{className:"w-5 h-5"})})]}),t.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:[S.length,"/2000文字"]})]})]})]})]})})});export{m as MessagingPanel};
//# sourceMappingURL=MessagingPanel-D7zdw3YG.js.map

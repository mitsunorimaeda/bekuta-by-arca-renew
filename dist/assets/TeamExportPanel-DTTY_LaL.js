import{s as w,ag as F,j as e,U as S,X as I,E as U,D as z,I as J,N as X}from"./index-C7IL5YWP.js";import{r}from"./chart-vendor-B8I3tXXj.js";import{g as $,b as B}from"./exportUtils-Bhmxw8Iv.js";import"./supabase-vendor-CRHRt2Ih.js";function O({team:c,onClose:C}){const[n,R]=r.useState("month"),[i,k]=r.useState(""),[d,D]=r.useState(""),[f,h]=r.useState(!1),[a,v]=r.useState(null),[E,u]=r.useState(!0);r.useEffect(()=>{A()},[c.id,n,i,d]);const A=async()=>{u(!0);try{const{data:t,error:o}=await w.from("users").select("*").eq("role","athlete").eq("team_id",c.id);if(o)throw o;if(!t||t.length===0){v(null),u(!1);return}const g=n==="custom"&&i&&d?{start:i,end:d}:$(n),W=t.map(s=>s.id),{data:p,error:N}=await w.from("training_records").select("*").in("user_id",W).gte("date",g.start).lte("date",g.end).order("date",{ascending:!0});if(N)throw N;const y=t.map(s=>{const m=(p==null?void 0:p.filter(q=>q.user_id===s.id))||[],x=F(m),l=x.length>0?x[x.length-1]:null;return{user:s,trainingRecords:m,acwrData:x,latestACWR:l==null?void 0:l.acwr,riskLevel:l==null?void 0:l.riskLevel}}),b=y.filter(s=>s.trainingRecords.length>0),j=b.map(s=>s.latestACWR).filter(s=>s!==void 0),P=j.length>0?j.reduce((s,m)=>s+m,0)/j.length:0,V=b.filter(s=>s.riskLevel==="high"||s.riskLevel==="caution").length,_={totalAthletes:t.length,activeAthletes:b.length,averageACWR:Number(P.toFixed(2)),highRiskAthletes:V};v({teamName:c.name,athletes:y,teamSummary:_,exportDate:new Date().toLocaleString("ja-JP"),dateRange:g})}catch(t){console.error("Error fetching team data:",t)}finally{u(!1)}},T=async()=>{if(a){h(!0);try{B(a),setTimeout(()=>{h(!1)},1e3)}catch(t){console.error("Export error:",t),alert("エクスポートに失敗しました。もう一度お試しください。"),h(!1)}}},L=()=>a?a.athletes.reduce((t,o)=>t+o.trainingRecords.length,0):0;return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto",children:[e.jsx("div",{className:"bg-gradient-to-r from-purple-600 to-blue-600 text-white p-6 rounded-t-2xl",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(S,{className:"w-8 h-8"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:"チームデータエクスポート"}),e.jsx("p",{className:"text-purple-100",children:c.name})]})]}),e.jsx("button",{onClick:C,className:"bg-purple-500 hover:bg-purple-400 rounded-full p-2 transition-colors",children:e.jsx(I,{className:"w-6 h-6"})})]})}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 mb-4 flex items-center",children:[e.jsx(U,{className:"w-5 h-5 mr-2"}),"エクスポート期間"]}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4",children:[{value:"week",label:"1週間"},{value:"month",label:"1ヶ月"},{value:"quarter",label:"3ヶ月"},{value:"custom",label:"カスタム"}].map(t=>e.jsx("button",{onClick:()=>R(t.value),className:`p-3 rounded-lg text-sm font-medium transition-colors ${n===t.value?"bg-purple-600 text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-50"}`,children:t.label},t.value))}),n==="custom"&&e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"開始日"}),e.jsx("input",{type:"date",value:i,onChange:t=>k(t.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"終了日"}),e.jsx("input",{type:"date",value:d,onChange:t=>D(t.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"})]})]}),a&&e.jsx("div",{className:"mt-4 p-3 bg-purple-50 rounded-lg",children:e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-bold text-purple-700",children:a.teamSummary.totalAthletes}),e.jsx("div",{className:"text-purple-600",children:"総選手数"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-bold text-purple-700",children:a.teamSummary.activeAthletes}),e.jsx("div",{className:"text-purple-600",children:"アクティブ"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-bold text-purple-700",children:L()}),e.jsx("div",{className:"text-purple-600",children:"練習記録"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-bold text-purple-700",children:a.teamSummary.averageACWR}),e.jsx("div",{className:"text-purple-600",children:"平均ACWR"})]})]})})]}),E?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"チームデータを読み込み中..."})]}):a?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 mb-4 flex items-center",children:[e.jsx(z,{className:"w-5 h-5 mr-2 text-green-600"}),"データエクスポート"]}),e.jsxs("button",{onClick:T,disabled:f,className:"w-full bg-green-600 hover:bg-green-700 text-white p-4 rounded-lg transition-colors disabled:opacity-50 flex items-center justify-center space-x-2",children:[e.jsx(J,{className:"w-5 h-5"}),e.jsx("span",{children:"チームデータ（CSV）"})]}),e.jsx("p",{className:"text-xs text-gray-600 mt-2",children:"全選手の練習記録とACWRデータをCSV形式でエクスポート"})]}),a.teamSummary.highRiskAthletes>0&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(X,{className:"w-6 h-6 text-red-600 mr-3"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-red-900",children:"注意が必要な選手"}),e.jsxs("p",{className:"text-sm text-red-700",children:[a.teamSummary.highRiskAthletes,"名の選手が高リスク状態です。 個別に詳細を確認してください。"]})]})]})}),f&&e.jsxs("div",{className:"text-center py-4",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"エクスポート中..."})]})]}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(S,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"データがありません"}),e.jsx("p",{className:"text-gray-600",children:"選択した期間にチームの練習記録がありません。"})]})]})]})})}export{O as TeamExportPanel};

import{s as e,ag as s,j as t,U as a,X as r,E as l,D as i,I as d,N as n}from"./index-DC548egD.js";import{r as c}from"./chart-vendor-DEPfNMx8.js";import{g as o,b as m}from"./exportUtils-CPsb9qem.js";import"./supabase-vendor-BgrwFlS9.js";function x({team:x,onClose:h}){const[u,g]=c.useState("month"),[p,j]=c.useState(""),[b,v]=c.useState(""),[N,f]=c.useState(!1),[y,w]=c.useState(null),[S,k]=c.useState(!0);c.useEffect(()=>{C()},[x.id,u,p,b]);const C=async()=>{k(!0);try{const{data:t,error:a}=await e.from("users").select("*").eq("role","athlete").eq("team_id",x.id);if(a)throw a;if(!t||0===t.length)return w(null),void k(!1);const r="custom"===u&&p&&b?{start:p,end:b}:o(u),l=t.map(e=>e.id),{data:i,error:d}=await e.from("training_records").select("*").in("user_id",l).gte("date",r.start).lte("date",r.end).order("date",{ascending:!0});if(d)throw d;const n=t.map(e=>{const t=(null==i?void 0:i.filter(s=>s.user_id===e.id))||[],a=s(t),r=a.length>0?a[a.length-1]:null;return{user:e,trainingRecords:t,acwrData:a,latestACWR:null==r?void 0:r.acwr,riskLevel:null==r?void 0:r.riskLevel}}),c=n.filter(e=>e.trainingRecords.length>0),m=c.map(e=>e.latestACWR).filter(e=>void 0!==e),h=m.length>0?m.reduce((e,s)=>e+s,0)/m.length:0,g=c.filter(e=>"high"===e.riskLevel||"caution"===e.riskLevel).length,j={totalAthletes:t.length,activeAthletes:c.length,averageACWR:Number(h.toFixed(2)),highRiskAthletes:g};w({teamName:x.name,athletes:n,teamSummary:j,exportDate:(new Date).toLocaleString("ja-JP"),dateRange:r})}catch(t){console.error("Error fetching team data:",t)}finally{k(!1)}};return t.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",children:t.jsxs("div",{className:"bg-white rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto",children:[t.jsx("div",{className:"bg-gradient-to-r from-purple-600 to-blue-600 text-white p-6 rounded-t-2xl",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx(a,{className:"w-8 h-8"}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-2xl font-bold",children:"チームデータエクスポート"}),t.jsx("p",{className:"text-purple-100",children:x.name})]})]}),t.jsx("button",{onClick:h,className:"bg-purple-500 hover:bg-purple-400 rounded-full p-2 transition-colors",children:t.jsx(r,{className:"w-6 h-6"})})]})}),t.jsxs("div",{className:"p-6 space-y-6",children:[t.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[t.jsxs("h3",{className:"font-semibold text-gray-900 mb-4 flex items-center",children:[t.jsx(l,{className:"w-5 h-5 mr-2"}),"エクスポート期間"]}),t.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4",children:[{value:"week",label:"1週間"},{value:"month",label:"1ヶ月"},{value:"quarter",label:"3ヶ月"},{value:"custom",label:"カスタム"}].map(e=>t.jsx("button",{onClick:()=>g(e.value),className:"p-3 rounded-lg text-sm font-medium transition-colors "+(u===e.value?"bg-purple-600 text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-50"),children:e.label},e.value))}),"custom"===u&&t.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"開始日"}),t.jsx("input",{type:"date",value:p,onChange:e=>j(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"終了日"}),t.jsx("input",{type:"date",value:b,onChange:e=>v(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"})]})]}),y&&t.jsx("div",{className:"mt-4 p-3 bg-purple-50 rounded-lg",children:t.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4 text-sm",children:[t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"font-bold text-purple-700",children:y.teamSummary.totalAthletes}),t.jsx("div",{className:"text-purple-600",children:"総選手数"})]}),t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"font-bold text-purple-700",children:y.teamSummary.activeAthletes}),t.jsx("div",{className:"text-purple-600",children:"アクティブ"})]}),t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"font-bold text-purple-700",children:y?y.athletes.reduce((e,s)=>e+s.trainingRecords.length,0):0}),t.jsx("div",{className:"text-purple-600",children:"練習記録"})]}),t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"font-bold text-purple-700",children:y.teamSummary.averageACWR}),t.jsx("div",{className:"text-purple-600",children:"平均ACWR"})]})]})})]}),S?t.jsxs("div",{className:"text-center py-8",children:[t.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"}),t.jsx("p",{className:"text-gray-600",children:"チームデータを読み込み中..."})]}):y?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[t.jsxs("h3",{className:"font-semibold text-gray-900 mb-4 flex items-center",children:[t.jsx(i,{className:"w-5 h-5 mr-2 text-green-600"}),"データエクスポート"]}),t.jsxs("button",{onClick:async()=>{if(y){f(!0);try{m(y),setTimeout(()=>{f(!1)},1e3)}catch(e){console.error("Export error:",e),alert("エクスポートに失敗しました。もう一度お試しください。"),f(!1)}}},disabled:N,className:"w-full bg-green-600 hover:bg-green-700 text-white p-4 rounded-lg transition-colors disabled:opacity-50 flex items-center justify-center space-x-2",children:[t.jsx(d,{className:"w-5 h-5"}),t.jsx("span",{children:"チームデータ（CSV）"})]}),t.jsx("p",{className:"text-xs text-gray-600 mt-2",children:"全選手の練習記録とACWRデータをCSV形式でエクスポート"})]}),y.teamSummary.highRiskAthletes>0&&t.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:t.jsxs("div",{className:"flex items-center",children:[t.jsx(n,{className:"w-6 h-6 text-red-600 mr-3"}),t.jsxs("div",{children:[t.jsx("h4",{className:"font-semibold text-red-900",children:"注意が必要な選手"}),t.jsxs("p",{className:"text-sm text-red-700",children:[y.teamSummary.highRiskAthletes,"名の選手が高リスク状態です。 個別に詳細を確認してください。"]})]})]})}),N&&t.jsxs("div",{className:"text-center py-4",children:[t.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-2"}),t.jsx("p",{className:"text-sm text-gray-600",children:"エクスポート中..."})]})]}):t.jsxs("div",{className:"text-center py-8",children:[t.jsx(a,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),t.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"データがありません"}),t.jsx("p",{className:"text-gray-600",children:"選択した期間にチームの練習記録がありません。"})]})]})]})})}export{x as TeamExportPanel};
//# sourceMappingURL=TeamExportPanel-BaFUi1FW.js.map

import{s as e,j as t,P as s,$ as r,as as a}from"./index-DC548egD.js";import{r as n}from"./chart-vendor-DEPfNMx8.js";import"./supabase-vendor-BgrwFlS9.js";const l=["筋力","スプリント","ジャンプ","敏捷","持久","その他"],i=e=>"team"===e?"チーム内":"org_sport"===e?"同校×同競技":"sport"===e?"競技全体":"不明";function d({team:d,onOpenAthlete:o}){var m;const[c,u]=n.useState([]),[x,p]=n.useState(!1),[_,h]=n.useState(null),[g,b]=n.useState(""),y=n.useMemo(()=>c.find(e=>e.id===g)??null,[c,g]),[v,f]=n.useState("primary_value"),j=!!(null==y?void 0:y.is_strength),N=n.useMemo(()=>y?j&&"relative_1rm"===v?"×BW":y.unit||"":"",[y,j,v]),w=n.useMemo(()=>(e=>{if(!e)return!1;if(!1===e.higher_is_better)return!0;if(!0===e.higher_is_better)return!1;const t=e.category_label||"";if("スプリント"===t||"敏捷"===t)return!0;const s=(e.name||"").toLowerCase();return s.startsWith("sprint_")||"050_r"===s||"050_l"===s||"050-l"===s||s.startsWith("pro_agility")||s.startsWith("arrowhead")})(y),[y]),[k,S]=n.useState([]),[C,M]=n.useState(!1),[$,R]=n.useState(null),[W,E]=n.useState(null),[F,O]=n.useState(null),[A,P]=n.useState(null),V=n.useMemo(()=>[{user_id:"dummy1",name:"田中",date:"2026-01-10",value:73.3,rank:1,top_percent:0,team_n:12},{user_id:"dummy2",name:"佐藤",date:"2026-01-08",value:71.2,rank:2,top_percent:8.3,team_n:12},{user_id:"dummy3",name:"鈴木",date:"2026-01-05",value:69,rank:3,top_percent:16.7,team_n:12}],[]),q=n.useMemo(()=>{const e=new Map;for(const t of c){const s=t.category_label||"その他";e.has(s)||e.set(s,[]),e.get(s).push(t)}for(const[t,s]of e.entries())s.sort((e,t)=>{const s=e.sort_order??9999,r=t.sort_order??9999;return s!==r?s-r:(e.display_name||"").localeCompare(t.display_name||"","ja")}),e.set(t,s);return Array.from(e.entries()).sort((e,t)=>{const s=l.indexOf(e[0]),r=l.indexOf(t[0]),a=-1===s?999:s,n=-1===r?999:r;return a!==n?a-n:e[0].localeCompare(t[0],"ja")})},[c]);n.useEffect(()=>{let t=!1;return(async()=>{try{p(!0),h(null);const{data:s,error:r}=await e.from("performance_test_types").select("\n              id,\n              name,\n              display_name,\n              unit,\n              higher_is_better,\n              is_strength,\n              category_id,\n              sort_order,\n              is_active,\n              user_can_input,\n              performance_categories (\n                id,\n                name,\n                display_name,\n                sort_order\n              )\n            ").eq("is_active",!0).order("sort_order",{ascending:!0});if(r)throw r;const a=(s??[]).map(e=>{var t,s,r;return{id:e.id,name:e.name,display_name:e.display_name,unit:e.unit,higher_is_better:e.higher_is_better,category_id:e.category_id,sort_order:e.sort_order??null,is_active:e.is_active,user_can_input:e.user_can_input,category_label:(null==(t=e.performance_categories)?void 0:t.display_name)||(null==(s=e.performance_categories)?void 0:s.name)||"その他",category_sort:(null==(r=e.performance_categories)?void 0:r.sort_order)??999,is_strength:e.is_strength??null}});if(t)return;u(a),!g&&a.length>0&&b(a[0].id)}catch(s){console.warn("[CoachRankingsView] testTypes error",s),t||h((null==s?void 0:s.message)??"種目の取得に失敗しました")}finally{t||p(!1)}})(),()=>{t=!0}},[null==d?void 0:d.id]),n.useEffect(()=>{y&&(y.is_strength||f("primary_value"))},[null==y?void 0:y.id]);const B=async()=>{if((null==d?void 0:d.id)&&g)try{M(!0),R(null);const{data:t,error:s}=await e.rpc("get_team_test_ranking",{p_days:365,p_limit:50,p_metric:v,p_team_id:d.id,p_test_type_id:g,p_min_n:5});if(s)throw s;const r=t??[],a=(null==r?void 0:r[0])??null;E((null==a?void 0:a.benchmark_scope)??null),O(null!=(null==a?void 0:a.benchmark_n)?Number(a.benchmark_n):null),P(null!=(null==a?void 0:a.min_n)?Number(a.min_n):null);const n=r.map(e=>({user_id:e.user_id,name:e.name??null,date:e.latest_date??null,value:null!=e.latest_value?Number(e.latest_value):null,rank:null!=e.team_rank?Number(e.team_rank):null,top_percent:null!=e.top_percent?Number(e.top_percent):null,team_n:null!=e.team_n?Number(e.team_n):null}));S(n)}catch(t){console.warn("[CoachRankingsView] ranking error",t),R((null==t?void 0:t.message)??"ランキング取得に失敗しました"),S(V),E(null),O(null),P(null)}finally{M(!1)}};n.useEffect(()=>{B()},[null==d?void 0:d.id,g,v]);const L=e=>e.name||"名前未設定",T=e=>{if(null==e)return"-";const t=(e=>{const t=(e||"").trim();return new Set(["回","点","m"]).has(t)?0:2})(N),s=Number(e);return 0===t?String(Math.round(s)):s.toFixed(t)};return t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"bg-white rounded-xl border border-gray-200 p-4 sm:p-5",children:[t.jsxs("div",{className:"flex items-start justify-between gap-3",children:[t.jsxs("div",{className:"min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(s,{className:"w-5 h-5 text-amber-500"}),t.jsx("div",{className:"text-base sm:text-lg font-semibold text-gray-900",children:"ランキング"})]}),t.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["種目ごとに「最新測定」の値で順位付け（チーム内）／",w?"小さいほど上位":"大きいほど上位"]})]}),t.jsxs("button",{onClick:B,className:"inline-flex items-center gap-2 px-3 py-2 rounded-lg border bg-white hover:bg-gray-50 text-sm",title:"再取得",children:[t.jsx(r,{className:"w-4 h-4 "+(C?"animate-spin":"")}),"更新"]})]}),t.jsxs("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-2 gap-3",children:[t.jsxs("div",{className:"relative",children:[t.jsx("select",{value:g,onChange:e=>b(e.target.value),className:"w-full appearance-none px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 text-sm bg-white",disabled:x,children:q.map(([e,s])=>t.jsx("optgroup",{label:e,children:s.map(e=>t.jsx("option",{value:e.id,children:e.display_name},e.id))},e))}),t.jsx(a,{className:"w-4 h-4 text-gray-400 absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none"})]}),t.jsxs("div",{className:"flex items-center justify-between",children:[j?t.jsxs("div",{className:"inline-flex rounded-lg bg-gray-100 p-1 text-[12px]",children:[t.jsx("button",{type:"button",onClick:()=>f("primary_value"),className:"px-3 py-1.5 rounded-md "+("primary_value"===v?"bg-white shadow text-gray-900":"text-gray-600"),children:"推定1RM"}),t.jsx("button",{type:"button",onClick:()=>f("relative_1rm"),className:"px-3 py-1.5 rounded-md "+("relative_1rm"===v?"bg-white shadow text-gray-900":"text-gray-600"),children:"相対1RM"})]}):t.jsx("div",{className:"text-sm text-gray-500",children:"（筋力以外は自動）"}),t.jsxs("div",{className:"text-sm text-gray-700",children:["単位：",t.jsx("span",{className:"font-semibold",children:N||"-"})]})]})]}),_&&t.jsx("div",{className:"mt-3 text-sm text-red-600",children:_})]}),t.jsxs("div",{className:"bg-white rounded-xl border border-gray-200 overflow-hidden",children:[t.jsxs("div",{className:"px-4 sm:px-5 py-3 border-b border-gray-100 flex items-center justify-between",children:[t.jsxs("div",{className:"text-sm font-semibold text-gray-900",children:[(null==y?void 0:y.display_name)??"種目"," の順位"]}),t.jsx("div",{className:"text-xs text-gray-500",children:W?t.jsxs(t.Fragment,{children:["比較：",i(W),"number"==typeof F?`（n=${F}）`:"","number"==typeof A?` / 閾値=${A}`:""]}):(null==(m=null==k?void 0:k[0])?void 0:m.team_n)?`n=${k[0].team_n}`:""})]}),W&&"team"!==W&&t.jsx("div",{className:"px-4 sm:px-5 py-2 text-[11px] text-amber-700 bg-amber-50 border-b border-amber-100",children:"※チーム内の母集団が少ないため、比較母集団を自動で拡張しています"}),$&&t.jsxs("div",{className:"px-4 sm:px-5 py-3 text-sm text-amber-700 bg-amber-50 border-b border-amber-100",children:[$,t.jsx("span",{className:"ml-2 text-xs text-amber-600",children:"（RPC未整備ならダミー表示になります）"})]}),C?t.jsx("div",{className:"flex items-center justify-center py-16",children:t.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"})}):0===k.length?t.jsx("div",{className:"py-12 text-center text-sm text-gray-500",children:"データがありません（この種目の測定がまだ無い可能性）"}):t.jsx("div",{className:"divide-y",children:k.map(e=>t.jsx("button",{className:"w-full text-left px-4 sm:px-5 py-3 hover:bg-gray-50",onClick:()=>{o&&o(e.user_id,g,v,L(e))},children:t.jsxs("div",{className:"flex items-center justify-between gap-3",children:[t.jsxs("div",{className:"min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("div",{className:"text-base font-bold text-gray-900 w-10",children:[e.rank??"-","位"]}),t.jsx("div",{className:"font-semibold text-gray-900 truncate",children:L(e)}),"number"==typeof e.top_percent&&t.jsxs("span",{className:"text-[11px] px-2 py-1 rounded-full border bg-amber-50 text-amber-800 border-amber-200",children:["上位 ",Number(e.top_percent).toFixed(1),"%"]})]}),t.jsxs("div",{className:"mt-1 text-xs text-gray-600",children:["最終測定日：",e.date??"-"]}),W&&t.jsxs("div",{className:"mt-0.5 text-[11px] text-gray-500",children:["基準：",i(W),"number"==typeof F?`（n=${F}）`:"","number"==typeof A?` / 閾値=${A}`:""]})]}),t.jsx("div",{className:"text-right",children:t.jsxs("div",{className:"text-xl font-bold text-blue-600",children:[T(e.value),t.jsx("span",{className:"text-sm font-semibold text-gray-600 ml-1",children:N})]})})]})},`${e.user_id}-${e.rank??"x"}`))})]}),t.jsx("div",{className:"text-xs text-gray-500",children:"※ 仕様：各選手の「最新記録」で順位付け（同値は rank() で同順位）"})]})}export{d as CoachRankingsView,d as default};
//# sourceMappingURL=CoachRankingsView-jr4dmQys.js.map

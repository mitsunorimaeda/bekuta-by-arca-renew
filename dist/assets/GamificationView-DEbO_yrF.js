var $e=Object.defineProperty;var Me=(t,a,s)=>a in t?$e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[a]=s;var de=(t,a,s)=>Me(t,typeof a!="symbol"?a+"":a,s);import{z as re,J as P,s as G,j as e,F as Y,K as fe,M as ae,N as se,P as W,Q as I,R as xe,X as ue,V as he,Z as Re,W as Ee,Y as Le,U as Z,_ as Te,$ as be,G as De,a0 as Be,a as He,a1 as Ae,n as ze,o as Fe,H as Ue,a2 as Ge}from"./index-C7IL5YWP.js";import{r,d as qe}from"./chart-vendor-B8I3tXXj.js";import"./supabase-vendor-CRHRt2Ih.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ve=re("Database",[["ellipse",{cx:"12",cy:"5",rx:"9",ry:"3",key:"msslwz"}],["path",{d:"M3 5V19A9 3 0 0 0 21 19V5",key:"1wlel7"}],["path",{d:"M3 12A9 3 0 0 0 21 12",key:"mv7ke4"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const We=re("Medal",[["path",{d:"M7.21 15 2.66 7.14a2 2 0 0 1 .13-2.2L4.4 2.8A2 2 0 0 1 6 2h12a2 2 0 0 1 1.6.8l1.6 2.14a2 2 0 0 1 .14 2.2L16.79 15",key:"143lza"}],["path",{d:"M11 12 5.12 2.2",key:"qhuxz6"}],["path",{d:"m13 12 5.88-9.8",key:"hbye0f"}],["path",{d:"M8 7h8",key:"i86dvs"}],["circle",{cx:"12",cy:"17",r:"5",key:"qbz8iq"}],["path",{d:"M12 18v-2h-.5",key:"fawc4q"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Je=re("Sunrise",[["path",{d:"M12 2v8",key:"1q4o3n"}],["path",{d:"m4.93 10.93 1.41 1.41",key:"2a7f42"}],["path",{d:"M2 18h2",key:"j10viu"}],["path",{d:"M20 18h2",key:"wocana"}],["path",{d:"m19.07 10.93-1.41 1.41",key:"15zs5n"}],["path",{d:"M22 22H2",key:"19qnx5"}],["path",{d:"m8 6 4-4 4 4",key:"ybng9g"}],["path",{d:"M16 18a4 4 0 0 0-8 0",key:"1lzouq"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oe=re("Tag",[["path",{d:"M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z",key:"vktsd0"}],["circle",{cx:"7.5",cy:"7.5",r:".5",fill:"currentColor",key:"kqv944"}]]);function Ze(t,a={}){var R,z;const s=a.enabled??!0,g=a.pollMs??0,u=a.pauseWhenHidden??!0,[f,j]=r.useState([]),[c,i]=r.useState(!0),[l,y]=r.useState(null),{state:M,registerPollJob:p}=P(),o=r.useRef(!0);r.useEffect(()=>()=>{o.current=!1},[]);const n=r.useRef(((z=(R=globalThis.crypto)==null?void 0:R.randomUUID)==null?void 0:z.call(R))??Math.random().toString(36).slice(2)),d=r.useRef(null),b=r.useRef(null),N=r.useRef(!1),k=r.useCallback(()=>{var $;const h=d.current;if(h){try{($=h.unsubscribe)==null||$.call(h)}catch{}try{G.removeChannel(h)}catch{}d.current=null}},[]),E=r.useCallback(()=>{b.current&&(b.current(),b.current=null)},[]),v=r.useCallback(async h=>{if(!t||!s||N.current)return;N.current=!0;const $=(h==null?void 0:h.silent)??!1;try{!$&&o.current&&i(!0);const{data:w,error:H}=await G.from("user_streaks").select("*").eq("user_id",t).order("streak_type");if(H)throw H;if(!o.current)return;j(w??[]),y(null)}catch(w){if(!o.current)return;y((w==null?void 0:w.message)??"ストリークの取得に失敗しました")}finally{N.current=!1,!$&&o.current&&i(!1)}},[t,s]);r.useEffect(()=>{if(k(),E(),!t||!s){i(!1);return}v({silent:!1})},[t,s,v,k,E]),r.useEffect(()=>{k()},[t,s,M.canRealtime,v,k]),r.useEffect(()=>{if(E(),!(!!t&&s&&g>0&&!0))return;const $=`streaks:${t}:${n.current}`,w=p({key:$,intervalMs:g,run:async()=>{await v({silent:!0})},enabled:!0,requireVisible:u,requireOnline:!0,immediate:!1});return b.current=w,()=>E()},[t,s,g,u,M.canRealtime,p,v,E]);const T=r.useCallback(h=>f.find($=>$.streak_type===h)||null,[f]),D=r.useCallback(()=>f.find(h=>h.streak_type==="all")||null,[f]),B=r.useCallback(async(h,$)=>{if(!t)return;const{error:w}=await G.rpc("update_user_streak",{p_user_id:t,p_streak_type:h,p_record_date:$});if(w)throw w;await v({silent:!0})},[t,v]),C=r.useCallback(h=>{if(!(h!=null&&h.last_recorded_date))return!1;const $=new Date(h.last_recorded_date),w=new Date;return w.setHours(0,0,0,0),$.setHours(0,0,0,0),Math.floor((w.getTime()-$.getTime())/864e5)>=1},[]),L=r.useCallback(h=>{if(!(h!=null&&h.last_recorded_date))return"broken";const $=new Date(h.last_recorded_date),w=new Date;w.setHours(0,0,0,0),$.setHours(0,0,0,0);const H=Math.floor((w.getTime()-$.getTime())/864e5);return H===0?"safe":H===1?"at_risk":"broken"},[]);return{streaks:f,loading:c,error:l,getStreakByType:T,getTotalStreak:D,updateStreak:B,isStreakAtRisk:C,getStreakStatus:L,refresh:async()=>{await v({silent:!1})}}}function Ke(t,a={}){var w,H;const s=a.includeTransactions??!1,g=a.transactionsLimit??50,[u,f]=r.useState(null),[j,c]=r.useState([]),[i,l]=r.useState(!0),[y,M]=r.useState(!1),[p,o]=r.useState(null),[n,d]=r.useState(!1),{state:b}=P(),N=r.useRef(!0);r.useEffect(()=>()=>{N.current=!1},[]),r.useRef(((H=(w=globalThis.crypto)==null?void 0:w.randomUUID)==null?void 0:H.call(w))??Math.random().toString(36).slice(2));const k=r.useRef(null),E=r.useRef(null),v=r.useRef(!1),T=r.useRef(!1),D=r.useRef(!1),B=r.useCallback(()=>{var S;const x=k.current;if(x){try{(S=x.unsubscribe)==null||S.call(x)}catch{}try{G.removeChannel(x)}catch{}k.current=null}},[]),C=r.useCallback(()=>{var S;const x=E.current;if(x){try{(S=x.unsubscribe)==null||S.call(x)}catch{}try{G.removeChannel(x)}catch{}E.current=null}},[]),L=r.useCallback(async x=>{if(!t||T.current)return;T.current=!0;const S=(x==null?void 0:x.silent)??!1;try{!S&&N.current&&l(!0);const _=await G.from("user_points").select("*").eq("user_id",t).maybeSingle();if(_.error)throw _.error;if(!N.current)return;f(_.data??null),o(null)}catch(_){if(!N.current)return;console.error("[usePoints] fetch user_points error:",_),o((_==null?void 0:_.message)??"ポイント情報の取得に失敗しました")}finally{T.current=!1,!S&&N.current&&l(!1)}},[t]),R=r.useCallback(async x=>{if(!t||D.current)return;D.current=!0;const S=(x==null?void 0:x.silent)??!1;try{!S&&N.current&&M(!0);const _=await G.from("point_transactions").select("id,user_id,points,reason,category,metadata,created_at").eq("user_id",t).order("created_at",{ascending:!1}).limit(g);if(_.error)throw _.error;if(!N.current)return;c(_.data??[]),o(null),v.current=!0,d(!0)}catch(_){if(!N.current)return;console.error("[usePoints] fetch point_transactions error:",_),o((_==null?void 0:_.message)??"ポイント履歴の取得に失敗しました")}finally{D.current=!1,!S&&N.current&&M(!1)}},[t,g]),z=r.useCallback(async x=>{await R({silent:(x==null?void 0:x.silent)??!1})},[R]);r.useEffect(()=>{if(B(),C(),!t){l(!1),c([]),d(!1),v.current=!1;return}L({silent:!1}),s?R({silent:!1}):(c([]),d(!1),v.current=!1)},[t,s,L,R,B,C]),r.useEffect(()=>{B()},[t,b.canRealtime,L,B]),r.useEffect(()=>{C()},[t,b.canRealtime,R,C]);const h=r.useCallback(()=>{const x=(u==null?void 0:u.current_points)??0,S=(u==null?void 0:u.points_to_next)??0;return S?Math.max(0,Math.min(100,Math.round(x/S*100))):0},[u]),$=r.useCallback(async x=>{const{error:S}=await G.rpc("award_points",x);if(S)throw S;await L({silent:!0}),v.current&&await R({silent:!0})},[L,R]);return{userPoints:u,transactions:j,loading:i,transactionsLoading:y,error:p,getLevelProgress:h,awardPoints:$,loadTransactions:z,hasLoadedTransactions:n}}function Qe(t,a={}){var v,T;const s=a.enabled??!0,g=a.pollMs??12e4,u=a.pauseWhenHidden??!0,[f,j]=r.useState([]),[c,i]=r.useState([]),[l,y]=r.useState(!0),[M,p]=r.useState(null),{registerPollJob:o}=P(),n=r.useRef(!0);r.useEffect(()=>(n.current=!0,()=>{n.current=!1}),[]);const d=r.useRef(((T=(v=globalThis.crypto)==null?void 0:v.randomUUID)==null?void 0:T.call(v))??Math.random().toString(36).slice(2)),b=r.useRef(null),N=r.useRef(!1),k=r.useCallback(()=>{b.current&&(b.current(),b.current=null)},[]),E=r.useCallback(async D=>{if(!t||!s||N.current)return;N.current=!0;const B=(D==null?void 0:D.silent)??!1;try{!B&&n.current&&y(!0);const{data:C,error:L}=await G.rpc("get_team_rankings",{p_team_id:t});if(L)throw L;const R=C??{},z=Array.isArray(R.weekly)?R.weekly:[],h=Array.isArray(R.points)?R.points:[];if(!n.current)return;j(z),i(h),p(null)}catch(C){if(!n.current)return;console.error("[useRankings] fetch error:",C),p((C==null?void 0:C.message)??"ランキングの取得に失敗しました")}finally{N.current=!1,!B&&n.current&&y(!1)}},[t,s]);return r.useEffect(()=>{if(k(),!t||!s){j([]),i([]),p(null),y(!1);return}E({silent:!1})},[t,s]),r.useEffect(()=>{if(k(),!(!!t&&s&&g>0))return;const B=`rankings:${t}:${d.current}`,C=o({key:B,intervalMs:g,run:async()=>{await E({silent:!0})},enabled:!0,requireVisible:u,requireOnline:!0,immediate:!1});return b.current=C,()=>k()},[t,s,g,u,o,E,k]),{weeklyRankings:f,pointsRankings:c,loading:l,error:M,refresh:async()=>{await E({silent:!1})}}}function X({streak:t,label:a,icon:s,compact:g=!1}){const u=()=>!t||t.current_streak===0?"text-gray-400":t.current_streak>=30?"text-orange-500":t.current_streak>=7?"text-yellow-500":"text-blue-500",f=()=>!t||t.current_streak===0?"bg-gray-50 dark:bg-gray-800":t.current_streak>=30?"bg-orange-50 dark:bg-orange-900/20":t.current_streak>=7?"bg-yellow-50 dark:bg-yellow-900/20":"bg-blue-50 dark:bg-blue-900/20",j=()=>!t||t.current_streak===0?"border-gray-200 dark:border-gray-700":t.current_streak>=30?"border-orange-200 dark:border-orange-800":t.current_streak>=7?"border-yellow-200 dark:border-yellow-800":"border-blue-200 dark:border-blue-800",c=()=>{if(!t||!t.last_recorded_date)return!1;const i=new Date(t.last_recorded_date),l=new Date;return l.setHours(0,0,0,0),i.setHours(0,0,0,0),Math.floor((l.getTime()-i.getTime())/(1e3*60*60*24))>=1};return g?e.jsxs("div",{className:`inline-flex items-center space-x-2 px-3 py-1.5 rounded-full border ${f()} ${j()} transition-colors`,children:[s||e.jsx(Y,{className:`w-4 h-4 ${u()}`}),e.jsxs("span",{className:`text-sm font-semibold ${u()}`,children:[(t==null?void 0:t.current_streak)||0,"日"]}),c()&&e.jsx(fe,{className:"w-3 h-3 text-red-500"})]}):e.jsxs("div",{className:`rounded-xl border ${f()} ${j()} p-4 sm:p-6 transition-all hover:shadow-md`,children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400 mb-1",children:a}),e.jsxs("div",{className:"flex items-baseline space-x-2",children:[e.jsx("p",{className:`text-3xl font-bold ${u()}`,children:(t==null?void 0:t.current_streak)||0}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:"日連続"})]})]}),e.jsx("div",{className:`p-3 rounded-lg ${f()}`,children:s||e.jsx(Y,{className:`w-6 h-6 ${u()}`})})]}),c()&&e.jsxs("div",{className:"flex items-center space-x-2 mb-3 p-2 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg",children:[e.jsx(fe,{className:"w-4 h-4 text-red-500 flex-shrink-0"}),e.jsx("p",{className:"text-xs text-red-600 dark:text-red-400",children:"今日記録しないとストリークが途切れます！"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 pt-3 border-t border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ae,{className:"w-4 h-4 text-gray-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"最長記録"}),e.jsxs("p",{className:"text-sm font-semibold text-gray-900 dark:text-white",children:[(t==null?void 0:t.longest_streak)||0,"日"]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(se,{className:"w-4 h-4 text-gray-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"累計記録"}),e.jsxs("p",{className:"text-sm font-semibold text-gray-900 dark:text-white",children:[(t==null?void 0:t.total_records)||0,"回"]})]})]})]}),t&&t.current_streak>0&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"次のマイルストーン"}),e.jsxs("span",{className:"font-semibold text-gray-900 dark:text-white",children:[t.current_streak<7?"7日":t.current_streak<30?"30日":"100日","連続"]})]}),e.jsx("div",{className:"mt-2 w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 overflow-hidden",children:e.jsx("div",{className:`h-full rounded-full transition-all duration-500 ${t.current_streak>=30?"bg-orange-500":t.current_streak>=7?"bg-yellow-500":"bg-blue-500"}`,style:{width:`${t.current_streak<7?t.current_streak/7*100:t.current_streak<30?(t.current_streak-7)/23*100:(t.current_streak-30)/70*100}%`}})})]})]})}function ye({userPoints:t,levelProgress:a,compact:s=!1,showDetails:g=!0,actions:u}){var y,M;const f=()=>t?t.current_level>=50?"text-purple-600 dark:text-purple-400":t.current_level>=40?"text-red-600 dark:text-red-400":t.current_level>=30?"text-orange-600 dark:text-orange-400":t.current_level>=20?"text-yellow-600 dark:text-yellow-400":t.current_level>=10?"text-green-600 dark:text-green-400":"text-blue-600 dark:text-blue-400":"text-gray-500",j=()=>t?t.current_level>=50?"bg-purple-50 dark:bg-purple-900/20":t.current_level>=40?"bg-red-50 dark:bg-red-900/20":t.current_level>=30?"bg-orange-50 dark:bg-orange-900/20":t.current_level>=20?"bg-yellow-50 dark:bg-yellow-900/20":t.current_level>=10?"bg-green-50 dark:bg-green-900/20":"bg-blue-50 dark:bg-blue-900/20":"bg-gray-50 dark:bg-gray-800",c=()=>t?t.current_level>=50?"border-purple-200 dark:border-purple-800":t.current_level>=40?"border-red-200 dark:border-red-800":t.current_level>=30?"border-orange-200 dark:border-orange-800":t.current_level>=20?"border-yellow-200 dark:border-yellow-800":t.current_level>=10?"border-green-200 dark:border-green-800":"border-blue-200 dark:border-blue-800":"border-gray-200 dark:border-gray-700",i=()=>t?t.current_level>=50?"bg-gradient-to-r from-purple-500 to-pink-500":t.current_level>=40?"bg-gradient-to-r from-red-500 to-orange-500":t.current_level>=30?"bg-gradient-to-r from-orange-500 to-yellow-500":t.current_level>=20?"bg-gradient-to-r from-yellow-500 to-green-500":t.current_level>=10?"bg-gradient-to-r from-green-500 to-blue-500":"bg-gradient-to-r from-blue-500 to-cyan-500":"bg-gray-400",l=()=>t?t.current_level>=50?e.jsx(xe,{className:"w-6 h-6"}):t.current_level>=30?e.jsx(W,{className:"w-6 h-6"}):e.jsx(I,{className:"w-6 h-6"}):e.jsx(I,{className:"w-6 h-6"});return s?e.jsxs("div",{className:`inline-flex items-center space-x-3 px-4 py-2 rounded-xl border ${j()} ${c()} transition-colors`,children:[e.jsx("div",{className:f(),children:l()}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:["Lv.",(t==null?void 0:t.current_level)||1]}),e.jsx("p",{className:`text-sm font-bold ${f()}`,children:(t==null?void 0:t.rank_title)||"ビギナー"})]})]}):e.jsxs("div",{className:`rounded-xl border ${j()} ${c()} p-4 sm:p-6 transition-all hover:shadow-lg`,children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400 mb-1",children:"あなたのランク"}),e.jsx("div",{className:"flex items-baseline space-x-2 mb-1",children:e.jsx("h3",{className:`text-2xl font-bold ${f()}`,children:(t==null?void 0:t.rank_title)||"ビギナー"})}),e.jsxs("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:["レベル ",(t==null?void 0:t.current_level)||1]})]}),e.jsx("div",{className:`p-3 rounded-xl ${j()} ${f()}`,children:l()})]}),g&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm mb-2",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"次のレベルまで"}),e.jsxs("span",{className:"font-semibold text-gray-900 dark:text-white",children:[(t==null?void 0:t.points_to_next_level)||100," pt"]})]}),e.jsx("div",{className:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden",children:e.jsx("div",{className:`h-full rounded-full transition-all duration-500 ${i()}`,style:{width:`${a}%`}})}),e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1 text-right",children:[Math.round(a),"%"]})]}),e.jsxs("div",{className:["pt-4 border-t border-gray-200 dark:border-gray-700","grid gap-3",u?"grid-cols-1 sm:grid-cols-3":"grid-cols-2"].join(" "),children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"p-2 bg-white dark:bg-gray-700 rounded-lg",children:e.jsx(W,{className:"w-4 h-4 text-yellow-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"総ポイント"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900 dark:text-white",children:((M=(y=t==null?void 0:t.total_points)==null?void 0:y.toLocaleString)==null?void 0:M.call(y))??0})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"p-2 bg-white dark:bg-gray-700 rounded-lg",children:e.jsx(se,{className:"w-4 h-4 text-green-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"現在のレベル"}),e.jsxs("p",{className:"text-sm font-semibold text-gray-900 dark:text-white",children:["Lv.",(t==null?void 0:t.current_level)||1]})]})]}),u?e.jsx("div",{className:"flex items-center sm:justify-end",children:u}):null]})]})]})}const Xe={Sparkles:xe,Award:ae,Flame:Y,Star:I,Trophy:W,Shield:Le,Database:Ve,Heart:Ee,Sunrise:Je,Zap:Re};function Ye({userBadges:t,allBadges:a,onClose:s,onBadgeClick:g}){const[u,f]=r.useState("all"),j=[{id:"all",label:"すべて"},{id:"streak",label:"ストリーク"},{id:"performance",label:"パフォーマンス"},{id:"consistency",label:"継続"},{id:"milestone",label:"マイルストーン"},{id:"special",label:"スペシャル"},{id:"team",label:"チーム"}],c=new Set(t.map(d=>d.badge_id)),i=a.filter(d=>!d.is_hidden&&(u==="all"||d.category===u)),l=d=>{switch(d){case"legendary":return"from-purple-500 to-pink-500";case"epic":return"from-orange-500 to-red-500";case"rare":return"from-blue-500 to-cyan-500";default:return"from-gray-400 to-gray-500"}},y=d=>{switch(d){case"legendary":return"border-purple-300 dark:border-purple-700";case"epic":return"border-orange-300 dark:border-orange-700";case"rare":return"border-blue-300 dark:border-blue-700";default:return"border-gray-300 dark:border-gray-600"}},M=d=>Xe[d]||I,p=i.filter(d=>c.has(d.id)).length,o=i.length,n=o>0?p/o*100:0;return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 backdrop-blur-sm",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col transition-colors",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"バッジコレクション"}),e.jsxs("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-1",children:["獲得: ",p," / ",o," (",Math.round(n),"%)"]})]}),s&&e.jsx("button",{onClick:s,className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors",children:e.jsx(ue,{className:"w-6 h-6 text-gray-600 dark:text-gray-400"})})]}),e.jsx("div",{className:"px-6 pt-4",children:e.jsx("div",{className:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 overflow-hidden",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-blue-500 to-purple-500 rounded-full transition-all duration-500",style:{width:`${n}%`}})})}),e.jsx("div",{className:"px-6 py-4 overflow-x-auto",children:e.jsx("div",{className:"flex space-x-2",children:j.map(d=>e.jsx("button",{onClick:()=>f(d.id),className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors whitespace-nowrap ${u===d.id?"bg-blue-600 text-white":"bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"}`,children:d.label},d.id))})}),e.jsxs("div",{className:"flex-1 overflow-y-auto px-6 pb-6",children:[e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4",children:i.map(d=>{const b=c.has(d.id),N=t.find(E=>E.badge_id===d.id),k=M(d.icon);return e.jsxs("div",{onClick:()=>g&&g(N||d),className:`relative p-4 rounded-xl border-2 transition-all cursor-pointer ${b?`${y(d.rarity)} bg-white dark:bg-gray-700 hover:shadow-lg transform hover:scale-105`:"border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 opacity-60 hover:opacity-80"}`,children:[b&&d.rarity!=="common"&&e.jsx("div",{className:"absolute top-2 right-2",children:e.jsx("div",{className:`w-2 h-2 rounded-full bg-gradient-to-r ${l(d.rarity)}`})}),(N==null?void 0:N.is_new)&&e.jsx("div",{className:"absolute -top-2 -right-2",children:e.jsx("div",{className:"bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full animate-pulse",children:"NEW"})}),e.jsx("div",{className:"flex justify-center mb-3",children:e.jsx("div",{className:`p-4 rounded-full ${b?`bg-gradient-to-br ${l(d.rarity)} text-white`:"bg-gray-200 dark:bg-gray-700 text-gray-400"}`,children:b?e.jsx(k,{className:"w-8 h-8"}):e.jsx(he,{className:"w-8 h-8"})})}),e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:`text-sm font-bold mb-1 ${b?"text-gray-900 dark:text-white":"text-gray-500 dark:text-gray-400"}`,children:d.name}),e.jsx("p",{className:`text-xs ${b?"text-gray-600 dark:text-gray-400":"text-gray-400 dark:text-gray-500"}`,children:d.description}),b&&e.jsxs("div",{className:"mt-2 flex items-center justify-center space-x-1 text-xs text-gray-500 dark:text-gray-400",children:[e.jsx(W,{className:"w-3 h-3"}),e.jsxs("span",{children:["+",d.points_reward,"pt"]})]})]})]},d.id)})}),i.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(he,{className:"w-12 h-12 text-gray-300 dark:text-gray-600 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"このカテゴリーにはバッジがありません"})]})]})]})})}function F(t,a=0){const s=typeof t=="number"?t:Number(t);return Number.isFinite(s)?s:a}function O(t,a="—"){const s=typeof t=="string"?t:t==null?"":String(t);return s.trim()?s:a}function Ie({weeklyRankings:t,pointsRankings:a,myUserId:s,compact:g=!1}){const[u,f]=r.useState("weekly"),j=r.useMemo(()=>Array.isArray(t)?t:[],[t]),c=r.useMemo(()=>Array.isArray(a)?a:[],[a]),i=o=>o===1?{icon:W,color:"text-yellow-500",bg:"bg-yellow-50 dark:bg-yellow-900/20"}:o===2?{icon:We,color:"text-gray-400",bg:"bg-gray-50 dark:bg-gray-800"}:o===3?{icon:ae,color:"text-orange-600 dark:text-orange-400",bg:"bg-orange-50 dark:bg-orange-900/20"}:null,l=g?5:10,y=()=>{const o=j.find(n=>(n==null?void 0:n.user_id)===s);return e.jsxs("div",{className:"space-y-2",children:[j.slice(0,l).map(n=>{const d=F(n==null?void 0:n.rank,0),b=i(d),N=O(n==null?void 0:n.user_id,`row-${d}`),k=(n==null?void 0:n.user_id)===s,E=F(n==null?void 0:n.weekly_records,0),v=O(n==null?void 0:n.user_name,"ユーザー");return e.jsx("div",{className:`flex items-center justify-between p-3 rounded-lg transition-all ${k?"bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-300 dark:border-blue-700":"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:shadow-md"}`,children:e.jsxs("div",{className:"flex items-center space-x-3 flex-1",children:[e.jsx("div",{className:`flex items-center justify-center w-8 h-8 rounded-full font-bold ${b?`${b.bg} ${b.color}`:"bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400"}`,children:b?e.jsx(b.icon,{className:"w-5 h-5"}):e.jsx("span",{className:"text-sm",children:d||"—"})}),e.jsx("div",{className:"flex-1",children:e.jsxs("p",{className:`font-semibold ${k?"text-blue-700 dark:text-blue-400":"text-gray-900 dark:text-white"}`,children:[v,k&&e.jsx("span",{className:"ml-2 text-xs text-blue-600 dark:text-blue-400",children:"(あなた)"})]})}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"text-sm font-semibold text-gray-900 dark:text-white",children:[E,"回"]}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"今週"})]})]})},N)}),o&&F(o==null?void 0:o.rank,0)>l&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center justify-center py-2",children:e.jsx("div",{className:"w-12 h-0.5 bg-gray-300 dark:bg-gray-600"})}),e.jsx("div",{className:"flex items-center justify-between p-3 rounded-lg bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-300 dark:border-blue-700",children:e.jsxs("div",{className:"flex items-center space-x-3 flex-1",children:[e.jsx("div",{className:"flex items-center justify-center w-8 h-8 rounded-full font-bold bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400",children:e.jsx("span",{className:"text-sm",children:F(o==null?void 0:o.rank,0)||"—"})}),e.jsx("div",{className:"flex-1",children:e.jsxs("p",{className:"font-semibold text-blue-700 dark:text-blue-400",children:[O(o==null?void 0:o.user_name,"あなた"),e.jsx("span",{className:"ml-2 text-xs",children:"(あなた)"})]})}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"text-sm font-semibold text-gray-900 dark:text-white",children:[F(o==null?void 0:o.weekly_records,0),"回"]}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"今週"})]})]})})]})]})},M=()=>{const o=c.find(n=>(n==null?void 0:n.user_id)===s);return e.jsxs("div",{className:"space-y-2",children:[c.slice(0,l).map(n=>{const d=F(n==null?void 0:n.rank,0),b=i(d),N=O(n==null?void 0:n.user_id,`row-${d}`),k=(n==null?void 0:n.user_id)===s,E=F(n==null?void 0:n.total_points,0),v=F(n==null?void 0:n.current_level,0),T=O(n==null?void 0:n.user_name,"ユーザー");return e.jsx("div",{className:`flex items-center justify-between p-3 rounded-lg transition-all ${k?"bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-300 dark:border-blue-700":"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:shadow-md"}`,children:e.jsxs("div",{className:"flex items-center space-x-3 flex-1",children:[e.jsx("div",{className:`flex items-center justify-center w-8 h-8 rounded-full font-bold ${b?`${b.bg} ${b.color}`:"bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400"}`,children:b?e.jsx(b.icon,{className:"w-5 h-5"}):e.jsx("span",{className:"text-sm",children:d||"—"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("p",{className:`font-semibold ${k?"text-blue-700 dark:text-blue-400":"text-gray-900 dark:text-white"}`,children:[T,k&&e.jsx("span",{className:"ml-2 text-xs text-blue-600 dark:text-blue-400",children:"(あなた)"})]}),e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:["Lv.",v]})]}),e.jsx("div",{className:"text-right",children:e.jsxs("p",{className:"text-sm font-semibold text-gray-900 dark:text-white",children:[E.toLocaleString(),"pt"]})})]})},N)}),o&&F(o==null?void 0:o.rank,0)>l&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center justify-center py-2",children:e.jsx("div",{className:"w-12 h-0.5 bg-gray-300 dark:bg-gray-600"})}),e.jsx("div",{className:"flex items-center justify-between p-3 rounded-lg bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-300 dark:border-blue-700",children:e.jsxs("div",{className:"flex items-center space-x-3 flex-1",children:[e.jsx("div",{className:"flex items-center justify-center w-8 h-8 rounded-full font-bold bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400",children:e.jsx("span",{className:"text-sm",children:F(o==null?void 0:o.rank,0)||"—"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("p",{className:"font-semibold text-blue-700 dark:text-blue-400",children:[O(o==null?void 0:o.user_name,"あなた"),e.jsx("span",{className:"ml-2 text-xs",children:"(あなた)"})]}),e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:["Lv.",F(o==null?void 0:o.current_level,0)]})]}),e.jsx("div",{className:"text-right",children:e.jsxs("p",{className:"text-sm font-semibold text-gray-900 dark:text-white",children:[F(o==null?void 0:o.total_points,0).toLocaleString(),"pt"]})})]})})]})]})},p=u==="weekly"?j:c;return g?e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 transition-colors",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-4",children:[e.jsx(Z,{className:"w-5 h-5 text-blue-600 dark:text-blue-400"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"チームランキング"})]}),u==="weekly"?y():M(),p.length===0&&e.jsxs("div",{className:"text-center py-10",children:[e.jsx(Z,{className:"w-10 h-10 text-gray-300 dark:text-gray-600 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"ランキングデータがありません"})]})]}):e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden transition-colors",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-4",children:[e.jsx(Z,{className:"w-6 h-6 text-blue-600 dark:text-blue-400"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"チームランキング"})]}),e.jsxs("div",{className:"flex space-x-2 bg-gray-100 dark:bg-gray-700 p-1 rounded-lg",children:[e.jsxs("button",{onClick:()=>f("weekly"),className:`flex-1 flex items-center justify-center space-x-2 px-4 py-2 rounded-md text-sm font-medium transition-colors ${u==="weekly"?"bg-white dark:bg-gray-600 text-blue-600 dark:text-blue-400 shadow-sm":"text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white"}`,children:[e.jsx(se,{className:"w-4 h-4"}),e.jsx("span",{children:"週間記録数"})]}),e.jsxs("button",{onClick:()=>f("points"),className:`flex-1 flex items-center justify-center space-x-2 px-4 py-2 rounded-md text-sm font-medium transition-colors ${u==="points"?"bg-white dark:bg-gray-600 text-blue-600 dark:text-blue-400 shadow-sm":"text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white"}`,children:[e.jsx(W,{className:"w-4 h-4"}),e.jsx("span",{children:"総ポイント"})]})]})]}),e.jsxs("div",{className:"p-6",children:[u==="weekly"?y():M(),p.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Z,{className:"w-12 h-12 text-gray-300 dark:text-gray-600 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"ランキングデータがありません"})]})]})]})}function Pe({newLevel:t,rankTitle:a,onClose:s}){const[g,u]=r.useState(!1),f=r.useMemo(()=>{const i=Te,l=(i==null?void 0:i.default)??i;return typeof l=="function"?l:null},[]);r.useEffect(()=>{if(u(!0),!f){console.warn("[LevelUpModal] canvas-confetti function not available (skipping confetti).");return}try{const l=Date.now()+4e3;(function y(){f({particleCount:2,angle:60,spread:55,origin:{x:0},colors:["#FFD700","#FFA500","#FF6347"]}),f({particleCount:2,angle:120,spread:55,origin:{x:1},colors:["#FFD700","#FFA500","#FF6347"]}),Date.now()<l&&requestAnimationFrame(y)})()}catch(i){console.warn("[LevelUpModal] confetti threw error (skipping).",i)}},[f]);const j=()=>t>=50?"from-purple-600 via-pink-600 to-purple-600":t>=40?"from-red-600 via-orange-600 to-red-600":t>=30?"from-orange-600 via-yellow-600 to-orange-600":t>=20?"from-yellow-600 via-green-600 to-yellow-600":t>=10?"from-green-600 via-blue-600 to-green-600":"from-blue-600 via-cyan-600 to-blue-600",c=r.useMemo(()=>Array.from({length:8}).map((i,l)=>({key:l,top:`${Math.random()*100}%`,left:`${Math.random()*100}%`,delay:`${l*.3}s`,duration:"2s"})),[]);return e.jsx("div",{className:"fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black bg-opacity-70 backdrop-blur-sm",children:e.jsxs("div",{className:`bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full overflow-hidden transition-all duration-500 transform ${g?"scale-100 opacity-100":"scale-90 opacity-0"}`,children:[e.jsxs("div",{className:`relative p-8 bg-gradient-to-r ${j()} text-white overflow-hidden`,children:[e.jsx("div",{className:"absolute inset-0 bg-black opacity-10"}),e.jsx("div",{className:"absolute inset-0 overflow-hidden",children:c.map(i=>e.jsx("div",{className:"absolute animate-pulse",style:{top:i.top,left:i.left,animationDelay:i.delay,animationDuration:i.duration},children:e.jsx(I,{className:"w-4 h-4 text-white opacity-30"})},i.key))}),e.jsxs("div",{className:"relative z-10",children:[e.jsx("button",{onClick:s,className:"absolute top-0 right-0 p-2 hover:bg-white hover:bg-opacity-20 rounded-lg transition-colors","aria-label":"閉じる",children:e.jsx(ue,{className:"w-5 h-5"})}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"inline-flex items-center justify-center mb-4",children:e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-0 bg-white opacity-20 rounded-full animate-ping",style:{animationDuration:"1.5s"}}),e.jsx("div",{className:"absolute inset-0 bg-white opacity-20 rounded-full animate-ping",style:{animationDelay:"0.5s",animationDuration:"1.5s"}}),e.jsx("div",{className:"relative bg-white bg-opacity-20 backdrop-blur-sm p-6 rounded-full",children:e.jsx(W,{className:"w-16 h-16 animate-bounce",style:{animationDuration:"1s"}})})]})}),e.jsx("h2",{className:"text-4xl font-bold mb-2 animate-pulse",children:"LEVEL UP!"}),e.jsx("p",{className:"text-white text-opacity-90 text-lg",children:"レベルアップしました！"})]})]})]}),e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsxs("div",{className:"flex items-center justify-center space-x-4 mb-4",children:[e.jsx("div",{className:"flex items-center space-x-2",children:e.jsxs("span",{className:"text-4xl font-bold text-gray-400 dark:text-gray-500",children:["Lv.",Math.max(0,t-1)]})}),e.jsx(se,{className:"w-6 h-6 text-gray-400"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("span",{className:`text-4xl font-bold bg-gradient-to-r ${j()} bg-clip-text text-transparent`,children:["Lv.",t]}),e.jsx(xe,{className:"w-6 h-6 text-yellow-500 animate-pulse"})]})]}),e.jsx("div",{className:"mb-4",children:e.jsx("div",{className:"inline-block",children:e.jsx("span",{className:`px-4 py-2 rounded-full text-lg font-bold bg-gradient-to-r ${j()} text-white shadow-lg`,children:a})})}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:"おめでとうございます！新しいランクに到達しました"}),e.jsxs("div",{className:"bg-gradient-to-br from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-xl p-4 border border-blue-200 dark:border-blue-800",children:[e.jsxs("p",{className:"text-sm font-semibold text-gray-900 dark:text-white mb-2",children:["レベル",t,"特典"]}),e.jsxs("div",{className:"space-y-1 text-sm text-gray-600 dark:text-gray-400",children:[e.jsx("p",{children:"• より多くのポイント獲得ボーナス"}),e.jsx("p",{children:"• 新しいバッジ獲得チャンス"}),e.jsx("p",{children:"• チーム内でのステータス向上"})]})]})]}),e.jsx("button",{onClick:s,className:`w-full py-3 rounded-xl font-semibold text-white bg-gradient-to-r ${j()} hover:shadow-lg transform hover:scale-105 transition-all`,children:"さらに成長する！"})]})]})})}class q extends qe.Component{constructor(){super(...arguments);de(this,"state",{hasError:!1});de(this,"retry",()=>this.setState({hasError:!1,error:void 0}))}static getDerivedStateFromError(s){return{hasError:!0,error:s}}componentDidCatch(s,g){console.error("[ErrorBoundary] caught",s,g)}render(){if(!this.state.hasError)return this.props.children;const s=this.props.title??"この表示でエラーが起きました",g=this.props.description??"このセクションだけ復旧できます。もう一度表示を試してください。";return this.props.compact?e.jsxs("div",{className:"rounded-xl border bg-white p-4 dark:bg-gray-800",children:[e.jsx("div",{className:"font-semibold text-gray-900 dark:text-white",children:s}),e.jsx("div",{className:"mt-1 text-sm text-gray-600 dark:text-gray-300",children:g}),e.jsx("div",{className:"mt-3 flex gap-2",children:e.jsx("button",{onClick:this.retry,className:"rounded-lg bg-black px-3 py-2 text-sm font-medium text-white",children:"再表示"})}),!1]}):e.jsxs("div",{className:"rounded-2xl border bg-white p-5 shadow-sm dark:bg-gray-800",children:[e.jsx("div",{className:"text-lg font-bold text-gray-900 dark:text-white",children:s}),e.jsx("div",{className:"mt-1 text-sm text-gray-600 dark:text-gray-300",children:g}),e.jsxs("div",{className:"mt-4 flex flex-wrap gap-2",children:[e.jsx("button",{onClick:this.retry,className:"rounded-lg bg-black px-3 py-2 text-sm font-medium text-white",children:"もう一度表示する"}),e.jsx("button",{onClick:()=>window.location.reload(),className:"rounded-lg border px-3 py-2 text-sm font-medium dark:border-gray-700",children:"ページを再読み込み"})]}),!1]})}}function pe(t){try{const a=new Date(t),s=new Intl.DateTimeFormat("ja-JP",{timeZone:"Asia/Tokyo",year:"numeric",month:"2-digit",day:"2-digit"}).format(a),g=new Intl.DateTimeFormat("ja-JP",{timeZone:"Asia/Tokyo",hour:"2-digit",minute:"2-digit",hour12:!1}).format(a);return{date:s,time:g}}catch{return{date:"----/--/--",time:"--:--"}}}function et(t){const a=(t??"").toLowerCase();return a?a.includes("streak")?"ストリーク":a.includes("badge")?"バッジ":a.includes("login")?"ログイン":a.includes("manual")?"手動":a.includes("admin")?"管理者":a.includes("training")?"トレーニング":a.includes("weight")?"体重":a.includes("sleep")?"睡眠":a.includes("motivation")?"モチベ":t??"その他":"その他"}function tt(t){const a=(t??"").toLowerCase();return a.includes("badge")?"bg-yellow-50 text-yellow-700 dark:bg-yellow-900/20 dark:text-yellow-300":a.includes("streak")?"bg-orange-50 text-orange-700 dark:bg-orange-900/20 dark:text-orange-300":a.includes("training")?"bg-blue-50 text-blue-700 dark:bg-blue-900/20 dark:text-blue-300":a.includes("sleep")?"bg-indigo-50 text-indigo-700 dark:bg-indigo-900/20 dark:text-indigo-300":a.includes("weight")?"bg-emerald-50 text-emerald-700 dark:bg-emerald-900/20 dark:text-emerald-300":"bg-gray-50 text-gray-700 dark:bg-gray-800 dark:text-gray-300"}function rt({open:t,onClose:a,transactions:s,loading:g,onReload:u}){r.useEffect(()=>{if(!t)return;const c=i=>{i.key==="Escape"&&a()};return window.addEventListener("keydown",c),()=>window.removeEventListener("keydown",c)},[t,a]);const f=r.useMemo(()=>{const c=new Map;for(const l of s??[]){const{date:y}=pe(l.created_at),M=c.get(y)??[];M.push(l),c.set(y,M)}return Array.from(c.keys()).sort((l,y)=>l<y?1:-1).map(l=>({date:l,items:(c.get(l)??[]).sort((y,M)=>y.created_at<M.created_at?1:-1)}))},[s]);if(!t)return null;const j=((s==null?void 0:s.length)??0)>0;return e.jsxs("div",{className:"fixed inset-0 z-[100]",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:a}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:e.jsxs("div",{className:"w-full max-w-2xl bg-white dark:bg-gray-900 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between px-5 py-4 border-b border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900 dark:text-white",children:"ポイント履歴"}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:"獲得・減少したポイントの記録です（JST表示）"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[u&&e.jsxs("button",{onClick:u,disabled:g,className:`inline-flex items-center gap-2 px-3 py-2 rounded-lg text-sm
                             bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700
                             hover:bg-gray-50 dark:hover:bg-gray-700
                             text-gray-900 dark:text-white transition-colors
                             disabled:opacity-60 disabled:cursor-not-allowed`,title:"更新",children:[e.jsx(be,{className:`w-4 h-4 ${g?"animate-spin":""}`}),"更新"]}),e.jsx("button",{onClick:a,className:"p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300",title:"閉じる",children:e.jsx(ue,{className:"w-5 h-5"})})]})]}),e.jsx("div",{className:"max-h-[70vh] overflow-y-auto px-5 py-4",children:g&&!j?e.jsx("div",{className:"h-48 flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"})}):j?e.jsx("div",{className:"space-y-5",children:f.map(c=>e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-gray-600 dark:text-gray-300 mb-2",children:c.date}),e.jsx("div",{className:"space-y-2",children:c.items.map(i=>{var d;const{time:l}=pe(i.created_at),y=Number(i.points??0),M=y>0?"+":"",p=(i.reason??"").trim()||"ポイント付与",o=et(i.category),n=tt(i.category);return e.jsx("div",{className:"rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-3",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400",children:[e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(De,{className:"w-3.5 h-3.5"}),l]}),e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-0.5 rounded-full ${n}`,children:[e.jsx(Oe,{className:"w-3.5 h-3.5"}),o]})]}),e.jsx("div",{className:"mt-1 text-sm font-semibold text-gray-900 dark:text-white truncate",children:p}),((d=i.metadata)==null?void 0:d.source)&&e.jsxs("div",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:["source: ",String(i.metadata.source)]})]}),e.jsxs("div",{className:`shrink-0 text-sm font-bold ${y>=0?"text-blue-700 dark:text-blue-300":"text-red-600 dark:text-red-300"}`,children:[M,y.toLocaleString()," pt"]})]})},i.id)})})]},c.date))}):e.jsxs("div",{className:"h-48 flex flex-col items-center justify-center text-center",children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900 dark:text-white",children:"まだ履歴がありません"}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-2",children:"記録やバッジ獲得でポイントが付与されると、ここに表示されます。"}),u&&e.jsxs("button",{onClick:u,className:`mt-4 inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm
                               bg-blue-600 hover:bg-blue-700 text-white transition-colors`,children:[e.jsx(be,{className:"w-4 h-4"}),"再読み込み"]})]})}),e.jsx("div",{className:"px-5 py-3 border-t border-gray-200 dark:border-gray-700 flex justify-end",children:e.jsx("button",{onClick:a,className:`px-4 py-2 rounded-lg text-sm
                         bg-gray-100 dark:bg-gray-800
                         hover:bg-gray-200 dark:hover:bg-gray-700
                         text-gray-900 dark:text-white transition-colors`,children:"閉じる"})})]})})]})}function at(t,a,s={}){var w,H;const g=s.enabled??!0,u=s.pollMs??12e4,f=s.pauseWhenHidden??!0,j=s.defaultScope??"global",[c,i]=r.useState(j),[l,y]=r.useState(null),[M,p]=r.useState({global:null,organization:null,team:null}),[o,n]=r.useState(!1),[d,b]=r.useState(null),{registerPollJob:N}=P(),k=r.useRef(!0);r.useEffect(()=>(k.current=!0,()=>{k.current=!1}),[]);const E=r.useRef(((H=(w=globalThis.crypto)==null?void 0:w.randomUUID)==null?void 0:H.call(w))??Math.random().toString(36).slice(2)),v=r.useRef(null),T=r.useRef(!1),D=r.useCallback(()=>{v.current&&(v.current(),v.current=null)},[]),B=r.useCallback(async()=>{if(!(!g||!t))try{const{data:x,error:S}=await G.from("users").select("id, team_id, organization_id").eq("id",t).maybeSingle();if(S)throw S;const _=a??(x==null?void 0:x.team_id)??null;if(!k.current)return;y({id:t,team_id:_,organization_id:(x==null?void 0:x.organization_id)??null})}catch(x){if(console.error("[useRankStats] loadUserMini error:",x),!k.current)return;y({id:t,team_id:a??null,organization_id:null})}},[g,t,a]);r.useEffect(()=>{B()},[B]);const C=!!(l!=null&&l.organization_id),L=!!(l!=null&&l.team_id),R=r.useMemo(()=>{const x=["global"];return C&&x.push("organization"),L&&x.push("team"),x},[C,L]);r.useEffect(()=>{g&&(c==="organization"&&!C&&i("global"),c==="team"&&!L&&i("global"))},[g,c,C,L]);const z=r.useCallback(async(x,S)=>{if(!g||x==="organization"&&!(l!=null&&l.organization_id)||x==="team"&&!(l!=null&&l.team_id)||T.current)return;T.current=!0;const _=(S==null?void 0:S.silent)??!1;try{!_&&k.current&&n(!0);const A={p_scope:x};x==="organization"&&(A.p_org_id=l.organization_id),x==="team"&&(A.p_team_id=l.team_id);const{data:ee,error:J}=await G.rpc("get_rank_stats",A);if(J)throw J;const K=ee??null;if(!k.current)return;p(le=>({...le,[x]:K})),b(null)}catch(A){if(console.error("[useRankStats] fetch error:",A),!k.current)return;b((A==null?void 0:A.message)??"順位情報の取得に失敗しました")}finally{T.current=!1,!_&&k.current&&n(!1)}},[g,l]);r.useEffect(()=>{D(),g&&l&&z(c,{silent:!1})},[g,l,c]),r.useEffect(()=>{if(D(),!(g&&u>0&&!!l))return;const S=`rankstats:${c}:${E.current}`,_=N({key:S,intervalMs:u,run:async()=>{await z(c,{silent:!0})},enabled:!0,requireVisible:f,requireOnline:!0,immediate:!1});return v.current=_,()=>D()},[g,u,f,N,z,D,c,l]);const h=M[c],$=r.useCallback(async()=>{await z(c,{silent:!1})},[z,c]);return{scope:c,setScope:i,availableScopes:R,canUseOrg:C,canUseTeam:L,data:h,loading:o,error:d,refresh:$}}function je(t){return t==="global"?"全体":t==="organization"?"組織内":"チーム内"}function st(t){return t==="global"?e.jsx(Be,{className:"w-5 h-5"}):t==="organization"?e.jsx(He,{className:"w-5 h-5"}):e.jsx(Z,{className:"w-5 h-5"})}function lt({scope:t,data:a,loading:s,error:g}){const u=r.useMemo(()=>{if(!a)return null;const c=a.total_users??0,i=a.my_rank,l=a.top_percent;return!c||i==null||l==null?`${je(t)}の順位データがありません`:`${c.toLocaleString()}人中 ${i.toLocaleString()}位（上位 ${l}%）`},[a,t]),f=r.useMemo(()=>((a==null?void 0:a.distribution)??[]).slice().reverse(),[a==null?void 0:a.distribution]),j=r.useMemo(()=>{const c=Math.max(0,...f.map(i=>Number(i.count??0)));return c>0?c:1},[f]);return e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center space-x-2 text-gray-900 dark:text-white",children:[e.jsx("div",{className:"p-2 rounded-lg bg-gray-50 dark:bg-gray-700",children:st(t)}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs text-gray-600 dark:text-gray-400",children:[je(t),"ランキング"]}),e.jsx("div",{className:"text-base font-semibold",children:s?"読み込み中…":u??"—"})]})]})}),g&&e.jsxs("div",{className:"mt-2 text-xs text-red-600 dark:text-red-400",children:["error: ",g]}),f.length?e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-xs text-gray-600 dark:text-gray-400 mb-2",children:"人数分布"}),e.jsx("div",{className:"space-y-2",children:f.map(c=>{const i=Number(c.count??0),l=Math.round(i/j*100);return e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-800 dark:text-gray-200",children:c.rank_title}),e.jsxs("span",{className:"text-gray-600 dark:text-gray-400",children:[i.toLocaleString(),"人"]})]}),e.jsx("div",{className:"w-full h-2 rounded-full bg-gray-200 dark:bg-gray-700 overflow-hidden",children:e.jsx("div",{className:"h-full rounded-full bg-blue-600",style:{width:`${l}%`},"aria-label":`${c.rank_title} ${i}人`})})]},c.rank_title)})})]}):e.jsx("div",{className:"mt-3 text-xs text-gray-500 dark:text-gray-400",children:"分布データはまだありません"})]})}function dt({userId:t,userTeamId:a}){const{state:s}=P();r.useEffect(()=>{console.log("[RealtimeHub state]",s)},[s]),r.useEffect(()=>{console.log("[Gamification] props",{userId:t,userTeamId:a})},[t,a]);const{loading:g,getStreakByType:u,getTotalStreak:f}=Ze(t),{scope:j,setScope:c,availableScopes:i,data:l,loading:y,error:M}=at(t,a,{enabled:!0,pollMs:12e4,pauseWhenHidden:!0,defaultScope:"global"}),{userPoints:p,loading:o,getLevelProgress:n,transactions:d,transactionsLoading:b,loadTransactions:N}=Ke(t,{includeTransactions:!1,transactionsLimit:50}),{allBadges:k,userBadges:E,loading:v,getNewBadges:T,markBadgeAsViewed:D,getBadgeProgress:B}=Ae(t,{enabled:!0,pollMs:5*60*1e3}),[C,L]=r.useState(null),[R,z]=r.useState(!1),h=r.useRef(null);r.useEffect(()=>{console.log("[Gamification] rankingsEl set?",!!C)},[C]),r.useEffect(()=>{if(!C)return;console.log("[Gamification] IntersectionObserver setup");const m=new IntersectionObserver(U=>{const Q=U.some(Ce=>Ce.isIntersecting);console.log("[Gamification] rankings inView?",Q),Q&&(console.log("[Gamification] ✅ rankingsEnabled -> true"),z(!0),m.disconnect(),h.current&&(window.clearTimeout(h.current),h.current=null))},{threshold:0,rootMargin:"200px 0px"});return m.observe(C),()=>{m.disconnect(),h.current&&(window.clearTimeout(h.current),h.current=null)}},[C]),r.useEffect(()=>{console.log("[Gamification] rankingsEnabled:",R)},[R]);const{weeklyRankings:$,pointsRankings:w,loading:H,error:x}=Qe(a,{enabled:R&&!!a,pollMs:12e4,pauseWhenHidden:!0});r.useEffect(()=>{console.log("[Gamification] rankings state",{enabled:R&&!!a,userTeamId:a,rankingsLoading:H,weeklyLen:($==null?void 0:$.length)??0,pointsLen:(w==null?void 0:w.length)??0,rankingsError:x})},[R,a,H,$,w,x]);const[S,_]=r.useState(!1),[A,ee]=r.useState(null),[J,K]=r.useState(null),[le,ne]=r.useState(!1),[we,ge]=r.useState(!1),ke=g||o||v,me=r.useMemo(()=>{if(o)return 0;try{return n()}catch(m){return console.warn("[GamificationView] getLevelProgress failed",m),0}},[o,n]),V=r.useMemo(()=>{if(v)return[];try{return T()??[]}catch(m){return console.warn("[GamificationView] getNewBadges failed",m),[]}},[v,T]),ie=r.useMemo(()=>{if(v)return{earned:0,total:0,percentage:0};try{return B()??{earned:0,total:0,percentage:0}}catch(m){return console.warn("[GamificationView] getBadgeProgress failed",m),{earned:0,total:0,percentage:0}}},[v,B]),te=r.useRef(null),ce=r.useMemo(()=>`bekuta:last_seen_level:${t||"unknown"}`,[t]),ve=()=>{try{const m=localStorage.getItem(ce),U=m==null?NaN:Number(m);return Number.isFinite(U)?U:null}catch{return null}},oe=m=>{try{localStorage.setItem(ce,String(m))}catch{}};r.useEffect(()=>{const m=p==null?void 0:p.current_level;if(m==null)return;const U=ve();if(U==null){oe(m),te.current=m;return}m>U&&(K({level:m,rankTitle:(p==null?void 0:p.rank_title)??""}),oe(m)),te.current!=null&&m>te.current&&(K({level:m,rankTitle:(p==null?void 0:p.rank_title)??""}),oe(m)),te.current=m},[p==null?void 0:p.current_level,p==null?void 0:p.rank_title,ce]),r.useEffect(()=>{try{if(A||!V||V.length===0)return;const m=V[0];m!=null&&m.badge&&ee(m.badge)}catch(m){console.warn("[GamificationView] new badge effect failed",m)}},[V,A]);const Ne=async()=>{try{if(A&&V.length>0){const m=V.find(U=>{var Q;return((Q=U==null?void 0:U.badge)==null?void 0:Q.id)===A.id});m&&await D(m.id)}}catch(m){console.warn("[GamificationView] markBadgeAsViewed failed",m)}finally{ee(null)}},_e=async()=>{console.log("[Gamification] openPointHistory clicked"),ge(!0),(d??[]).length===0?(console.log("[Gamification] loadTransactions start"),await N({silent:!1}),console.log("[Gamification] loadTransactions done")):console.log("[Gamification] transactions already loaded (skip fetch)")},Se=async()=>{console.log("[Gamification] reloadPointHistory"),await N({silent:!1})};return e.jsx(q,{title:"ゲーミフィケーションの表示に失敗しました",description:"この画面だけ復旧できます。再表示を試してください。",children:ke?e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(q,{compact:!0,title:"チュートリアルの表示でエラー",children:e.jsx(ze,{steps:Fe("gamification"),isActive:le,onComplete:()=>ne(!1),onSkip:()=>ne(!1)})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"ゲーミフィケーション"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-1",children:"楽しみながら継続的な記録を！ストリークとバッジで成長を可視化"})]}),e.jsxs("button",{onClick:()=>ne(!0),className:"flex items-center space-x-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors",title:"チュートリアルを表示",children:[e.jsx(Ue,{className:"w-5 h-5"}),e.jsx("span",{className:"hidden sm:inline",children:"チュートリアル"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsx(q,{compact:!0,title:"ストリーク表示でエラー",children:e.jsx(X,{streak:f(),label:"総合ストリーク",icon:e.jsx(Y,{className:"w-6 h-6"})})}),e.jsx(q,{compact:!0,title:"レベル表示でエラー",children:e.jsx("div",{className:"space-y-3",children:e.jsx(ye,{userPoints:p,levelProgress:me,showDetails:!1})})}),e.jsxs("button",{onClick:()=>_(!0),className:"bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 hover:shadow-md transition-all text-left","data-tutorial":"badges-card",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400 mb-1",children:"バッジコレクション"}),e.jsxs("div",{className:"flex items-baseline space-x-2",children:[e.jsx("p",{className:"text-3xl font-bold text-gray-900 dark:text-white",children:ie.earned}),e.jsxs("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:["/ ",ie.total]})]})]}),e.jsx("div",{className:"p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg",children:e.jsx(ae,{className:"w-6 h-6 text-yellow-600 dark:text-yellow-400"})})]}),e.jsx("div",{className:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 overflow-hidden",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-yellow-500 to-orange-500 rounded-full transition-all duration-500",style:{width:`${ie.percentage}%`}})}),V.length>0&&e.jsx("div",{className:"mt-2 flex items-center space-x-1 text-xs text-red-600 dark:text-red-400 font-semibold animate-pulse",children:e.jsxs("span",{children:["新しいバッジ: ",V.length,"個"]})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{"data-tutorial":"streaks-section",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center space-x-2",children:[e.jsx(Y,{className:"w-5 h-5 text-orange-500"}),e.jsx("span",{children:"あなたのストリーク"})]}),e.jsx(q,{compact:!0,title:"ストリーク詳細でエラー",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(X,{streak:u("training"),label:"練習記録"}),e.jsx(X,{streak:u("weight"),label:"体重記録"}),e.jsx(X,{streak:u("sleep"),label:"睡眠記録"}),e.jsx(X,{streak:u("motivation"),label:"モチベーション記録"})]})})]}),e.jsxs("div",{"data-tutorial":"level-section",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center space-x-2",children:[e.jsx(W,{className:"w-5 h-5 text-yellow-500"}),e.jsx("span",{children:"レベル進捗"})]}),e.jsx(q,{compact:!0,title:"レベル進捗の表示でエラー",children:e.jsx(ye,{userPoints:p,levelProgress:me,showDetails:!0,actions:e.jsx("button",{onClick:_e,className:`w-full sm:w-auto px-3 py-2 rounded-lg text-sm
                                   bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700
                                   hover:bg-gray-50 dark:hover:bg-gray-700
                                   text-gray-900 dark:text-white transition-colors`,title:"ポイント履歴を表示",children:"ポイント履歴"})})})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"flex items-center space-x-2 mb-2",children:i.map(m=>e.jsx("button",{onClick:()=>c(m),className:`px-3 py-1 rounded-full text-xs border transition-colors
                      ${j===m?"bg-blue-600 text-white border-blue-600":"bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700"}`,children:m==="global"?"全体":m==="organization"?"組織":"チーム"},m))}),e.jsx(lt,{scope:j,data:l,loading:y,error:M})]}),e.jsxs("div",{ref:L,"data-tutorial":"rankings-section",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center space-x-2",children:[e.jsx(Z,{className:"w-5 h-5 text-blue-500"}),e.jsx("span",{children:"チームランキング"})]}),e.jsx(q,{compact:!0,title:"ランキング表示でエラー",children:R?H?e.jsx("div",{className:"flex items-center justify-center h-24",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsx(Ie,{weeklyRankings:$,pointsRankings:w,myUserId:t}):e.jsx("div",{className:"text-sm text-gray-500 dark:text-gray-400 h-24 flex items-center",children:"ランキングを読み込みます…"})}),x&&e.jsxs("div",{className:"mt-2 text-xs text-red-600 dark:text-red-400",children:["rankingsError: ",x]})]})]}),S&&e.jsx(q,{title:"バッジ一覧の表示でエラー",children:e.jsx(Ye,{userBadges:E,allBadges:k,onClose:()=>_(!1)})}),A&&e.jsx(q,{title:"バッジ獲得モーダルの表示でエラー",children:e.jsx(Ge,{badge:A,onClose:Ne})}),J&&e.jsx(q,{title:"レベルアップ演出の表示でエラー",children:e.jsx(Pe,{newLevel:J.level,rankTitle:J.rankTitle,onClose:()=>K(null)})}),e.jsx(rt,{open:we,onClose:()=>ge(!1),transactions:d??[],loading:b,onReload:Se})]})})}export{dt as GamificationView};

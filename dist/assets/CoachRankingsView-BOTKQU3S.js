import{s as L,j as e,N as G,X as T,P as X,$ as Y,as as H}from"./index-C7IL5YWP.js";import{r}from"./chart-vendor-B8I3tXXj.js";import{P as I}from"./PerformanceChart-B8Th93D_.js";import"./supabase-vendor-CRHRt2Ih.js";const J=n=>typeof n=="number"&&Number.isFinite(n);function Q({open:n,onClose:v,teamId:R,athleteUserId:C,athleteName:O,testTypeId:j,testTypeDisplayName:V,metricKey:o,unitLabel:B}){var P,$;const[a,x]=r.useState([]),[M,N]=r.useState([]),[S,f]=r.useState(!1),[E,A]=r.useState(null);r.useEffect(()=>{if(!n||!C||!j||!R)return;let p=!1;return(async()=>{try{f(!0),A(null);const[c,w]=await Promise.all([L.from("performance_records").select(`
              id,
              user_id,
              test_type_id,
              date,
              values,
              notes,
              test_type:performance_test_types (
                id,
                name,
                display_name,
                unit,
                higher_is_better
              )
            `).eq("user_id",C).eq("test_type_id",j).order("date",{ascending:!0}),L.rpc("get_team_monthly_latest",{p_team_id:R,p_test_type_id:j,p_metric:o,p_months:12})]);if(c.error)throw c.error;if(w.error)throw w.error;if(p)return;const g=(c.data??[]).map(s=>({id:s.id,user_id:s.user_id,test_type_id:s.test_type_id,date:s.date,values:s.values,notes:s.notes??"",test_type:s.test_type?{id:s.test_type.id,name:s.test_type.name,display_name:s.test_type.display_name,unit:s.test_type.unit,higher_is_better:s.test_type.higher_is_better}:null}));x(g);const h=(w.data??[]).map(s=>({month_start:String(s.month_start),team_n:s.team_n!=null?Number(s.team_n):null,team_avg:s.team_avg!=null?Number(s.team_avg):null}));N(h)}catch(c){console.error("[CoachAthletePerformanceModal] fetch error",c),p||A((c==null?void 0:c.message)??"取得に失敗しました"),p||(x([]),N([]))}finally{p||f(!1)}})(),()=>{p=!0}},[n,C,j,R,o]);const D=r.useMemo(()=>{var k;if(!a||a.length===0)return;const p=(k=a[0])==null?void 0:k.test_type,c=(p==null?void 0:p.higher_is_better)??!0,w=h=>{var t,l;const s=o==="relative_1rm"?(t=h.values)==null?void 0:t.relative_1rm:(l=h.values)==null?void 0:l.primary_value,q=typeof s=="string"?parseFloat(s):s;return Number.isFinite(q)?q:null};let _=null,g=null;for(const h of a){const s=w(h);if(J(s)){if(_==null){_=s,g=h.date;continue}(c?s>_:s<_)&&(_=s,g=h.date)}}if(!(_==null||!g))return{value:_,date:g}},[a,o]),F=V||(($=(P=a==null?void 0:a[0])==null?void 0:P.test_type)==null?void 0:$.display_name)||"推移";return n?e.jsxs("div",{className:"fixed inset-0 z-50",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:v}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-3 sm:p-6",children:e.jsxs("div",{className:"w-full max-w-5xl max-h-[90vh] overflow-hidden rounded-2xl bg-white shadow-2xl border border-gray-200",children:[e.jsxs("div",{className:"px-4 sm:px-6 py-4 border-b border-gray-100 flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(G,{className:"w-5 h-5 text-blue-600"}),e.jsxs("div",{className:"text-base sm:text-lg font-bold text-gray-900 truncate",children:[O||"選手","：",F]})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["表示：",o==="relative_1rm"?"相対（×BW）":"通常"]})]}),e.jsx("button",{onClick:v,className:"shrink-0 inline-flex items-center justify-center rounded-lg border bg-white hover:bg-gray-50 w-10 h-10","aria-label":"close",title:"閉じる",children:e.jsx(T,{className:"w-5 h-5 text-gray-700"})})]}),e.jsx("div",{className:"p-4 sm:p-6 overflow-y-auto max-h-[calc(90vh-72px)]",children:S?e.jsx("div",{className:"flex items-center justify-center py-16",children:e.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"})}):E?e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-xl p-4 text-sm text-red-700",children:[e.jsx("div",{className:"font-semibold mb-1",children:"取得エラー"}),e.jsx("div",{className:"mb-3",children:E})]}):e.jsx(I,{records:a,personalBest:D,testTypeName:F,metricKey:o,unitLabel:B,teamMonthly:M})})]})})]}):null}const z=new Set(["bench_press","back_squat","deadlift","bulgarian_squat_r","bulgarian_squat_l"]),U=n=>n!=null&&n.includes("rsi")?2:1;function se({team:n}){var q;const[v,R]=r.useState([]),[C,O]=r.useState(!1),[j,V]=r.useState(null),[o,B]=r.useState(""),a=r.useMemo(()=>v.find(t=>t.id===o)??null,[v,o]),[x,M]=r.useState("primary_value"),N=!!a&&z.has(a.name),S=r.useMemo(()=>a?N&&x==="relative_1rm"?"×BW":a.unit:"",[a,N,x]),[f,E]=r.useState([]),[A,D]=r.useState(!1),[F,P]=r.useState(null),[$,p]=r.useState(!1),[c,w]=r.useState(null),_=r.useMemo(()=>[{user_id:"dummy1",name:"田中",date:"2026-01-10",value:73.3,rank:1,top_percent:0,team_n:12},{user_id:"dummy2",name:"佐藤",date:"2026-01-08",value:71.2,rank:2,top_percent:8.3,team_n:12},{user_id:"dummy3",name:"鈴木",date:"2026-01-05",value:69,rank:3,top_percent:16.7,team_n:12}],[]),g=r.useMemo(()=>{const t=new Map;for(const m of v){const u=m.category_label||"その他";t.has(u)||t.set(u,[]),t.get(u).push(m)}for(const[m,u]of t.entries())u.sort((i,d)=>{const b=i.sort_order??9999,y=d.sort_order??9999;return b!==y?b-y:(i.display_name||"").localeCompare(d.display_name||"","ja")}),t.set(m,u);const l=["筋力","スプリント","ジャンプ","敏捷","持久","その他"];return Array.from(t.entries()).sort((m,u)=>{const i=l.indexOf(m[0]),d=l.indexOf(u[0]),b=i===-1?999:i,y=d===-1?999:d;return b!==y?b-y:m[0].localeCompare(u[0],"ja")})},[v]);r.useEffect(()=>{let t=!1;return(async()=>{try{O(!0),V(null);const{data:l,error:m}=await L.from("performance_test_types").select(`
          id,
          name,
          display_name,
          unit,
          higher_is_better,
          category_id,
          sort_order,
          is_active,
          user_can_input,
          performance_categories (
            id,
            name,
            display_name,
            sort_order
          )
        `).eq("is_active",!0).order("sort_order",{ascending:!0}),i=(l??[]).map(d=>{var b,y,W;return{id:d.id,name:d.name,display_name:d.display_name,unit:d.unit,higher_is_better:d.higher_is_better,category_id:d.category_id,is_active:d.is_active,user_can_input:d.user_can_input,category_label:((b=d.performance_categories)==null?void 0:b.display_name)||((y=d.performance_categories)==null?void 0:y.name)||"その他",category_sort:((W=d.performance_categories)==null?void 0:W.sort_order)??999}});if(t)return;R(i),!o&&i.length>0&&B(i[0].id)}catch(l){console.error("[CoachRankingsView] testTypes error",l),t||V((l==null?void 0:l.message)??"種目の取得に失敗しました")}finally{t||O(!1)}})(),()=>{t=!0}},[n==null?void 0:n.id]),r.useEffect(()=>{a&&(z.has(a.name)||M("primary_value"))},[a==null?void 0:a.id]);const k=async()=>{if(!(!(n!=null&&n.id)||!o))try{D(!0),P(null);const{data:t,error:l}=await L.rpc("get_team_test_ranking",{p_team_id:n.id,p_test_type_id:o,p_metric:x,p_days:365,p_limit:50});if(l)throw l;const u=(t??[]).map(i=>({user_id:i.user_id,name:i.name??null,date:i.date??null,value:i.value!=null?Number(i.value):null,rank:i.rank!=null?Number(i.rank):null,top_percent:i.top_percent!=null?Number(i.top_percent):null,team_n:i.team_n!=null?Number(i.team_n):null}));E(u)}catch(t){console.warn("[CoachRankingsView] ranking error",t),P((t==null?void 0:t.message)??"ランキング取得に失敗しました"),E(_)}finally{D(!1)}};r.useEffect(()=>{k()},[n==null?void 0:n.id,o,x]);const h=t=>t.name||"名前未設定",s=t=>{if(t==null)return"-";const l=U(a==null?void 0:a.name);return Number(t).toFixed(l)};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white rounded-xl border border-gray-200 p-4 sm:p-5",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(X,{className:"w-5 h-5 text-amber-500"}),e.jsx("div",{className:"text-base sm:text-lg font-semibold text-gray-900",children:"ランキング"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"種目ごとに「最新測定」の値で順位付け（チーム内）"})]}),e.jsxs("button",{onClick:k,className:"inline-flex items-center gap-2 px-3 py-2 rounded-lg border bg-white hover:bg-gray-50 text-sm",title:"再取得",children:[e.jsx(Y,{className:`w-4 h-4 ${A?"animate-spin":""}`}),"更新"]})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx("select",{value:o,onChange:t=>B(t.target.value),className:"w-full appearance-none px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 text-sm bg-white",disabled:C,children:g.map(([t,l])=>e.jsx("optgroup",{label:t,children:l.map(m=>e.jsx("option",{value:m.id,children:m.display_name},m.id))},t))}),e.jsx(H,{className:"w-4 h-4 text-gray-400 absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[N?e.jsxs("div",{className:"inline-flex rounded-lg bg-gray-100 p-1 text-[12px]",children:[e.jsx("button",{type:"button",onClick:()=>M("primary_value"),className:`px-3 py-1.5 rounded-md ${x==="primary_value"?"bg-white shadow text-gray-900":"text-gray-600"}`,children:"推定1RM"}),e.jsx("button",{type:"button",onClick:()=>M("relative_1rm"),className:`px-3 py-1.5 rounded-md ${x==="relative_1rm"?"bg-white shadow text-gray-900":"text-gray-600"}`,children:"相対1RM"})]}):e.jsx("div",{className:"text-sm text-gray-500",children:"（筋力以外は自動）"}),e.jsxs("div",{className:"text-sm text-gray-700",children:["単位：",e.jsx("span",{className:"font-semibold",children:S||"-"})]})]})]}),j&&e.jsx("div",{className:"mt-3 text-sm text-red-600",children:j})]}),e.jsxs("div",{className:"bg-white rounded-xl border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:"px-4 sm:px-5 py-3 border-b border-gray-100 flex items-center justify-between",children:[e.jsxs("div",{className:"text-sm font-semibold text-gray-900",children:[(a==null?void 0:a.display_name)??"種目"," の順位"]}),e.jsx("div",{className:"text-xs text-gray-500",children:(q=f==null?void 0:f[0])!=null&&q.team_n?`n=${f[0].team_n}`:""})]}),F&&e.jsxs("div",{className:"px-4 sm:px-5 py-3 text-sm text-amber-700 bg-amber-50 border-b border-amber-100",children:[F,e.jsx("span",{className:"ml-2 text-xs text-amber-600",children:"（RPC未整備ならダミー表示になります）"})]}),A?e.jsx("div",{className:"flex items-center justify-center py-16",children:e.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"})}):f.length===0?e.jsx("div",{className:"py-12 text-center text-sm text-gray-500",children:"データがありません（この種目の測定がまだ無い可能性）"}):e.jsx("div",{className:"divide-y",children:f.map(t=>e.jsx("button",{className:"w-full text-left px-4 sm:px-5 py-3 hover:bg-gray-50",onClick:()=>onOpenAthlete(t.user_id,o,x),children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"text-base font-bold text-gray-900 w-10",children:[t.rank??"-","位"]}),e.jsx("div",{className:"font-semibold text-gray-900 truncate",children:h(t)}),typeof t.top_percent=="number"&&e.jsxs("span",{className:"text-[11px] px-2 py-1 rounded-full border bg-amber-50 text-amber-800 border-amber-200",children:["上位 ",Number(t.top_percent).toFixed(1),"%"]})]}),e.jsxs("div",{className:"mt-1 text-xs text-gray-600",children:["最終測定日：",t.date??"-"]})]}),e.jsx("div",{className:"text-right",children:e.jsxs("div",{className:"text-xl font-bold text-blue-600",children:[s(t.value),e.jsx("span",{className:"text-sm font-semibold text-gray-600 ml-1",children:S})]})})]})},`${t.user_id}-${t.rank??"x"}`))})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"※ 仕様：各選手の「最新記録」で順位付け（同値は rank() で同順位）"}),$&&c&&o&&e.jsx(Q,{open:$,onClose:()=>p(!1),teamId:n.id,athleteUserId:c.userId,athleteName:c.name,testTypeId:o,testTypeDisplayName:a==null?void 0:a.display_name,metricKey:x,unitLabel:S})]})}export{se as CoachRankingsView,se as default};

import{z as e,ah as t,ai as r,s as a,ag as s,aj as l,j as n,ad as i,E as d,ak as o,D as c,al as m,am as x,a as g,U as h,a5 as u,$ as p,p as b,G as y,an as f,ab as v,ao as j,ap as N,aq as w,B as k,ar as _,N as C,A}from"./index-BXAoWvaK.js";import{r as R}from"./chart-vendor-DEPfNMx8.js";import"./supabase-vendor-BgrwFlS9.js";
/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const S=e("PowerOff",[["path",{d:"M18.36 6.64A9 9 0 0 1 20.77 15",key:"dxknvb"}],["path",{d:"M6.16 6.16a9 9 0 1 0 12.68 12.68",key:"1x7qb5"}],["path",{d:"M12 2v4",key:"3427ic"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]),q=e("Power",[["path",{d:"M12 2v10",key:"mnfbl"}],["path",{d:"M18.4 6.6a9 9 0 1 1-12.77.04",key:"obofu9"}]]),D=e("XCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]]);
/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */function M(e){if(null==e||""===e)return null;const t="number"==typeof e?e:Number(e);return Number.isFinite(t)?t:null}function $(e){const t=M(null==e?void 0:e.load);if(null!=t)return t;const r=M(null==e?void 0:e.rpe),a=M(null==e?void 0:e.duration_min);return null!=r&&null!=a?r*a:0}function z(e){return Math.round(100*e)/100}async function E(e,t){const{data:r,error:l}=await a.from("users").select("*").eq("id",e).single();if(l)throw l;if(!r)throw new Error("Athlete not found");const{data:n,error:i}=await a.from("training_records").select("*").eq("user_id",e).gte("date",t.start).lte("date",t.end).order("date",{ascending:!0});if(i)throw i;const d=(null==n?void 0:n.length)||0,o=(null==n?void 0:n.reduce((e,t)=>e+$(t),0))||0,c=(null==n?void 0:n.reduce((e,t)=>e+(M(t.duration_min)??0),0))||0,m=d>0?o/d:0,x=(null==n?void 0:n.reduce((e,t)=>Math.max(e,$(t)),0))||0,g=d>0?(n||[]).reduce((e,t)=>e+(M(t.rpe)??0),0)/d:0,h=(n||[]).map(e=>{const t=function(e){if(!e)return null;if("string"==typeof e){const t=e.match(/^(\d{4}-\d{2}-\d{2})/);return t?t[1]:null}try{const t=new Date(e);return Number.isNaN(t.getTime())?null:t.toISOString().slice(0,10)}catch{return null}}(null==e?void 0:e.date);return t?{date:t,load:$(e)}:null}).filter(Boolean),u=(h.length>0?s(h):[]).map(e=>e.acwr).filter(e=>"number"==typeof e&&Number.isFinite(e)),p=u.length>0?u[u.length-1]:0,b=u.length>0?u.reduce((e,t)=>e+t,0)/u.length:0,y=u.length>0?Math.max(...u):0,f=u.length>0?Math.min(...u):0,v=u.filter(e=>e<.8||e>1.3).length,j=p>=1.5?"high":p>=1.3?"medium":p>=.8?"low":"medium",N=u.length>=3?u[u.length-1]>u[Math.floor(u.length/2)]?"improving":"declining":"stable",{data:w,error:k}=await a.from("weight_records").select("*").eq("user_id",e).gte("date",t.start).lte("date",t.end).order("date",{ascending:!0});if(k)throw k;const _=(w||[]).map(e=>M(e.weight_kg)).filter(e=>"number"==typeof e&&Number.isFinite(e)),C=_.length>0?_[_.length-1]:null,A=_.length>0?_[0]:null,R=_.length>0?_.reduce((e,t)=>e+t,0)/_.length:null,S=null!=C&&null!=A?C-A:null,q=null!=C&&null!=A&&A>0?(C-A)/A*100:null,D=null==S?"no_data":Math.abs(S)<.5?"stable":S>0?"increasing":"decreasing",{data:E,error:F}=await a.from("sleep_records").select("*").eq("user_id",e).gte("date",t.start).lte("date",t.end);if(F)throw F;const I=(E||[]).map(e=>M(e.sleep_hours)).filter(e=>"number"==typeof e&&Number.isFinite(e)),L=(E||[]).map(e=>M(e.sleep_quality)).filter(e=>"number"==typeof e&&Number.isFinite(e)),W=I.length>0?I.reduce((e,t)=>e+t,0)/I.length:null,T=L.length>0?L.reduce((e,t)=>e+t,0)/L.length:null,G=L.length<3?"no_data":L[L.length-1]>L[Math.floor(L.length/2)]?"improving":L[L.length-1]<L[Math.floor(L.length/2)]?"declining":"stable",{data:O,error:P}=await a.from("motivation_records").select("*").eq("user_id",e).gte("date",t.start).lte("date",t.end);if(P)throw P;const H=(O||[]).map(e=>M(e.motivation_level)).filter(e=>"number"==typeof e&&Number.isFinite(e)),U=(O||[]).map(e=>M(e.energy_level)).filter(e=>"number"==typeof e&&Number.isFinite(e)),B=(O||[]).map(e=>M(e.stress_level)).filter(e=>"number"==typeof e&&Number.isFinite(e)),J=H.length>0?H.reduce((e,t)=>e+t,0)/H.length:null,V=U.length>0?U.reduce((e,t)=>e+t,0)/U.length:null,Y=B.length>0?B.reduce((e,t)=>e+t,0)/B.length:null,Q=H.length<3?"no_data":H[H.length-1]>H[Math.floor(H.length/2)]?"improving":H[H.length-1]<H[Math.floor(H.length/2)]?"declining":"stable",{data:X,error:Z}=await a.from("performance_records").select("*, performance_test_types(*)").eq("user_id",e).gte("date",t.start).lte("date",t.end);if(Z)throw Z;const K=(null==X?void 0:X.length)||0;let ee=0,te=0;if(X&&X.length>0){const e=new Map;X.forEach(t=>{const r=t.test_type_id;e.has(r)||e.set(r,[]),e.get(r).push(t)}),e.forEach(e=>{var t,r;if(e.length>=2){const a=[...e].sort((e,t)=>new Date(e.date).getTime()-new Date(t.date).getTime()),s=a[0],l=a[a.length-1],n=null==(t=null==s?void 0:s.values)?void 0:t.result,i=null==(r=null==l?void 0:l.values)?void 0:r.result;null!=n&&null!=i&&(i>n?ee++:i<n&&te++)}})}const{data:re}=await a.from("alerts").select("*").eq("user_id",e).gte("created_at",t.start).lte("created_at",t.end),ae=re||[],se=ae.length,le=ae.filter(e=>"high"===e.priority).length,ne=ae.filter(e=>{var t;return"medium"===(null==(t=e.metadata)?void 0:t.priority)}).length,ie=ae.filter(e=>"low"===e.priority).length,de=ae.filter(e=>e.is_resolved).length;return{athleteId:r.id,athleteName:r.name,athleteEmail:r.email,trainingRecords:{totalSessions:d,totalLoad:z(o),averageLoad:z(m),maxLoad:z(x),averageRPE:z(g),totalDuration:Math.round(c)},acwrData:{current:z(p),average:z(b),max:z(y),min:z(f),riskLevel:j,daysInDangerZone:v,trend:N},weightData:{current:C,average:null!=R?z(R):null,change:null!=S?z(S):null,changePercent:null!=q?z(q):null,trend:D},sleepData:{averageHours:null!=W?z(W):null,averageQuality:null!=T?z(T):null,totalRecords:(null==E?void 0:E.length)||0,qualityTrend:G},motivationData:{averageMotivation:null!=J?z(J):null,averageEnergy:null!=V?z(V):null,averageStress:null!=Y?z(Y):null,totalRecords:(null==O?void 0:O.length)||0,motivationTrend:Q},performanceData:{totalTests:K,personalBests:0,improvements:ee,declines:te},alerts:{total:se,high:le,medium:ne,low:ie,resolved:de}}}function F(e){const[s,n]=R.useState([]),[i,d]=R.useState(!0),[o,c]=R.useState(null);R.useEffect(()=>{e?m():(n([]),d(!1))},[e]);const m=async()=>{if(e)try{d(!0),c(null);const{data:t,error:r}=await a.from("generated_reports").select("*").eq("team_id",e).order("created_at",{ascending:!1}).limit(50);if(r)throw r;n(t||[])}catch(t){console.error("Error fetching reports:",t),c(t.message)}finally{d(!1)}};return{reports:s,loading:i,error:o,generateReport:async(e,s,l,n)=>{try{const i=function(e,a,s){const l=t(),n=new Date(l.getTime());let i=new Date(n.getTime());switch(e){case"weekly":i.setDate(n.getDate()-7);break;case"monthly":i.setMonth(n.getMonth()-1);break;case"quarterly":i.setMonth(n.getMonth()-3);break;case"semi_annual":i.setMonth(n.getMonth()-6);break;case"annual":i.setFullYear(n.getFullYear()-1);break;case"custom":if(a&&s)return{start:a,end:s,type:"custom"}}return{start:r(i),end:r(n),type:e}}(s,l,n),d=await async function(e,t){const{data:r,error:s}=await a.from("teams").select("*").eq("id",e).single();if(s)throw s;if(!r)throw new Error("Team not found");const{data:l,error:n}=await a.from("users").select("*").eq("team_id",e).eq("role","athlete");if(n)throw n;const i=(null==l?void 0:l.length)||0,d=[];if(l)for(const a of l)try{const e=await E(a.id,t);d.push(e)}catch(o){console.error(`Error generating report for athlete ${a.id}:`,o)}const c=d.filter(e=>e.trainingRecords.totalSessions>0).length,m=c>0?d.reduce((e,t)=>e+t.trainingRecords.averageLoad,0)/c:0,x=d.filter(e=>e.acwrData.current>0),g=x.length>0?x.reduce((e,t)=>e+t.acwrData.current,0)/x.length:0,h=d.filter(e=>"high"===e.acwrData.riskLevel).length,u=d.filter(e=>"medium"===e.acwrData.riskLevel).length,p=d.filter(e=>"low"===e.acwrData.riskLevel).length,b=d.reduce((e,t)=>e+t.alerts.total,0),y=d.reduce((e,t)=>e+t.alerts.high,0),f=[],v=[];g>1.3?(f.push(`チーム平均ACWR（${g.toFixed(2)}）が推奨範囲を超えています。全体的にトレーニング負荷が高い状態です。`),v.push("チーム全体のトレーニング強度を見直し、適切な休息日を設けることを推奨します。")):g<.8&&g>0?(f.push(`チーム平均ACWR（${g.toFixed(2)}）が推奨範囲を下回っています。トレーニング負荷が不足している可能性があります。`),v.push("選手のコンディションを確認しながら、段階的にトレーニング負荷を増やすことを検討してください。")):f.push(`チーム平均ACWR（${g.toFixed(2)}）は適切な範囲内です。`),h>0&&(f.push(`${h}名の選手が高リスク状態です。個別対応が必要です。`),v.push(`高リスク選手: ${d.filter(e=>"high"===e.acwrData.riskLevel).map(e=>e.athleteName).join(", ")} の負荷調整を優先してください。`)),y>0&&(f.push(`${y}件の重要アラートが発生しています。`),v.push("高優先度のアラートに対して迅速に対応してください。"));const j=d.filter(e=>null!==e.sleepData.averageHours&&e.sleepData.averageHours<7);j.length>0&&(f.push(`${j.length}名の選手の平均睡眠時間が7時間未満です。`),v.push(`睡眠不足の選手（${j.map(e=>e.athleteName).join("、")}）に対して、睡眠習慣の改善を指導してください。`));const N=d.filter(e=>null!==e.motivationData.averageMotivation&&e.motivationData.averageMotivation<3);return N.length>0&&(f.push(`${N.length}名の選手のモチベーションが低下しています。`),v.push(`モチベーション低下が見られる選手（${N.map(e=>e.athleteName).join("、")}）と個別面談を行うことを推奨します。`)),{teamId:r.id,teamName:r.name,period:t,generatedAt:(new Date).toISOString(),totalAthletes:i,activeAthletes:c,teamAverageLoad:z(m),teamAverageACWR:z(g),highRiskCount:h,mediumRiskCount:u,lowRiskCount:p,totalAlerts:b,newAlerts:b,criticalAlerts:y,athletes:d,insights:f,recommendations:v}}(e,i),{data:c}=await a.from("teams").select("name").eq("id",e).single(),x={report_type:s,title:`${(null==c?void 0:c.name)||"チーム"}レポート - ${i.start} 〜 ${i.end}`,period_start:i.start,period_end:i.end,team_id:e,athlete_ids:d.athletes.map(e=>e.athleteId),summary_data:{totalAthletes:d.totalAthletes,activeAthletes:d.activeAthletes,teamAverageLoad:d.teamAverageLoad,teamAverageACWR:d.teamAverageACWR,highRiskCount:d.highRiskCount,mediumRiskCount:d.mediumRiskCount,lowRiskCount:d.lowRiskCount,totalAlerts:d.totalAlerts,criticalAlerts:d.criticalAlerts},detailed_data:d,insights:d.insights,recommendations:d.recommendations,generation_status:"completed"},{data:g,error:h}=await a.from("generated_reports").insert(x).select().single();if(h)throw h;return await m(),{success:!0,reportId:g.id}}catch(i){return console.error("Error generating report:",i),{success:!1,error:i.message}}},markReportAsViewed:async e=>{try{const{error:t}=await a.from("generated_reports").update({viewed_at:l()}).eq("id",e);if(t)throw t;await m()}catch(t){console.error("Error marking report as viewed:",t)}},deleteReport:async e=>{try{const{error:t}=await a.from("generated_reports").delete().eq("id",e);if(t)throw t;return await m(),{success:!0}}catch(t){return console.error("Error deleting report:",t),{success:!1,error:t.message}}},refreshReports:m}}function I({organizationId:e,userId:t}){const[r,s]=R.useState([]),[l,p]=R.useState(null),[b,y]=R.useState("team"),[f,v]=R.useState({start:"",end:""}),[j,N]=R.useState(""),[w,k]=R.useState(""),[_,C]=R.useState([]),[A,S]=R.useState([]),[q,D]=R.useState({acwr:!0,training_load:!0,performance:!0,injury_risk:!0,attendance:!0,trends:!0}),[M,$]=R.useState(!1),[z,E]=R.useState(!1),[F,I]=R.useState(!1),[L,W]=R.useState(null),[T,G]=R.useState([]),[O,P]=R.useState(!1);R.useEffect(()=>{e&&(H(),U(),J())},[e]),R.useEffect(()=>{p(e=>e&&e.report_type===b?e:null),"organization"===b?(N(""),k(""),S([])):"team"===b&&k("")},[b]),R.useEffect(()=>{if(!j)return S([]),void k("");B(j)},[j]);const H=async()=>{try{const{data:t,error:r}=await a.from("report_templates").select("*").eq("organization_id",e).order("name");if(r)throw r;s(t||[])}catch(t){console.error("[AdvancedReportGenerator] fetchTemplates failed:",t),s([])}},U=async()=>{try{$(!0);const{data:t,error:r}=await a.from("teams").select("id, name").eq("organization_id",e).order("name");if(r)throw r;C(t||[])}catch(t){console.error("[AdvancedReportGenerator] fetchTeams failed:",t),C([])}finally{$(!1)}},B=async e=>{try{E(!0),S([]),k("");const{data:t,error:r}=await a.from("team_member_assignments").select("user_id, users!inner(id, name)").eq("team_id",e);if(r)throw r;const s=(null==t?void 0:t.map(e=>{var t;return{id:e.user_id,name:(null==(t=e.users)?void 0:t.name)||"unknown"}}))||[];s.sort((e,t)=>e.name.localeCompare(t.name,"ja")),S(s)}catch(t){console.error("[AdvancedReportGenerator] fetchAthletes failed:",t),S([])}finally{E(!1)}},J=async()=>{try{P(!0);const{data:t,error:r}=await a.from("report_history").select("id, report_type, status, created_at, started_at, completed_at, file_path, report_url, error_message, parameters").eq("organization_id",e).order("created_at",{ascending:!1}).limit(20);if(r)throw r;G(t||[])}catch(t){console.error("[AdvancedReportGenerator] fetchHistory failed:",t),G([])}finally{P(!1)}},V=R.useMemo(()=>f.start&&f.end&&f.start>f.end?"開始日が終了日より後になっています":null,[f.start,f.end]),Y=R.useMemo(()=>{if(!f.start||!f.end)return"期間（開始日・終了日）を入力してください";if(V)return V;if("team"===b&&!j)return"チームを選択してください";if("individual"===b){if(!j)return"チームを選択してください";if(!w)return"アスリートを選択してください"}return Object.values(q).some(Boolean)?null:"含める指標を1つ以上選択してください"},[f.start,f.end,V,b,j,w,q]),Q=!F&&!Y,X=e=>{window.open(e,"_blank","noopener,noreferrer")},Z=e=>{switch(e){case"individual":return n.jsx(u,{className:"w-5 h-5"});case"team":return n.jsx(h,{className:"w-5 h-5"});case"organization":return n.jsx(g,{className:"w-5 h-5"});default:return n.jsx(i,{className:"w-5 h-5"})}},K={acwr:"ACWR",training_load:"トレーニング負荷",performance:"パフォーマンス",injury_risk:"傷害リスク",attendance:"出欠/稼働",trends:"トレンド"},ee=e=>{const t="px-2 py-1 text-xs rounded-full";return"completed"===e?`${t} bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300`:"failed"===e?`${t} bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300`:`${t} bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-200`};return n.jsxs("div",{className:"bg-white dark:bg-gray-800 p-6 rounded-lg shadow space-y-6",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(i,{className:"w-6 h-6 text-blue-600 dark:text-blue-400"}),n.jsx("h3",{className:"text-xl font-semibold text-gray-900 dark:text-white",children:"高度なレポート生成"})]}),n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"レポートタイプ"}),n.jsx("div",{className:"grid grid-cols-3 gap-3",children:["individual","team","organization"].map(e=>n.jsxs("button",{type:"button",onClick:()=>y(e),className:"p-4 border-2 rounded-lg flex flex-col items-center gap-2 transition-colors "+(b===e?"border-blue-500 bg-blue-50 dark:bg-blue-900/20":"border-gray-300 dark:border-gray-600 hover:border-blue-300 dark:hover:border-blue-700"),children:[Z(e),n.jsx("span",{className:"text-sm font-medium text-gray-900 dark:text-white",children:"individual"===e?"個人":"team"===e?"チーム":"組織"})]},e))})]}),r.length>0&&n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"テンプレート（任意）"}),n.jsxs("select",{value:(null==l?void 0:l.id)||"",onChange:e=>{const t=r.find(t=>t.id===e.target.value);p(t||null),t&&y(t.report_type)},className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white",children:[n.jsx("option",{value:"",children:"カスタムレポート"}),r.map(e=>n.jsx("option",{value:e.id,children:e.name},e.id))]})]}),n.jsxs("div",{children:[n.jsxs("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:[n.jsx(d,{className:"inline w-4 h-4 mr-1"}),"期間"]}),n.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-xs text-gray-600 dark:text-gray-400 mb-1",children:"開始日"}),n.jsx("input",{type:"date",value:f.start,onChange:e=>v({...f,start:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-xs text-gray-600 dark:text-gray-400 mb-1",children:"終了日"}),n.jsx("input",{type:"date",value:f.end,onChange:e=>v({...f,end:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"})]})]}),V&&n.jsx("div",{className:"mt-2 text-sm text-red-600 dark:text-red-400",children:V})]}),("team"===b||"individual"===b)&&n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"チーム"}),n.jsxs("select",{value:j,onChange:e=>N(e.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white",disabled:M,children:[n.jsx("option",{value:"",children:M?"読み込み中…":"チームを選択"}),_.map(e=>n.jsx("option",{value:e.id,children:e.name},e.id))]})]}),"individual"===b&&j&&n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"アスリート"}),n.jsxs("select",{value:w,onChange:e=>k(e.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white",disabled:z,children:[n.jsx("option",{value:"",children:z?"読み込み中…":"アスリートを選択"}),A.map(e=>n.jsx("option",{value:e.id,children:e.name},e.id))]})]}),n.jsxs("div",{children:[n.jsxs("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:[n.jsx(o,{className:"inline w-4 h-4 mr-1"}),"含める指標"]}),n.jsx("div",{className:"grid grid-cols-2 gap-3",children:Object.entries(q).map(([e,t])=>n.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[n.jsx("input",{type:"checkbox",checked:t,onChange:t=>D({...q,[e]:t.target.checked}),className:"w-4 h-4 text-blue-600 rounded focus:ring-blue-500"}),n.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:K[e]??e.replace(/_/g," ")})]},e))})]}),n.jsxs("button",{type:"button",onClick:async()=>{if(Y)window.alert(Y);else{I(!0),W(null);try{const r={report_type:b,date_range:f,team_id:"organization"===b?null:j,athlete_id:"individual"===b?w:null,metrics:q},{data:s,error:n}=await a.from("report_history").insert({organization_id:e,template_id:(null==l?void 0:l.id)||null,report_type:b,generated_by:t,parameters:r,status:"pending"}).select("id").single();if(n)throw n;const i=null==s?void 0:s.id;if(!i)throw new Error("Failed to create report_history");const{data:d,error:o}=await a.functions.invoke("generate_report",{body:{report_history_id:i}});if(o)throw console.error("[AdvancedReportGenerator] invoke error:",o),o;const c={report_history_id:i,report_url:(null==d?void 0:d.report_url)??null,file_path:(null==d?void 0:d.file_path)??null};W(c),await J(),c.report_url?window.alert("レポート生成が完了しました。ダウンロードできます。"):window.alert("生成は完了しましたが、URLがまだありません（Storage設定を確認してください）")}catch(r){console.error("[AdvancedReportGenerator] generateReport failed:",r),window.alert(`レポート生成に失敗しました：${(null==r?void 0:r.message)??r}`),await J()}finally{I(!1)}}},disabled:!Q,className:"w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2",children:[n.jsx(c,{className:"w-5 h-5"}),F?"生成中...":"レポートを生成"]}),Y&&n.jsxs("div",{className:"text-sm text-gray-600 dark:text-gray-300",children:["※ ",Y]}),L&&n.jsxs("div",{className:"p-4 rounded-lg bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800",children:[n.jsxs("div",{className:"text-sm text-gray-700 dark:text-gray-200",children:[n.jsx("div",{className:"font-semibold mb-1",children:"最新の生成結果"}),n.jsxs("div",{className:"break-all",children:["report_history_id: ",L.report_history_id]}),L.file_path&&n.jsxs("div",{className:"break-all",children:["file_path: ",L.file_path]})]}),n.jsx("div",{className:"mt-3 flex flex-wrap gap-2",children:L.report_url?n.jsxs(n.Fragment,{children:[n.jsxs("button",{type:"button",onClick:()=>X(L.report_url),className:"px-3 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white text-sm flex items-center gap-2",children:[n.jsx(m,{className:"w-4 h-4"}),"レポートを開く"]}),n.jsxs("a",{href:L.report_url,className:"px-3 py-2 rounded bg-gray-900 hover:bg-black text-white text-sm flex items-center gap-2",target:"_blank",rel:"noreferrer",children:[n.jsx(c,{className:"w-4 h-4"}),"ダウンロード"]})]}):n.jsx("div",{className:"text-sm text-orange-700 dark:text-orange-300",children:"report_url がまだありません（Storage/署名URL生成を確認）"})})]})]}),n.jsxs("div",{className:"border-t border-gray-200 dark:border-gray-700 pt-6",children:[n.jsxs("div",{className:"flex items-center justify-between mb-3",children:[n.jsx("h4",{className:"font-semibold text-gray-900 dark:text-white",children:"レポート履歴（最新20件）"}),n.jsxs("button",{type:"button",onClick:J,disabled:O,className:"px-3 py-2 rounded bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 text-sm flex items-center gap-2 disabled:opacity-50",children:[n.jsx(x,{className:"w-4 h-4"}),"更新"]})]}),O?n.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-300",children:"読み込み中…"}):0===T.length?n.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-300",children:"履歴がありません。"}):n.jsx("div",{className:"space-y-3",children:T.map(e=>n.jsxs("div",{className:"p-4 rounded-lg bg-gray-50 dark:bg-gray-700/40 border border-gray-200 dark:border-gray-700",children:[n.jsxs("div",{className:"flex items-center justify-between gap-3",children:[n.jsxs("div",{className:"min-w-0",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("span",{className:ee(e.status),children:e.status}),n.jsx("span",{className:"text-sm text-gray-800 dark:text-gray-100",children:e.report_type.toUpperCase()})]}),n.jsxs("div",{className:"text-xs text-gray-600 dark:text-gray-300 mt-1 break-all",children:["id: ",e.id]})]}),n.jsx("div",{className:"flex items-center gap-2",children:e.report_url?n.jsxs("button",{type:"button",onClick:()=>X(e.report_url),className:"px-3 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white text-sm flex items-center gap-2",children:[n.jsx(c,{className:"w-4 h-4"}),"開く"]}):n.jsxs("button",{type:"button",disabled:!0,className:"px-3 py-2 rounded bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 text-sm flex items-center gap-2 opacity-60 cursor-not-allowed",children:[n.jsx(c,{className:"w-4 h-4"}),"なし"]})})]}),e.error_message&&n.jsx("div",{className:"mt-2 text-sm text-red-600 dark:text-red-300",children:e.error_message}),n.jsxs("div",{className:"mt-2 text-xs text-gray-600 dark:text-gray-300 grid grid-cols-1 md:grid-cols-2 gap-2",children:[n.jsxs("div",{children:["created: ",e.created_at]}),n.jsxs("div",{children:["completed: ",e.completed_at??"-"]}),n.jsxs("div",{className:"break-all",children:["file_path: ",e.file_path??"-"]})]})]},e.id))})]})]})}function L({organizationId:e,userId:t}){const[r,s]=R.useState([]),[l,d]=R.useState(!0),[o,m]=R.useState("all");R.useEffect(()=>{x()},[e,o]);const x=async()=>{try{d(!0);let t=a.from("report_history").select("\n          *,\n          users!report_history_generated_by_fkey(name)\n        ").eq("organization_id",e).order("created_at",{ascending:!1}).limit(50);"all"!==o&&(t=t.eq("status",o));const{data:r,error:l}=await t;if(l)throw l;s(r||[])}catch(t){console.error("Error fetching reports:",t)}finally{d(!1)}},g=e=>{switch(e){case"completed":return n.jsx(f,{className:"w-5 h-5 text-green-600 dark:text-green-400"});case"failed":return n.jsx(D,{className:"w-5 h-5 text-red-600 dark:text-red-400"});default:return n.jsx(y,{className:"w-5 h-5 text-yellow-600 dark:text-yellow-400"})}},h=e=>{switch(e){case"completed":return"bg-green-50 dark:bg-green-900/20";case"failed":return"bg-red-50 dark:bg-red-900/20";default:return"bg-yellow-50 dark:bg-yellow-900/20"}},u=e=>{switch(e){case"completed":return"完了";case"failed":return"失敗";default:return"処理中"}},v=e=>{switch(e){case"individual":return"個人レポート";case"team":return"チームレポート";case"organization":return"組織レポート";default:return"レポート"}};return l?n.jsx("div",{className:"flex items-center justify-center h-64",children:n.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})}):n.jsxs("div",{className:"bg-white dark:bg-gray-800 p-6 rounded-lg shadow",children:[n.jsxs("div",{className:"flex items-center justify-between mb-6",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(i,{className:"w-6 h-6 text-purple-600 dark:text-purple-400"}),n.jsx("h3",{className:"text-xl font-semibold text-gray-900 dark:text-white",children:"レポート履歴"})]}),n.jsx("button",{onClick:x,className:"p-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors",title:"更新",children:n.jsx(p,{className:"w-5 h-5"})})]}),n.jsx("div",{className:"flex gap-2 mb-6",children:["all","completed","pending","failed"].map(e=>n.jsx("button",{onClick:()=>m(e),className:"px-4 py-2 text-sm rounded-lg transition-colors "+(o===e?"bg-purple-600 text-white":"bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600"),children:"all"===e?"すべて":u(e)},e))}),0===r.length?n.jsxs("div",{className:"text-center py-12 text-gray-500 dark:text-gray-400",children:[n.jsx(i,{className:"w-12 h-12 mx-auto mb-3 opacity-50"}),n.jsx("p",{children:"レポート履歴がありません"})]}):n.jsx("div",{className:"space-y-3",children:r.map(e=>{var t,l;return n.jsx("div",{className:`p-4 rounded-lg border-2 ${h(e.status)} border-gray-200 dark:border-gray-700`,children:n.jsxs("div",{className:"flex items-start justify-between",children:[n.jsxs("div",{className:"flex-1",children:[n.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[g(e.status),n.jsx("h4",{className:"font-semibold text-gray-900 dark:text-white",children:v(e.report_type)}),n.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:(l=e.created_at,new Date(l).toLocaleString("ja-JP",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}))})]}),n.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm text-gray-600 dark:text-gray-400 mb-2",children:[n.jsxs("div",{children:[n.jsx("span",{className:"font-medium",children:"生成者: "}),(null==(t=e.users)?void 0:t.name)||"Unknown"]}),n.jsxs("div",{children:[n.jsx("span",{className:"font-medium",children:"ステータス: "}),u(e.status)]})]}),e.parameters&&Object.keys(e.parameters).length>0&&n.jsxs("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:[n.jsx("span",{className:"font-medium",children:"パラメータ: "}),e.parameters.date_range&&n.jsxs("span",{children:[e.parameters.date_range.start," ~ ",e.parameters.date_range.end]})]}),e.error_message&&n.jsxs("div",{className:"mt-2 p-2 bg-red-100 dark:bg-red-900/30 rounded text-sm text-red-800 dark:text-red-200",children:["エラー: ",e.error_message]})]}),n.jsxs("div",{className:"flex gap-2 ml-4",children:["completed"===e.status&&n.jsx("button",{onClick:()=>alert("ダウンロード機能は実装予定です"),className:"p-2 text-blue-600 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-900/20 rounded-lg transition-colors",title:"ダウンロード",children:n.jsx(c,{className:"w-5 h-5"})}),n.jsx("button",{onClick:()=>(async e=>{if(confirm("このレポートを削除しますか？"))try{const{error:t}=await a.from("report_history").delete().eq("id",e);if(t)throw t;s(r.filter(t=>t.id!==e))}catch(t){console.error("Error deleting report:",t),alert("レポートの削除に失敗しました")}})(e.id),className:"p-2 text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-900/20 rounded-lg transition-colors",title:"削除",children:n.jsx(b,{className:"w-5 h-5"})})]})]})},e.id)})})]})}function W({organizationId:e,userId:t}){const[r,s]=R.useState([]),[l,i]=R.useState(!1),[o,c]=R.useState(null),[m,x]=R.useState(!0),[g,h]=R.useState({name:"",schedule_type:"weekly",day_of_week:"1",day_of_month:"1",time:"09:00",recipients:""});R.useEffect(()=>{u()},[e]);const u=async()=>{try{x(!0);const{data:t,error:r}=await a.from("scheduled_reports").select("*").eq("organization_id",e).order("name");if(r)throw r;s(t||[])}catch(t){console.error("Error fetching scheduled reports:",t)}finally{x(!1)}},p=e=>{const t=e.schedule_config,r=t.time||"09:00";switch(e.schedule_type){case"daily":return`毎日 ${r}`;case"weekly":return`毎週${["日","月","火","水","木","金","土"][t.day_of_week||1]}曜日 ${r}`;case"monthly":return`毎月${t.day_of_month||1}日 ${r}`;default:return"不明"}};return m?n.jsx("div",{className:"flex items-center justify-center h-64",children:n.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-green-600"})}):n.jsxs("div",{className:"bg-white dark:bg-gray-800 p-6 rounded-lg shadow",children:[n.jsxs("div",{className:"flex items-center justify-between mb-6",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(d,{className:"w-6 h-6 text-green-600 dark:text-green-400"}),n.jsx("h3",{className:"text-xl font-semibold text-gray-900 dark:text-white",children:"スケジュールレポート"})]}),n.jsxs("button",{onClick:()=>i(!0),className:"flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors",children:[n.jsx(v,{className:"w-5 h-5"}),"新規作成"]})]}),l&&n.jsxs("form",{onSubmit:async r=>{r.preventDefault();try{const r={time:g.time};"weekly"===g.schedule_type?r.day_of_week=parseInt(g.day_of_week):"monthly"===g.schedule_type&&(r.day_of_month=parseInt(g.day_of_month));const s=g.recipients.split(",").map(e=>e.trim()).filter(e=>e),{data:l}=await a.rpc("calculate_next_run",{p_schedule_type:g.schedule_type,p_schedule_config:r}),n={organization_id:e,template_id:e,name:g.name,schedule_type:g.schedule_type,schedule_config:r,recipients:s,next_run:l,created_by:t};if(o){const{error:e}=await a.from("scheduled_reports").update(n).eq("id",o.id);if(e)throw e}else{const{error:e}=await a.from("scheduled_reports").insert(n);if(e)throw e}i(!1),c(null),h({name:"",schedule_type:"weekly",day_of_week:"1",day_of_month:"1",time:"09:00",recipients:""}),u()}catch(s){console.error("Error saving scheduled report:",s),alert("スケジュールの保存に失敗しました")}},className:"mb-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg",children:[n.jsx("h4",{className:"font-semibold text-gray-900 dark:text-white mb-4",children:o?"スケジュール編集":"新規スケジュール"}),n.jsxs("div",{className:"space-y-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"スケジュール名"}),n.jsx("input",{type:"text",required:!0,value:g.name,onChange:e=>h({...g,name:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-green-500 dark:bg-gray-800 dark:text-white"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"頻度"}),n.jsxs("select",{value:g.schedule_type,onChange:e=>h({...g,schedule_type:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-green-500 dark:bg-gray-800 dark:text-white",children:[n.jsx("option",{value:"daily",children:"毎日"}),n.jsx("option",{value:"weekly",children:"毎週"}),n.jsx("option",{value:"monthly",children:"毎月"})]})]}),"weekly"===g.schedule_type&&n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"曜日"}),n.jsxs("select",{value:g.day_of_week,onChange:e=>h({...g,day_of_week:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-green-500 dark:bg-gray-800 dark:text-white",children:[n.jsx("option",{value:"0",children:"日曜日"}),n.jsx("option",{value:"1",children:"月曜日"}),n.jsx("option",{value:"2",children:"火曜日"}),n.jsx("option",{value:"3",children:"水曜日"}),n.jsx("option",{value:"4",children:"木曜日"}),n.jsx("option",{value:"5",children:"金曜日"}),n.jsx("option",{value:"6",children:"土曜日"})]})]}),"monthly"===g.schedule_type&&n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"日付"}),n.jsx("input",{type:"number",min:"1",max:"31",value:g.day_of_month,onChange:e=>h({...g,day_of_month:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-green-500 dark:bg-gray-800 dark:text-white"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"時刻"}),n.jsx("input",{type:"time",value:g.time,onChange:e=>h({...g,time:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-green-500 dark:bg-gray-800 dark:text-white"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"送信先メールアドレス（カンマ区切り）"}),n.jsx("input",{type:"text",required:!0,value:g.recipients,onChange:e=>h({...g,recipients:e.target.value}),placeholder:"user1@example.com, user2@example.com",className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-green-500 dark:bg-gray-800 dark:text-white"})]}),n.jsxs("div",{className:"flex gap-2",children:[n.jsx("button",{type:"submit",className:"flex-1 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors",children:"保存"}),n.jsx("button",{type:"button",onClick:()=>{i(!1),c(null)},className:"flex-1 py-2 bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-700 dark:text-white rounded-lg transition-colors",children:"キャンセル"})]})]})]}),0===r.length?n.jsxs("div",{className:"text-center py-12 text-gray-500 dark:text-gray-400",children:[n.jsx(d,{className:"w-12 h-12 mx-auto mb-3 opacity-50"}),n.jsx("p",{children:"スケジュールされたレポートがありません"})]}):n.jsx("div",{className:"space-y-3",children:r.map(e=>n.jsxs("div",{className:"p-4 bg-gray-50 dark:bg-gray-700 rounded-lg flex items-center justify-between",children:[n.jsxs("div",{className:"flex-1",children:[n.jsx("h4",{className:"font-semibold text-gray-900 dark:text-white mb-2",children:e.name}),n.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-600 dark:text-gray-400",children:[n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx(y,{className:"w-4 h-4"}),p(e)]}),n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx(j,{className:"w-4 h-4"}),e.recipients.length," 人"]})]})]}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("button",{onClick:()=>(async e=>{try{const{error:t}=await a.from("scheduled_reports").update({is_active:!e.is_active}).eq("id",e.id);if(t)throw t;u()}catch(t){console.error("Error toggling report:",t)}})(e),className:"p-2 rounded-lg transition-colors "+(e.is_active?"text-green-600 dark:text-green-400 hover:bg-green-100 dark:hover:bg-green-900/20":"text-gray-400 dark:text-gray-600 hover:bg-gray-200 dark:hover:bg-gray-600"),title:e.is_active?"無効化":"有効化",children:e.is_active?n.jsx(q,{className:"w-5 h-5"}):n.jsx(S,{className:"w-5 h-5"})}),n.jsx("button",{onClick:()=>(async e=>{if(confirm("このスケジュールを削除しますか？"))try{const{error:t}=await a.from("scheduled_reports").delete().eq("id",e);if(t)throw t;u()}catch(t){console.error("Error deleting report:",t),alert("削除に失敗しました")}})(e.id),className:"p-2 text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-900/20 rounded-lg transition-colors",title:"削除",children:n.jsx(b,{className:"w-5 h-5"})})]})]},e.id))})]})}function T({team:e}){var t,r,a,s;const{user:l}=N(),{organizations:o}=w((null==l?void 0:l.id)||""),c=e.organization_id||(o.length>0?o[0].id:""),{reports:m,loading:x,generateReport:g,markReportAsViewed:u,deleteReport:f,refreshReports:j}=F(e.id),[S,q]=R.useState(!1),[D,M]=R.useState(!1),[$,z]=R.useState("weekly"),[E,T]=R.useState(""),[G,O]=R.useState(""),[P,H]=R.useState(null),[U,B]=R.useState("basic"),J=e=>{switch(e){case"high":return"text-red-600 bg-red-50";case"medium":return"text-yellow-600 bg-yellow-50";case"low":return"text-green-600 bg-green-50";default:return"text-gray-600 bg-gray-50"}},V=e=>{switch(e){case"high":return"高リスク";case"medium":return"中リスク";case"low":return"低リスク";default:return"不明"}};return x?n.jsx("div",{className:"flex items-center justify-center py-12",children:n.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})}):n.jsxs("div",{className:"space-y-6",children:[n.jsx("div",{className:"bg-white rounded-xl shadow-sm p-2",children:n.jsx("div",{className:"flex gap-2",children:[{id:"basic",label:"基本レポート",icon:i},{id:"advanced",label:"高度なレポート",icon:k},{id:"scheduled",label:"スケジュール",icon:d},{id:"history",label:"履歴",icon:y}].map(e=>n.jsxs("button",{onClick:()=>B(e.id),className:"flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-lg transition-colors "+(U===e.id?"bg-blue-600 text-white":"text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700"),children:[n.jsx(e.icon,{className:"w-5 h-5"}),n.jsx("span",{className:"font-medium",children:e.label})]},e.id))})}),"advanced"===U&&l&&n.jsx(I,{organizationId:c,userId:l.id}),"scheduled"===U&&l&&n.jsx(W,{organizationId:c,userId:l.id}),"history"===U&&l&&n.jsx(L,{organizationId:c,userId:l.id}),"basic"===U&&n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"bg-white rounded-xl shadow-sm p-6",children:[n.jsxs("div",{className:"flex items-center justify-between mb-4",children:[n.jsxs("div",{children:[n.jsxs("h2",{className:"text-2xl font-bold text-gray-900 flex items-center",children:[n.jsx(i,{className:"w-7 h-7 mr-3 text-blue-600"}),"チームレポート"]}),n.jsxs("p",{className:"text-gray-600 mt-1",children:[e.name,"の選手コンディションレポート"]})]}),n.jsxs("div",{className:"flex items-center space-x-3",children:[n.jsxs("button",{onClick:j,className:"bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition-colors flex items-center space-x-2",children:[n.jsx(p,{className:"w-4 h-4"}),n.jsx("span",{children:"更新"})]}),n.jsxs("button",{onClick:()=>M(!0),className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center space-x-2",children:[n.jsx(v,{className:"w-4 h-4"}),n.jsx("span",{children:"レポート生成"})]})]})]}),n.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-4 gap-4 mt-6",children:[n.jsxs("div",{className:"bg-blue-50 rounded-lg p-4 text-center",children:[n.jsx("div",{className:"text-2xl font-bold text-blue-600",children:m.length}),n.jsx("div",{className:"text-sm text-blue-700",children:"生成済みレポート"})]}),n.jsxs("div",{className:"bg-green-50 rounded-lg p-4 text-center",children:[n.jsx("div",{className:"text-2xl font-bold text-green-600",children:m.filter(e=>e.viewed_at).length}),n.jsx("div",{className:"text-sm text-green-700",children:"閲覧済み"})]}),n.jsxs("div",{className:"bg-yellow-50 rounded-lg p-4 text-center",children:[n.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:m.filter(e=>!e.viewed_at).length}),n.jsx("div",{className:"text-sm text-yellow-700",children:"未閲覧"})]}),n.jsxs("div",{className:"bg-purple-50 rounded-lg p-4 text-center",children:[n.jsx("div",{className:"text-2xl font-bold text-purple-600",children:(null==(r=null==(t=m[0])?void 0:t.summary_data)?void 0:r.totalAthletes)||0}),n.jsx("div",{className:"text-sm text-purple-700",children:"対象選手数"})]})]})]}),n.jsxs("div",{className:"bg-white rounded-xl shadow-sm p-6",children:[n.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"生成済みレポート"}),0===m.length?n.jsxs("div",{className:"text-center py-12",children:[n.jsx(i,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),n.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-2",children:"レポートがありません"}),n.jsx("p",{className:"text-gray-600 mb-4",children:"「レポート生成」ボタンから新しいレポートを作成してください。"}),n.jsxs("button",{onClick:()=>M(!0),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors inline-flex items-center space-x-2",children:[n.jsx(v,{className:"w-4 h-4"}),n.jsx("span",{children:"レポート生成"})]})]}):n.jsx("div",{className:"space-y-4",children:m.map(e=>n.jsx("div",{className:"border rounded-lg p-4 hover:shadow-md transition-shadow "+(e.viewed_at?"border-gray-200":"border-blue-300 bg-blue-50"),children:n.jsxs("div",{className:"flex items-start justify-between",children:[n.jsxs("div",{className:"flex-1",children:[n.jsxs("div",{className:"flex items-center space-x-3 mb-2",children:[n.jsx("h4",{className:"text-lg font-semibold text-gray-900",children:e.title}),!e.viewed_at&&n.jsx("span",{className:"bg-blue-600 text-white text-xs px-2 py-1 rounded-full",children:"新規"})]}),n.jsxs("div",{className:"flex items-center space-x-4 text-sm text-gray-600 mb-3",children:[n.jsxs("span",{className:"flex items-center",children:[n.jsx(d,{className:"w-4 h-4 mr-1"}),e.period_start," 〜 ",e.period_end]}),n.jsxs("span",{className:"flex items-center",children:[n.jsx(y,{className:"w-4 h-4 mr-1"}),new Date(e.generated_at).toLocaleString("ja-JP")]}),n.jsxs("span",{className:"flex items-center",children:[n.jsx(_,{className:"w-4 h-4 mr-1"}),e.view_count,"回閲覧"]})]}),e.summary_data&&n.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-5 gap-3 mb-3",children:[n.jsxs("div",{className:"bg-gray-50 rounded p-2",children:[n.jsx("div",{className:"text-xs text-gray-600",children:"選手数"}),n.jsx("div",{className:"text-lg font-bold text-gray-900",children:e.summary_data.activeAthletes||0})]}),n.jsxs("div",{className:"bg-blue-50 rounded p-2",children:[n.jsx("div",{className:"text-xs text-blue-600",children:"平均ACWR"}),n.jsx("div",{className:"text-lg font-bold text-blue-900",children:(e.summary_data.teamAverageACWR||0).toFixed(2)})]}),n.jsxs("div",{className:"bg-red-50 rounded p-2",children:[n.jsx("div",{className:"text-xs text-red-600",children:"高リスク"}),n.jsxs("div",{className:"text-lg font-bold text-red-900",children:[e.summary_data.highRiskCount||0,"名"]})]}),n.jsxs("div",{className:"bg-yellow-50 rounded p-2",children:[n.jsx("div",{className:"text-xs text-yellow-600",children:"中リスク"}),n.jsxs("div",{className:"text-lg font-bold text-yellow-900",children:[e.summary_data.mediumRiskCount||0,"名"]})]}),n.jsxs("div",{className:"bg-orange-50 rounded p-2",children:[n.jsx("div",{className:"text-xs text-orange-600",children:"アラート"}),n.jsxs("div",{className:"text-lg font-bold text-orange-900",children:[e.summary_data.criticalAlerts||0,"件"]})]})]}),e.insights&&e.insights.length>0&&n.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded p-3",children:n.jsxs("div",{className:"flex items-start",children:[n.jsx(C,{className:"w-4 h-4 text-yellow-600 mr-2 mt-0.5 flex-shrink-0"}),n.jsx("div",{className:"text-sm text-yellow-800",children:e.insights[0]})]})})]}),n.jsxs("div",{className:"flex items-center space-x-2 ml-4",children:[n.jsx("button",{onClick:()=>(e=>{H(e),u(e.id)})(e),className:"bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg transition-colors",title:"詳細表示",children:n.jsx(_,{className:"w-4 h-4"})}),n.jsx("button",{onClick:()=>(async e=>{if(!confirm("このレポートを削除してもよろしいですか？"))return;const t=await f(e);t.success?alert("レポートを削除しました"):alert(`エラー: ${t.error}`)})(e.id),className:"bg-red-600 hover:bg-red-700 text-white p-2 rounded-lg transition-colors",title:"削除",children:n.jsx(b,{className:"w-4 h-4"})})]})]})},e.id))})]}),D&&n.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",children:n.jsxs("div",{className:"bg-white rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto",children:[n.jsx("div",{className:"bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 rounded-t-2xl",children:n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center space-x-3",children:[n.jsx(k,{className:"w-8 h-8"}),n.jsxs("div",{children:[n.jsx("h2",{className:"text-2xl font-bold",children:"レポート生成"}),n.jsx("p",{className:"text-blue-100",children:e.name})]})]}),n.jsx("button",{onClick:()=>M(!1),className:"bg-blue-500 hover:bg-blue-400 rounded-full p-2 transition-colors",children:n.jsx("span",{className:"text-2xl",children:"×"})})]})}),n.jsxs("div",{className:"p-6 space-y-6",children:[n.jsxs("div",{children:[n.jsxs("h3",{className:"font-semibold text-gray-900 mb-4 flex items-center",children:[n.jsx(d,{className:"w-5 h-5 mr-2 text-blue-600"}),"レポート期間の選択"]}),n.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-3 mb-4",children:[{value:"weekly",label:"1週間"},{value:"monthly",label:"1ヶ月"},{value:"quarterly",label:"3ヶ月"},{value:"semi_annual",label:"6ヶ月"},{value:"annual",label:"1年"},{value:"custom",label:"カスタム"}].map(e=>n.jsx("button",{onClick:()=>z(e.value),className:"p-3 rounded-lg text-sm font-medium transition-colors "+($===e.value?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"),children:e.label},e.value))}),"custom"===$&&n.jsxs("div",{className:"grid grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"開始日"}),n.jsx("input",{type:"date",value:E,onChange:e=>T(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"終了日"}),n.jsx("input",{type:"date",value:G,onChange:e=>O(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]})]})]}),n.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[n.jsx("h4",{className:"font-medium text-blue-900 mb-2",children:"レポートに含まれるデータ"}),n.jsxs("div",{className:"text-sm text-blue-700 space-y-1",children:[n.jsx("p",{children:"✓ トレーニング負荷とACWR分析"}),n.jsx("p",{children:"✓ 体重変化の推移"}),n.jsx("p",{children:"✓ 睡眠とモチベーションデータ"}),n.jsx("p",{children:"✓ パフォーマンステスト結果"}),n.jsx("p",{children:"✓ 怪我リスクアラート"}),n.jsx("p",{children:"✓ チーム平均との比較"}),n.jsx("p",{children:"✓ インサイトと推奨事項"})]})]}),n.jsxs("div",{className:"flex items-center justify-end space-x-3",children:[n.jsx("button",{onClick:()=>M(!1),className:"px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors",disabled:S,children:"キャンセル"}),n.jsx("button",{onClick:async()=>{q(!0);try{const t=await g(e.id,$,"custom"===$?E:void 0,"custom"===$?G:void 0);t.success?(alert("レポートを生成しました！"),M(!1)):alert(`エラー: ${t.error}`)}catch(t){console.error("Report generation error:",t),alert("レポート生成に失敗しました")}finally{q(!1)}},disabled:S||"custom"===$&&(!E||!G),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors disabled:opacity-50 flex items-center space-x-2",children:S?n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),n.jsx("span",{children:"生成中..."})]}):n.jsxs(n.Fragment,{children:[n.jsx(k,{className:"w-4 h-4"}),n.jsx("span",{children:"レポート生成"})]})})]})]})]})}),P&&n.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 overflow-y-auto",children:n.jsxs("div",{className:"bg-white rounded-2xl shadow-xl max-w-6xl w-full max-h-[90vh] overflow-y-auto",children:[n.jsx("div",{className:"bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 rounded-t-2xl sticky top-0 z-10",children:n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{children:[n.jsx("h2",{className:"text-2xl font-bold",children:P.title}),n.jsxs("p",{className:"text-blue-100",children:[P.period_start," 〜 ",P.period_end]})]}),n.jsx("button",{onClick:()=>H(null),className:"bg-blue-500 hover:bg-blue-400 rounded-full p-2 transition-colors",children:n.jsx("span",{className:"text-2xl",children:"×"})})]})}),n.jsxs("div",{className:"p-6 space-y-6",children:[P.summary_data&&n.jsxs("div",{className:"bg-gray-50 rounded-lg p-6",children:[n.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"チーム概要"}),n.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4",children:[n.jsxs("div",{className:"bg-white rounded-lg p-4 text-center",children:[n.jsx("div",{className:"text-2xl font-bold text-gray-900",children:P.summary_data.activeAthletes}),n.jsx("div",{className:"text-sm text-gray-600",children:"活動選手数"})]}),n.jsxs("div",{className:"bg-white rounded-lg p-4 text-center",children:[n.jsx("div",{className:"text-2xl font-bold text-blue-600",children:(null==(a=P.summary_data.teamAverageACWR)?void 0:a.toFixed(2))||"0.00"}),n.jsx("div",{className:"text-sm text-gray-600",children:"平均ACWR"})]}),n.jsxs("div",{className:"bg-white rounded-lg p-4 text-center",children:[n.jsx("div",{className:"text-2xl font-bold text-red-600",children:P.summary_data.highRiskCount}),n.jsx("div",{className:"text-sm text-gray-600",children:"高リスク選手"})]}),n.jsxs("div",{className:"bg-white rounded-lg p-4 text-center",children:[n.jsx("div",{className:"text-2xl font-bold text-orange-600",children:P.summary_data.criticalAlerts}),n.jsx("div",{className:"text-sm text-gray-600",children:"重要アラート"})]})]})]}),P.insights&&P.insights.length>0&&n.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-6",children:[n.jsxs("h3",{className:"text-lg font-semibold text-gray-900 mb-4 flex items-center",children:[n.jsx(C,{className:"w-5 h-5 mr-2 text-yellow-600"}),"インサイト"]}),n.jsx("div",{className:"space-y-2",children:P.insights.map((e,t)=>n.jsxs("p",{className:"text-sm text-gray-700",children:["• ",e]},t))})]}),P.recommendations&&P.recommendations.length>0&&n.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-6",children:[n.jsxs("h3",{className:"text-lg font-semibold text-gray-900 mb-4 flex items-center",children:[n.jsx(A,{className:"w-5 h-5 mr-2 text-blue-600"}),"推奨事項"]}),n.jsx("div",{className:"space-y-2",children:P.recommendations.map((e,t)=>n.jsxs("p",{className:"text-sm text-gray-700",children:["• ",e]},t))})]}),(null==(s=P.detailed_data)?void 0:s.athletes)&&n.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-6",children:[n.jsxs("h3",{className:"text-lg font-semibold text-gray-900 mb-4 flex items-center",children:[n.jsx(h,{className:"w-5 h-5 mr-2 text-gray-600"}),"選手別データ"]}),n.jsx("div",{className:"space-y-4",children:P.detailed_data.athletes.map(e=>{var t,r;return n.jsxs("div",{className:"border border-gray-200 rounded-lg p-4",children:[n.jsxs("div",{className:"flex items-center justify-between mb-3",children:[n.jsx("h4",{className:"text-lg font-semibold text-gray-900",children:e.athleteName}),n.jsx("span",{className:`px-3 py-1 rounded-full text-sm font-medium ${J(e.acwrData.riskLevel)}`,children:V(e.acwrData.riskLevel)})]}),n.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-5 gap-3 text-sm",children:[n.jsxs("div",{children:[n.jsx("div",{className:"text-gray-600",children:"トレーニング"}),n.jsxs("div",{className:"font-semibold text-gray-900",children:[e.trainingRecords.totalSessions,"回"]})]}),n.jsxs("div",{children:[n.jsx("div",{className:"text-gray-600",children:"ACWR"}),n.jsx("div",{className:"font-semibold text-gray-900",children:e.acwrData.current.toFixed(2)})]}),n.jsxs("div",{children:[n.jsx("div",{className:"text-gray-600",children:"睡眠"}),n.jsxs("div",{className:"font-semibold text-gray-900",children:[(null==(t=e.sleepData.averageHours)?void 0:t.toFixed(1))||"-","h"]})]}),n.jsxs("div",{children:[n.jsx("div",{className:"text-gray-600",children:"モチベ"}),n.jsx("div",{className:"font-semibold text-gray-900",children:(null==(r=e.motivationData.averageMotivation)?void 0:r.toFixed(1))||"-"})]}),n.jsxs("div",{children:[n.jsx("div",{className:"text-gray-600",children:"アラート"}),n.jsxs("div",{className:"font-semibold text-red-600",children:[e.alerts.high,"件"]})]})]})]},e.athleteId)})})]})]})]})})]})]})}export{T as ReportView};
//# sourceMappingURL=ReportView-nD5fRgZk.js.map

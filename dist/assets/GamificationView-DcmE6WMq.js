var e=Object.defineProperty,r=(r,t,a)=>((r,t,a)=>t in r?e(r,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):r[t]=a)(r,"symbol"!=typeof t?t+"":t,a);import{z as t,J as a,s,j as l,F as n,K as i,M as d,N as o,P as c,Q as x,R as u,X as g,V as m,Z as h,W as b,Y as y,U as f,_ as p,$ as k,G as v,a0 as j,a as w,a1 as N,n as _,o as S,H as C,a2 as M}from"./index-DC548egD.js";import{r as $,d as E}from"./chart-vendor-DEPfNMx8.js";import"./supabase-vendor-BgrwFlS9.js";
/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const R=t("Database",[["ellipse",{cx:"12",cy:"5",rx:"9",ry:"3",key:"msslwz"}],["path",{d:"M3 5V19A9 3 0 0 0 21 19V5",key:"1wlel7"}],["path",{d:"M3 12A9 3 0 0 0 21 12",key:"mv7ke4"}]]),T=t("Medal",[["path",{d:"M7.21 15 2.66 7.14a2 2 0 0 1 .13-2.2L4.4 2.8A2 2 0 0 1 6 2h12a2 2 0 0 1 1.6.8l1.6 2.14a2 2 0 0 1 .14 2.2L16.79 15",key:"143lza"}],["path",{d:"M11 12 5.12 2.2",key:"qhuxz6"}],["path",{d:"m13 12 5.88-9.8",key:"hbye0f"}],["path",{d:"M8 7h8",key:"i86dvs"}],["circle",{cx:"12",cy:"17",r:"5",key:"qbz8iq"}],["path",{d:"M12 18v-2h-.5",key:"fawc4q"}]]),L=t("Sunrise",[["path",{d:"M12 2v8",key:"1q4o3n"}],["path",{d:"m4.93 10.93 1.41 1.41",key:"2a7f42"}],["path",{d:"M2 18h2",key:"j10viu"}],["path",{d:"M20 18h2",key:"wocana"}],["path",{d:"m19.07 10.93-1.41 1.41",key:"15zs5n"}],["path",{d:"M22 22H2",key:"19qnx5"}],["path",{d:"m8 6 4-4 4 4",key:"ybng9g"}],["path",{d:"M16 18a4 4 0 0 0-8 0",key:"1lzouq"}]]),D=t("Tag",[["path",{d:"M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z",key:"vktsd0"}],["circle",{cx:"7.5",cy:"7.5",r:".5",fill:"currentColor",key:"kqv944"}]]);
/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */function z({streak:e,label:r,icon:t,compact:a=!1}){const s=()=>e&&0!==e.current_streak?e.current_streak>=30?"text-orange-500":e.current_streak>=7?"text-yellow-500":"text-blue-500":"text-gray-400",c=()=>e&&0!==e.current_streak?e.current_streak>=30?"bg-orange-50 dark:bg-orange-900/20":e.current_streak>=7?"bg-yellow-50 dark:bg-yellow-900/20":"bg-blue-50 dark:bg-blue-900/20":"bg-gray-50 dark:bg-gray-800",x=()=>e&&0!==e.current_streak?e.current_streak>=30?"border-orange-200 dark:border-orange-800":e.current_streak>=7?"border-yellow-200 dark:border-yellow-800":"border-blue-200 dark:border-blue-800":"border-gray-200 dark:border-gray-700",u=()=>{if(!e||!e.last_recorded_date)return!1;const r=new Date(e.last_recorded_date),t=new Date;t.setHours(0,0,0,0),r.setHours(0,0,0,0);return Math.floor((t.getTime()-r.getTime())/864e5)>=1};return a?l.jsxs("div",{className:`inline-flex items-center space-x-2 px-3 py-1.5 rounded-full border ${c()} ${x()} transition-colors`,children:[t||l.jsx(n,{className:`w-4 h-4 ${s()}`}),l.jsxs("span",{className:`text-sm font-semibold ${s()}`,children:[(null==e?void 0:e.current_streak)||0,"日"]}),u()&&l.jsx(i,{className:"w-3 h-3 text-red-500"})]}):l.jsxs("div",{className:`rounded-xl border ${c()} ${x()} p-4 sm:p-6 transition-all hover:shadow-md`,children:[l.jsxs("div",{className:"flex items-start justify-between mb-3",children:[l.jsxs("div",{children:[l.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400 mb-1",children:r}),l.jsxs("div",{className:"flex items-baseline space-x-2",children:[l.jsx("p",{className:`text-3xl font-bold ${s()}`,children:(null==e?void 0:e.current_streak)||0}),l.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:"日連続"})]})]}),l.jsx("div",{className:`p-3 rounded-lg ${c()}`,children:t||l.jsx(n,{className:`w-6 h-6 ${s()}`})})]}),u()&&l.jsxs("div",{className:"flex items-center space-x-2 mb-3 p-2 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg",children:[l.jsx(i,{className:"w-4 h-4 text-red-500 flex-shrink-0"}),l.jsx("p",{className:"text-xs text-red-600 dark:text-red-400",children:"今日記録しないとストリークが途切れます！"})]}),l.jsxs("div",{className:"grid grid-cols-2 gap-3 pt-3 border-t border-gray-200 dark:border-gray-700",children:[l.jsxs("div",{className:"flex items-center space-x-2",children:[l.jsx(d,{className:"w-4 h-4 text-gray-400"}),l.jsxs("div",{children:[l.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"最長記録"}),l.jsxs("p",{className:"text-sm font-semibold text-gray-900 dark:text-white",children:[(null==e?void 0:e.longest_streak)||0,"日"]})]})]}),l.jsxs("div",{className:"flex items-center space-x-2",children:[l.jsx(o,{className:"w-4 h-4 text-gray-400"}),l.jsxs("div",{children:[l.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"累計記録"}),l.jsxs("p",{className:"text-sm font-semibold text-gray-900 dark:text-white",children:[(null==e?void 0:e.total_records)||0,"回"]})]})]})]}),e&&e.current_streak>0&&l.jsxs("div",{className:"mt-3 pt-3 border-t border-gray-200 dark:border-gray-700",children:[l.jsxs("div",{className:"flex items-center justify-between text-xs",children:[l.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"次のマイルストーン"}),l.jsxs("span",{className:"font-semibold text-gray-900 dark:text-white",children:[e.current_streak<7?"7日":e.current_streak<30?"30日":"100日","連続"]})]}),l.jsx("div",{className:"mt-2 w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 overflow-hidden",children:l.jsx("div",{className:"h-full rounded-full transition-all duration-500 "+(e.current_streak>=30?"bg-orange-500":e.current_streak>=7?"bg-yellow-500":"bg-blue-500"),style:{width:(e.current_streak<7?e.current_streak/7*100:e.current_streak<30?(e.current_streak-7)/23*100:(e.current_streak-30)/70*100)+"%"}})})]})]})}function P({userPoints:e,levelProgress:r,compact:t=!1,showDetails:a=!0,actions:s}){var n,i;const d=()=>e?e.current_level>=50?"text-purple-600 dark:text-purple-400":e.current_level>=40?"text-red-600 dark:text-red-400":e.current_level>=30?"text-orange-600 dark:text-orange-400":e.current_level>=20?"text-yellow-600 dark:text-yellow-400":e.current_level>=10?"text-green-600 dark:text-green-400":"text-blue-600 dark:text-blue-400":"text-gray-500",g=()=>e?e.current_level>=50?"bg-purple-50 dark:bg-purple-900/20":e.current_level>=40?"bg-red-50 dark:bg-red-900/20":e.current_level>=30?"bg-orange-50 dark:bg-orange-900/20":e.current_level>=20?"bg-yellow-50 dark:bg-yellow-900/20":e.current_level>=10?"bg-green-50 dark:bg-green-900/20":"bg-blue-50 dark:bg-blue-900/20":"bg-gray-50 dark:bg-gray-800",m=()=>e?e.current_level>=50?"border-purple-200 dark:border-purple-800":e.current_level>=40?"border-red-200 dark:border-red-800":e.current_level>=30?"border-orange-200 dark:border-orange-800":e.current_level>=20?"border-yellow-200 dark:border-yellow-800":e.current_level>=10?"border-green-200 dark:border-green-800":"border-blue-200 dark:border-blue-800":"border-gray-200 dark:border-gray-700",h=()=>e?e.current_level>=50?l.jsx(u,{className:"w-6 h-6"}):e.current_level>=30?l.jsx(c,{className:"w-6 h-6"}):l.jsx(x,{className:"w-6 h-6"}):l.jsx(x,{className:"w-6 h-6"});return t?l.jsxs("div",{className:`inline-flex items-center space-x-3 px-4 py-2 rounded-xl border ${g()} ${m()} transition-colors`,children:[l.jsx("div",{className:d(),children:h()}),l.jsxs("div",{children:[l.jsxs("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:["Lv.",(null==e?void 0:e.current_level)||1]}),l.jsx("p",{className:`text-sm font-bold ${d()}`,children:(null==e?void 0:e.rank_title)||"ビギナー"})]})]}):l.jsxs("div",{className:`rounded-xl border ${g()} ${m()} p-4 sm:p-6 transition-all hover:shadow-lg`,children:[l.jsxs("div",{className:"flex items-start justify-between mb-4",children:[l.jsxs("div",{className:"flex-1",children:[l.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400 mb-1",children:"あなたのランク"}),l.jsx("div",{className:"flex items-baseline space-x-2 mb-1",children:l.jsx("h3",{className:`text-2xl font-bold ${d()}`,children:(null==e?void 0:e.rank_title)||"ビギナー"})}),l.jsxs("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:["レベル ",(null==e?void 0:e.current_level)||1]})]}),l.jsx("div",{className:`p-3 rounded-xl ${g()} ${d()}`,children:h()})]}),a&&l.jsxs(l.Fragment,{children:[l.jsxs("div",{className:"mb-4",children:[l.jsxs("div",{className:"flex items-center justify-between text-sm mb-2",children:[l.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"次のレベルまで"}),l.jsxs("span",{className:"font-semibold text-gray-900 dark:text-white",children:[(null==e?void 0:e.points_to_next_level)||100," pt"]})]}),l.jsx("div",{className:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden",children:l.jsx("div",{className:"h-full rounded-full transition-all duration-500 "+(e?e.current_level>=50?"bg-gradient-to-r from-purple-500 to-pink-500":e.current_level>=40?"bg-gradient-to-r from-red-500 to-orange-500":e.current_level>=30?"bg-gradient-to-r from-orange-500 to-yellow-500":e.current_level>=20?"bg-gradient-to-r from-yellow-500 to-green-500":e.current_level>=10?"bg-gradient-to-r from-green-500 to-blue-500":"bg-gradient-to-r from-blue-500 to-cyan-500":"bg-gray-400"),style:{width:`${r}%`}})}),l.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1 text-right",children:[Math.round(r),"%"]})]}),l.jsxs("div",{className:["pt-4 border-t border-gray-200 dark:border-gray-700","grid gap-3",s?"grid-cols-1 sm:grid-cols-3":"grid-cols-2"].join(" "),children:[l.jsxs("div",{className:"flex items-center space-x-2",children:[l.jsx("div",{className:"p-2 bg-white dark:bg-gray-700 rounded-lg",children:l.jsx(c,{className:"w-4 h-4 text-yellow-500"})}),l.jsxs("div",{children:[l.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"総ポイント"}),l.jsx("p",{className:"text-sm font-semibold text-gray-900 dark:text-white",children:(null==(i=null==(n=null==e?void 0:e.total_points)?void 0:n.toLocaleString)?void 0:i.call(n))??0})]})]}),l.jsxs("div",{className:"flex items-center space-x-2",children:[l.jsx("div",{className:"p-2 bg-white dark:bg-gray-700 rounded-lg",children:l.jsx(o,{className:"w-4 h-4 text-green-500"})}),l.jsxs("div",{children:[l.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"現在のレベル"}),l.jsxs("p",{className:"text-sm font-semibold text-gray-900 dark:text-white",children:["Lv.",(null==e?void 0:e.current_level)||1]})]})]}),s?l.jsx("div",{className:"flex items-center sm:justify-end",children:s}):null]})]})]})}const A={Sparkles:u,Award:d,Flame:n,Star:x,Trophy:c,Shield:y,Database:R,Heart:b,Sunrise:L,Zap:h};function F({userBadges:e,allBadges:r,onClose:t,onBadgeClick:a}){const[s,n]=$.useState("all"),i=new Set(e.map(e=>e.badge_id)),d=r.filter(e=>!e.is_hidden&&("all"===s||e.category===s)),o=e=>{switch(e){case"legendary":return"from-purple-500 to-pink-500";case"epic":return"from-orange-500 to-red-500";case"rare":return"from-blue-500 to-cyan-500";default:return"from-gray-400 to-gray-500"}},u=e=>{switch(e){case"legendary":return"border-purple-300 dark:border-purple-700";case"epic":return"border-orange-300 dark:border-orange-700";case"rare":return"border-blue-300 dark:border-blue-700";default:return"border-gray-300 dark:border-gray-600"}},h=d.filter(e=>i.has(e.id)).length,b=d.length,y=b>0?h/b*100:0;return l.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 backdrop-blur-sm",children:l.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col transition-colors",children:[l.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700",children:[l.jsxs("div",{children:[l.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"バッジコレクション"}),l.jsxs("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-1",children:["獲得: ",h," / ",b," (",Math.round(y),"%)"]})]}),t&&l.jsx("button",{onClick:t,className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors",children:l.jsx(g,{className:"w-6 h-6 text-gray-600 dark:text-gray-400"})})]}),l.jsx("div",{className:"px-6 pt-4",children:l.jsx("div",{className:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 overflow-hidden",children:l.jsx("div",{className:"h-full bg-gradient-to-r from-blue-500 to-purple-500 rounded-full transition-all duration-500",style:{width:`${y}%`}})})}),l.jsx("div",{className:"px-6 py-4 overflow-x-auto",children:l.jsx("div",{className:"flex space-x-2",children:[{id:"all",label:"すべて"},{id:"streak",label:"ストリーク"},{id:"performance",label:"パフォーマンス"},{id:"consistency",label:"継続"},{id:"milestone",label:"マイルストーン"},{id:"special",label:"スペシャル"},{id:"team",label:"チーム"}].map(e=>l.jsx("button",{onClick:()=>n(e.id),className:"px-4 py-2 rounded-lg text-sm font-medium transition-colors whitespace-nowrap "+(s===e.id?"bg-blue-600 text-white":"bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"),children:e.label},e.id))})}),l.jsxs("div",{className:"flex-1 overflow-y-auto px-6 pb-6",children:[l.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4",children:d.map(r=>{const t=i.has(r.id),s=e.find(e=>e.badge_id===r.id),n=(d=r.icon,A[d]||x);var d;return l.jsxs("div",{onClick:()=>a&&a(s||r),className:"relative p-4 rounded-xl border-2 transition-all cursor-pointer "+(t?`${u(r.rarity)} bg-white dark:bg-gray-700 hover:shadow-lg transform hover:scale-105`:"border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 opacity-60 hover:opacity-80"),children:[t&&"common"!==r.rarity&&l.jsx("div",{className:"absolute top-2 right-2",children:l.jsx("div",{className:`w-2 h-2 rounded-full bg-gradient-to-r ${o(r.rarity)}`})}),(null==s?void 0:s.is_new)&&l.jsx("div",{className:"absolute -top-2 -right-2",children:l.jsx("div",{className:"bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full animate-pulse",children:"NEW"})}),l.jsx("div",{className:"flex justify-center mb-3",children:l.jsx("div",{className:"p-4 rounded-full "+(t?`bg-gradient-to-br ${o(r.rarity)} text-white`:"bg-gray-200 dark:bg-gray-700 text-gray-400"),children:t?l.jsx(n,{className:"w-8 h-8"}):l.jsx(m,{className:"w-8 h-8"})})}),l.jsxs("div",{className:"text-center",children:[l.jsx("h3",{className:"text-sm font-bold mb-1 "+(t?"text-gray-900 dark:text-white":"text-gray-500 dark:text-gray-400"),children:r.name}),l.jsx("p",{className:"text-xs "+(t?"text-gray-600 dark:text-gray-400":"text-gray-400 dark:text-gray-500"),children:r.description}),t&&l.jsxs("div",{className:"mt-2 flex items-center justify-center space-x-1 text-xs text-gray-500 dark:text-gray-400",children:[l.jsx(c,{className:"w-3 h-3"}),l.jsxs("span",{children:["+",r.points_reward,"pt"]})]})]})]},r.id)})}),0===d.length&&l.jsxs("div",{className:"text-center py-12",children:[l.jsx(m,{className:"w-12 h-12 text-gray-300 dark:text-gray-600 mx-auto mb-3"}),l.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"このカテゴリーにはバッジがありません"})]})]})]})})}function q(e,r=0){const t="number"==typeof e?e:Number(e);return Number.isFinite(t)?t:r}function G(e,r="—"){const t="string"==typeof e?e:null==e?"":String(e);return t.trim()?t:r}function H({weeklyRankings:e,pointsRankings:r,myUserId:t,compact:a=!1}){const[s,n]=$.useState("weekly"),i=$.useMemo(()=>Array.isArray(e)?e:[],[e]),x=$.useMemo(()=>Array.isArray(r)?r:[],[r]),u=e=>1===e?{icon:c,color:"text-yellow-500",bg:"bg-yellow-50 dark:bg-yellow-900/20"}:2===e?{icon:T,color:"text-gray-400",bg:"bg-gray-50 dark:bg-gray-800"}:3===e?{icon:d,color:"text-orange-600 dark:text-orange-400",bg:"bg-orange-50 dark:bg-orange-900/20"}:null,g=a?5:10,m=()=>{const e=i.find(e=>(null==e?void 0:e.user_id)===t);return l.jsxs("div",{className:"space-y-2",children:[i.slice(0,g).map(e=>{const r=q(null==e?void 0:e.rank,0),a=u(r),s=G(null==e?void 0:e.user_id,`row-${r}`),n=(null==e?void 0:e.user_id)===t,i=q(null==e?void 0:e.weekly_records,0),d=G(null==e?void 0:e.user_name,"ユーザー");return l.jsx("div",{className:"flex items-center justify-between p-3 rounded-lg transition-all "+(n?"bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-300 dark:border-blue-700":"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:shadow-md"),children:l.jsxs("div",{className:"flex items-center space-x-3 flex-1",children:[l.jsx("div",{className:"flex items-center justify-center w-8 h-8 rounded-full font-bold "+(a?`${a.bg} ${a.color}`:"bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400"),children:a?l.jsx(a.icon,{className:"w-5 h-5"}):l.jsx("span",{className:"text-sm",children:r||"—"})}),l.jsx("div",{className:"flex-1",children:l.jsxs("p",{className:"font-semibold "+(n?"text-blue-700 dark:text-blue-400":"text-gray-900 dark:text-white"),children:[d,n&&l.jsx("span",{className:"ml-2 text-xs text-blue-600 dark:text-blue-400",children:"(あなた)"})]})}),l.jsxs("div",{className:"text-right",children:[l.jsxs("p",{className:"text-sm font-semibold text-gray-900 dark:text-white",children:[i,"回"]}),l.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"今週"})]})]})},s)}),e&&q(null==e?void 0:e.rank,0)>g&&l.jsxs(l.Fragment,{children:[l.jsx("div",{className:"flex items-center justify-center py-2",children:l.jsx("div",{className:"w-12 h-0.5 bg-gray-300 dark:bg-gray-600"})}),l.jsx("div",{className:"flex items-center justify-between p-3 rounded-lg bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-300 dark:border-blue-700",children:l.jsxs("div",{className:"flex items-center space-x-3 flex-1",children:[l.jsx("div",{className:"flex items-center justify-center w-8 h-8 rounded-full font-bold bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400",children:l.jsx("span",{className:"text-sm",children:q(null==e?void 0:e.rank,0)||"—"})}),l.jsx("div",{className:"flex-1",children:l.jsxs("p",{className:"font-semibold text-blue-700 dark:text-blue-400",children:[G(null==e?void 0:e.user_name,"あなた"),l.jsx("span",{className:"ml-2 text-xs",children:"(あなた)"})]})}),l.jsxs("div",{className:"text-right",children:[l.jsxs("p",{className:"text-sm font-semibold text-gray-900 dark:text-white",children:[q(null==e?void 0:e.weekly_records,0),"回"]}),l.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"今週"})]})]})})]})]})},h=()=>{const e=x.find(e=>(null==e?void 0:e.user_id)===t);return l.jsxs("div",{className:"space-y-2",children:[x.slice(0,g).map(e=>{const r=q(null==e?void 0:e.rank,0),a=u(r),s=G(null==e?void 0:e.user_id,`row-${r}`),n=(null==e?void 0:e.user_id)===t,i=q(null==e?void 0:e.total_points,0),d=q(null==e?void 0:e.current_level,0),o=G(null==e?void 0:e.user_name,"ユーザー");return l.jsx("div",{className:"flex items-center justify-between p-3 rounded-lg transition-all "+(n?"bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-300 dark:border-blue-700":"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:shadow-md"),children:l.jsxs("div",{className:"flex items-center space-x-3 flex-1",children:[l.jsx("div",{className:"flex items-center justify-center w-8 h-8 rounded-full font-bold "+(a?`${a.bg} ${a.color}`:"bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400"),children:a?l.jsx(a.icon,{className:"w-5 h-5"}):l.jsx("span",{className:"text-sm",children:r||"—"})}),l.jsxs("div",{className:"flex-1",children:[l.jsxs("p",{className:"font-semibold "+(n?"text-blue-700 dark:text-blue-400":"text-gray-900 dark:text-white"),children:[o,n&&l.jsx("span",{className:"ml-2 text-xs text-blue-600 dark:text-blue-400",children:"(あなた)"})]}),l.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:["Lv.",d]})]}),l.jsx("div",{className:"text-right",children:l.jsxs("p",{className:"text-sm font-semibold text-gray-900 dark:text-white",children:[i.toLocaleString(),"pt"]})})]})},s)}),e&&q(null==e?void 0:e.rank,0)>g&&l.jsxs(l.Fragment,{children:[l.jsx("div",{className:"flex items-center justify-center py-2",children:l.jsx("div",{className:"w-12 h-0.5 bg-gray-300 dark:bg-gray-600"})}),l.jsx("div",{className:"flex items-center justify-between p-3 rounded-lg bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-300 dark:border-blue-700",children:l.jsxs("div",{className:"flex items-center space-x-3 flex-1",children:[l.jsx("div",{className:"flex items-center justify-center w-8 h-8 rounded-full font-bold bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400",children:l.jsx("span",{className:"text-sm",children:q(null==e?void 0:e.rank,0)||"—"})}),l.jsxs("div",{className:"flex-1",children:[l.jsxs("p",{className:"font-semibold text-blue-700 dark:text-blue-400",children:[G(null==e?void 0:e.user_name,"あなた"),l.jsx("span",{className:"ml-2 text-xs",children:"(あなた)"})]}),l.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:["Lv.",q(null==e?void 0:e.current_level,0)]})]}),l.jsx("div",{className:"text-right",children:l.jsxs("p",{className:"text-sm font-semibold text-gray-900 dark:text-white",children:[q(null==e?void 0:e.total_points,0).toLocaleString(),"pt"]})})]})})]})]})},b="weekly"===s?i:x;return a?l.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 transition-colors",children:[l.jsxs("div",{className:"flex items-center space-x-2 mb-4",children:[l.jsx(f,{className:"w-5 h-5 text-blue-600 dark:text-blue-400"}),l.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"チームランキング"})]}),"weekly"===s?m():h(),0===b.length&&l.jsxs("div",{className:"text-center py-10",children:[l.jsx(f,{className:"w-10 h-10 text-gray-300 dark:text-gray-600 mx-auto mb-3"}),l.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"ランキングデータがありません"})]})]}):l.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden transition-colors",children:[l.jsxs("div",{className:"p-6 border-b border-gray-200 dark:border-gray-700",children:[l.jsxs("div",{className:"flex items-center space-x-2 mb-4",children:[l.jsx(f,{className:"w-6 h-6 text-blue-600 dark:text-blue-400"}),l.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"チームランキング"})]}),l.jsxs("div",{className:"flex space-x-2 bg-gray-100 dark:bg-gray-700 p-1 rounded-lg",children:[l.jsxs("button",{onClick:()=>n("weekly"),className:"flex-1 flex items-center justify-center space-x-2 px-4 py-2 rounded-md text-sm font-medium transition-colors "+("weekly"===s?"bg-white dark:bg-gray-600 text-blue-600 dark:text-blue-400 shadow-sm":"text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white"),children:[l.jsx(o,{className:"w-4 h-4"}),l.jsx("span",{children:"週間記録数"})]}),l.jsxs("button",{onClick:()=>n("points"),className:"flex-1 flex items-center justify-center space-x-2 px-4 py-2 rounded-md text-sm font-medium transition-colors "+("points"===s?"bg-white dark:bg-gray-600 text-blue-600 dark:text-blue-400 shadow-sm":"text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white"),children:[l.jsx(c,{className:"w-4 h-4"}),l.jsx("span",{children:"総ポイント"})]})]})]}),l.jsxs("div",{className:"p-6",children:["weekly"===s?m():h(),0===b.length&&l.jsxs("div",{className:"text-center py-12",children:[l.jsx(f,{className:"w-12 h-12 text-gray-300 dark:text-gray-600 mx-auto mb-3"}),l.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"ランキングデータがありません"})]})]})]})}function I({newLevel:e,rankTitle:r,onClose:t}){const[a,s]=$.useState(!1),n=$.useMemo(()=>{const e=p,r=(null==e?void 0:e.default)??e;return"function"==typeof r?r:null},[]);$.useEffect(()=>{if(s(!0),n)try{const e=4e3,r=Date.now()+e;!function e(){n({particleCount:2,angle:60,spread:55,origin:{x:0},colors:["#FFD700","#FFA500","#FF6347"]}),n({particleCount:2,angle:120,spread:55,origin:{x:1},colors:["#FFD700","#FFA500","#FF6347"]}),Date.now()<r&&requestAnimationFrame(e)}()}catch(e){console.warn("[LevelUpModal] confetti threw error (skipping).",e)}else console.warn("[LevelUpModal] canvas-confetti function not available (skipping confetti).")},[n]);const i=()=>e>=50?"from-purple-600 via-pink-600 to-purple-600":e>=40?"from-red-600 via-orange-600 to-red-600":e>=30?"from-orange-600 via-yellow-600 to-orange-600":e>=20?"from-yellow-600 via-green-600 to-yellow-600":e>=10?"from-green-600 via-blue-600 to-green-600":"from-blue-600 via-cyan-600 to-blue-600",d=$.useMemo(()=>Array.from({length:8}).map((e,r)=>({key:r,top:100*Math.random()+"%",left:100*Math.random()+"%",delay:.3*r+"s",duration:"2s"})),[]);return l.jsx("div",{className:"fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black bg-opacity-70 backdrop-blur-sm",children:l.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full overflow-hidden transition-all duration-500 transform "+(a?"scale-100 opacity-100":"scale-90 opacity-0"),children:[l.jsxs("div",{className:`relative p-8 bg-gradient-to-r ${i()} text-white overflow-hidden`,children:[l.jsx("div",{className:"absolute inset-0 bg-black opacity-10"}),l.jsx("div",{className:"absolute inset-0 overflow-hidden",children:d.map(e=>l.jsx("div",{className:"absolute animate-pulse",style:{top:e.top,left:e.left,animationDelay:e.delay,animationDuration:e.duration},children:l.jsx(x,{className:"w-4 h-4 text-white opacity-30"})},e.key))}),l.jsxs("div",{className:"relative z-10",children:[l.jsx("button",{onClick:t,className:"absolute top-0 right-0 p-2 hover:bg-white hover:bg-opacity-20 rounded-lg transition-colors","aria-label":"閉じる",children:l.jsx(g,{className:"w-5 h-5"})}),l.jsxs("div",{className:"text-center",children:[l.jsx("div",{className:"inline-flex items-center justify-center mb-4",children:l.jsxs("div",{className:"relative",children:[l.jsx("div",{className:"absolute inset-0 bg-white opacity-20 rounded-full animate-ping",style:{animationDuration:"1.5s"}}),l.jsx("div",{className:"absolute inset-0 bg-white opacity-20 rounded-full animate-ping",style:{animationDelay:"0.5s",animationDuration:"1.5s"}}),l.jsx("div",{className:"relative bg-white bg-opacity-20 backdrop-blur-sm p-6 rounded-full",children:l.jsx(c,{className:"w-16 h-16 animate-bounce",style:{animationDuration:"1s"}})})]})}),l.jsx("h2",{className:"text-4xl font-bold mb-2 animate-pulse",children:"LEVEL UP!"}),l.jsx("p",{className:"text-white text-opacity-90 text-lg",children:"レベルアップしました！"})]})]})]}),l.jsxs("div",{className:"p-6",children:[l.jsxs("div",{className:"text-center mb-6",children:[l.jsxs("div",{className:"flex items-center justify-center space-x-4 mb-4",children:[l.jsx("div",{className:"flex items-center space-x-2",children:l.jsxs("span",{className:"text-4xl font-bold text-gray-400 dark:text-gray-500",children:["Lv.",Math.max(0,e-1)]})}),l.jsx(o,{className:"w-6 h-6 text-gray-400"}),l.jsxs("div",{className:"flex items-center space-x-2",children:[l.jsxs("span",{className:`text-4xl font-bold bg-gradient-to-r ${i()} bg-clip-text text-transparent`,children:["Lv.",e]}),l.jsx(u,{className:"w-6 h-6 text-yellow-500 animate-pulse"})]})]}),l.jsx("div",{className:"mb-4",children:l.jsx("div",{className:"inline-block",children:l.jsx("span",{className:`px-4 py-2 rounded-full text-lg font-bold bg-gradient-to-r ${i()} text-white shadow-lg`,children:r})})}),l.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:"おめでとうございます！新しいランクに到達しました"}),l.jsxs("div",{className:"bg-gradient-to-br from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-xl p-4 border border-blue-200 dark:border-blue-800",children:[l.jsxs("p",{className:"text-sm font-semibold text-gray-900 dark:text-white mb-2",children:["レベル",e,"特典"]}),l.jsxs("div",{className:"space-y-1 text-sm text-gray-600 dark:text-gray-400",children:[l.jsx("p",{children:"• より多くのポイント獲得ボーナス"}),l.jsx("p",{children:"• 新しいバッジ獲得チャンス"}),l.jsx("p",{children:"• チーム内でのステータス向上"})]})]})]}),l.jsx("button",{onClick:t,className:`w-full py-3 rounded-xl font-semibold text-white bg-gradient-to-r ${i()} hover:shadow-lg transform hover:scale-105 transition-all`,children:"さらに成長する！"})]})]})})}class U extends E.Component{constructor(){super(...arguments),r(this,"state",{hasError:!1}),r(this,"retry",()=>this.setState({hasError:!1,error:void 0}))}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,r){console.error("[ErrorBoundary] caught",e,r)}render(){if(!this.state.hasError)return this.props.children;const e=this.props.title??"この表示でエラーが起きました",r=this.props.description??"このセクションだけ復旧できます。もう一度表示を試してください。";return this.props.compact?l.jsxs("div",{className:"rounded-xl border bg-white p-4 dark:bg-gray-800",children:[l.jsx("div",{className:"font-semibold text-gray-900 dark:text-white",children:e}),l.jsx("div",{className:"mt-1 text-sm text-gray-600 dark:text-gray-300",children:r}),l.jsx("div",{className:"mt-3 flex gap-2",children:l.jsx("button",{onClick:this.retry,className:"rounded-lg bg-black px-3 py-2 text-sm font-medium text-white",children:"再表示"})}),!1]}):l.jsxs("div",{className:"rounded-2xl border bg-white p-5 shadow-sm dark:bg-gray-800",children:[l.jsx("div",{className:"text-lg font-bold text-gray-900 dark:text-white",children:e}),l.jsx("div",{className:"mt-1 text-sm text-gray-600 dark:text-gray-300",children:r}),l.jsxs("div",{className:"mt-4 flex flex-wrap gap-2",children:[l.jsx("button",{onClick:this.retry,className:"rounded-lg bg-black px-3 py-2 text-sm font-medium text-white",children:"もう一度表示する"}),l.jsx("button",{onClick:()=>window.location.reload(),className:"rounded-lg border px-3 py-2 text-sm font-medium dark:border-gray-700",children:"ページを再読み込み"})]}),!1]})}}function B(e){try{const r=new Date(e),t=new Intl.DateTimeFormat("ja-JP",{timeZone:"Asia/Tokyo",year:"numeric",month:"2-digit",day:"2-digit"}).format(r);return{date:t,time:new Intl.DateTimeFormat("ja-JP",{timeZone:"Asia/Tokyo",hour:"2-digit",minute:"2-digit",hour12:!1}).format(r)}}catch{return{date:"----/--/--",time:"--:--"}}}function V({open:e,onClose:r,transactions:t,loading:a,onReload:s}){$.useEffect(()=>{if(!e)return;const t=e=>{"Escape"===e.key&&r()};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[e,r]);const n=$.useMemo(()=>{const e=new Map;for(const r of t??[]){const{date:t}=B(r.created_at),a=e.get(t)??[];a.push(r),e.set(t,a)}return Array.from(e.keys()).sort((e,r)=>e<r?1:-1).map(r=>({date:r,items:(e.get(r)??[]).sort((e,r)=>e.created_at<r.created_at?1:-1)}))},[t]);if(!e)return null;const i=((null==t?void 0:t.length)??0)>0;return l.jsxs("div",{className:"fixed inset-0 z-[100]",children:[l.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:r}),l.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:l.jsxs("div",{className:"w-full max-w-2xl bg-white dark:bg-gray-900 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 overflow-hidden",children:[l.jsxs("div",{className:"flex items-center justify-between px-5 py-4 border-b border-gray-200 dark:border-gray-700",children:[l.jsxs("div",{children:[l.jsx("h3",{className:"text-lg font-bold text-gray-900 dark:text-white",children:"ポイント履歴"}),l.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:"獲得・減少したポイントの記録です（JST表示）"})]}),l.jsxs("div",{className:"flex items-center gap-2",children:[s&&l.jsxs("button",{onClick:s,disabled:a,className:"inline-flex items-center gap-2 px-3 py-2 rounded-lg text-sm\n                             bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700\n                             hover:bg-gray-50 dark:hover:bg-gray-700\n                             text-gray-900 dark:text-white transition-colors\n                             disabled:opacity-60 disabled:cursor-not-allowed",title:"更新",children:[l.jsx(k,{className:"w-4 h-4 "+(a?"animate-spin":"")}),"更新"]}),l.jsx("button",{onClick:r,className:"p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300",title:"閉じる",children:l.jsx(g,{className:"w-5 h-5"})})]})]}),l.jsx("div",{className:"max-h-[70vh] overflow-y-auto px-5 py-4",children:a&&!i?l.jsx("div",{className:"h-48 flex items-center justify-center",children:l.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"})}):i?l.jsx("div",{className:"space-y-5",children:n.map(e=>l.jsxs("div",{children:[l.jsx("div",{className:"text-xs font-semibold text-gray-600 dark:text-gray-300 mb-2",children:e.date}),l.jsx("div",{className:"space-y-2",children:e.items.map(e=>{var r;const{time:t}=B(e.created_at),a=Number(e.points??0),s=a>0?"+":"",n=(e.reason??"").trim()||"ポイント付与",i=function(e){const r=(e??"").toLowerCase();return r?r.includes("streak")?"ストリーク":r.includes("badge")?"バッジ":r.includes("login")?"ログイン":r.includes("manual")?"手動":r.includes("admin")?"管理者":r.includes("training")?"トレーニング":r.includes("weight")?"体重":r.includes("sleep")?"睡眠":r.includes("motivation")?"モチベ":e??"その他":"その他"}(e.category),d=function(e){const r=(e??"").toLowerCase();return r.includes("badge")?"bg-yellow-50 text-yellow-700 dark:bg-yellow-900/20 dark:text-yellow-300":r.includes("streak")?"bg-orange-50 text-orange-700 dark:bg-orange-900/20 dark:text-orange-300":r.includes("training")?"bg-blue-50 text-blue-700 dark:bg-blue-900/20 dark:text-blue-300":r.includes("sleep")?"bg-indigo-50 text-indigo-700 dark:bg-indigo-900/20 dark:text-indigo-300":r.includes("weight")?"bg-emerald-50 text-emerald-700 dark:bg-emerald-900/20 dark:text-emerald-300":"bg-gray-50 text-gray-700 dark:bg-gray-800 dark:text-gray-300"}(e.category);return l.jsx("div",{className:"rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-3",children:l.jsxs("div",{className:"flex items-start justify-between gap-3",children:[l.jsxs("div",{className:"min-w-0",children:[l.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400",children:[l.jsxs("span",{className:"inline-flex items-center gap-1",children:[l.jsx(v,{className:"w-3.5 h-3.5"}),t]}),l.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-0.5 rounded-full ${d}`,children:[l.jsx(D,{className:"w-3.5 h-3.5"}),i]})]}),l.jsx("div",{className:"mt-1 text-sm font-semibold text-gray-900 dark:text-white truncate",children:n}),(null==(r=e.metadata)?void 0:r.source)&&l.jsxs("div",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:["source: ",String(e.metadata.source)]})]}),l.jsxs("div",{className:"shrink-0 text-sm font-bold "+(a>=0?"text-blue-700 dark:text-blue-300":"text-red-600 dark:text-red-300"),children:[s,a.toLocaleString()," pt"]})]})},e.id)})})]},e.date))}):l.jsxs("div",{className:"h-48 flex flex-col items-center justify-center text-center",children:[l.jsx("p",{className:"text-sm font-semibold text-gray-900 dark:text-white",children:"まだ履歴がありません"}),l.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-2",children:"記録やバッジ獲得でポイントが付与されると、ここに表示されます。"}),s&&l.jsxs("button",{onClick:s,className:"mt-4 inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm\n                               bg-blue-600 hover:bg-blue-700 text-white transition-colors",children:[l.jsx(k,{className:"w-4 h-4"}),"再読み込み"]})]})}),l.jsx("div",{className:"px-5 py-3 border-t border-gray-200 dark:border-gray-700 flex justify-end",children:l.jsx("button",{onClick:r,className:"px-4 py-2 rounded-lg text-sm\n                         bg-gray-100 dark:bg-gray-800\n                         hover:bg-gray-200 dark:hover:bg-gray-700\n                         text-gray-900 dark:text-white transition-colors",children:"閉じる"})})]})})]})}function J(e){return"global"===e?"全体":"organization"===e?"組織内":"チーム内"}function O(e){return"global"===e?l.jsx(j,{className:"w-5 h-5"}):"organization"===e?l.jsx(w,{className:"w-5 h-5"}):l.jsx(f,{className:"w-5 h-5"})}function W({scope:e,data:r,loading:t,error:a}){const s=$.useMemo(()=>{if(!r)return null;const t=r.total_users??0,a=r.my_rank,s=r.top_percent;return t&&null!=a&&null!=s?`${t.toLocaleString()}人中 ${a.toLocaleString()}位（上位 ${s}%）`:`${J(e)}の順位データがありません`},[r,e]),n=$.useMemo(()=>((null==r?void 0:r.distribution)??[]).slice().reverse(),[null==r?void 0:r.distribution]),i=$.useMemo(()=>{const e=Math.max(0,...n.map(e=>Number(e.count??0)));return e>0?e:1},[n]);return l.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4",children:[l.jsx("div",{className:"flex items-center justify-between",children:l.jsxs("div",{className:"flex items-center space-x-2 text-gray-900 dark:text-white",children:[l.jsx("div",{className:"p-2 rounded-lg bg-gray-50 dark:bg-gray-700",children:O(e)}),l.jsxs("div",{children:[l.jsxs("div",{className:"text-xs text-gray-600 dark:text-gray-400",children:[J(e),"ランキング"]}),l.jsx("div",{className:"text-base font-semibold",children:t?"読み込み中…":s??"—"})]})]})}),a&&l.jsxs("div",{className:"mt-2 text-xs text-red-600 dark:text-red-400",children:["error: ",a]}),n.length?l.jsxs("div",{className:"mt-3",children:[l.jsx("div",{className:"text-xs text-gray-600 dark:text-gray-400 mb-2",children:"人数分布"}),l.jsx("div",{className:"space-y-2",children:n.map(e=>{const r=Number(e.count??0),t=Math.round(r/i*100);return l.jsxs("div",{className:"space-y-1",children:[l.jsxs("div",{className:"flex items-center justify-between text-xs",children:[l.jsx("span",{className:"text-gray-800 dark:text-gray-200",children:e.rank_title}),l.jsxs("span",{className:"text-gray-600 dark:text-gray-400",children:[r.toLocaleString(),"人"]})]}),l.jsx("div",{className:"w-full h-2 rounded-full bg-gray-200 dark:bg-gray-700 overflow-hidden",children:l.jsx("div",{className:"h-full rounded-full bg-blue-600",style:{width:`${t}%`},"aria-label":`${e.rank_title} ${r}人`})})]},e.rank_title)})})]}):l.jsx("div",{className:"mt-3 text-xs text-gray-500 dark:text-gray-400",children:"分布データはまだありません"})]})}function Z({userId:e,userTeamId:r}){const{state:t}=a();$.useEffect(()=>{console.log("[RealtimeHub state]",t)},[t]),$.useEffect(()=>{console.log("[Gamification] props",{userId:e,userTeamId:r})},[e,r]);const{loading:i,getStreakByType:o,getTotalStreak:x}=function(e,r={}){var t,l;const n=r.enabled??!0,i=r.pollMs??0,d=r.pauseWhenHidden??!0,[o,c]=$.useState([]),[x,u]=$.useState(!0),[g,m]=$.useState(null),{state:h,registerPollJob:b}=a(),y=$.useRef(!0);$.useEffect(()=>()=>{y.current=!1},[]);const f=$.useRef((null==(l=null==(t=globalThis.crypto)?void 0:t.randomUUID)?void 0:l.call(t))??Math.random().toString(36).slice(2)),p=$.useRef(null),k=$.useRef(null),v=$.useRef(!1),j=$.useCallback(()=>{var e;const r=p.current;if(r){try{null==(e=r.unsubscribe)||e.call(r)}catch(t){}try{s.removeChannel(r)}catch(t){}p.current=null}},[]),w=$.useCallback(()=>{k.current&&(k.current(),k.current=null)},[]),N=$.useCallback(async r=>{if(!e||!n)return;if(v.current)return;v.current=!0;const t=(null==r?void 0:r.silent)??!1;try{!t&&y.current&&u(!0);const{data:r,error:a}=await s.from("user_streaks").select("*").eq("user_id",e).order("streak_type");if(a)throw a;if(!y.current)return;c(r??[]),m(null)}catch(a){if(!y.current)return;m((null==a?void 0:a.message)??"ストリークの取得に失敗しました")}finally{v.current=!1,!t&&y.current&&u(!1)}},[e,n]);$.useEffect(()=>{j(),w(),e&&n?N({silent:!1}):u(!1)},[e,n,N,j,w]),$.useEffect(()=>{j()},[e,n,h.canRealtime,N,j]),$.useEffect(()=>{if(w(),!(e&&n&&i>0))return;const r=`streaks:${e}:${f.current}`,t=b({key:r,intervalMs:i,run:async()=>{await N({silent:!0})},enabled:!0,requireVisible:d,requireOnline:!0,immediate:!1});return k.current=t,()=>w()},[e,n,i,d,h.canRealtime,b,N,w]);const _=$.useCallback(e=>o.find(r=>r.streak_type===e)||null,[o]),S=$.useCallback(()=>o.find(e=>"all"===e.streak_type)||null,[o]),C=$.useCallback(async(r,t)=>{if(!e)return;const{error:a}=await s.rpc("update_user_streak",{p_user_id:e,p_streak_type:r,p_record_date:t});if(a)throw a;await N({silent:!0})},[e,N]),M=$.useCallback(e=>{if(!(null==e?void 0:e.last_recorded_date))return!1;const r=new Date(e.last_recorded_date),t=new Date;return t.setHours(0,0,0,0),r.setHours(0,0,0,0),Math.floor((t.getTime()-r.getTime())/864e5)>=1},[]),E=$.useCallback(e=>{if(!(null==e?void 0:e.last_recorded_date))return"broken";const r=new Date(e.last_recorded_date),t=new Date;t.setHours(0,0,0,0),r.setHours(0,0,0,0);const a=Math.floor((t.getTime()-r.getTime())/864e5);return 0===a?"safe":1===a?"at_risk":"broken"},[]);return{streaks:o,loading:x,error:g,getStreakByType:_,getTotalStreak:S,updateStreak:C,isStreakAtRisk:M,getStreakStatus:E,refresh:async()=>{await N({silent:!1})}}}(e),{scope:u,setScope:g,availableScopes:m,data:h,loading:b,error:y}=function(e,r,t={}){var l,n;const i=t.enabled??!0,d=t.pollMs??12e4,o=t.pauseWhenHidden??!0,c=t.defaultScope??"global",[x,u]=$.useState(c),[g,m]=$.useState(null),[h,b]=$.useState({global:null,organization:null,team:null}),[y,f]=$.useState(!1),[p,k]=$.useState(null),{registerPollJob:v}=a(),j=$.useRef(!0);$.useEffect(()=>(j.current=!0,()=>{j.current=!1}),[]);const w=$.useRef((null==(n=null==(l=globalThis.crypto)?void 0:l.randomUUID)?void 0:n.call(l))??Math.random().toString(36).slice(2)),N=$.useRef(null),_=$.useRef(!1),S=$.useCallback(()=>{N.current&&(N.current(),N.current=null)},[]),C=$.useCallback(async()=>{if(i&&e)try{const{data:t,error:a}=await s.from("users").select("id, team_id, organization_id").eq("id",e).maybeSingle();if(a)throw a;const l=r??(null==t?void 0:t.team_id)??null;if(!j.current)return;m({id:e,team_id:l,organization_id:(null==t?void 0:t.organization_id)??null})}catch(t){if(console.error("[useRankStats] loadUserMini error:",t),!j.current)return;m({id:e,team_id:r??null,organization_id:null})}},[i,e,r]);$.useEffect(()=>{C()},[C]);const M=!!(null==g?void 0:g.organization_id),E=!!(null==g?void 0:g.team_id),R=$.useMemo(()=>{const e=["global"];return M&&e.push("organization"),E&&e.push("team"),e},[M,E]);$.useEffect(()=>{i&&("organization"!==x||M||u("global"),"team"!==x||E||u("global"))},[i,x,M,E]);const T=$.useCallback(async(e,r)=>{if(!i)return;if("organization"===e&&!(null==g?void 0:g.organization_id))return;if("team"===e&&!(null==g?void 0:g.team_id))return;if(_.current)return;_.current=!0;const t=(null==r?void 0:r.silent)??!1;try{!t&&j.current&&f(!0);const r={p_scope:e};"organization"===e&&(r.p_org_id=g.organization_id),"team"===e&&(r.p_team_id=g.team_id);const{data:a,error:l}=await s.rpc("get_rank_stats",r);if(l)throw l;const n=a??null;if(!j.current)return;b(r=>({...r,[e]:n})),k(null)}catch(a){if(console.error("[useRankStats] fetch error:",a),!j.current)return;k((null==a?void 0:a.message)??"順位情報の取得に失敗しました")}finally{_.current=!1,!t&&j.current&&f(!1)}},[i,g]);$.useEffect(()=>{S(),i&&g&&T(x,{silent:!1})},[i,g,x]),$.useEffect(()=>{if(S(),!(i&&d>0&&g))return;const e=`rankstats:${x}:${w.current}`,r=v({key:e,intervalMs:d,run:async()=>{await T(x,{silent:!0})},enabled:!0,requireVisible:o,requireOnline:!0,immediate:!1});return N.current=r,()=>S()},[i,d,o,v,T,S,x,g]);const L=h[x],D=$.useCallback(async()=>{await T(x,{silent:!1})},[T,x]);return{scope:x,setScope:u,availableScopes:R,canUseOrg:M,canUseTeam:E,data:L,loading:y,error:p,refresh:D}}(e,r,{enabled:!0,pollMs:12e4,pauseWhenHidden:!0,defaultScope:"global"}),{userPoints:p,loading:k,getLevelProgress:v,transactions:j,transactionsLoading:w,loadTransactions:E}=function(e,r={}){var t,l;const n=r.includeTransactions??!1,i=r.transactionsLimit??50,[d,o]=$.useState(null),[c,x]=$.useState([]),[u,g]=$.useState(!0),[m,h]=$.useState(!1),[b,y]=$.useState(null),[f,p]=$.useState(!1),{state:k}=a(),v=$.useRef(!0);$.useEffect(()=>()=>{v.current=!1},[]),$.useRef((null==(l=null==(t=globalThis.crypto)?void 0:t.randomUUID)?void 0:l.call(t))??Math.random().toString(36).slice(2));const j=$.useRef(null),w=$.useRef(null),N=$.useRef(!1),_=$.useRef(!1),S=$.useRef(!1),C=$.useCallback(()=>{var e;const r=j.current;if(r){try{null==(e=r.unsubscribe)||e.call(r)}catch(t){}try{s.removeChannel(r)}catch(t){}j.current=null}},[]),M=$.useCallback(()=>{var e;const r=w.current;if(r){try{null==(e=r.unsubscribe)||e.call(r)}catch(t){}try{s.removeChannel(r)}catch(t){}w.current=null}},[]),E=$.useCallback(async r=>{if(!e)return;if(_.current)return;_.current=!0;const t=(null==r?void 0:r.silent)??!1;try{!t&&v.current&&g(!0);const r=await s.from("user_points").select("*").eq("user_id",e).maybeSingle();if(r.error)throw r.error;if(!v.current)return;o(r.data??null),y(null)}catch(a){if(!v.current)return;console.error("[usePoints] fetch user_points error:",a),y((null==a?void 0:a.message)??"ポイント情報の取得に失敗しました")}finally{_.current=!1,!t&&v.current&&g(!1)}},[e]),R=$.useCallback(async r=>{if(!e)return;if(S.current)return;S.current=!0;const t=(null==r?void 0:r.silent)??!1;try{!t&&v.current&&h(!0);const r=await s.from("point_transactions").select("id,user_id,points,reason,category,metadata,created_at").eq("user_id",e).order("created_at",{ascending:!1}).limit(i);if(r.error)throw r.error;if(!v.current)return;x(r.data??[]),y(null),N.current=!0,p(!0)}catch(a){if(!v.current)return;console.error("[usePoints] fetch point_transactions error:",a),y((null==a?void 0:a.message)??"ポイント履歴の取得に失敗しました")}finally{S.current=!1,!t&&v.current&&h(!1)}},[e,i]),T=$.useCallback(async e=>{await R({silent:(null==e?void 0:e.silent)??!1})},[R]);$.useEffect(()=>{if(C(),M(),!e)return g(!1),x([]),p(!1),void(N.current=!1);E({silent:!1}),n?R({silent:!1}):(x([]),p(!1),N.current=!1)},[e,n,E,R,C,M]),$.useEffect(()=>{C()},[e,k.canRealtime,E,C]),$.useEffect(()=>{M()},[e,k.canRealtime,R,M]);const L=$.useCallback(()=>{const e=(null==d?void 0:d.current_points)??0,r=(null==d?void 0:d.points_to_next)??0;return r?Math.max(0,Math.min(100,Math.round(e/r*100))):0},[d]),D=$.useCallback(async e=>{const{error:r}=await s.rpc("award_points",e);if(r)throw r;await E({silent:!0}),N.current&&await R({silent:!0})},[E,R]);return{userPoints:d,transactions:c,loading:u,transactionsLoading:m,error:b,getLevelProgress:L,awardPoints:D,loadTransactions:T,hasLoadedTransactions:f}}(e,{includeTransactions:!1,transactionsLimit:50}),{allBadges:R,userBadges:T,loading:L,getNewBadges:D,markBadgeAsViewed:A,getBadgeProgress:q}=N(e,{enabled:!0,pollMs:3e5}),[G,B]=$.useState(null),[J,O]=$.useState(!1),Z=$.useRef(null);$.useEffect(()=>{console.log("[Gamification] rankingsEl set?",!!G)},[G]),$.useEffect(()=>{if(!G)return;console.log("[Gamification] IntersectionObserver setup");const e=new IntersectionObserver(r=>{const t=r.some(e=>e.isIntersecting);console.log("[Gamification] rankings inView?",t),t&&(console.log("[Gamification] ✅ rankingsEnabled -> true"),O(!0),e.disconnect(),Z.current&&(window.clearTimeout(Z.current),Z.current=null))},{threshold:0,rootMargin:"200px 0px"});return e.observe(G),()=>{e.disconnect(),Z.current&&(window.clearTimeout(Z.current),Z.current=null)}},[G]),$.useEffect(()=>{console.log("[Gamification] rankingsEnabled:",J)},[J]);const{weeklyRankings:K,pointsRankings:Q,loading:Y,error:X}=function(e,r={}){var t,l;const n=r.enabled??!0,i=r.pollMs??12e4,d=r.pauseWhenHidden??!0,[o,c]=$.useState([]),[x,u]=$.useState([]),[g,m]=$.useState(!0),[h,b]=$.useState(null),{registerPollJob:y}=a(),f=$.useRef(!0);$.useEffect(()=>(f.current=!0,()=>{f.current=!1}),[]);const p=$.useRef((null==(l=null==(t=globalThis.crypto)?void 0:t.randomUUID)?void 0:l.call(t))??Math.random().toString(36).slice(2)),k=$.useRef(null),v=$.useRef(!1),j=$.useCallback(()=>{k.current&&(k.current(),k.current=null)},[]),w=$.useCallback(async r=>{if(!e||!n)return;if(v.current)return;v.current=!0;const t=(null==r?void 0:r.silent)??!1;try{!t&&f.current&&m(!0);const{data:r,error:a}=await s.rpc("get_team_rankings",{p_team_id:e});if(a)throw a;const l=r??{},n=Array.isArray(l.weekly)?l.weekly:[],i=Array.isArray(l.points)?l.points:[];if(!f.current)return;c(n),u(i),b(null)}catch(a){if(!f.current)return;console.error("[useRankings] fetch error:",a),b((null==a?void 0:a.message)??"ランキングの取得に失敗しました")}finally{v.current=!1,!t&&f.current&&m(!1)}},[e,n]);return $.useEffect(()=>{if(j(),!e||!n)return c([]),u([]),b(null),void m(!1);w({silent:!1})},[e,n]),$.useEffect(()=>{if(j(),!(e&&n&&i>0))return;const r=`rankings:${e}:${p.current}`,t=y({key:r,intervalMs:i,run:async()=>{await w({silent:!0})},enabled:!0,requireVisible:d,requireOnline:!0,immediate:!1});return k.current=t,()=>j()},[e,n,i,d,y,w,j]),{weeklyRankings:o,pointsRankings:x,loading:g,error:h,refresh:async()=>{await w({silent:!1})}}}(r,{enabled:J&&!!r,pollMs:12e4,pauseWhenHidden:!0});$.useEffect(()=>{console.log("[Gamification] rankings state",{enabled:J&&!!r,userTeamId:r,rankingsLoading:Y,weeklyLen:(null==K?void 0:K.length)??0,pointsLen:(null==Q?void 0:Q.length)??0,rankingsError:X})},[J,r,Y,K,Q,X]);const[ee,re]=$.useState(!1),[te,ae]=$.useState(null),[se,le]=$.useState(null),[ne,ie]=$.useState(!1),[de,oe]=$.useState(!1),ce=i||k||L,xe=$.useMemo(()=>{if(k)return 0;try{return v()}catch(e){return console.warn("[GamificationView] getLevelProgress failed",e),0}},[k,v]),ue=$.useMemo(()=>{if(L)return[];try{return D()??[]}catch(e){return console.warn("[GamificationView] getNewBadges failed",e),[]}},[L,D]),ge=$.useMemo(()=>{if(L)return{earned:0,total:0,percentage:0};try{return q()??{earned:0,total:0,percentage:0}}catch(e){return console.warn("[GamificationView] getBadgeProgress failed",e),{earned:0,total:0,percentage:0}}},[L,q]),me=$.useRef(null),he=$.useMemo(()=>`bekuta:last_seen_level:${e||"unknown"}`,[e]),be=e=>{try{localStorage.setItem(he,String(e))}catch{}};$.useEffect(()=>{const e=null==p?void 0:p.current_level;if(null==e)return;const r=(()=>{try{const e=localStorage.getItem(he),r=null==e?NaN:Number(e);return Number.isFinite(r)?r:null}catch{return null}})();if(null==r)return be(e),void(me.current=e);e>r&&(le({level:e,rankTitle:(null==p?void 0:p.rank_title)??""}),be(e)),null!=me.current&&e>me.current&&(le({level:e,rankTitle:(null==p?void 0:p.rank_title)??""}),be(e)),me.current=e},[null==p?void 0:p.current_level,null==p?void 0:p.rank_title,he]),$.useEffect(()=>{try{if(te)return;if(!ue||0===ue.length)return;const e=ue[0];(null==e?void 0:e.badge)&&ae(e.badge)}catch(e){console.warn("[GamificationView] new badge effect failed",e)}},[ue,te]);return l.jsx(U,{title:"ゲーミフィケーションの表示に失敗しました",description:"この画面だけ復旧できます。再表示を試してください。",children:ce?l.jsx("div",{className:"flex items-center justify-center h-96",children:l.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})}):l.jsxs("div",{className:"space-y-6",children:[l.jsx(U,{compact:!0,title:"チュートリアルの表示でエラー",children:l.jsx(_,{steps:S("gamification"),isActive:ne,onComplete:()=>ie(!1),onSkip:()=>ie(!1)})}),l.jsxs("div",{className:"flex items-center justify-between",children:[l.jsxs("div",{children:[l.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"ゲーミフィケーション"}),l.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-1",children:"楽しみながら継続的な記録を！ストリークとバッジで成長を可視化"})]}),l.jsxs("button",{onClick:()=>ie(!0),className:"flex items-center space-x-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors",title:"チュートリアルを表示",children:[l.jsx(C,{className:"w-5 h-5"}),l.jsx("span",{className:"hidden sm:inline",children:"チュートリアル"})]})]}),l.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[l.jsx(U,{compact:!0,title:"ストリーク表示でエラー",children:l.jsx(z,{streak:x(),label:"総合ストリーク",icon:l.jsx(n,{className:"w-6 h-6"})})}),l.jsx(U,{compact:!0,title:"レベル表示でエラー",children:l.jsx("div",{className:"space-y-3",children:l.jsx(P,{userPoints:p,levelProgress:xe,showDetails:!1})})}),l.jsxs("button",{onClick:()=>re(!0),className:"bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 hover:shadow-md transition-all text-left","data-tutorial":"badges-card",children:[l.jsxs("div",{className:"flex items-start justify-between mb-3",children:[l.jsxs("div",{children:[l.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400 mb-1",children:"バッジコレクション"}),l.jsxs("div",{className:"flex items-baseline space-x-2",children:[l.jsx("p",{className:"text-3xl font-bold text-gray-900 dark:text-white",children:ge.earned}),l.jsxs("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:["/ ",ge.total]})]})]}),l.jsx("div",{className:"p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg",children:l.jsx(d,{className:"w-6 h-6 text-yellow-600 dark:text-yellow-400"})})]}),l.jsx("div",{className:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 overflow-hidden",children:l.jsx("div",{className:"h-full bg-gradient-to-r from-yellow-500 to-orange-500 rounded-full transition-all duration-500",style:{width:`${ge.percentage}%`}})}),ue.length>0&&l.jsx("div",{className:"mt-2 flex items-center space-x-1 text-xs text-red-600 dark:text-red-400 font-semibold animate-pulse",children:l.jsxs("span",{children:["新しいバッジ: ",ue.length,"個"]})})]})]}),l.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[l.jsxs("div",{className:"space-y-6",children:[l.jsxs("div",{"data-tutorial":"streaks-section",children:[l.jsxs("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center space-x-2",children:[l.jsx(n,{className:"w-5 h-5 text-orange-500"}),l.jsx("span",{children:"あなたのストリーク"})]}),l.jsx(U,{compact:!0,title:"ストリーク詳細でエラー",children:l.jsxs("div",{className:"space-y-4",children:[l.jsx(z,{streak:o("training"),label:"練習記録"}),l.jsx(z,{streak:o("weight"),label:"体重記録"}),l.jsx(z,{streak:o("sleep"),label:"睡眠記録"}),l.jsx(z,{streak:o("motivation"),label:"モチベーション記録"})]})})]}),l.jsxs("div",{"data-tutorial":"level-section",children:[l.jsxs("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center space-x-2",children:[l.jsx(c,{className:"w-5 h-5 text-yellow-500"}),l.jsx("span",{children:"レベル進捗"})]}),l.jsx(U,{compact:!0,title:"レベル進捗の表示でエラー",children:l.jsx(P,{userPoints:p,levelProgress:xe,showDetails:!0,actions:l.jsx("button",{onClick:async()=>{console.log("[Gamification] openPointHistory clicked"),oe(!0);0===(j??[]).length?(console.log("[Gamification] loadTransactions start"),await E({silent:!1}),console.log("[Gamification] loadTransactions done")):console.log("[Gamification] transactions already loaded (skip fetch)")},className:"w-full sm:w-auto px-3 py-2 rounded-lg text-sm\n                                   bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700\n                                   hover:bg-gray-50 dark:hover:bg-gray-700\n                                   text-gray-900 dark:text-white transition-colors",title:"ポイント履歴を表示",children:"ポイント履歴"})})})]})]}),l.jsxs("div",{className:"mb-4",children:[l.jsx("div",{className:"flex items-center space-x-2 mb-2",children:m.map(e=>l.jsx("button",{onClick:()=>g(e),className:"px-3 py-1 rounded-full text-xs border transition-colors\n                      "+(u===e?"bg-blue-600 text-white border-blue-600":"bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700"),children:"global"===e?"全体":"organization"===e?"組織":"チーム"},e))}),l.jsx(W,{scope:u,data:h,loading:b,error:y})]}),l.jsxs("div",{ref:B,"data-tutorial":"rankings-section",children:[l.jsxs("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center space-x-2",children:[l.jsx(f,{className:"w-5 h-5 text-blue-500"}),l.jsx("span",{children:"チームランキング"})]}),l.jsx(U,{compact:!0,title:"ランキング表示でエラー",children:J?Y?l.jsx("div",{className:"flex items-center justify-center h-24",children:l.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):l.jsx(H,{weeklyRankings:K,pointsRankings:Q,myUserId:e}):l.jsx("div",{className:"text-sm text-gray-500 dark:text-gray-400 h-24 flex items-center",children:"ランキングを読み込みます…"})}),X&&l.jsxs("div",{className:"mt-2 text-xs text-red-600 dark:text-red-400",children:["rankingsError: ",X]})]})]}),ee&&l.jsx(U,{title:"バッジ一覧の表示でエラー",children:l.jsx(F,{userBadges:T,allBadges:R,onClose:()=>re(!1)})}),te&&l.jsx(U,{title:"バッジ獲得モーダルの表示でエラー",children:l.jsx(M,{badge:te,onClose:async()=>{try{if(te&&ue.length>0){const e=ue.find(e=>{var r;return(null==(r=null==e?void 0:e.badge)?void 0:r.id)===te.id});e&&await A(e.id)}}catch(e){console.warn("[GamificationView] markBadgeAsViewed failed",e)}finally{ae(null)}}})}),se&&l.jsx(U,{title:"レベルアップ演出の表示でエラー",children:l.jsx(I,{newLevel:se.level,rankTitle:se.rankTitle,onClose:()=>le(null)})}),l.jsx(V,{open:de,onClose:()=>oe(!1),transactions:j??[],loading:w,onReload:async()=>{console.log("[Gamification] reloadPointHistory"),await E({silent:!1})}})]})})}export{Z as GamificationView};
//# sourceMappingURL=GamificationView-DcmE6WMq.js.map
